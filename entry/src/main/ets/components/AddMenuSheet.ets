/**
 * é¥µçŸ¥é?- åŠ å·èœå•åº•éƒ¨å¼¹å‡ºç»„ä»¶
 * æä¾›å››ä¸ªåŠŸèƒ½å…¥å£ï¼šç²¾ç¡®åŒ¹é…ã€ä¸ªäººåˆ›ä½œã€åŽŸæ–™æ–°å¢žã€é±¼ç±»æ–°å¢?
 */
import { ThemeColors } from '../theme/ThemeColors';
import { ThemeConstants } from '../theme/ThemeConstants';

// èœå•é¡¹æ•°æ®æŽ¥å?
export interface AddMenuItem {
  id: string;
  icon: Resource;
  iconBg: string;
  title: string;
  description: string;
  route: string;
}

// èœå•é¡¹é…ç½?
export const ADD_MENU_ITEMS: AddMenuItem[] = [
  {
    id: 'precise_match',
    icon: $r('app.media.Precise'),
    iconBg: '#FFEBEE',
    title: 'ç²¾ç¡®åŒ¹é…',
    description: 'æ ¹æ®æ¡ä»¶ç²¾å‡†æŽ¨è',
    route: 'pages/PreciseMatchPage'
  },
  {
    id: 'personal_creation',
    icon: $r('app.media.Creation'),
    iconBg: '#E8F5E9',
    title: 'ä¸ªäººåˆ›ä½œ',
    description: 'åˆ›å»ºè‡ªå®šä¹‰é…æ–?,
    route: 'pages/RecipeCreatePage'
  },
  {
    id: 'ingredient_add',
    icon: $r('app.media.Raw_material'),
    iconBg: '#E0F7FA',
    title: 'åŽŸæ–™æ–°å¢ž',
    description: 'æ·»åŠ è‡ªå®šä¹‰åŽŸæ–?,
    route: 'pages/IngredientAddPage'
  },
  {
    id: 'fish_add',
    icon: $r('app.media.FishLei'),
    iconBg: '#FFF3E0',
    title: 'é±¼ç±»æ–°å¢ž',
    description: 'æ·»åŠ è‡ªå®šä¹‰é±¼ç§?,
    route: 'pages/FishAddPage'
  }
];

@Component
export struct AddMenuSheet {
  @Prop visible: boolean = false;
  onClose?: () => void;
  onItemClick?: (item: AddMenuItem) => void;

  @State private sheetOffset: number = 380;  // åˆå§‹åç§»é‡ï¼ˆéšè—çŠ¶æ€ï¼‰

  aboutToAppear(): void {
    if (this.visible) {
      this.animateIn();
    }
  }

  // ç›‘å¬visibleå˜åŒ–
  onVisibleChange(): void {
    if (this.visible) {
      this.animateIn();
    } else {
      this.animateOut();
    }
  }

  // æ»‘å…¥åŠ¨ç”»
  private animateIn(): void {
    animateTo({
      duration: 250,
      curve: Curve.EaseOut
    }, () => {
      this.sheetOffset = 0;
    });
  }

  // æ»‘å‡ºåŠ¨ç”»
  private animateOut(): void {
    animateTo({
      duration: 200,
      curve: Curve.EaseIn
    }, () => {
      this.sheetOffset = 380;
    });
  }

  // å¤„ç†é®ç½©ç‚¹å‡»
  private handleOverlayClick(): void {
    if (this.onClose) {
      this.onClose();
    }
  }

  // å¤„ç†èœå•é¡¹ç‚¹å‡?
  private handleItemClick(item: AddMenuItem): void {
    if (this.onItemClick) {
      this.onItemClick(item);
    }
  }

  build() {
    if (this.visible) {
      Stack() {
        // é®ç½©å±?
        Column()
          .width('100%')
          .height('100%')
          .backgroundColor(ThemeColors.OVERLAY)
          .onClick(() => this.handleOverlayClick())
          .transition({ type: TransitionType.All, opacity: 0 })

        // åº•éƒ¨å¼¹å‡ºå¡ç‰‡
        Column() {
          // é¡¶éƒ¨æ‹–æ‹½æŒ‡ç¤ºæ?
          Row() {
            Column()
              .width(40)
              .height(4)
              .backgroundColor(ThemeColors.TEXT_HINT)
              .borderRadius(2)
          }
          .width('100%')
          .justifyContent(FlexAlign.Center)
          .padding({ top: 12, bottom: 8 })

          // æ ‡é¢˜
          Text('å¿«é€Ÿæ“ä½?)
            .fontSize(ThemeConstants.FONT_SIZE_LG)
            .fontWeight(FontWeight.Bold)
            .fontColor(ThemeColors.TEXT_PRIMARY)
            .margin({ bottom: 20 })

          // 2x2 ç½‘æ ¼å¸ƒå±€
          Column({ space: 12 }) {
            // ç¬¬ä¸€è¡?
            Row({ space: 12 }) {
              this.MenuItemCard(ADD_MENU_ITEMS[0])
              this.MenuItemCard(ADD_MENU_ITEMS[1])
            }
            .width('100%')

            // ç¬¬äºŒè¡?
            Row({ space: 12 }) {
              this.MenuItemCard(ADD_MENU_ITEMS[2])
              this.MenuItemCard(ADD_MENU_ITEMS[3])
            }
            .width('100%')
          }
          .width('100%')
          .padding({ left: 16, right: 16, bottom: 28 })
        }
        .width('100%')
        .backgroundColor(ThemeColors.BG_PRIMARY)
        .borderRadius({ topLeft: 24, topRight: 24 })
        .position({ x: 0, y: '100%' })
        .translate({ y: -380 + this.sheetOffset })
        .shadow({ radius: 20, color: 'rgba(0,0,0,0.15)', offsetY: -4 })
        .gesture(
          PanGesture({ direction: PanDirection.Down })
            .onActionEnd(() => {
              if (this.onClose) {
                this.onClose();
              }
            })
        )
      }
      .width('100%')
      .height('100%')
      .position({ x: 0, y: 0 })
    }
  }

  @Builder
  MenuItemCard(item: AddMenuItem) {
    Column({ space: 8 }) {
      // å›¾æ ‡å®¹å™¨
      Row() {
        Image(item.icon)
          .width(32)
          .height(32)
          .objectFit(ImageFit.Contain)
      }
      .width(56)
      .height(56)
      .backgroundColor(item.iconBg)
      .borderRadius(12)
      .justifyContent(FlexAlign.Center)

      // æ ‡é¢˜
      Text(item.title)
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .fontWeight(FontWeight.Medium)
        .fontColor(ThemeColors.TEXT_PRIMARY)

      // æè¿°
      Text(item.description)
        .fontSize(ThemeConstants.FONT_SIZE_XS)
        .fontColor(ThemeColors.TEXT_SECONDARY)
    }
    .layoutWeight(1)
    .padding(16)
    .backgroundColor(ThemeColors.BG_CARD)
    .borderRadius(ThemeConstants.RADIUS_MD)
    .alignItems(HorizontalAlign.Center)
    .onClick(() => this.handleItemClick(item))
  }
}
