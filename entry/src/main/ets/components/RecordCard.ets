/**
 * é¥µçŸ¥é?- æ¸”è·è®°å½•å¡ç‰‡ç»„ä»¶
 * ç”¨äºåœ¨åˆ—è¡¨ä¸­å±•ç¤ºå•æ¡æ¸”è·è®°å½•
 */
import { ThemeColors } from '../theme/ThemeColors';
import { ThemeConstants } from '../theme/ThemeConstants';
import { FishingRecord } from '../common/types/UserTypes';

@Component
export struct RecordCard {
  @Prop record: FishingRecord = new FishingRecord();
  onClick?: () => void;
  onDelete?: () => void;

  private formatDate(timestamp: number): string {
    const date = new Date(timestamp);
    const month = date.getMonth() + 1;
    const day = date.getDate();
    const weekDays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
    const weekDay = weekDays[date.getDay()];
    return `${month}æœ?{day}æ—?${weekDay}`;
  }

  private getWeatherIcon(weather: string): string {
    const icons: Record<string, string> = {
      'æ™´æœ—': 'â˜€ï¸?,
      'å¤šäº‘': 'â›?,
      'é˜´å¤©': 'â˜ï¸',
      'å°é›¨': 'ğŸŒ§ï¸?,
      'å¤§é£': 'ğŸ’¨'
    };
    return icons[weather] || 'ğŸŒ¤ï¸?;
  }

  // æˆªæ–­é±¼ç§åç§°ï¼Œæœ€å¤šæ˜¾ç¤?ç§é±¼
  private formatFishName(name: string): string {
    if (!name) return 'æœªçŸ¥é±¼ç§';
    const fishList = name.split('ã€?);
    if (fishList.length <= 2) return name;
    return fishList.slice(0, 2).join('ã€?) + 'ç­?;
  }

  build() {
    Column({ space: 8 }) {
      // ç¬¬ä¸€è¡Œï¼šæ—¥æœŸå’Œå¤©æ°?
      Row() {
        Row({ space: 6 }) {
          Text('ğŸ“…')
            .fontSize(14)
          Text(this.formatDate(this.record.date))
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.TEXT_SECONDARY)
        }

        Blank()

        Row({ space: 4 }) {
          Text(this.getWeatherIcon(this.record.weather))
            .fontSize(14)
          Text(this.record.weather)
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.TEXT_SECONDARY)
        }
        .padding({ left: 8, right: 8, top: 2, bottom: 2 })
        .backgroundColor(ThemeColors.BG_TERTIARY)
        .borderRadius(ThemeConstants.RADIUS_FULL)
      }
      .width('100%')

      // ç¬¬äºŒè¡Œï¼šé’“ç‚¹
      Row({ space: 6 }) {
        Text('ğŸ“')
          .fontSize(14)
        Text(this.record.location || 'æœªå¡«å†™é’“ç‚?)
          .fontSize(ThemeConstants.FONT_SIZE_BASE)
          .fontColor(ThemeColors.TEXT_PRIMARY)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .layoutWeight(1)
      }
      .width('100%')

      // ç¬¬ä¸‰è¡Œï¼šé±¼ç§ + æ•°é‡ + é‡é‡ï¼ˆä¸€è¡Œæ˜¾ç¤ºï¼‰
      Row() {
        // å·¦ä¾§ï¼šé±¼ç§å’Œæ•°é‡
        Row({ space: 6 }) {
          Text('ğŸŸ')
            .fontSize(16)
            .flexShrink(0)
          Text(this.formatFishName(this.record.fishName))
            .fontSize(ThemeConstants.FONT_SIZE_MD)
            .fontWeight(FontWeight.Medium)
            .fontColor(ThemeColors.TEXT_PRIMARY)
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .constraintSize({ maxWidth: '45%' })
          Text(`Ã—${this.record.count}å°¾`)
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.TEXT_SECONDARY)
            .flexShrink(0)
        }
        .flexShrink(1)

        Blank()

        // å³ä¾§ï¼šé‡é‡?
        Row() {
          Text(`${this.record.weight}`)
            .fontSize(ThemeConstants.FONT_SIZE_XL)
            .fontWeight(FontWeight.Bold)
            .fontColor(ThemeColors.PRIMARY_DARK)
          Text('kg')
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.TEXT_SECONDARY)
            .margin({ left: 2, top: 4 })
        }
        .flexShrink(0)
      }
      .width('100%')

      // ç¬¬å››è¡Œï¼šé…æ–¹ï¼ˆå¦‚æœ‰ï¼‰
      if (this.record.recipeName) {
        Row({ space: 6 }) {
          Text('ğŸ§ª')
            .fontSize(14)
          Text(this.record.recipeName)
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.TEXT_SECONDARY)
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .layoutWeight(1)
        }
        .width('100%')
      }
    }
    .width('100%')
    .padding(ThemeConstants.SPACE_MD)
    .backgroundColor(ThemeColors.BG_CARD)
    .borderRadius(ThemeConstants.RADIUS_MD)
    .shadow({ radius: 4, color: 'rgba(0,0,0,0.05)', offsetY: 2 })
    .onClick(() => {
      if (this.onClick) {
        this.onClick();
      }
    })
  }
}
