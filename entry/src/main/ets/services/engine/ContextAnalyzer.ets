/**
 * ç¯å¢ƒåˆ†æå™?
 * è´Ÿè´£åˆ†æè¾“å…¥çš„ç¯å¢ƒæ¡ä»¶ï¼Œç”Ÿæˆå‘³å‹æƒé‡å’ŒçŠ¶æ€æƒé‡?
 */
import {
  GenerateRecipeInput, FlavorModifier, StateModifier,
  FishRecipeRule, RecipeSeason, RecipeWaterType
} from '../../common/types/RecipeTypes';
import { getFishRule, getTemperatureRule, getDensityModifier, getActivityModifier, getModeModifier, getMethodModifier } from '../../data/RecipeRules';

// å‘³å‹æƒé‡
export class FlavorWeights {
  fishy: number = 0;      // è…?
  fragrant: number = 0;   // é¦?
  sweet: number = 0;      // ç”?
  sour: number = 0;       // é…?
  stinky: number = 0;     // è‡?

  constructor() {}

  static create(fi: number, fr: number, sw: number, so: number, st: number): FlavorWeights {
    const w = new FlavorWeights();
    w.fishy = fi; w.fragrant = fr; w.sweet = sw; w.sour = so; w.stinky = st;
    return w;
  }

  clone(): FlavorWeights {
    return FlavorWeights.create(this.fishy, this.fragrant, this.sweet, this.sour, this.stinky);
  }

  // è·å–ä¸»å‘³å?
  getPrimaryFlavor(): string {
    let max = this.fishy;
    let primary = 'è…?;
    if (this.fragrant > max) { max = this.fragrant; primary = 'é¦?; }
    if (this.sweet > max) { max = this.sweet; primary = 'ç”?; }
    if (this.sour > max) { max = this.sour; primary = 'é…?; }
    if (this.stinky > max) { max = this.stinky; primary = 'è‡?; }
    return primary;
  }

  // è·å–æ¬¡å‘³å?
  getSecondaryFlavor(): string {
    const primary = this.getPrimaryFlavor();
    let max = -1;
    let secondary = '';
    if (primary !== 'è…? && this.fishy > max) { max = this.fishy; secondary = 'è…?; }
    if (primary !== 'é¦? && this.fragrant > max) { max = this.fragrant; secondary = 'é¦?; }
    if (primary !== 'ç”? && this.sweet > max) { max = this.sweet; secondary = 'ç”?; }
    if (primary !== 'é…? && this.sour > max) { max = this.sour; secondary = 'é…?; }
    if (primary !== 'è‡? && this.stinky > max) { max = this.stinky; secondary = 'è‡?; }
    return secondary;
  }

  // è®¡ç®—æ€»å¼ºåº?
  getTotalIntensity(): number {
    return this.fishy + this.fragrant + this.sweet + this.sour + this.stinky;
  }
}

// çŠ¶æ€æƒé‡?
export class StateWeights {
  atomization: number = 50;  // é›¾åŒ– (0-100, é«?å¿«é›¾åŒ?
  viscosity: number = 50;    // ç²˜åº¦ (0-100, é«?ç²?
  weight: number = 50;       // æ¯”é‡ (0-100, é«?é‡?

  constructor() {}

  static create(atom: number, visc: number, wt: number): StateWeights {
    const w = new StateWeights();
    w.atomization = atom; w.viscosity = visc; w.weight = wt;
    return w;
  }

  clone(): StateWeights {
    return StateWeights.create(this.atomization, this.viscosity, this.weight);
  }
}

// ç‰¹æ®Šåœºæ™¯ç±»å‹
export type SpecialScenario =
  'extreme_cold' |      // æå¯’ (<5Â°C)
  'extreme_hot' |       // æçƒ­ (>30Â°C)
  'carnivore_fish' |    // è‚‰é£Ÿæ€§é±¼ç±?
  'black_pit_new' |     // é»‘å‘æ–°æ”¾é±?
  'black_pit_old' |     // é»‘å‘è€é±¼
  'flowing_water' |     // æµæ°´ç¯å¢ƒ
  'deep_water' |        // æ·±æ°´åŒ?
  'night_fishing' |     // å¤œé’“
  'competition';        // ç«æŠ€é’?

// åˆ†æç»“æœ
export class AnalysisResult {
  flavorWeights: FlavorWeights = new FlavorWeights();
  stateWeights: StateWeights = new StateWeights();
  priorityFactors: string[] = [];       // ä¼˜å…ˆè€ƒè™‘çš„å› ç´?
  specialScenarios: SpecialScenario[] = [];  // ç‰¹æ®Šåœºæ™¯æ ‡è®°
  fishRule: FishRecipeRule | null = null;
  analysisNotes: string[] = [];         // åˆ†æå¤‡æ³¨

  constructor() {}
}

// ç¯å¢ƒåˆ†æå™?
export class ContextAnalyzer {
  private static instance: ContextAnalyzer | null = null;

  private constructor() {}

  static getInstance(): ContextAnalyzer {
    if (ContextAnalyzer.instance === null) {
      ContextAnalyzer.instance = new ContextAnalyzer();
    }
    return ContextAnalyzer.instance;
  }

  /**
   * ç»¼åˆåˆ†ææ‰€æœ‰ç¯å¢ƒå› ç´?
   */
  analyze(input: GenerateRecipeInput): AnalysisResult {
    const result = new AnalysisResult();

    // 1. è·å–é±¼ç§åŸºç¡€è§„åˆ™
    const fishRule = getFishRule(input.targetFishId);
    if (fishRule === null) {
      result.analysisNotes.push('æœªæ‰¾åˆ°ç›®æ ‡é±¼ç§è§„åˆ™ï¼Œä½¿ç”¨é»˜è®¤é…ç½®');
      result.flavorWeights = FlavorWeights.create(50, 50, 40, 20, 10);
      result.stateWeights = StateWeights.create(50, 50, 50);
      return result;
    }
    result.fishRule = fishRule;

    // 2. åˆå§‹åŒ–åŸºç¡€å‘³å‹æƒé‡
    result.flavorWeights = FlavorWeights.create(
      fishRule.baseFlavor.fishy,
      fishRule.baseFlavor.fragrant,
      fishRule.baseFlavor.sweet,
      fishRule.baseFlavor.sour,
      fishRule.baseFlavor.stinky
    );

    // 3. åˆå§‹åŒ–åŸºç¡€çŠ¶æ€æƒé‡?
    result.stateWeights = StateWeights.create(50, 50, 50);

    // 4. æ£€æµ‹ç‰¹æ®Šåœºæ™?
    result.specialScenarios = this.detectSpecialScenarios(input, fishRule);

    // 5. åº”ç”¨å­£èŠ‚ä¿®æ­£
    this.applySeasonModifier(result, fishRule, input.season);

    // 6. åº”ç”¨æ¸©åº¦ä¿®æ­£ (æƒé‡æœ€é«?
    this.applyTemperatureModifier(result, input.temperature);

    // 7. åº”ç”¨æ°´åŸŸä¿®æ­£
    this.applyWaterTypeModifier(result, fishRule, input.waterType);

    // 8. åº”ç”¨é±¼æƒ…ä¿®æ­£
    this.applyFishConditionModifier(result, input);

    // 9. åº”ç”¨ä½œé’“æ–¹å¼ä¿®æ­£
    this.applyMethodModifier(result, input.fishingMethod);

    // 10. åº”ç”¨æ¨¡å¼ä¿®æ­£
    this.applyModeModifier(result, input.mode);

    // 11. åº”ç”¨ç‰¹æ®Šåœºæ™¯ä¿®æ­£
    this.applySpecialScenarioModifiers(result);

    // 12. å½’ä¸€åŒ–æƒé‡?
    this.normalizeWeights(result);

    // 13. ç¡®å®šä¼˜å…ˆå› ç´ 
    result.priorityFactors = this.determinePriorityFactors(input, result);

    return result;
  }


  /**
   * æ£€æµ‹ç‰¹æ®Šåœºæ™?
   */
  private detectSpecialScenarios(input: GenerateRecipeInput, fishRule: FishRecipeRule): SpecialScenario[] {
    const scenarios: SpecialScenario[] = [];

    // æç«¯æ¸©åº¦
    if (input.temperature < 5) {
      scenarios.push('extreme_cold');
    } else if (input.temperature > 30) {
      scenarios.push('extreme_hot');
    }

    // è‚‰é£Ÿæ€§é±¼ç±?
    const carnivoreFish = ['catfish', 'snakehead', 'mandarin_fish', 'yellow_catfish', 'pike', 'bass', 'eel'];
    for (let i = 0; i < carnivoreFish.length; i++) {
      if (input.targetFishId === carnivoreFish[i]) {
        scenarios.push('carnivore_fish');
        break;
      }
    }

    // é»‘å‘åœºæ™¯
    if (input.waterType === 'pond') {
      if (input.fishDensity === 'high' && input.fishActivity === 'good') {
        scenarios.push('black_pit_new');
      } else if (input.fishActivity === 'poor') {
        scenarios.push('black_pit_old');
      }
    }

    // æµæ°´ç¯å¢ƒ
    if (input.waterType === 'river') {
      scenarios.push('flowing_water');
    }

    // æ·±æ°´åŒ?(æ°´åº“)
    if (input.waterType === 'reservoir') {
      scenarios.push('deep_water');
    }

    return scenarios;
  }

  /**
   * åº”ç”¨å­£èŠ‚ä¿®æ­£
   */
  private applySeasonModifier(result: AnalysisResult, fishRule: FishRecipeRule, season: RecipeSeason): void {
    let mod: FlavorModifier;
    if (season === 'spring') {
      mod = fishRule.seasonModifier.spring;
      result.analysisNotes.push('æ˜¥å­£ï¼šé±¼åˆšå¼€å£ï¼Œé€‚å½“å¢è…¥');
    } else if (season === 'summer') {
      mod = fishRule.seasonModifier.summer;
      result.analysisNotes.push('å¤å­£ï¼šæ°´æ¸©é«˜ï¼Œæ¸…æ·¡ä¸ºä¸?);
    } else if (season === 'autumn') {
      mod = fishRule.seasonModifier.autumn;
      result.analysisNotes.push('ç§‹å­£ï¼šé±¼å‚¨å¤‡è¿‡å†¬ï¼Œé¦™ç”œä¸ºä¸?);
    } else {
      mod = fishRule.seasonModifier.winter;
      result.analysisNotes.push('å†¬å­£ï¼šæ°´æ¸©ä½ï¼Œæµ“è…¥æµ“é¦?);
    }

    result.flavorWeights.fishy += mod.fishy;
    result.flavorWeights.fragrant += mod.fragrant;
    result.flavorWeights.sweet += mod.sweet;
    result.flavorWeights.sour += mod.sour;
    result.flavorWeights.stinky += mod.stinky;
  }

  /**
   * åº”ç”¨æ¸©åº¦ä¿®æ­£ (æƒé‡ç³»æ•°1.2)
   */
  private applyTemperatureModifier(result: AnalysisResult, temperature: number): void {
    const tempRule = getTemperatureRule(temperature);
    const scale = 1.2; // æ¸©åº¦å½±å“æƒé‡æ›´é«˜

    result.flavorWeights.fishy += Math.round(tempRule.flavorModifier.fishy * scale);
    result.flavorWeights.fragrant += Math.round(tempRule.flavorModifier.fragrant * scale);
    result.flavorWeights.sweet += Math.round(tempRule.flavorModifier.sweet * scale);
    result.flavorWeights.sour += Math.round(tempRule.flavorModifier.sour * scale);
    result.flavorWeights.stinky += Math.round(tempRule.flavorModifier.stinky * scale);

    result.stateWeights.atomization += tempRule.stateModifier.atomization;
    result.stateWeights.viscosity += tempRule.stateModifier.viscosity;
    result.stateWeights.weight += tempRule.stateModifier.intensity;

    result.analysisNotes.push(tempRule.description);
  }

  /**
   * åº”ç”¨æ°´åŸŸä¿®æ­£
   */
  private applyWaterTypeModifier(result: AnalysisResult, fishRule: FishRecipeRule, waterType: RecipeWaterType): void {
    let mod: StateModifier;
    if (waterType === 'river') {
      mod = fishRule.waterModifier.river;
      result.analysisNotes.push('é‡æ²³ï¼šé™ä½é›¾åŒ–ï¼Œå¢åŠ ç²˜åº¦');
    } else if (waterType === 'pond') {
      mod = fishRule.waterModifier.pond;
      result.analysisNotes.push('é»‘å‘ï¼šåŠ å¿«é›¾åŒ–ï¼Œå‘³å‹åŠ é‡');
    } else if (waterType === 'reservoir') {
      mod = fishRule.waterModifier.reservoir;
      result.analysisNotes.push('æ°´åº“ï¼šå¤§é¢—ç²’ï¼Œç•™é±¼æŒä¹?);
    } else {
      mod = fishRule.waterModifier.wild_pond;
      result.analysisNotes.push('é‡å¡˜ï¼šå‘³å‹é€‚ä¸­ï¼ŒçŠ¶æ€è‡ªç„?);
    }

    result.stateWeights.atomization += mod.atomization;
    result.stateWeights.viscosity += mod.viscosity;
    result.stateWeights.weight += mod.intensity;
  }

  /**
   * åº”ç”¨é±¼æƒ…ä¿®æ­£
   */
  private applyFishConditionModifier(result: AnalysisResult, input: GenerateRecipeInput): void {
    // å¯†åº¦ä¿®æ­£
    const densityMod = getDensityModifier(input.fishDensity);
    result.stateWeights.atomization += densityMod.atomization;
    result.stateWeights.viscosity += densityMod.viscosity;
    result.stateWeights.weight += densityMod.intensity;

    if (input.fishDensity === 'high') {
      result.analysisNotes.push('é±¼å¯†åº¦é«˜ï¼šå¿«é›¾åŒ–æŠ¢é±¼');
    } else if (input.fishDensity === 'low') {
      result.analysisNotes.push('é±¼å¯†åº¦ä½ï¼šæ…¢é›¾åŒ–ç•™é±¼');
    }

    // å¼€å£æƒ…å†µä¿®æ­?
    const activityMod = getActivityModifier(input.fishActivity);
    result.stateWeights.atomization += activityMod.atomization;
    result.stateWeights.viscosity += activityMod.viscosity;

    if (input.fishActivity === 'good') {
      // å¼€å£å¥½ï¼Œå‘³å‹å¯ä»¥æ·¡ä¸€ç‚?
      this.scaleFlavorWeights(result.flavorWeights, 0.9);
      result.analysisNotes.push('å¼€å£å¥½ï¼šå‘³å‹å¯é€‚å½“å‡æ·¡');
    } else if (input.fishActivity === 'poor') {
      // å¼€å£å·®ï¼Œå‘³å‹è¦æµ?
      this.scaleFlavorWeights(result.flavorWeights, 1.2);
      result.analysisNotes.push('å¼€å£å·®ï¼šå‘³å‹åŠ é‡?);
    }
  }

  /**
   * åº”ç”¨ä½œé’“æ–¹å¼ä¿®æ­£
   */
  private applyMethodModifier(result: AnalysisResult, method: string): void {
    const mod = getMethodModifier(method);
    result.stateWeights.atomization += mod.atomization;
    result.stateWeights.viscosity += mod.viscosity;

    if (method === 'pull') {
      result.analysisNotes.push('æ‹‰é¥µï¼šéœ€è¦æ‹‰ä¸ç²‰');
    } else if (method === 'scatter') {
      result.analysisNotes.push('æ•£ç‚®ï¼šæå¿«é›¾åŒ?);
    } else if (method === 'wrap') {
      result.analysisNotes.push('åŒ…é£Ÿï¼šå¤–é›¾åŒ–å†…ç²˜');
    }
  }

  /**
   * åº”ç”¨æ¨¡å¼ä¿®æ­£
   */
  private applyModeModifier(result: AnalysisResult, mode: string): void {
    const modeMod = getModeModifier(mode);

    // å‘³å‹ç¼©æ”¾
    this.scaleFlavorWeights(result.flavorWeights, modeMod.flavorScale);

    // é›¾åŒ–åç§»
    result.stateWeights.atomization += modeMod.atomizationBias;

    if (mode === 'conservative') {
      result.analysisNotes.push('ä¿å®ˆæ¨¡å¼ï¼šç»å…¸é…æ–¹ï¼Œç¨³å®šå‡ºé±¼');
    } else if (mode === 'aggressive') {
      result.analysisNotes.push('æ¿€è¿›æ¨¡å¼ï¼šå‘³å‹æµ“çƒˆï¼Œå¯èƒ½çˆ†æŠ?);
    }
  }

  /**
   * åº”ç”¨ç‰¹æ®Šåœºæ™¯ä¿®æ­£
   */
  private applySpecialScenarioModifiers(result: AnalysisResult): void {
    for (let i = 0; i < result.specialScenarios.length; i++) {
      const scenario = result.specialScenarios[i];

      if (scenario === 'extreme_cold') {
        // æå¯’ï¼šé«˜è…¥é«˜è›‹ç™½
        result.flavorWeights.fishy += 30;
        result.flavorWeights.fragrant += 15;
        result.stateWeights.atomization -= 20;
        result.stateWeights.viscosity += 15;
        result.analysisNotes.push('æå¯’åœºæ™¯ï¼šé«˜è…¥é«˜è›‹ç™½ï¼Œæ…¢é›¾åŒ–');
      } else if (scenario === 'extreme_hot') {
        // æçƒ­ï¼šæ¸…æ·¡æœé…?
        result.flavorWeights.fishy -= 30;
        result.flavorWeights.sour += 25;
        result.flavorWeights.sweet -= 15;
        result.stateWeights.atomization += 20;
        result.analysisNotes.push('æçƒ­åœºæ™¯ï¼šæ¸…æ·¡æœé…¸ï¼Œå¿«é›¾åŒ?);
      } else if (scenario === 'carnivore_fish') {
        // è‚‰é£Ÿæ€§é±¼ç±»ï¼šæµ“è…¥
        result.flavorWeights.fishy += 20;
        result.flavorWeights.stinky += 15;
        result.analysisNotes.push('è‚‰é£Ÿæ€§é±¼ç±»ï¼šæµ“è…¥å‘?);
      } else if (scenario === 'black_pit_new') {
        // é»‘å‘æ–°æ”¾é±¼ï¼šåŠ å°è?
        result.flavorWeights.fragrant += 15;
        result.stateWeights.atomization += 15;
        result.analysisNotes.push('é»‘å‘æ–°é±¼ï¼šå¯åŠ å°è¯ï¼Œå¿«é›¾åŒ?);
      } else if (scenario === 'black_pit_old') {
        // é»‘å‘è€é±¼ï¼šæœ¬å‘?
        this.scaleFlavorWeights(result.flavorWeights, 0.7);
        result.stateWeights.atomization -= 15;
        result.analysisNotes.push('é»‘å‘è€é±¼ï¼šæœ¬å‘³ä¸ºä¸»ï¼Œæ…¢é›¾åŒ?);
      } else if (scenario === 'flowing_water') {
        // æµæ°´ï¼šå¢ç²˜å¢é‡?
        result.stateWeights.viscosity += 20;
        result.stateWeights.weight += 15;
        result.stateWeights.atomization -= 15;
        result.analysisNotes.push('æµæ°´ç¯å¢ƒï¼šå¢ç²˜å¢é‡?);
      } else if (scenario === 'deep_water') {
        // æ·±æ°´ï¼šé‡æ¯”é‡
        result.stateWeights.weight += 20;
        result.stateWeights.atomization -= 10;
        result.analysisNotes.push('æ·±æ°´åŒºï¼šé‡æ¯”é‡ï¼Œå¿«åˆ°åº?);
      }
    }
  }

  /**
   * ç¼©æ”¾å‘³å‹æƒé‡
   */
  private scaleFlavorWeights(weights: FlavorWeights, scale: number): void {
    weights.fishy = Math.round(weights.fishy * scale);
    weights.fragrant = Math.round(weights.fragrant * scale);
    weights.sweet = Math.round(weights.sweet * scale);
    weights.sour = Math.round(weights.sour * scale);
    weights.stinky = Math.round(weights.stinky * scale);
  }

  /**
   * å½’ä¸€åŒ–æƒé‡åˆ° 0-100 èŒƒå›´
   */
  private normalizeWeights(result: AnalysisResult): void {
    // å‘³å‹æƒé‡
    result.flavorWeights.fishy = Math.min(100, Math.max(0, result.flavorWeights.fishy));
    result.flavorWeights.fragrant = Math.min(100, Math.max(0, result.flavorWeights.fragrant));
    result.flavorWeights.sweet = Math.min(100, Math.max(0, result.flavorWeights.sweet));
    result.flavorWeights.sour = Math.min(100, Math.max(0, result.flavorWeights.sour));
    result.flavorWeights.stinky = Math.min(100, Math.max(0, result.flavorWeights.stinky));

    // çŠ¶æ€æƒé‡?
    result.stateWeights.atomization = Math.min(100, Math.max(0, result.stateWeights.atomization));
    result.stateWeights.viscosity = Math.min(100, Math.max(0, result.stateWeights.viscosity));
    result.stateWeights.weight = Math.min(100, Math.max(0, result.stateWeights.weight));
  }

  /**
   * ç¡®å®šä¼˜å…ˆå› ç´ 
   */
  private determinePriorityFactors(input: GenerateRecipeInput, result: AnalysisResult): string[] {
    const factors: string[] = [];

    // æ¸©åº¦æ˜¯æœ€é‡è¦çš„å› ç´?
    if (input.temperature < 10 || input.temperature > 28) {
      factors.push('temperature');
    }

    // ç‰¹æ®Šåœºæ™¯
    if (result.specialScenarios.length > 0) {
      factors.push('special_scenario');
    }

    // é±¼ç§ç‰¹æ€?
    factors.push('fish_species');

    // æ°´åŸŸç±»å‹
    if (input.waterType === 'pond' || input.waterType === 'river') {
      factors.push('water_type');
    }

    // é±¼æƒ…
    if (input.fishActivity === 'poor' || input.fishDensity === 'low') {
      factors.push('fish_condition');
    }

    return factors;
  }

  /**
   * è®¡ç®—ä¸¤ä¸ªåˆ†æç»“æœçš„å·®å¼‚åº¦
   */
  calculateDifference(result1: AnalysisResult, result2: AnalysisResult): number {
    // å‘³å‹å·®å¼‚
    let flavorDiff = 0;
    flavorDiff += Math.abs(result1.flavorWeights.fishy - result2.flavorWeights.fishy);
    flavorDiff += Math.abs(result1.flavorWeights.fragrant - result2.flavorWeights.fragrant);
    flavorDiff += Math.abs(result1.flavorWeights.sweet - result2.flavorWeights.sweet);
    flavorDiff += Math.abs(result1.flavorWeights.sour - result2.flavorWeights.sour);
    flavorDiff += Math.abs(result1.flavorWeights.stinky - result2.flavorWeights.stinky);
    flavorDiff = flavorDiff / 5; // å¹³å‡

    // çŠ¶æ€å·®å¼?
    let stateDiff = 0;
    stateDiff += Math.abs(result1.stateWeights.atomization - result2.stateWeights.atomization);
    stateDiff += Math.abs(result1.stateWeights.viscosity - result2.stateWeights.viscosity);
    stateDiff += Math.abs(result1.stateWeights.weight - result2.stateWeights.weight);
    stateDiff = stateDiff / 3; // å¹³å‡

    // ç»¼åˆå·®å¼‚åº?(0-100)
    return Math.min(100, (flavorDiff * 0.6 + stateDiff * 0.4));
  }
}

// å¯¼å‡ºå•ä¾‹è·å–å‡½æ•°
export function getContextAnalyzer(): ContextAnalyzer {
  return ContextAnalyzer.getInstance();
}
