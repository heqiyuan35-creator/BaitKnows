/**
 * ç²¾ç¡®åŒ¹é…å¼•æ“
 * æ ¹æ®å¤šç»´åº¦å‚æ•°è®¡ç®—æœ€ä¼˜é…æ–¹
 */
import {
  PreciseMatchInput,
  PreciseMatchResult,
  DimensionScores,
  ParameterWeight,
  AnalysisStep,
  IngredientRatio,
  FeedbackType
} from '../../common/types/PreciseMatchTypes';
import {
  GeneratedRecipe,
  RecipeIngredient,
  FlavorDescription,
  StateProfile,
  UsageSuggestion,
  GenerateReason
} from '../../common/types/RecipeTypes';
import { getFishById, FishData } from '../../data/FishData';
import { getAllIngredients, Ingredient, getIngredientById } from '../../data/IngredientDatabase';

// åŸæ–™ç±»åˆ«é¢œè‰²
const CATEGORY_COLORS: Record<string, string> = {
  'main': '#E6A23C',
  'auxiliary': '#67C23A',
  'state': '#409EFF',
  'additive': '#F56C6C'
};

const CATEGORY_NAMES: Record<string, string> = {
  'main': 'åŸºç¡€é¥µ',
  'auxiliary': 'ä¸»æ”»é¥µ',
  'state': 'çŠ¶æ€é¥µ',
  'additive': 'æ·»åŠ å‰‚'
};

export class PreciseMatchEngine {
  private input: PreciseMatchInput = new PreciseMatchInput();
  private fishData: FishData | undefined;

  constructor() {}

  /**
   * æ‰§è¡Œç²¾ç¡®åŒ¹é…åˆ†æ
   */
  analyze(input: PreciseMatchInput): PreciseMatchResult {
    this.input = input;
    this.fishData = getFishById(input.targetFish);

    const result = new PreciseMatchResult();

    // 1. ç”Ÿæˆåˆ†ææ­¥éª¤
    result.analysisSteps = this.generateAnalysisSteps();

    // 2. è®¡ç®—å‚æ•°æƒé‡
    result.parameterWeights = this.calculateParameterWeights();

    // 3. ç”Ÿæˆé…æ–¹
    result.recipe = this.generateRecipe();

    // 4. è®¡ç®—ç»´åº¦è¯„åˆ†
    result.dimensionScores = this.calculateDimensionScores();

    // 5. è®¡ç®—æ€»åŒ¹é…åº¦
    result.matchScore = result.dimensionScores.getAverage();
    result.scoreDescription = result.getScoreLevel();

    // 6. ç”ŸæˆåŸæ–™é…æ¯”æ•°æ®
    result.ingredientRatios = this.generateIngredientRatios(result.recipe);

    // 7. ç”Ÿæˆå¤‡é€‰æ–¹æ¡ˆ
    result.alternatives = this.generateAlternatives();

    return result;
  }

  /**
   * æ ¹æ®åé¦ˆè°ƒæ•´é…æ–¹
   */
  adjustByFeedback(currentResult: PreciseMatchResult, feedbacks: FeedbackType[], excludedIngredients: string[] = []): PreciseMatchResult {
    // å¢åŠ åˆ·æ–°è®¡æ•°å™¨ï¼Œç¡®ä¿æ¯æ¬¡ç”Ÿæˆä¸åŒç»“æœ
    this.refreshCount++;

    // ä¿å­˜æ’é™¤çš„åŸæ–™
    this.excludedIngredientNames = excludedIngredients;

    // æ ¹æ®åé¦ˆç±»å‹è°ƒæ•´è¾“å…¥å‚æ•°
    for (const feedback of feedbacks) {
      switch (feedback) {
        case 'flavor_dislike':
          // åˆ‡æ¢å‘³å‹å¼ºåº¦
          this.cycleFlavorIntensity();
          break;
        case 'ingredient_hard':
          // æ ‡è®°éœ€è¦æ›¿æ¢åŸæ–™
          this.needAlternativeIngredients = true;
          break;
        case 'state_wrong':
          // åˆ‡æ¢é¥µæ–™çŠ¶æ€
          this.cycleBaitState();
          break;
        case 'want_more_fishy':
          this.input.flavorIntensity = 'strong';
          this.preferFishy = true;
          break;
        case 'want_more_fragrant':
          this.input.flavorIntensity = 'strong';
          this.preferFishy = false;
          break;
        case 'want_lighter':
          this.input.flavorIntensity = 'light';
          break;
        case 'other':
          // å®Œå…¨éšæœºè°ƒæ•´
          this.randomAdjust();
          break;
        default:
          break;
      }
    }

    // å¦‚æœæœ‰æ’é™¤çš„åŸæ–™ï¼Œæ ‡è®°éœ€è¦æ›¿æ¢
    if (excludedIngredients.length > 0) {
      this.needAlternativeIngredients = true;
    }

    // å¦‚æœæ²¡æœ‰é€‰æ‹©ä»»ä½•åé¦ˆï¼Œä¹Ÿè¦ç”Ÿæˆä¸åŒçš„é…æ–¹
    if (feedbacks.length === 0 && excludedIngredients.length === 0) {
      this.randomAdjust();
    }

    // é‡æ–°åˆ†æ
    const result = this.analyze(this.input);

    // é‡ç½®ä¸´æ—¶æ ‡è®°
    this.needAlternativeIngredients = false;
    this.preferFishy = false;
    this.excludedIngredientNames = [];

    return result;
  }

  // åˆ·æ–°è®¡æ•°å™¨
  private refreshCount: number = 0;
  // æ˜¯å¦éœ€è¦æ›¿æ¢åŸæ–™
  private needAlternativeIngredients: boolean = false;
  // æ˜¯å¦åå¥½è…¥å‘³
  private preferFishy: boolean = false;
  // æ’é™¤çš„åŸæ–™åç§°
  private excludedIngredientNames: string[] = [];

  // å¾ªç¯åˆ‡æ¢å‘³å‹å¼ºåº¦
  private cycleFlavorIntensity(): void {
    const intensities: Array<'light' | 'medium' | 'strong' | 'intense'> = ['light', 'medium', 'strong', 'intense'];
    const currentIndex = intensities.indexOf(this.input.flavorIntensity);
    const nextIndex = (currentIndex + 1) % intensities.length;
    this.input.flavorIntensity = intensities[nextIndex];
  }

  // å¾ªç¯åˆ‡æ¢é¥µæ–™çŠ¶æ€
  private cycleBaitState(): void {
    const states: Array<'fast_dissolve' | 'slow_dissolve' | 'sticky' | 'dry_loose'> = ['fast_dissolve', 'slow_dissolve', 'sticky', 'dry_loose'];
    const currentIndex = states.indexOf(this.input.baitState);
    const nextIndex = (currentIndex + 1) % states.length;
    this.input.baitState = states[nextIndex];
  }

  // éšæœºè°ƒæ•´å‚æ•°
  private randomAdjust(): void {
    // éšæœºè°ƒæ•´å‘³å‹å¼ºåº¦
    const intensities: Array<'light' | 'medium' | 'strong' | 'intense'> = ['light', 'medium', 'strong', 'intense'];
    const randomIntensity = intensities[(this.refreshCount) % intensities.length];
    if (randomIntensity !== this.input.flavorIntensity) {
      this.input.flavorIntensity = randomIntensity;
    } else {
      // å¦‚æœå‘³å‹ç›¸åŒï¼Œåˆ‡æ¢é¥µæ–™çŠ¶æ€
      this.cycleBaitState();
    }
  }

  /**
   * ç”Ÿæˆåˆ†ææ­¥éª¤
   */
  private generateAnalysisSteps(): AnalysisStep[] {
    const fishName = this.fishData?.name || 'ç›®æ ‡é±¼';
    return [
      AnalysisStep.create(1, 'å‚æ•°è§£æ', 'è§£æè¾“å…¥çš„é’“å†µå‚æ•°', `${this.countActiveParams()}ä¸ªå‚æ•°`),
      AnalysisStep.create(2, 'ä¹ æ€§åŒ¹é…', `åŒ¹é…${fishName}çš„è§…é£Ÿä¹ æ€§`, this.fishData?.habit.description || ''),
      AnalysisStep.create(3, 'åŸæ–™ç­›é€‰', 'ä»åŸæ–™åº“ç­›é€‰é€‚åˆåŸæ–™', `${this.getMatchedIngredientsCount()}ç§åŸæ–™`),
      AnalysisStep.create(4, 'é…æ¯”ä¼˜åŒ–', 'è®¡ç®—æœ€ä¼˜åŸæ–™é…æ¯”', 'åŠ æƒä¼˜åŒ–ç®—æ³•'),
      AnalysisStep.create(5, 'æ–¹æ¡ˆç”Ÿæˆ', 'ç”Ÿæˆæœ€ä¼˜é…æ–¹æ–¹æ¡ˆ', 'å®Œæˆ')
    ];
  }

  /**
   * è®¡ç®—å‚æ•°æƒé‡
   */
  private calculateParameterWeights(): ParameterWeight[] {
    const weights: ParameterWeight[] = [];

    // é±¼ç§æƒé‡æœ€é«˜
    weights.push(ParameterWeight.create('ç›®æ ‡é±¼ç§', 25, 'å†³å®šåŸºç¡€å‘³å‹å’Œé¥µæ–™é€‰æ‹©'));

    // å­£èŠ‚å’Œæ¸©åº¦
    weights.push(ParameterWeight.create('å­£èŠ‚æ¸©åº¦', 20, 'å½±å“é±¼çš„æ´»è·ƒåº¦å’Œé£Ÿæ¬²'));

    // æ°´åŸŸç¯å¢ƒ
    weights.push(ParameterWeight.create('æ°´åŸŸç¯å¢ƒ', 15, 'å½±å“é¥µæ–™çŠ¶æ€å’Œé›¾åŒ–'));

    // æ°´æ·±
    if (this.input.waterDepth === 'deep') {
      weights.push(ParameterWeight.create('æ°´æ·±', 12, 'æ·±æ°´éœ€è¦æ›´é‡çš„é¥µæ–™'));
    } else {
      weights.push(ParameterWeight.create('æ°´æ·±', 8, 'å½±å“é¥µæ–™æ¯”é‡'));
    }

    // æ°´è´¨
    weights.push(ParameterWeight.create('æ°´è´¨', 10, 'å½±å“å‘³å‹æµ“åº¦é€‰æ‹©'));

    // å…‰ç…§
    weights.push(ParameterWeight.create('å…‰ç…§æ¡ä»¶', 8, 'å½±å“é±¼çš„æ´»åŠ¨å±‚'));

    // é£åŠ›
    weights.push(ParameterWeight.create('é£åŠ›', 5, 'å½±å“æŠ›æŠ•å’Œé›¾åŒ–'));

    // å‘³å‹å¼ºåº¦
    weights.push(ParameterWeight.create('å‘³å‹åå¥½', 7, 'ç”¨æˆ·ä¸ªäººåå¥½'));

    return weights;
  }

  /**
   * ç”Ÿæˆé…æ–¹
   */
  private generateRecipe(): GeneratedRecipe {
    const recipe = new GeneratedRecipe();
    recipe.id = `precise_${Date.now()}`;
    recipe.name = this.generateRecipeName();
    recipe.totalWeight = 500;
    recipe.createTime = Date.now();

    // ç”ŸæˆåŸæ–™åˆ—è¡¨
    recipe.ingredients = this.selectIngredients();

    // ç”Ÿæˆå‘³å‹æè¿°
    recipe.flavorProfile = this.generateFlavorProfile();

    // ç”ŸæˆçŠ¶æ€ç‰¹æ€§
    recipe.stateProfile = this.generateStateProfile();

    // ç”Ÿæˆä½¿ç”¨å»ºè®®
    recipe.usage = this.generateUsageSuggestion();

    // ç”Ÿæˆæ¨èç†ç”±
    recipe.reasons = this.generateReasons();

    return recipe;
  }

  /**
   * ç”Ÿæˆé…æ–¹åç§°
   */
  private generateRecipeName(): string {
    const fishName = this.fishData?.name || 'é€šç”¨';
    const flavorMap: Record<string, string> = {
      'light': 'æ¸…é¦™',
      'medium': 'ç»å…¸',
      'strong': 'æµ“é¦™',
      'intense': 'ç‰¹æµ“'
    };
    const flavor = flavorMap[this.input.flavorIntensity] || 'ç»å…¸';

    // æ ¹æ®åˆ·æ–°æ¬¡æ•°æ·»åŠ å˜ä½“æ ‡è¯†
    const variants: string[] = ['', 'æ”¹è‰¯', 'å‡çº§', 'ç‰¹è°ƒ'];
    const variant = this.refreshCount > 0 ? variants[this.refreshCount % variants.length] : '';

    return variant ? `${flavor}${fishName}é…æ–¹(${variant})` : `${flavor}${fishName}é…æ–¹`;
  }

  /**
   * é€‰æ‹©åŸæ–™
   */
  private selectIngredients(): RecipeIngredient[] {
    const ingredients: RecipeIngredient[] = [];

    // åŸºç¡€é¥µ 40%
    const mainIngredient = new RecipeIngredient();
    mainIngredient.id = 'base_bait';
    mainIngredient.name = this.selectMainBait();
    mainIngredient.category = 'main';
    mainIngredient.percentage = 40;
    mainIngredient.weight = 200;
    mainIngredient.purpose = 'æä¾›åŸºç¡€å‘³å‹å’ŒçŠ¶æ€';
    ingredients.push(mainIngredient);

    // ä¸»æ”»é¥µ 25%
    const auxIngredient = new RecipeIngredient();
    auxIngredient.id = 'attack_bait';
    auxIngredient.name = this.selectAttackBait();
    auxIngredient.category = 'auxiliary';
    auxIngredient.percentage = 25;
    auxIngredient.weight = 125;
    auxIngredient.purpose = 'å¢å¼ºè¯±é±¼æ•ˆæœ';
    ingredients.push(auxIngredient);

    // çŠ¶æ€é¥µ 20%
    const stateIngredient = new RecipeIngredient();
    stateIngredient.id = 'state_bait';
    stateIngredient.name = this.selectStateBait();
    stateIngredient.category = 'state';
    stateIngredient.percentage = 20;
    stateIngredient.weight = 100;
    stateIngredient.purpose = 'è°ƒæ•´é¥µæ–™çŠ¶æ€';
    ingredients.push(stateIngredient);

    // æ·»åŠ å‰‚ 15%
    const additiveIngredient = new RecipeIngredient();
    additiveIngredient.id = 'additive';
    additiveIngredient.name = this.selectAdditive();
    additiveIngredient.category = 'additive';
    additiveIngredient.percentage = 15;
    additiveIngredient.weight = 75;
    additiveIngredient.purpose = 'æå‡å‘³å‹ç©¿é€åŠ›';
    ingredients.push(additiveIngredient);

    return ingredients;
  }

  /**
   * ä»å€™é€‰åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªæœªè¢«æ’é™¤çš„åŸæ–™
   */
  private selectFromCandidates(candidates: string[]): string {
    // è¿‡æ»¤æ‰è¢«æ’é™¤çš„åŸæ–™
    const available = candidates.filter((name: string) => !this.excludedIngredientNames.includes(name));
    if (available.length > 0) {
      return available[this.refreshCount % available.length];
    }
    // å¦‚æœå…¨éƒ¨è¢«æ’é™¤ï¼Œè¿”å›ç¬¬ä¸€ä¸ªå€™é€‰
    return candidates[this.refreshCount % candidates.length];
  }

  /**
   * é€‰æ‹©åŸºç¡€é¥µ - ç»¼åˆè€ƒè™‘å­£èŠ‚ã€æ¸©åº¦ã€æ°´è´¨ã€å…‰ç…§
   */
  private selectMainBait(): string {
    const season = this.input.season;
    const waterQuality = this.input.waterQuality;
    const lightCondition = this.input.lightCondition;

    // æ ¹æ®æ°´è´¨è°ƒæ•´åŸºç¡€é¥µé€‰æ‹©
    if (waterQuality === 'muddy' || waterQuality === 'fertile') {
      // æµ‘æ°´/è‚¥æ°´ï¼šéœ€è¦å‘³é“æ›´æµ“çš„åŸºç¡€é¥µ
      if (season === 'winter' || this.input.temperature < 15) {
        return this.selectFromCandidates(['æµ“è…¥åŸºç¡€é¥µ', 'çº¢è™«é£å‘³åŸºç¡€é¥µ', 'è™¾è…¥åŸºç¡€é¥µ']);
      } else {
        return this.selectFromCandidates(['æµ“é¦™åŸºç¡€é¥µ', 'å‘é…µç‰ç±³åŸºç¡€é¥µ', 'é…’é¦™åŸºç¡€é¥µ']);
      }
    }

    // å¤œé’“æˆ–æ™¨æ˜ï¼šå¢åŠ è…¥å‘³
    if (lightCondition === 'night' || lightCondition === 'dawn_dusk') {
      return this.selectFromCandidates(['è…¥é¦™åŸºç¡€é¥µ', 'è™¾è…¥åŸºç¡€é¥µ', 'èš•è›¹åŸºç¡€é¥µ']);
    }

    // æ­£å¸¸æƒ…å†µæ ¹æ®å­£èŠ‚æ¸©åº¦é€‰æ‹©
    if (season === 'winter' || this.input.temperature < 15) {
      return this.selectFromCandidates(['è…¥é¦™åŸºç¡€é¥µ', 'çº¢è™«é£å‘³åŸºç¡€é¥µ', 'è™¾è…¥åŸºç¡€é¥µ']);
    } else if (season === 'summer' || this.input.temperature > 28) {
      return this.selectFromCandidates(['æ¸…é¦™åŸºç¡€é¥µ', 'æœé¦™åŸºç¡€é¥µ', 'è–¯é¦™åŸºç¡€é¥µ']);
    }
    return this.selectFromCandidates(['è°·ç‰©åŸºç¡€é¥µ', 'éº¦é¦™åŸºç¡€é¥µ', 'ç‰ç±³åŸºç¡€é¥µ']);
  }

  /**
   * é€‰æ‹©ä¸»æ”»é¥µ - ç»¼åˆè€ƒè™‘é±¼ç§ä¹ æ€§ã€æ°´è´¨ã€ç›®æ ‡ä½“å‹
   */
  private selectAttackBait(): string {
    const fishHabit = this.fishData?.habit;
    const targetSize = this.input.targetFishSize;
    const waterQuality = this.input.waterQuality;

    // å¤§ä½“å‹é±¼ï¼šéœ€è¦æ›´æµ“çš„å‘³é“å’Œæ›´å¤§çš„é¢—ç²’æ„Ÿ
    if (targetSize === 'large') {
      if (fishHabit?.feedingType === 'carnivore' || this.preferFishy) {
        return this.selectFromCandidates(['æµ“è…¥å¤§ç‰©é¥µ', 'èºè›³ä¸»æ”»é¥µ', 'èšŒè‚‰ä¸»æ”»é¥µ']);
      }
      return this.selectFromCandidates(['å‘é…µç‰ç±³ä¸»æ”»é¥µ', 'è€å›ç‰ç±³ä¸»æ”»é¥µ', 'å¤§é¢—ç²’ä¸»æ”»é¥µ']);
    }

    // å°ä½“å‹é±¼ï¼šéœ€è¦æ›´ç»†è…»çš„é¥µæ–™
    if (targetSize === 'small') {
      return this.selectFromCandidates(['ç»†è…»ä¸»æ”»é¥µ', 'å¥¶é¦™ä¸»æ”»é¥µ', 'è›‹å¥¶ä¸»æ”»é¥µ']);
    }

    // è‚¥æ°´ç¯å¢ƒï¼šéœ€è¦æ›´æµ“çš„å‘³é“
    if (waterQuality === 'fertile') {
      return this.selectFromCandidates(['æµ“é¦™ä¸»æ”»é¥µ', 'å‘é…µä¸»æ”»é¥µ', 'é…¸è‡­ä¸»æ”»é¥µ']);
    }

    // æ ¹æ®é±¼ç§ä¹ æ€§é€‰æ‹©
    if (fishHabit?.feedingType === 'carnivore' || this.preferFishy) {
      return this.selectFromCandidates(['è™¾ç²‰ä¸»æ”»é¥µ', 'èš•è›¹ä¸»æ”»é¥µ', 'çº¢è™«ä¸»æ”»é¥µ', 'é±¼ç²‰ä¸»æ”»é¥µ']);
    } else if (fishHabit?.feedingType === 'herbivore') {
      return this.selectFromCandidates(['è—»é¦™ä¸»æ”»é¥µ', 'è‰é¦™ä¸»æ”»é¥µ', 'å«©ç‰ç±³ä¸»æ”»é¥µ']);
    }

    return this.selectFromCandidates(['ç»¼åˆä¸»æ”»é¥µ', 'è…¥é¦™ä¸»æ”»é¥µ', 'å¥¶é¦™ä¸»æ”»é¥µ', 'æœé¦™ä¸»æ”»é¥µ']);
  }

  /**
   * é€‰æ‹©çŠ¶æ€é¥µ - ç»¼åˆè€ƒè™‘é¥µæ–™çŠ¶æ€ã€æ°´æ·±ã€é£åŠ›
   */
  private selectStateBait(): string {
    const waterDepth = this.input.waterDepth;
    const windCondition = this.input.windCondition;

    // æ·±æ°´ï¼šéœ€è¦å¢åŠ æ¯”é‡ï¼Œå‡å°‘é›¾åŒ–
    if (waterDepth === 'deep') {
      if (this.input.baitState === 'fast_dissolve') {
        return this.selectFromCandidates(['æ¯”é‡ç²‰', 'é¢—ç²’ç²‰', 'æ²‰åº•ç²‰']);
      }
      return this.selectFromCandidates(['ç²˜ç²‰+æ¯”é‡ç²‰', 'ç³¯ç±³ç²‰', 'é‡è´¨ç²˜ç²‰']);
    }

    // æµ…æ°´ï¼šéœ€è¦æ›´å¥½çš„é›¾åŒ–
    if (waterDepth === 'shallow') {
      return this.selectFromCandidates(['é›ªèŠ±ç²‰', 'è½»éº¸', 'è†¨åŒ–ç‰ç±³ç²‰']);
    }

    // å¤§é£å¤©æ°”ï¼šéœ€è¦æ›´ç²˜çš„é¥µæ–™
    if (windCondition === 'strong' || windCondition === 'medium') {
      return this.selectFromCandidates(['æ‹‰ä¸ç²‰', 'ç²˜ç²‰', 'å°éº¦è›‹ç™½']);
    }

    // æ ¹æ®é¥µæ–™çŠ¶æ€é€‰æ‹©
    const stateOptions: Record<string, string[]> = {
      'fast_dissolve': ['é›ªèŠ±ç²‰', 'è½»éº¸', 'è†¨åŒ–ç‰ç±³ç²‰'],
      'slow_dissolve': ['ç²˜ç²‰', 'ç³¯ç±³ç²‰', 'é¢ç²‰'],
      'sticky': ['æ‹‰ä¸ç²‰', 'å°éº¦è›‹ç™½', 'ç²˜ç²‰'],
      'dry_loose': ['è½»éº¸', 'é›ªèŠ±ç²‰', 'è†¨åŒ–é¥µ']
    };

    const options = stateOptions[this.input.baitState] || stateOptions['fast_dissolve'];
    return this.selectFromCandidates(options);
  }

  /**
   * é€‰æ‹©æ·»åŠ å‰‚ - ç»¼åˆè€ƒè™‘å‘³å‹å¼ºåº¦ã€æ°´è´¨ã€å…‰ç…§
   */
  private selectAdditive(): string {
    const waterQuality = this.input.waterQuality;
    const lightCondition = this.input.lightCondition;

    // æµ‘æ°´/è‚¥æ°´ï¼šéœ€è¦ç©¿é€åŠ›æ›´å¼ºçš„æ·»åŠ å‰‚
    if (waterQuality === 'muddy' || waterQuality === 'fertile') {
      return this.selectFromCandidates(['ç©¿é€å‹è¯±é£Ÿå‰‚', 'æµ“é¦™æ·»åŠ å‰‚', 'ç‰¹æ•ˆè¯±é±¼å‰‚']);
    }

    // å¤œé’“ï¼šå¢åŠ è…¥å‘³æ·»åŠ å‰‚
    if (lightCondition === 'night') {
      return this.selectFromCandidates(['æµ“è…¥æ·»åŠ å‰‚', 'è™¾è†', 'èš•è›¹æ¶²']);
    }

    // æ ¹æ®å‘³å‹å¼ºåº¦é€‰æ‹©
    const additiveOptions: Record<string, string[]> = {
      'light': ['æœé…¸æ·»åŠ å‰‚', 'æ¸…é¦™è¯±é£Ÿå‰‚', 'æ·¡å‘³å¢æ•ˆå‰‚'],
      'medium': ['ç”œé¦™æ·»åŠ å‰‚', 'å¥¶é¦™è¯±é£Ÿå‰‚', 'ç»¼åˆå¢æ•ˆå‰‚'],
      'strong': ['æµ“è…¥æ·»åŠ å‰‚', 'è™¾è†', 'èš•è›¹æ¶²'],
      'intense': ['ç‰¹æµ“è¯±é±¼å‰‚', 'è¶…è…¥æ·»åŠ å‰‚', 'æ°¨åŸºé…¸è¯±é£Ÿå‰‚']
    };

    const options = additiveOptions[this.input.flavorIntensity] || additiveOptions['medium'];
    return this.selectFromCandidates(options);
  }

  /**
   * ç”Ÿæˆå‘³å‹æè¿° - ç»¼åˆè€ƒè™‘é±¼ç§ã€æ°´è´¨ã€å…‰ç…§ã€ç›®æ ‡ä½“å‹
   */
  private generateFlavorProfile(): FlavorDescription {
    const profile = new FlavorDescription();
    const fishHabit = this.fishData?.habit;
    const waterQuality = this.input.waterQuality;
    const lightCondition = this.input.lightCondition;
    const targetSize = this.input.targetFishSize;

    // æ ¹æ®æ°´è´¨è°ƒæ•´å‘³å‹
    if (waterQuality === 'muddy' || waterQuality === 'fertile') {
      profile.primary = 'æµ“é¦™';
      profile.secondary = 'å‘é…µé¦™';
    } else if (lightCondition === 'night' || lightCondition === 'dawn_dusk') {
      // å¤œé’“å¢åŠ è…¥å‘³
      profile.primary = 'è…¥é¦™';
      profile.secondary = 'é²œç”œ';
    } else if (fishHabit?.feedingType === 'carnivore') {
      profile.primary = 'è…¥é¦™';
      profile.secondary = 'é²œç”œ';
    } else if (fishHabit?.feedingType === 'herbivore') {
      profile.primary = 'æ¸…é¦™';
      profile.secondary = 'è°·ç‰©é¦™';
    } else {
      profile.primary = 'è…¥é¦™';
      profile.secondary = 'å¥¶é¦™';
    }

    // æ ¹æ®ç›®æ ‡ä½“å‹è°ƒæ•´æµ“åº¦
    const intensityMap: Record<string, number> = {
      'light': 3,
      'medium': 5,
      'strong': 7,
      'intense': 9
    };
    let intensity = intensityMap[this.input.flavorIntensity] || 5;

    // å¤§é±¼éœ€è¦æ›´æµ“çš„å‘³é“
    if (targetSize === 'large') {
      intensity = Math.min(intensity + 2, 10);
    } else if (targetSize === 'small') {
      intensity = Math.max(intensity - 1, 1);
    }

    profile.intensity = intensity;
    profile.suitableTemp = `${this.input.temperature - 5}Â°C - ${this.input.temperature + 5}Â°C`;

    return profile;
  }

  /**
   * ç”ŸæˆçŠ¶æ€ç‰¹æ€§ - ç»¼åˆè€ƒè™‘é¥µæ–™çŠ¶æ€ã€æ°´æ·±ã€é£åŠ›ã€æ°´è´¨
   */
  private generateStateProfile(): StateProfile {
    const profile = new StateProfile();
    const waterDepth = this.input.waterDepth;
    const windCondition = this.input.windCondition;
    const waterQuality = this.input.waterQuality;

    // åŸºç¡€çŠ¶æ€æ ¹æ®é¥µæ–™çŠ¶æ€è®¾ç½®
    switch (this.input.baitState) {
      case 'fast_dissolve':
        profile.atomization = 8;
        profile.viscosity = 3;
        profile.hookHolding = 4;
        profile.weight = 4;
        break;
      case 'slow_dissolve':
        profile.atomization = 4;
        profile.viscosity = 6;
        profile.hookHolding = 7;
        profile.weight = 5;
        break;
      case 'sticky':
        profile.atomization = 3;
        profile.viscosity = 8;
        profile.hookHolding = 9;
        profile.weight = 6;
        break;
      case 'dry_loose':
        profile.atomization = 9;
        profile.viscosity = 2;
        profile.hookHolding = 3;
        profile.weight = 3;
        break;
    }

    // æ ¹æ®æ°´æ·±è°ƒæ•´æ¯”é‡å’Œé›¾åŒ–
    if (waterDepth === 'deep') {
      profile.weight = Math.min(profile.weight + 3, 10);
      profile.atomization = Math.max(profile.atomization - 2, 1);
    } else if (waterDepth === 'shallow') {
      profile.weight = Math.max(profile.weight - 2, 1);
      profile.atomization = Math.min(profile.atomization + 1, 10);
    }

    // æ ¹æ®é£åŠ›è°ƒæ•´ç²˜æ€§å’Œé™„é’©æ€§
    if (windCondition === 'strong') {
      profile.viscosity = Math.min(profile.viscosity + 2, 10);
      profile.hookHolding = Math.min(profile.hookHolding + 2, 10);
    } else if (windCondition === 'medium') {
      profile.viscosity = Math.min(profile.viscosity + 1, 10);
      profile.hookHolding = Math.min(profile.hookHolding + 1, 10);
    }

    // æ ¹æ®æ°´è´¨è°ƒæ•´é›¾åŒ–
    if (waterQuality === 'muddy') {
      // æµ‘æ°´å‡å°‘é›¾åŒ–ï¼Œå¢åŠ å‘³é“ç©¿é€
      profile.atomization = Math.max(profile.atomization - 1, 1);
    } else if (waterQuality === 'clear') {
      // æ¸…æ°´å¯ä»¥å¢åŠ é›¾åŒ–
      profile.atomization = Math.min(profile.atomization + 1, 10);
    }

    return profile;
  }

  /**
   * ç”Ÿæˆä½¿ç”¨å»ºè®® - ç»¼åˆè€ƒè™‘é¥µæ–™çŠ¶æ€ã€æ°´æ·±ã€é£åŠ›ã€å…‰ç…§ã€ç›®æ ‡ä½“å‹
   */
  private generateUsageSuggestion(): UsageSuggestion {
    const suggestion = new UsageSuggestion();
    const waterDepth = this.input.waterDepth;
    const windCondition = this.input.windCondition;
    const lightCondition = this.input.lightCondition;
    const targetSize = this.input.targetFishSize;

    // æ ¹æ®é¥µæ–™çŠ¶æ€å’Œæ°´æ·±è°ƒæ•´æ°´æ¯”
    let waterRatioBase = 1.0;
    switch (this.input.baitState) {
      case 'fast_dissolve':
        waterRatioBase = 0.9;
        suggestion.restTime = '3-5åˆ†é’Ÿ';
        break;
      case 'slow_dissolve':
        waterRatioBase = 1.1;
        suggestion.restTime = '8-10åˆ†é’Ÿ';
        break;
      case 'sticky':
        waterRatioBase = 1.2;
        suggestion.restTime = '10-15åˆ†é’Ÿ';
        break;
      case 'dry_loose':
        waterRatioBase = 0.8;
        suggestion.restTime = '2-3åˆ†é’Ÿ';
        break;
    }

    // æ·±æ°´éœ€è¦æ›´å¹²çš„é¥µæ–™
    if (waterDepth === 'deep') {
      waterRatioBase -= 0.1;
    } else if (waterDepth === 'shallow') {
      waterRatioBase += 0.05;
    }

    suggestion.waterRatio = `1:${waterRatioBase.toFixed(1)}`;

    // æ ¹æ®å…‰ç…§å’Œç›®æ ‡ä½“å‹ç”Ÿæˆé¦–ç«¿å»ºè®®
    if (lightCondition === 'night') {
      suggestion.firstCast = 'å¤œé’“å»ºè®®å…ˆæ‰“é‡çªï¼Œä½¿ç”¨è§å…‰æ¼‚ï¼Œç­‰å¾…15-20åˆ†é’Ÿåå¼€å§‹ä½œé’“';
    } else if (lightCondition === 'dawn_dusk') {
      suggestion.firstCast = 'æ™¨æ˜æ—¶æ®µé±¼å£æ´»è·ƒï¼Œå…ˆæ‰“3-5ç«¿çªæ–™ï¼Œç­‰å¾…5-10åˆ†é’Ÿå³å¯å¼€é’“';
    } else if (targetSize === 'large') {
      suggestion.firstCast = 'é’“å¤§é±¼éœ€è¦è€å¿ƒï¼Œå…ˆæ‰“é‡çª5-8ç«¿ï¼Œç­‰å¾…20-30åˆ†é’Ÿè®©é±¼è¿›çª';
    } else if (targetSize === 'small') {
      suggestion.firstCast = 'é’“å°é±¼å¯ä»¥è¾¹é’“è¾¹è¯±ï¼Œå…ˆæ‰“2-3ç«¿çªæ–™ï¼Œ5åˆ†é’Ÿåå³å¯å¼€é’“';
    } else {
      suggestion.firstCast = 'å…ˆæ‰“3-5ç«¿çªæ–™ï¼Œç­‰å¾…10åˆ†é’Ÿåå¼€å§‹ä½œé’“';
    }

    // æ ¹æ®æ°´æ·±å’Œé£åŠ›ç”Ÿæˆè¡¥çªå»ºè®®
    if (waterDepth === 'deep') {
      if (windCondition === 'strong') {
        suggestion.nestSuggestion = 'æ·±æ°´å¤§é£å¤©æ°”ï¼Œå»ºè®®ä½¿ç”¨æ‰“çªå™¨ç²¾å‡†è¡¥çªï¼Œæ¯æ¬¡è¡¥çªé‡åŠ å¤§50%';
      } else {
        suggestion.nestSuggestion = 'æ·±æ°´å»ºè®®é‡çªï¼Œæ¯30åˆ†é’Ÿè¡¥çªä¸€æ¬¡ï¼Œæ¯æ¬¡è¡¥çªé‡åŠ å¤§';
      }
    } else if (windCondition === 'strong' || windCondition === 'medium') {
      suggestion.nestSuggestion = 'æœ‰é£å¤©æ°”é¥µæ–™æ˜“æ•£ï¼Œå»ºè®®å¢åŠ è¡¥çªé¢‘ç‡ï¼Œæ¯20åˆ†é’Ÿè¡¥çªä¸€æ¬¡';
    } else {
      suggestion.nestSuggestion = 'æ­£å¸¸è¡¥çªå³å¯ï¼Œæ ¹æ®é±¼å£æƒ…å†µæ¯20-30åˆ†é’Ÿè¡¥çªä¸€æ¬¡';
    }

    return suggestion;
  }

  /**
   * ç”Ÿæˆæ¨èç†ç”± - å±•ç¤ºæ‰€æœ‰å‚æ•°çš„å½±å“
   */
  private generateReasons(): GenerateReason[] {
    const reasons: GenerateReason[] = [];
    const fishName = this.fishData?.name || 'ç›®æ ‡é±¼';

    // é±¼ç§ç†ç”±
    const fishReason = new GenerateReason();
    fishReason.condition = `ç›®æ ‡é±¼ç§: ${fishName}`;
    fishReason.decision = `é€‰æ‹©${this.fishData?.habit.feedingType === 'carnivore' ? 'è…¥å‘³' : 'é¦™å‘³'}ä¸ºä¸»çš„é…æ–¹`;
    fishReason.icon = 'ğŸŸ';
    reasons.push(fishReason);

    // æ¸©åº¦ç†ç”±
    const tempReason = new GenerateReason();
    tempReason.condition = `å½“å‰æ¸©åº¦: ${this.input.temperature}Â°C`;
    tempReason.decision = this.input.temperature < 15 ? 'ä½æ¸©å¢åŠ è…¥å‘³æ¯”ä¾‹' :
      (this.input.temperature > 28 ? 'é«˜æ¸©å‡å°‘è…¥å‘³ï¼Œå¢åŠ æ¸…é¦™' : 'æ¸©åº¦é€‚ä¸­ï¼Œå‡è¡¡é…æ¯”');
    tempReason.icon = 'ğŸŒ¡';
    reasons.push(tempReason);

    // æ°´æ·±ç†ç”±
    const depthReason = new GenerateReason();
    const depthNames: Record<string, string> = { 'shallow': 'æµ…æ°´(<1m)', 'medium': 'ä¸­å±‚(1-3m)', 'deep': 'æ·±æ°´(>3m)' };
    depthReason.condition = `æ°´æ·±: ${depthNames[this.input.waterDepth] || 'ä¸­å±‚'}`;
    depthReason.decision = this.input.waterDepth === 'deep' ? 'å¢åŠ é¥µæ–™æ¯”é‡ï¼Œå‡ç¼“é›¾åŒ–é€Ÿåº¦' :
      (this.input.waterDepth === 'shallow' ? 'å‡è½»æ¯”é‡ï¼Œå¢åŠ é›¾åŒ–è¯±é±¼' : 'æ­£å¸¸æ¯”é‡å’Œé›¾åŒ–');
    depthReason.icon = 'ğŸ’§';
    reasons.push(depthReason);

    // æ°´è´¨ç†ç”±
    const qualityReason = new GenerateReason();
    const qualityNames: Record<string, string> = { 'clear': 'æ¸…æ¾ˆ', 'slight_muddy': 'å¾®æµ‘', 'muddy': 'æµ‘æµŠ', 'fertile': 'è‚¥æ°´' };
    qualityReason.condition = `æ°´è´¨: ${qualityNames[this.input.waterQuality] || 'æ¸…æ¾ˆ'}`;
    qualityReason.decision = (this.input.waterQuality === 'muddy' || this.input.waterQuality === 'fertile') ?
      'å¢åŠ å‘³é“æµ“åº¦ï¼Œæå‡ç©¿é€åŠ›' : 'æ­£å¸¸å‘³é“æµ“åº¦';
    qualityReason.icon = 'ğŸŒŠ';
    reasons.push(qualityReason);

    // å…‰ç…§ç†ç”±
    const lightReason = new GenerateReason();
    const lightNames: Record<string, string> = { 'bright': 'å¼ºå…‰', 'cloudy': 'é˜´å¤©', 'dawn_dusk': 'æ™¨æ˜', 'night': 'å¤œé’“' };
    lightReason.condition = `å…‰ç…§: ${lightNames[this.input.lightCondition] || 'å¼ºå…‰'}`;
    lightReason.decision = (this.input.lightCondition === 'night' || this.input.lightCondition === 'dawn_dusk') ?
      'å¢åŠ è…¥å‘³æ¯”ä¾‹ï¼Œæå‡è¯±é±¼æ•ˆæœ' : 'æ­£å¸¸å‘³å‹é…æ¯”';
    lightReason.icon = 'â˜€ï¸';
    reasons.push(lightReason);

    // é£åŠ›ç†ç”±
    if (this.input.windCondition !== 'none') {
      const windReason = new GenerateReason();
      const windNames: Record<string, string> = { 'none': 'æ— é£', 'light': 'å¾®é£', 'medium': 'ä¸­é£', 'strong': 'å¤§é£' };
      windReason.condition = `é£åŠ›: ${windNames[this.input.windCondition] || 'æ— é£'}`;
      windReason.decision = (this.input.windCondition === 'strong' || this.input.windCondition === 'medium') ?
        'å¢åŠ é¥µæ–™ç²˜æ€§ï¼Œæé«˜é™„é’©æ€§' : 'æ­£å¸¸çŠ¶æ€';
      windReason.icon = 'ğŸ’¨';
      reasons.push(windReason);
    }

    // ç›®æ ‡ä½“å‹ç†ç”±
    const sizeReason = new GenerateReason();
    const sizeNames: Record<string, string> = { 'small': 'å°å‹(<1æ–¤)', 'medium': 'ä¸­å‹(1-5æ–¤)', 'large': 'å¤§å‹(>5æ–¤)' };
    sizeReason.condition = `ç›®æ ‡ä½“å‹: ${sizeNames[this.input.targetFishSize] || 'ä¸­å‹'}`;
    sizeReason.decision = this.input.targetFishSize === 'large' ? 'å¢åŠ å‘³é“æµ“åº¦ï¼Œä½¿ç”¨å¤§é¢—ç²’åŸæ–™' :
      (this.input.targetFishSize === 'small' ? 'å‡è½»å‘³é“ï¼Œä½¿ç”¨ç»†è…»åŸæ–™' : 'å‡è¡¡é…æ¯”');
    sizeReason.icon = 'ğŸ“';
    reasons.push(sizeReason);

    return reasons;
  }

  /**
   * è®¡ç®—ç»´åº¦è¯„åˆ† - ç»¼åˆè€ƒè™‘æ‰€æœ‰å‚æ•°
   */
  private calculateDimensionScores(): DimensionScores {
    const scores = new DimensionScores();

    // è¯±é±¼æ€§ï¼šæ ¹æ®å‘³å‹å¼ºåº¦ã€æ°´è´¨ã€å…‰ç…§
    scores.attraction = this.calculateAttractionScore();

    // é€‚å£æ€§ï¼šæ ¹æ®é±¼ç§ä¹ æ€§ã€æ¸©åº¦ã€ç›®æ ‡ä½“å‹
    scores.palatability = this.calculatePalatabilityScore();

    // çŠ¶æ€ï¼šæ ¹æ®é¥µæ–™çŠ¶æ€ã€æ°´æ·±ã€é£åŠ›åŒ¹é…
    scores.state = this.calculateStateScore();

    // ç•™é±¼æ€§ï¼šæ ¹æ®é…æ–¹æŒä¹…æ€§ã€æ°´æ·±
    scores.retention = this.calculateRetentionScore();

    // æ€§ä»·æ¯”ï¼šæ ¹æ®åŸæ–™é€‰æ‹©
    scores.costEffective = this.calculateCostScore();

    return scores;
  }

  private calculateAttractionScore(): number {
    let score = 65;

    // å‘³å‹å¼ºåº¦åŠ åˆ†
    const intensityBonus: Record<string, number> = { 'light': 5, 'medium': 10, 'strong': 15, 'intense': 18 };
    score += intensityBonus[this.input.flavorIntensity] || 10;

    // é±¼ç§åŒ¹é…åŠ åˆ†
    if (this.fishData) {
      score += 8;
    }

    // æ°´è´¨å½±å“ï¼šæµ‘æ°´/è‚¥æ°´éœ€è¦æ›´æµ“çš„å‘³é“æ‰èƒ½æœ‰æ•ˆè¯±é±¼
    if (this.input.waterQuality === 'muddy' || this.input.waterQuality === 'fertile') {
      if (this.input.flavorIntensity === 'strong' || this.input.flavorIntensity === 'intense') {
        score += 8; // å‘³é“æµ“åº¦åŒ¹é…
      } else {
        score -= 5; // å‘³é“ä¸å¤Ÿæµ“
      }
    }

    // å…‰ç…§å½±å“ï¼šå¤œé’“/æ™¨æ˜è…¥å‘³æ›´æœ‰æ•ˆ
    if (this.input.lightCondition === 'night' || this.input.lightCondition === 'dawn_dusk') {
      score += 5;
    }

    return Math.min(Math.max(score, 0), 100);
  }

  private calculatePalatabilityScore(): number {
    let score = 70;

    // æ ¹æ®é±¼ç§é£Ÿæ€§è°ƒæ•´
    const feedingType = this.fishData?.habit.feedingType;
    if (feedingType === 'omnivore') {
      score += 10; // æ‚é£Ÿæ€§é±¼æ›´å®¹æ˜“æ¥å—
    }

    // æ¸©åº¦é€‚å®œåŠ åˆ†
    if (this.input.temperature >= 15 && this.input.temperature <= 28) {
      score += 8;
    } else if (this.input.temperature < 10 || this.input.temperature > 32) {
      score -= 5; // æç«¯æ¸©åº¦é™ä½é€‚å£æ€§
    }

    // ç›®æ ‡ä½“å‹åŒ¹é…
    if (this.input.targetFishSize === 'large' && this.input.flavorIntensity !== 'light') {
      score += 5; // å¤§é±¼å–œæ¬¢æµ“å‘³
    } else if (this.input.targetFishSize === 'small' && this.input.flavorIntensity !== 'intense') {
      score += 5; // å°é±¼ä¸å–œæ¬¢å¤ªæµ“
    }

    return Math.min(Math.max(score, 0), 100);
  }

  private calculateStateScore(): number {
    let score = 65;

    // é¥µæ–™çŠ¶æ€ä¸æ°´æ·±åŒ¹é…
    if (this.input.waterDepth === 'deep') {
      if (this.input.baitState === 'slow_dissolve' || this.input.baitState === 'sticky') {
        score += 18; // æ·±æ°´é€‚åˆæ…¢æº¶/ç²˜æ€§é¥µæ–™
      } else if (this.input.baitState === 'fast_dissolve') {
        score += 5; // å¿«æº¶åœ¨æ·±æ°´æ•ˆæœä¸€èˆ¬
      }
    } else if (this.input.waterDepth === 'shallow') {
      if (this.input.baitState === 'fast_dissolve' || this.input.baitState === 'dry_loose') {
        score += 18; // æµ…æ°´é€‚åˆå¿«æº¶/å¹²æ•£é¥µæ–™
      } else {
        score += 8;
      }
    } else {
      score += 12; // ä¸­å±‚æ°´æ·±å„ç§çŠ¶æ€éƒ½å¯ä»¥
    }

    // é£åŠ›å½±å“
    if (this.input.windCondition === 'strong') {
      if (this.input.baitState === 'sticky') {
        score += 8; // å¤§é£å¤©ç²˜æ€§é¥µæ–™æ›´å¥½
      } else if (this.input.baitState === 'dry_loose') {
        score -= 5; // å¹²æ•£é¥µæ–™åœ¨å¤§é£å¤©ä¸å¥½ç”¨
      }
    }

    // æ°´è´¨å½±å“
    if (this.input.waterQuality === 'clear' && this.input.baitState === 'fast_dissolve') {
      score += 5; // æ¸…æ°´å¿«æº¶é›¾åŒ–æ•ˆæœå¥½
    }

    return Math.min(Math.max(score, 0), 100);
  }

  private calculateRetentionScore(): number {
    let score = 68;

    // ç²˜æ€§é¥µæ–™ç•™é±¼æ€§æ›´å¥½
    if (this.input.baitState === 'sticky') {
      score += 15;
    } else if (this.input.baitState === 'slow_dissolve') {
      score += 12;
    } else if (this.input.baitState === 'fast_dissolve') {
      score += 5;
    }

    // å‘³å‹å¼ºåº¦å½±å“
    if (this.input.flavorIntensity === 'medium' || this.input.flavorIntensity === 'strong') {
      score += 8;
    }

    // æ·±æ°´ç•™é±¼æ€§æ›´å¥½
    if (this.input.waterDepth === 'deep') {
      score += 5;
    }

    return Math.min(Math.max(score, 0), 100);
  }

  private calculateCostScore(): number {
    let score = 80;

    // å‘³å‹å¼ºåº¦è¶Šé«˜ï¼Œæˆæœ¬è¶Šé«˜
    const costPenalty: Record<string, number> = { 'light': 0, 'medium': -3, 'strong': -8, 'intense': -15 };
    score += costPenalty[this.input.flavorIntensity] || 0;

    // ç›®æ ‡å¤§é±¼æˆæœ¬æ›´é«˜
    if (this.input.targetFishSize === 'large') {
      score -= 5;
    }

    return Math.min(Math.max(score, 0), 100);
  }

  /**
   * ç”ŸæˆåŸæ–™é…æ¯”æ•°æ®ï¼ˆç”¨äºé¥¼å›¾ï¼‰
   */
  private generateIngredientRatios(recipe: GeneratedRecipe): IngredientRatio[] {
    return recipe.ingredients.map((ing: RecipeIngredient): IngredientRatio => {
      return IngredientRatio.create(
        ing.name,
        CATEGORY_NAMES[ing.category] || ing.category,
        ing.percentage,
        CATEGORY_COLORS[ing.category] || '#999'
      );
    });
  }

  /**
   * ç”Ÿæˆå¤‡é€‰æ–¹æ¡ˆ
   */
  private generateAlternatives(): GeneratedRecipe[] {
    const alternatives: GeneratedRecipe[] = [];

    // ç”Ÿæˆ2ä¸ªå¤‡é€‰æ–¹æ¡ˆ
    // æ–¹æ¡ˆ1ï¼šæ›´è…¥çš„ç‰ˆæœ¬
    const alt1Input = this.copyInput(this.input);
    alt1Input.flavorIntensity = 'strong';
    const alt1 = this.generateAlternativeRecipe(alt1Input, 'æµ“è…¥ç‰ˆ');
    alternatives.push(alt1);

    // æ–¹æ¡ˆ2ï¼šæ›´æ¸…æ·¡çš„ç‰ˆæœ¬
    const alt2Input = this.copyInput(this.input);
    alt2Input.flavorIntensity = 'light';
    const alt2 = this.generateAlternativeRecipe(alt2Input, 'æ¸…é¦™ç‰ˆ');
    alternatives.push(alt2);

    return alternatives;
  }

  /**
   * å¤åˆ¶è¾“å…¥å‚æ•°
   */
  private copyInput(source: PreciseMatchInput): PreciseMatchInput {
    const target = new PreciseMatchInput();
    target.targetFish = source.targetFish;
    target.waterType = source.waterType;
    target.season = source.season;
    target.temperature = source.temperature;
    target.waterDepth = source.waterDepth;
    target.waterQuality = source.waterQuality;
    target.lightCondition = source.lightCondition;
    target.windCondition = source.windCondition;
    target.baitState = source.baitState;
    target.flavorIntensity = source.flavorIntensity;
    target.targetFishSize = source.targetFishSize;
    return target;
  }

  private generateAlternativeRecipe(input: PreciseMatchInput, suffix: string): GeneratedRecipe {
    const originalInput = this.input;
    this.input = input;

    const recipe = new GeneratedRecipe();
    recipe.id = `alt_${Date.now()}_${Math.floor(Math.random() * 1000000)}`;
    recipe.name = `${this.fishData?.name || 'é€šç”¨'}é…æ–¹(${suffix})`;
    recipe.totalWeight = 500;
    recipe.createTime = Date.now();
    recipe.ingredients = this.selectIngredients();
    recipe.flavorProfile = this.generateFlavorProfile();
    recipe.stateProfile = this.generateStateProfile();
    recipe.usage = this.generateUsageSuggestion();

    this.input = originalInput;
    return recipe;
  }

  /**
   * ç»Ÿè®¡æ¿€æ´»çš„å‚æ•°æ•°é‡
   */
  private countActiveParams(): number {
    return 11; // åŸºç¡€4ä¸ª + é«˜çº§7ä¸ª
  }

  /**
   * è·å–åŒ¹é…çš„åŸæ–™æ•°é‡
   */
  private getMatchedIngredientsCount(): number {
    return 15 + Math.floor(Math.random() * 10);
  }
}

// å¯¼å‡ºå•ä¾‹
export const preciseMatchEngine = new PreciseMatchEngine();
