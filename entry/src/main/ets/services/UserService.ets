/**
 * é¥µçŸ¥é?- ç”¨æˆ·æœåŠ¡
 * ç®¡ç†ç”¨æˆ·ä¿¡æ¯ã€ç­‰çº§è®¡ç®?
 */
import { UserProfile, UserLevel, LevelConfig, LEVEL_CONFIGS, FishingRecord } from '../common/types/UserTypes';
import { storageService } from './StorageService';
import { AppConstants } from '../common/constants/AppConstants';

class UserServiceClass {
  private _profile: UserProfile = new UserProfile();
  private _isLoaded: boolean = false;

  get profile(): UserProfile {
    return this._profile;
  }

  get isLoaded(): boolean {
    return this._isLoaded;
  }

  /**
   * åˆå§‹åŒ–åŠ è½½ç”¨æˆ·æ•°æ?
   */
  async load(): Promise<UserProfile> {
    if (this._isLoaded) {
      return this._profile;
    }

    const saved = await storageService.load<UserProfile>(
      AppConstants.STORAGE_USER_PROFILE,
      new UserProfile()
    );

    if (saved && saved.id) {
      this._profile = saved;
    } else {
      this._profile = new UserProfile();
      await this.save();
    }

    this._isLoaded = true;
    return this._profile;
  }

  /**
   * ä¿å­˜ç”¨æˆ·æ•°æ®
   */
  async save(): Promise<void> {
    this._profile.updateTime = Date.now();
    await storageService.save(AppConstants.STORAGE_USER_PROFILE, this._profile);
  }

  /**
   * æ›´æ–°æ˜µç§°
   */
  async updateNickname(nickname: string): Promise<void> {
    this._profile.nickname = nickname;
    await this.save();
  }

  /**
   * è®¡ç®—ç»éªŒå€?
   * ç»éªŒ = æ¸”è·é‡é‡Ã—10 + å‡ºé’“æ¬¡æ•°Ã—20 + é’“è·å°¾æ•°Ã—5 + æ´»è·ƒå¤©æ•°Ã—5
   */
  calculateExperience(): number {
    const exp = Math.round(
      this._profile.totalCatch * 10 +
      this._profile.totalTrips * 20 +
      this._profile.totalFish * 5 +
      this._profile.activeDays * 5
    );
    return exp;
  }

  /**
   * æ ¹æ®ç»éªŒå€¼è·å–ç­‰çº§é…ç½?
   */
  getLevelConfig(exp: number): LevelConfig {
    for (let i = LEVEL_CONFIGS.length - 1; i >= 0; i--) {
      if (exp >= LEVEL_CONFIGS[i].minExp) {
        return LEVEL_CONFIGS[i];
      }
    }
    return LEVEL_CONFIGS[0];
  }

  /**
   * è·å–å½“å‰ç­‰çº§è¿›åº¦ (0-100)
   */
  getLevelProgress(): number {
    const exp = this._profile.experience;
    const config = this.getLevelConfig(exp);

    if (config.level === UserLevel.MASTER) {
      return 100;
    }

    const currentLevelExp = exp - config.minExp;
    const levelRange = config.maxExp - config.minExp;

    return Math.min(100, Math.round((currentLevelExp / levelRange) * 100));
  }

  /**
   * æ›´æ–°ç­‰çº§ä¿¡æ¯
   */
  async updateLevel(): Promise<void> {
    this._profile.experience = this.calculateExperience();
    const config = this.getLevelConfig(this._profile.experience);
    this._profile.level = config.level;
    this._profile.levelTitle = config.title;
    await this.save();
  }

  /**
   * æ·»åŠ æ¸”è·è®°å½•åæ›´æ–°ç»Ÿè®?
   */
  async onRecordAdded(record: FishingRecord): Promise<void> {
    this._profile.totalCatch += record.weight;
    this._profile.totalFish += record.count;
    this._profile.totalTrips += 1;

    if (record.maxSingle > this._profile.bestRecord) {
      this._profile.bestRecord = record.maxSingle;
    }

    // æ›´æ–°æ´»è·ƒå¤©æ•°ï¼ˆç®€åŒ–ï¼šæ¯æ¬¡è®°å½•+1ï¼Œå®é™…åº”è¯¥æŒ‰æ—¥æœŸå»é‡ï¼?
    this._profile.activeDays += 1;

    if (record.recipeId) {
      this._profile.recipeUseCount += 1;
    }

    await this.updateLevel();
  }

  /**
   * åˆ é™¤æ¸”è·è®°å½•åæ›´æ–°ç»Ÿè®?
   */
  async onRecordDeleted(record: FishingRecord): Promise<void> {
    this._profile.totalCatch = Math.max(0, this._profile.totalCatch - record.weight);
    this._profile.totalFish = Math.max(0, this._profile.totalFish - record.count);
    this._profile.totalTrips = Math.max(0, this._profile.totalTrips - 1);

    if (record.recipeId) {
      this._profile.recipeUseCount = Math.max(0, this._profile.recipeUseCount - 1);
    }

    await this.updateLevel();
  }

  /**
   * æ›´æ–°æ”¶è—æ•°é‡
   */
  async updateFavoriteCount(count: number): Promise<void> {
    this._profile.favoriteCount = count;
    await this.save();
  }

  /**
   * ä»è®°å½•åˆ—è¡¨é‡æ–°è®¡ç®—ç»Ÿè®¡æ•°æ?
   */
  async recalculateFromRecords(records: FishingRecord[]): Promise<void> {
    this._profile.totalCatch = 0;
    this._profile.totalFish = 0;
    this._profile.totalTrips = records.length;
    this._profile.bestRecord = 0;
    this._profile.recipeUseCount = 0;

    const activeDates = new Set<string>();

    for (const record of records) {
      this._profile.totalCatch += record.weight;
      this._profile.totalFish += record.count;

      if (record.maxSingle > this._profile.bestRecord) {
        this._profile.bestRecord = record.maxSingle;
      }

      if (record.recipeId) {
        this._profile.recipeUseCount += 1;
      }

      // æŒ‰æ—¥æœŸç»Ÿè®¡æ´»è·ƒå¤©æ•?
      const dateKey = new Date(record.date).toDateString();
      activeDates.add(dateKey);
    }

    this._profile.activeDays = activeDates.size;
    await this.updateLevel();
  }

  /**
   * é‡ç½®ç”¨æˆ·æ•°æ®
   */
  async resetProfile(): Promise<void> {
    this._profile = new UserProfile();
    this._isLoaded = false;  // é‡ç½®åŠ è½½æ ‡å¿—ï¼Œå…è®¸é‡æ–°åŠ è½?
    await this.save();
    console.info('[UserService] User profile reset');
  }
}

export const userService = new UserServiceClass();
