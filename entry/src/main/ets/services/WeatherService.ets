/**
 * å¤©æ°”æœåŠ¡ - ä½¿ç”¨å’Œé£å¤©æ°”API
 */
import { http } from '@kit.NetworkKit';
import { LocationService } from './LocationService';

// å¤©æ°”æ•°æ®æ¥å£
export interface WeatherData {
  temperature: number;
  weatherText: string;
  humidity: number;
  windDirection: string;
  windSpeed: number;
  pressure: number;
  uvIndex: number;
  visibility: number;
  isValid: boolean;
}

// é’“é±¼æŒ‡æ•°
export interface FishingIndex {
  level: string;
  color: string;
  description: string;
}

// å’Œé£å¤©æ°”APIå“åº”æ¥å£
interface QWeatherNow {
  temp: string;
  text: string;
  humidity: string;
  windDir: string;
  windSpeed: string;
  pressure: string;
  vis: string;
}

interface QWeatherResponse {
  code: string;
  now: QWeatherNow;
}

// ============================================================
// ã€é…ç½®åŒºã€‘å’Œé£å¤©æ°”API
// ============================================================
const QWEATHER_HOST = 'mv2pg7eyad.re.qweatherapi.com';
const QWEATHER_KEY = 'YOUR_QWEATHER_API_KEY';  // è¯·æ›¿æ¢ä¸ºä½ çš„å’Œé£å¤©æ°”API Key
// ============================================================

// ç¼“å­˜çš„å¤©æ°”æ•°æ?
let cachedWeather: WeatherData = {
  temperature: 0,
  weatherText: '--',
  humidity: 0,
  windDirection: '--',
  windSpeed: 0,
  pressure: 0,
  uvIndex: 0,
  visibility: 0,
  isValid: false
};

// ç­‰å¾…å®šä½å®Œæˆï¼ˆæœ€å¤šç­‰å¾?ç§’ï¼‰
async function waitForLocation(): Promise<boolean> {
  const TAG = 'WeatherService';
  let location = LocationService.currentLocation;
  
  // å¦‚æœå·²ç»æœ‰æœ‰æ•ˆä½ç½®ï¼Œç›´æ¥è¿”å›
  if (location.isValid && location.latitude !== 30.5844) {
    console.info(TAG, `ä½ç½®å·²å°±ç»? ${location.latitude}, ${location.longitude}`);
    return true;
  }
  
  // ç­‰å¾…å®šä½å®Œæˆ
  console.info(TAG, 'ç­‰å¾…å®šä½æœåŠ¡...');
  for (let i = 0; i < 10; i++) {
    await new Promise<void>((resolve) => setTimeout(resolve, 500));
    location = LocationService.currentLocation;
    // æ£€æŸ¥æ˜¯å¦è·å–åˆ°çœŸå®ä½ç½®ï¼ˆéé»˜è®¤æ­¦æ±‰åæ ‡ï¼?
    if (location.isValid && (location.latitude !== 30.5844 || location.longitude !== 114.2986)) {
      console.info(TAG, `å®šä½æˆåŠŸ: ${location.latitude}, ${location.longitude}`);
      return true;
    }
  }
  
  console.warn(TAG, 'å®šä½è¶…æ—¶ï¼Œä½¿ç”¨å½“å‰ä½ç½?);
  return location.isValid;
}

// è·å–å¤©æ°”æ•°æ®
export async function fetchWeather(): Promise<WeatherData> {
  const TAG = 'WeatherService';
  
  // å…ˆç­‰å¾…å®šä½å®Œæˆ?
  const hasLocation = await waitForLocation();
  const location = LocationService.currentLocation;

  console.info(TAG, `fetchWeather: hasLocation=${hasLocation}, lat=${location.latitude}, lng=${location.longitude}`);

  if (!hasLocation || !location.isValid) {
    console.error(TAG, 'æ— æ³•è·å–ä½ç½®ï¼Œä½¿ç”¨æ¨¡æ‹Ÿå¤©æ°?);
    return getMockWeather();
  }

  if (QWEATHER_HOST) {
    try {
      const result = await fetchQWeather(location.latitude, location.longitude);
      console.info(TAG, `å’Œé£å¤©æ°”è¿”å›: isValid=${result.isValid}, æ¸©åº¦=${result.temperature}Â°C, å¤©æ°”=${result.weatherText}`);
      if (result.isValid) {
        cachedWeather = result;
        console.info(TAG, `ä½¿ç”¨çœŸå®å¤©æ°”æ•°æ®`);
        return result;
      }
    } catch (err) {
      console.error(TAG, `å’Œé£å¤©æ°”è¯·æ±‚å¤±è´¥: ${err}`);
    }
  }

  console.info(TAG, 'ä½¿ç”¨æ¨¡æ‹Ÿå¤©æ°”');
  return getMockWeather();
}

// å’Œé£å¤©æ°”API
async function fetchQWeather(lat: number, lng: number): Promise<WeatherData> {
  const TAG = 'QWeather';
  // ä½¿ç”¨æ›´é«˜ç²¾åº¦çš„åæ ‡ï¼ˆä¿ç•™6ä½å°æ•°ä»¥è·å¾—æœ€ç²¾ç¡®çš„å¤©æ°”æ•°æ®ï¼‰
  const url = `https://${QWEATHER_HOST}/v7/weather/now?location=${lng.toFixed(6)},${lat.toFixed(6)}&key=${QWEATHER_KEY}`;

  console.info(TAG, `========== å’Œé£å¤©æ°”APIè¯·æ±‚ ==========`);
  console.info(TAG, `ç”¨æˆ·åæ ‡: çº¬åº¦=${lat.toFixed(6)}, ç»åº¦=${lng.toFixed(6)}`);
  console.info(TAG, `è¯·æ±‚URL: ${url}`);
  const httpRequest = http.createHttp();

  const emptyResult: WeatherData = {
    temperature: 0,
    weatherText: '--',
    humidity: 0,
    windDirection: '--',
    windSpeed: 0,
    pressure: 0,
    uvIndex: 0,
    visibility: 0,
    isValid: false
  };

  try {
    const response = await httpRequest.request(url, {
      method: http.RequestMethod.GET,
      header: { 'Content-Type': 'application/json' },
      connectTimeout: 15000,
      readTimeout: 15000
    });

    console.info(TAG, `HTTPå“åº”çŠ¶æ€ç : ${response.responseCode}`);
    if (response.responseCode === 200) {
      const resultStr = response.result as string;
      console.info(TAG, `APIå“åº”æ•°æ®: ${resultStr}`);
      
      const data: QWeatherResponse = JSON.parse(resultStr);

      if (data.code === '200' && data.now) {
        const now = data.now;
        console.info(TAG, `========== å¤©æ°”æ•°æ®è§£ææˆåŠŸ ==========`);
        console.info(TAG, `æ¸©åº¦: ${now.temp}Â°C`);
        console.info(TAG, `å¤©æ°”: ${now.text}`);
        console.info(TAG, `æ¹¿åº¦: ${now.humidity}%`);
        console.info(TAG, `é£å‘: ${now.windDir}`);
        console.info(TAG, `é£é€? ${now.windSpeed}km/h`);
        console.info(TAG, `æ°”å‹: ${now.pressure}hPa`);
        console.info(TAG, `èƒ½è§åº? ${now.vis}km`);
        console.info(TAG, `==========================================`);
        
        const result: WeatherData = {
          temperature: parseInt(now.temp) || 0,
          weatherText: now.text || 'æœªçŸ¥',
          humidity: parseInt(now.humidity) || 0,
          windDirection: now.windDir || 'å¾®é£',
          windSpeed: parseInt(now.windSpeed) || 0,
          pressure: parseInt(now.pressure) || 1013,
          uvIndex: 0,
          visibility: parseInt(now.vis) || 10,
          isValid: true
        };
        
        httpRequest.destroy();
        return result;
      } else {
        console.error(TAG, `APIè¿”å›é”™è¯¯: code=${data.code}`);
      }
    } else {
      console.error(TAG, `HTTPé”™è¯¯: ${response.responseCode}`);
    }
  } catch (err) {
    console.error(TAG, `è¯·æ±‚å¼‚å¸¸: ${err}`);
  }

  httpRequest.destroy();
  return emptyResult;
}

// æ¨¡æ‹Ÿå¤©æ°”æ•°æ®
function getMockWeather(): WeatherData {
  const month = new Date().getMonth() + 1;
  const hour = new Date().getHours();
  const day = new Date().getDate();
  const seed = day * 7 + month;

  let temp: number;
  let weatherText: string;
  let humidity: number;

  if (month === 12 || month === 1 || month === 2) {
    temp = 2 + (seed % 8);
    if (hour >= 12 && hour <= 15) temp += 3;
    weatherText = (seed % 3 === 0) ? 'é˜? : 'å¤šäº‘';
    humidity = 65 + (seed % 20);
  } else if (month >= 6 && month <= 8) {
    temp = 28 + (seed % 10);
    if (hour >= 12 && hour <= 15) temp += 3;
    weatherText = (seed % 2 === 0) ? 'æ™? : 'å¤šäº‘';
    humidity = 55 + (seed % 25);
  } else if (month >= 3 && month <= 5) {
    temp = 12 + (seed % 12);
    weatherText = 'å¤šäº‘';
    humidity = 50 + (seed % 25);
  } else {
    temp = 15 + (seed % 12);
    weatherText = (seed % 3 === 0) ? 'æ™? : 'å¤šäº‘';
    humidity = 50 + (seed % 20);
  }

  const windDirs: string[] = ['åŒ—é£', 'ä¸œåŒ—é£?, 'ä¸œé£', 'ä¸œå—é£?, 'å—é£', 'è¥¿å—é£?, 'è¥¿é£', 'è¥¿åŒ—é£?];

  cachedWeather = {
    temperature: temp,
    weatherText: weatherText,
    humidity: humidity,
    windDirection: windDirs[seed % 8],
    windSpeed: 5 + (seed % 15),
    pressure: 1010 + (seed % 15),
    uvIndex: (month >= 5 && month <= 9) ? 5 + (seed % 4) : 1 + (seed % 3),
    visibility: 8 + (seed % 7),
    isValid: true
  };

  return cachedWeather;
}

// è·å–ç¼“å­˜çš„å¤©æ°?
export function getCachedWeather(): WeatherData {
  return cachedWeather;
}

// å¼ºåˆ¶åˆ·æ–°å¤©æ°”ï¼ˆå…ˆåˆ·æ–°ä½ç½®ï¼Œå†è·å–å¤©æ°”ï¼?
export async function refreshWeather(): Promise<WeatherData> {
  const TAG = 'WeatherService';
  console.info(TAG, 'å¼ºåˆ¶åˆ·æ–°å¤©æ°”æ•°æ®...');
  
  // å…ˆåˆ·æ–°ä½ç½?
  try {
    await LocationService.refreshLocation();
    console.info(TAG, 'ä½ç½®å·²åˆ·æ–?);
  } catch (err) {
    console.warn(TAG, `åˆ·æ–°ä½ç½®å¤±è´¥: ${err}`);
  }
  
  // é‡æ–°è·å–å¤©æ°”
  return fetchWeather();
}

// è®¡ç®—é’“é±¼æŒ‡æ•°
export function calculateFishingIndex(weather: WeatherData): FishingIndex {
  if (!weather.isValid) {
    return { level: 'æœªçŸ¥', color: '#999999', description: 'æš‚æ— å¤©æ°”æ•°æ®' };
  }

  let score = 100;
  const TAG = 'FishingIndex';

  // æ¸©åº¦è¯„åˆ†ï¼ˆæœ€ä½?5-25Â°Cï¼?
  if (weather.temperature < 5 || weather.temperature > 35) {
    score -= 40;
  } else if (weather.temperature < 10 || weather.temperature > 30) {
    score -= 20;
  } else if (weather.temperature < 15 || weather.temperature > 25) {
    score -= 5;  // 10-15Â°C æˆ?25-30Â°C è½»å¾®æ‰£åˆ†
  } else {
    score += 10;  // 15-25Â°C æœ€ä½?
  }

  // é£é€Ÿè¯„åˆ†ï¼ˆæœ€ä½?< 8km/hï¼?
  if (weather.windSpeed > 25) {
    score -= 35;
  } else if (weather.windSpeed > 18) {
    score -= 25;
  } else if (weather.windSpeed > 12) {
    score -= 15;  // 12-18km/h ä¸­ç­‰é£?
  } else if (weather.windSpeed > 8) {
    score -= 5;   // 8-12km/h è½»é£
  } else {
    score += 5;   // < 8km/h å¾®é£æœ€ä½?
  }

  // æ°”å‹è¯„åˆ†ï¼ˆæœ€ä½?1005-1025 hPaï¼?
  if (weather.pressure >= 1005 && weather.pressure <= 1025) {
    score += 10;
  } else if (weather.pressure < 990 || weather.pressure > 1035) {
    score -= 15;  // æç«¯æ°”å‹
  }

  // å¤©æ°”çŠ¶å†µè¯„åˆ†
  const badWeather: string[] = ['é›?, 'é›?, 'é›?, 'æš?, 'éœ?, 'é›?];
  const normalWeather: string[] = ['é˜?];  // é˜´å¤©è½»å¾®æ‰£åˆ†
  const goodWeather: string[] = ['æ™?, 'å¤šäº‘'];

  if (badWeather.some((w: string) => weather.weatherText.includes(w))) {
    score -= 25;
  } else if (normalWeather.some((w: string) => weather.weatherText.includes(w))) {
    score -= 10;  // é˜´å¤©ä¸å¤ªç†æƒ³
  } else if (goodWeather.some((w: string) => weather.weatherText.includes(w))) {
    score += 5;
  }

  // ç¡®ä¿åˆ†æ•°åœ¨åˆç†èŒƒå›?
  score = Math.max(0, Math.min(100, score));

  console.info(TAG, `Score=${score}, temp=${weather.temperature}, wind=${weather.windSpeed}, pressure=${weather.pressure}, weather=${weather.weatherText}`);

  if (score >= 80) {
    return { level: 'é€‚å®œ', color: '#4CAF50', description: 'å¤©æ°”æ¡ä»¶éå¸¸é€‚åˆé’“é±¼' };
  } else if (score >= 60) {
    return { level: 'ä¸€èˆ?, color: '#FF9800', description: 'å¤©æ°”æ¡ä»¶å°šå¯ï¼Œæ³¨æ„é˜²æŠ? };
  } else {
    return { level: 'ä¸å®œ', color: '#F44336', description: 'å¤©æ°”æ¡ä»¶ä¸ä½³ï¼Œå»ºè®®æ”¹æ—? };
  }
}
