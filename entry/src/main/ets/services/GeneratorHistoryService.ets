/**
 * é¥µçŸ¥é?- é…æ–¹ç”Ÿæˆå†å²æœåŠ¡
 */
import { GeneratedRecipe } from '../common/types/RecipeTypes';
import { storageService } from './StorageService';
import { AppConstants } from '../common/constants/AppConstants';

class GeneratorHistoryServiceClass {
  private _history: GeneratedRecipe[] = [];
  private _isLoaded: boolean = false;
  private readonly MAX_HISTORY = 50;

  get history(): GeneratedRecipe[] {
    return this._history;
  }

  get isLoaded(): boolean {
    return this._isLoaded;
  }

  /**
   * åŠ è½½å†å²è®°å½•
   */
  async load(): Promise<GeneratedRecipe[]> {
    if (this._isLoaded) {
      return this._history;
    }

    const saved = await storageService.load<GeneratedRecipe[]>(
      AppConstants.STORAGE_GENERATOR_HISTORY,
      []
    );

    this._history = saved || [];
    // æŒ‰æ—¶é—´å€’åº
    this._history.sort((a, b) => b.createTime - a.createTime);
    this._isLoaded = true;

    return this._history;
  }

  /**
   * ä¿å­˜å†å²è®°å½•
   */
  private async save(): Promise<void> {
    await storageService.save(AppConstants.STORAGE_GENERATOR_HISTORY, this._history);
  }

  /**
   * æ·»åŠ ç”Ÿæˆè®°å½•
   */
  async addHistory(recipe: GeneratedRecipe): Promise<void> {
    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
    const exists = this._history.some(h => h.id === recipe.id);
    if (exists) {
      return;
    }

    this._history.unshift(recipe);

    // é™åˆ¶æœ€å¤§æ•°é‡?
    if (this._history.length > this.MAX_HISTORY) {
      this._history = this._history.slice(0, this.MAX_HISTORY);
    }

    await this.save();
  }

  /**
   * åˆ é™¤å†å²è®°å½•
   */
  async deleteHistory(recipeId: string): Promise<boolean> {
    const index = this._history.findIndex(h => h.id === recipeId);
    if (index < 0) {
      return false;
    }

    this._history.splice(index, 1);
    await this.save();
    return true;
  }

  /**
   * æ¸…ç©ºæ‰€æœ‰å†å?
   */
  async clearAll(): Promise<void> {
    this._history = [];
    await this.save();
  }

  /**
   * æ ¹æ®IDè·å–å†å²è®°å½•
   */
  getHistoryById(recipeId: string): GeneratedRecipe | null {
    return this._history.find(h => h.id === recipeId) || null;
  }

  /**
   * è·å–æœ€è¿‘Næ¡è®°å½?
   */
  getRecentHistory(limit: number = 10): GeneratedRecipe[] {
    return this._history.slice(0, limit);
  }
}

export const generatorHistoryService = new GeneratorHistoryServiceClass();
