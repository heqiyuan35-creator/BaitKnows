/**
 * é¥µçŸ¥é“ - æ¸”è·è®°å½•è¯¦æƒ…/ç¼–è¾‘é¡µ
 */
import { ThemeColors } from '../theme/ThemeColors';
import { ThemeConstants } from '../theme/ThemeConstants';
import { Router, RouteParams } from '../router/Router';
import { FishingRecord } from '../common/types/UserTypes';
import { fishingRecordService } from '../services/FishingRecordService';
import { promptAction } from '@kit.ArkUI';

// é±¼ç§é€‰é¡¹
interface FishOption {
  name: string;
  icon: Resource;
}

@Entry
@Component
struct RecordDetailPage {
  @State record: FishingRecord = new FishingRecord();
  @State isEdit: boolean = false;
  @State isLoading: boolean = true;
  @State showDeleteDialog: boolean = false;

  // ç¼–è¾‘çŠ¶æ€çš„ä¸´æ—¶æ•°æ®
  @State editLocation: string = '';
  @State editFishName: string = '';
  @State editWeight: string = '';
  @State editCount: string = '';
  @State editMaxSingle: string = '';
  @State editRecipeName: string = '';
  @State editWeather: string = '';
  @State editNotes: string = '';

  private fishOptions: FishOption[] = [
    { name: 'é²¤é±¼', icon: $r('app.media.Carp') },
    { name: 'è‰é±¼', icon: $r('app.media.Grass_carp') },
    { name: 'é²«é±¼', icon: $r('app.media.Crucian_carp') },
    { name: 'é’é±¼', icon: $r('app.media.Black_carp') },
    { name: 'é²¶é±¼', icon: $r('app.media.Catfish') },
    { name: 'é²¢é±¼', icon: $r('app.media.Silvercarp') },
    { name: 'é³™é±¼', icon: $r('app.media.Bigheadcarp') },
    { name: 'é»‘é±¼', icon: $r('app.media.Snakehead_fish') },
    { name: 'é²ˆé±¼', icon: $r('app.media.Perch') },
    { name: 'å…¶ä»–', icon: $r('app.media.Fish') }
  ];

  private weatherOptions: string[] = ['æ™´æœ—', 'å¤šäº‘', 'é˜´å¤©', 'å°é›¨', 'å¤§é£'];

  aboutToAppear(): void {
    const params = Router.getParams();
    if (params.recordId) {
      this.loadRecord(params.recordId);
    }
    if (params.isEdit) {
      this.isEdit = true;
    }
  }

  private loadRecord(recordId: string): void {
    const record = fishingRecordService.getRecordById(recordId);
    if (record) {
      this.record = record;
      this.initEditData();
    }
    this.isLoading = false;
  }

  private initEditData(): void {
    this.editLocation = this.record.location;
    this.editFishName = this.record.fishName;
    this.editWeight = this.record.weight.toString();
    this.editCount = this.record.count.toString();
    this.editMaxSingle = this.record.maxSingle.toString();
    this.editRecipeName = this.record.recipeName;
    this.editWeather = this.record.weather;
    this.editNotes = this.record.notes;
  }

  private formatDate(timestamp: number): string {
    const date = new Date(timestamp);
    const month = date.getMonth() + 1;
    const day = date.getDate();
    const weekDays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
    const weekDay = weekDays[date.getDay()];
    return `${month}æœˆ${day}æ—¥ ${weekDay}`;
  }

  private getWeatherIcon(weather: string): string {
    const icons: Record<string, string> = {
      'æ™´æœ—': 'â˜€ï¸',
      'å¤šäº‘': 'â›…',
      'é˜´å¤©': 'â˜ï¸',
      'å°é›¨': 'ğŸŒ§ï¸',
      'å¤§é£': 'ğŸ’¨'
    };
    return icons[weather] || 'ğŸŒ¤ï¸';
  }

  // æˆªæ–­é±¼ç§åç§°ï¼Œæœ€å¤šæ˜¾ç¤º2ç§é±¼
  private formatFishName(name: string): string {
    if (!name) return 'æœªçŸ¥é±¼ç§';
    const fishList = name.split('ã€');
    if (fishList.length <= 2) return name;
    return fishList.slice(0, 2).join('ã€') + 'ç­‰';
  }

  private async saveChanges(): Promise<void> {
    this.record.location = this.editLocation;
    this.record.fishName = this.editFishName;
    this.record.weight = parseFloat(this.editWeight) || 0;
    this.record.count = parseInt(this.editCount) || 0;
    this.record.maxSingle = parseFloat(this.editMaxSingle) || 0;
    this.record.recipeName = this.editRecipeName;
    this.record.weather = this.editWeather;
    this.record.notes = this.editNotes;

    const success = await fishingRecordService.updateRecord(this.record);
    if (success) {
      promptAction.showToast({ message: 'ä¿å­˜æˆåŠŸ' });
      this.isEdit = false;
    } else {
      promptAction.showToast({ message: 'ä¿å­˜å¤±è´¥' });
    }
  }

  private async deleteRecord(): Promise<void> {
    try {
      const recordId = this.record.id;
      if (!recordId) {
        promptAction.showToast({ message: 'è®°å½•IDæ— æ•ˆ' });
        return;
      }
      const success = await fishingRecordService.deleteRecord(recordId);
      if (success) {
        promptAction.showToast({ message: 'åˆ é™¤æˆåŠŸ' });
        Router.back();
      } else {
        promptAction.showToast({ message: 'åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•' });
      }
    } catch (error) {
      console.error('[RecordDetailPage] Delete error:', error);
      promptAction.showToast({ message: 'åˆ é™¤å‡ºé”™ï¼Œè¯·é‡è¯•' });
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      this.HeaderBar()

      if (this.isLoading) {
        this.LoadingView()
      } else if (this.isEdit) {
        this.EditView()
      } else {
        this.DetailView()
      }

      // åˆ é™¤ç¡®è®¤å¼¹çª—
      if (this.showDeleteDialog) {
        this.DeleteDialog()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(ThemeColors.BG_PRIMARY)
  }

  @Builder
  HeaderBar() {
    Column() {
      // çŠ¶æ€æ å ä½
      Row()
        .width('100%')
        .height(36)

      Row() {
        Image($r('app.media.Left'))
          .width(24)
          .height(24)
          .fillColor(ThemeColors.TEXT_PRIMARY)
          .onClick(() => {
            if (this.isEdit) {
              this.isEdit = false;
              this.initEditData();
            } else {
              Router.back();
            }
          })

        Blank()

        Text(this.isEdit ? 'ç¼–è¾‘è®°å½•' : 'è®°å½•è¯¦æƒ…')
          .fontSize(ThemeConstants.FONT_SIZE_LG)
          .fontWeight(FontWeight.Medium)
          .fontColor(ThemeColors.TEXT_PRIMARY)

        Blank()

        if (!this.isEdit) {
          Row({ space: 16 }) {
            Text('ç¼–è¾‘')
              .fontSize(ThemeConstants.FONT_SIZE_SM)
              .fontColor(ThemeColors.PRIMARY)
              .onClick(() => { this.isEdit = true; })

            Text('åˆ é™¤')
              .fontSize(ThemeConstants.FONT_SIZE_SM)
              .fontColor('#FF4444')
              .onClick(() => { this.showDeleteDialog = true; })
          }
        } else {
          Text('ä¿å­˜')
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.PRIMARY)
            .onClick(() => { this.saveChanges(); })
        }
      }
      .width('100%')
      .height(48)
      .padding({ left: 16, right: 16 })
    }
    .width('100%')
  }

  @Builder
  LoadingView() {
    Column() {
      LoadingProgress()
        .width(48)
        .height(48)
        .color(ThemeColors.PRIMARY)
      Text('åŠ è½½ä¸­...')
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .margin({ top: 12 })
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
  }

  @Builder
  DetailView() {
    Scroll() {
      Column({ space: ThemeConstants.SPACE_MD }) {
        // ä¸»ä¿¡æ¯å¡ç‰‡
        Column({ space: 12 }) {
          // æ—¥æœŸå’Œå¤©æ°”
          Row() {
            Row({ space: 6 }) {
              Text('ğŸ“…')
                .fontSize(14)
              Text(this.formatDate(this.record.date))
                .fontSize(ThemeConstants.FONT_SIZE_SM)
                .fontColor(ThemeColors.TEXT_SECONDARY)
            }
            Blank()
            Row({ space: 4 }) {
              Text(this.getWeatherIcon(this.record.weather))
                .fontSize(16)
              Text(this.record.weather)
                .fontSize(ThemeConstants.FONT_SIZE_SM)
                .fontColor(ThemeColors.TEXT_SECONDARY)
            }
            .padding({ left: 10, right: 10, top: 4, bottom: 4 })
            .backgroundColor(ThemeColors.BG_TERTIARY)
            .borderRadius(ThemeConstants.RADIUS_FULL)
          }
          .width('100%')

          // é±¼ç§å’Œé‡é‡
          Row() {
            Column({ space: 4 }) {
              Row({ space: 8 }) {
                Text('ğŸŸ')
                  .fontSize(24)
                  .flexShrink(0)
                Text(this.formatFishName(this.record.fishName))
                  .fontSize(ThemeConstants.FONT_SIZE_XL)
                  .fontWeight(FontWeight.Bold)
                  .fontColor(ThemeColors.TEXT_PRIMARY)
                  .maxLines(1)
                  .textOverflow({ overflow: TextOverflow.Ellipsis })
              }
              .constraintSize({ maxWidth: '60%' })

              Text(`å…± ${this.record.count} å°¾`)
                .fontSize(ThemeConstants.FONT_SIZE_SM)
                .fontColor(ThemeColors.TEXT_SECONDARY)
            }
            .alignItems(HorizontalAlign.Start)
            .flexShrink(1)

            Blank()

            Column({ space: 4 }) {
              Row() {
                Text(`${this.record.weight}`)
                  .fontSize(36)
                  .fontWeight(FontWeight.Bold)
                  .fontColor(ThemeColors.PRIMARY)
                Text('kg')
                  .fontSize(ThemeConstants.FONT_SIZE_MD)
                  .fontColor(ThemeColors.TEXT_SECONDARY)
                  .margin({ left: 4, top: 12 })
              }
            }
            .alignItems(HorizontalAlign.End)
            .flexShrink(0)
          }
          .width('100%')
        }
        .width('100%')
        .padding(ThemeConstants.SPACE_MD)
        .backgroundColor(ThemeColors.BG_CARD)
        .borderRadius(ThemeConstants.RADIUS_MD)
        .margin({ left: ThemeConstants.SPACE_MD, right: ThemeConstants.SPACE_MD })
        .shadow({ radius: 8, color: 'rgba(0,0,0,0.05)', offsetY: 2 })

        // è¯¦ç»†ä¿¡æ¯
        Column({ space: 1 }) {
          this.InfoRow('ğŸ“ é’“ç‚¹', this.record.location || 'æœªå¡«å†™')
          this.InfoRow('ğŸ† æœ€å¤§å•å°¾', `${this.record.maxSingle} kg`)
          this.RecipeInfoRow()
        }
        .margin({ left: ThemeConstants.SPACE_MD, right: ThemeConstants.SPACE_MD })
        .borderRadius(ThemeConstants.RADIUS_MD)
        .clip(true)
        .shadow({ radius: 8, color: 'rgba(0,0,0,0.05)', offsetY: 2 })

        // æ¸”è·å›¾ç‰‡
        if (this.record.photos && this.record.photos.length > 0) {
          Column({ space: 8 }) {
            Row({ space: 6 }) {
              Text('ğŸ“·')
                .fontSize(16)
              Text('æ¸”è·å›¾ç‰‡')
                .fontSize(ThemeConstants.FONT_SIZE_MD)
                .fontWeight(FontWeight.Medium)
                .fontColor(ThemeColors.TEXT_PRIMARY)
            }
            .width('100%')

            Row({ space: 8 }) {
              ForEach(this.record.photos, (photo: string, index: number) => {
                Image(photo)
                  .width(100)
                  .height(100)
                  .objectFit(ImageFit.Cover)
                  .borderRadius(ThemeConstants.RADIUS_SM)
              }, (photo: string, index: number) => `photo_${index}`)
            }
            .width('100%')
          }
          .width('100%')
          .padding(ThemeConstants.SPACE_MD)
          .backgroundColor(ThemeColors.BG_CARD)
          .borderRadius(ThemeConstants.RADIUS_MD)
          .margin({ left: ThemeConstants.SPACE_MD, right: ThemeConstants.SPACE_MD })
          .shadow({ radius: 8, color: 'rgba(0,0,0,0.05)', offsetY: 2 })
        }

        // å¤‡æ³¨
        if (this.record.notes) {
          Column({ space: 8 }) {
            Row({ space: 6 }) {
              Text('ğŸ“')
                .fontSize(16)
              Text('å¤‡æ³¨')
                .fontSize(ThemeConstants.FONT_SIZE_MD)
                .fontWeight(FontWeight.Medium)
                .fontColor(ThemeColors.TEXT_PRIMARY)
            }
            .width('100%')

            Text(this.record.notes)
              .fontSize(ThemeConstants.FONT_SIZE_BASE)
              .fontColor(ThemeColors.TEXT_SECONDARY)
              .lineHeight(22)
              .width('100%')
          }
          .width('100%')
          .padding(ThemeConstants.SPACE_MD)
          .backgroundColor(ThemeColors.BG_CARD)
          .borderRadius(ThemeConstants.RADIUS_MD)
          .margin({ left: ThemeConstants.SPACE_MD, right: ThemeConstants.SPACE_MD })
          .shadow({ radius: 8, color: 'rgba(0,0,0,0.05)', offsetY: 2 })
        }
      }
      .padding({ top: ThemeConstants.SPACE_MD, bottom: 40 })
    }
    .layoutWeight(1)
    .scrollBar(BarState.Off)
  }

  @Builder
  InfoRow(label: string, value: string) {
    Row() {
      Text(label)
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .fontColor(ThemeColors.TEXT_SECONDARY)
      Blank()
      Text(value)
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .fontColor(ThemeColors.TEXT_PRIMARY)
    }
    .width('100%')
    .height(52)
    .padding({ left: ThemeConstants.SPACE_MD, right: ThemeConstants.SPACE_MD })
    .backgroundColor(ThemeColors.BG_CARD)
  }

  @Builder
  RecipeInfoRow() {
    Row() {
      Text('ğŸ§ª ä½¿ç”¨é…æ–¹')
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .fontColor(ThemeColors.TEXT_SECONDARY)
      Blank()
      if (this.record.recipeName && this.record.recipeId) {
        Row({ space: 4 }) {
          Text(this.record.recipeName)
            .fontSize(ThemeConstants.FONT_SIZE_BASE)
            .fontColor(ThemeColors.PRIMARY)
          Text('>')
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.PRIMARY)
        }
        .onClick(() => {
          Router.goToRecipeDetail(this.record.recipeId);
        })
      } else {
        Text(this.record.recipeName || 'æœªå¡«å†™')
          .fontSize(ThemeConstants.FONT_SIZE_BASE)
          .fontColor(ThemeColors.TEXT_PRIMARY)
      }
    }
    .width('100%')
    .height(52)
    .padding({ left: ThemeConstants.SPACE_MD, right: ThemeConstants.SPACE_MD })
    .backgroundColor(ThemeColors.BG_CARD)
  }

  @Builder
  EditView() {
    Scroll() {
      Column({ space: ThemeConstants.SPACE_MD }) {
        // é’“ç‚¹ä½ç½®
        this.EditInput('ğŸ“ é’“ç‚¹ä½ç½®', 'è¯·è¾“å…¥é’“ç‚¹åç§°', this.editLocation, (v: string) => { this.editLocation = v; })

        // å¤©æ°”é€‰æ‹©
        this.WeatherSelector()

        // é±¼ç§é€‰æ‹©
        this.FishSelector()

        // é‡é‡
        this.EditInput('âš–ï¸ æ€»é‡é‡ (kg)', 'è¯·è¾“å…¥é‡é‡', this.editWeight, (v: string) => { this.editWeight = v; })

        // æ•°é‡
        this.EditInput('ğŸ”¢ æ•°é‡ (å°¾)', 'è¯·è¾“å…¥æ•°é‡', this.editCount, (v: string) => { this.editCount = v; })

        // æœ€å¤§å•å°¾
        this.EditInput('ğŸ† æœ€å¤§å•å°¾ (kg)', 'è¯·è¾“å…¥æœ€å¤§å•å°¾é‡é‡', this.editMaxSingle, (v: string) => { this.editMaxSingle = v; })

        // ä½¿ç”¨é…æ–¹
        this.EditInput('ğŸ§ª ä½¿ç”¨é…æ–¹', 'è¯·è¾“å…¥é…æ–¹åç§°', this.editRecipeName, (v: string) => { this.editRecipeName = v; })

        // å¤‡æ³¨
        this.NotesInput()
      }
      .padding({ left: ThemeConstants.SPACE_MD, right: ThemeConstants.SPACE_MD, top: ThemeConstants.SPACE_MD, bottom: 40 })
    }
    .layoutWeight(1)
    .scrollBar(BarState.Off)
  }

  @Builder
  EditInput(label: string, placeholder: string, value: string, onChange: (v: string) => void) {
    Column({ space: 8 }) {
      Text(label)
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .width('100%')

      TextInput({ placeholder: placeholder, text: value })
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .placeholderColor(ThemeColors.TEXT_HINT)
        .backgroundColor(ThemeColors.BG_CARD)
        .borderRadius(ThemeConstants.RADIUS_SM)
        .height(48)
        .padding({ left: ThemeConstants.SPACE_MD, right: ThemeConstants.SPACE_MD })
        .onChange(onChange)
    }
  }

  @Builder
  WeatherSelector() {
    Column({ space: 8 }) {
      Text('ğŸŒ¤ï¸ å¤©æ°”')
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .width('100%')

      Row({ space: 8 }) {
        ForEach(this.weatherOptions, (option: string) => {
          Text(option)
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(this.editWeather === option ? ThemeColors.TEXT_PRIMARY : ThemeColors.TEXT_SECONDARY)
            .padding({ left: 12, right: 12, top: 8, bottom: 8 })
            .backgroundColor(this.editWeather === option ? ThemeColors.PRIMARY : ThemeColors.BG_CARD)
            .borderRadius(ThemeConstants.RADIUS_SM)
            .onClick(() => { this.editWeather = option; })
        })
      }
      .width('100%')
    }
  }

  @Builder
  FishSelector() {
    Column({ space: 8 }) {
      Text('ğŸŸ é±¼ç§')
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .width('100%')

      Flex({ wrap: FlexWrap.Wrap }) {
        ForEach(this.fishOptions, (option: FishOption) => {
          Column({ space: 4 }) {
            Image(option.icon)
              .width(28)
              .height(28)
              .objectFit(ImageFit.Contain)
            Text(option.name)
              .fontSize(ThemeConstants.FONT_SIZE_XS)
              .fontColor(this.editFishName === option.name ? ThemeColors.TEXT_PRIMARY : ThemeColors.TEXT_SECONDARY)
          }
          .width(64)
          .padding({ top: 8, bottom: 8 })
          .backgroundColor(this.editFishName === option.name ? ThemeColors.PRIMARY : ThemeColors.BG_CARD)
          .borderRadius(ThemeConstants.RADIUS_SM)
          .margin({ right: 8, bottom: 8 })
          .onClick(() => { this.editFishName = option.name; })
        })
      }
      .width('100%')
    }
  }

  @Builder
  NotesInput() {
    Column({ space: 8 }) {
      Text('ğŸ“ å¤‡æ³¨')
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .width('100%')

      TextArea({ placeholder: 'è®°å½•ä¸€äº›å¿ƒå¾—ä½“ä¼š...', text: this.editNotes })
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .placeholderColor(ThemeColors.TEXT_HINT)
        .backgroundColor(ThemeColors.BG_CARD)
        .borderRadius(ThemeConstants.RADIUS_SM)
        .height(100)
        .padding(ThemeConstants.SPACE_MD)
        .onChange((v: string) => { this.editNotes = v; })
    }
  }

  @Builder
  DeleteDialog() {
    Stack() {
      // é®ç½©
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0,0,0,0.5)')
        .onClick(() => { this.showDeleteDialog = false; })

      // å¼¹çª—
      Column({ space: 16 }) {
        Text('ç¡®è®¤åˆ é™¤')
          .fontSize(ThemeConstants.FONT_SIZE_LG)
          .fontWeight(FontWeight.Medium)
          .fontColor(ThemeColors.TEXT_PRIMARY)

        Text('åˆ é™¤åæ— æ³•æ¢å¤ï¼Œç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')
          .fontSize(ThemeConstants.FONT_SIZE_BASE)
          .fontColor(ThemeColors.TEXT_SECONDARY)
          .textAlign(TextAlign.Center)

        Row({ space: 12 }) {
          Button('å–æ¶ˆ')
            .fontSize(ThemeConstants.FONT_SIZE_BASE)
            .fontColor(ThemeColors.TEXT_PRIMARY)
            .backgroundColor(ThemeColors.BG_TERTIARY)
            .layoutWeight(1)
            .height(44)
            .onClick(() => { this.showDeleteDialog = false; })

          Button('åˆ é™¤')
            .fontSize(ThemeConstants.FONT_SIZE_BASE)
            .fontColor(Color.White)
            .backgroundColor('#FF4444')
            .layoutWeight(1)
            .height(44)
            .onClick(() => {
              this.showDeleteDialog = false;
              this.deleteRecord();
            })
        }
        .width('100%')
      }
      .width('80%')
      .padding(24)
      .backgroundColor(ThemeColors.BG_CARD)
      .borderRadius(ThemeConstants.RADIUS_LG)
    }
    .width('100%')
    .height('100%')
    .position({ x: 0, y: 0 })
  }
}
