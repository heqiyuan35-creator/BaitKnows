/**
 * é¥µçŸ¥é“ - åœ°å›¾é¡µé¢
 * æ˜¾ç¤ºå‘¨è¾¹çœŸå®é’“ç‚¹ï¼Œç‚¹å‡»æ¨èé¥µæ–™
 */
import { MapComponent, mapCommon, map, site } from '@kit.MapKit';
import { AsyncCallback, BusinessError } from '@kit.BasicServicesKit';
import { router } from '@kit.ArkUI';
import { ThemeColors } from '../theme/ThemeColors';
import { LocationService, LocationInfo } from '../services/LocationService';
import { FishingSpotService } from '../services/FishingSpotService';
import { FishingSpot, BaitInfo, WaterTypeNames, WaterTypeIcons } from '../data/FishingSpotData';

@Entry
@Component
struct MapPage {
  private TAG = 'MapPage';
  private mapOptions?: mapCommon.MapOptions;
  private mapCallback?: AsyncCallback<map.MapComponentController>;
  private mapController?: map.MapComponentController;
  private locationMarker?: map.Marker;
  private spotMarkers: map.Marker[] = [];

  @State isMapReady: boolean = false;
  @State isSearching: boolean = false;
  @State currentLocation: string = 'å®šä½ä¸­...';
  @State locationInfo: LocationInfo = LocationService.currentLocation;
  @State fishingSpots: FishingSpot[] = [];
  @State showBaitDialog: boolean = false;
  @State selectedSpot: FishingSpot | null = null;
  @State recommendedBaits: BaitInfo[] = [];
  @State clickedLocationName: string = '';  // ç‚¹å‡»ä½ç½®çš„åç§°

  aboutToAppear(): void {
    this.locationInfo = LocationService.currentLocation;

    // ç”¨å½“å‰ä½ç½®åˆå§‹åŒ–åœ°å›¾
    this.mapOptions = {
      position: {
        target: {
          latitude: this.locationInfo.latitude,
          longitude: this.locationInfo.longitude
        },
        zoom: 14
      },
      scaleControlsEnabled: true,
      zoomControlsEnabled: true,
      compassControlsEnabled: true
    };

    if (this.locationInfo.isValid) {
      this.currentLocation = 'å·²å®šä½';
    }

    this.mapCallback = async (err, mapController) => {
      if (!err) {
        this.mapController = mapController;
        this.isMapReady = true;

        const eventManager = this.mapController.getEventManager();

        // åœ°å›¾åŠ è½½å®Œæˆ
        eventManager.on('mapLoad', () => {
          this.addUserLocationMarker();
          this.searchNearbySpots();
        });

        // åœ°å›¾ç‚¹å‡»äº‹ä»¶ - é€†åœ°ç†ç¼–ç è·å–åœ°å
        eventManager.on('mapClick', (position: mapCommon.LatLng) => {
          this.onMapClick(position);
        });
      } else {
        console.error(this.TAG, `Map init failed: ${err.code}, ${err.message}`);
      }
    };
  }

  // åœ°å›¾ç‚¹å‡»äº‹ä»¶å¤„ç†
  async onMapClick(position: mapCommon.LatLng): Promise<void> {
    console.info(this.TAG, `Map clicked: ${position.latitude}, ${position.longitude}`);
    this.clickedLocationName = 'æŸ¥è¯¢ä¸­...';

    try {
      const params: site.ReverseGeocodeParams = {
        location: {
          latitude: position.latitude,
          longitude: position.longitude
        },
        language: 'zh',
        radius: 50
      };

      const result = await site.reverseGeocode(params);

      if (result && result.addressComponent) {
        const addr = result.addressComponent;

        // æ‹¼æ¥åœ°å€ï¼šåŒº + è¡—é“/é“è·¯
        const parts: string[] = [];
        if (addr.adminLevel3) {
          parts.push(addr.adminLevel3);
        }
        if (addr.adminLevel4) {
          parts.push(addr.adminLevel4);
        }

        if (parts.length > 0) {
          this.clickedLocationName = parts.join('');
        } else {
          this.clickedLocationName = `${position.latitude.toFixed(4)}, ${position.longitude.toFixed(4)}`;
        }

        console.info(this.TAG, `Location name: ${this.clickedLocationName}`);
      } else {
        this.clickedLocationName = `${position.latitude.toFixed(4)}, ${position.longitude.toFixed(4)}`;
      }
    } catch (error) {
      const err = error as BusinessError;
      console.error(this.TAG, `Reverse geocode failed: ${err.code}, ${err.message}`);
      this.clickedLocationName = `${position.latitude.toFixed(4)}, ${position.longitude.toFixed(4)}`;
    }
  }

  // æœç´¢å‘¨è¾¹çœŸå®é’“ç‚¹
  async searchNearbySpots(): Promise<void> {
    if (!this.locationInfo.isValid) return;

    this.isSearching = true;
    this.currentLocation = 'æœç´¢é’“ç‚¹ä¸­...';

    try {
      this.fishingSpots = await FishingSpotService.searchNearbySpots(
        this.locationInfo.latitude,
        this.locationInfo.longitude,
        5000 // 5km èŒƒå›´
      );

      // ä¿å­˜åˆ°å…¨å±€ç¼“å­˜ï¼Œä¾›é¦–é¡µä½¿ç”¨
      FishingSpotService.updateCachedSpots(this.fishingSpots);

      this.currentLocation = `å·²å®šä½ Â· å‘ç° ${this.fishingSpots.length} ä¸ªé’“ç‚¹`;

      // æ·»åŠ é’“ç‚¹æ ‡è®°
      await this.addSpotMarkers();
    } catch (err) {
      console.error(this.TAG, `Search spots failed: ${err}`);
      this.currentLocation = 'æœç´¢é’“ç‚¹å¤±è´¥';
    } finally {
      this.isSearching = false;
    }
  }

  // æ·»åŠ ç”¨æˆ·ä½ç½®æ ‡è®°
  async addUserLocationMarker(): Promise<void> {
    if (!this.mapController || !this.locationInfo.isValid) return;

    try {
      // ç”¨æˆ·ä½ç½®æ ‡è®°
      const markerOptions: mapCommon.MarkerOptions = {
        position: {
          latitude: this.locationInfo.latitude,
          longitude: this.locationInfo.longitude
        },
        title: 'ğŸ“ æˆ‘çš„ä½ç½®',
        snippet: 'å½“å‰æ‰€åœ¨ä½ç½®',
        clickable: true,
        alpha: 1,
        anchorU: 0.5,
        anchorV: 1
      };
      this.locationMarker = await this.mapController.addMarker(markerOptions);

      // æ˜¾ç¤ºä¿¡æ¯çª—å£
      this.locationMarker.setInfoWindowVisible(true);
    } catch (e) {
      console.error(this.TAG, `Add user marker error: ${e}`);
    }
  }

  // æ·»åŠ é’“ç‚¹æ ‡è®°
  async addSpotMarkers(): Promise<void> {
    if (!this.mapController) return;

    // æ¸…é™¤æ—§æ ‡è®°
    for (const marker of this.spotMarkers) {
      marker.remove();
    }
    this.spotMarkers = [];

    // æ·»åŠ æ–°æ ‡è®°
    for (const spot of this.fishingSpots) {
      try {
        const icon = WaterTypeIcons[spot.waterType] || 'ğŸ“';
        const markerOptions: mapCommon.MarkerOptions = {
          position: {
            latitude: spot.latitude,
            longitude: spot.longitude
          },
          title: `${icon} ${spot.name}`,
          snippet: `${WaterTypeNames[spot.waterType]} Â· ${FishingSpotService.formatDistance(spot.distance || 0)}`,
          clickable: true
        };

        const marker = await this.mapController.addMarker(markerOptions);
        this.spotMarkers.push(marker);
      } catch (e) {
        console.error(this.TAG, `Add spot marker error: ${e}`);
      }
    }

    // ç›‘å¬æ ‡è®°ç‚¹å‡»
    if (this.mapController) {
      const eventManager = this.mapController.getEventManager();
      eventManager.on('markerClick', (clickedMarker: map.Marker) => {
        const clickedSpot = this.fishingSpots.find(s =>
          Math.abs(s.latitude - clickedMarker.getPosition().latitude) < 0.0001 &&
          Math.abs(s.longitude - clickedMarker.getPosition().longitude) < 0.0001
        );
        if (clickedSpot) {
          this.onSpotClick(clickedSpot);
        }
      });
    }
  }

  // ç‚¹å‡»é’“ç‚¹
  onSpotClick(spot: FishingSpot): void {
    this.selectedSpot = spot;
    this.recommendedBaits = FishingSpotService.recommendBaits(spot.waterType);
    this.showBaitDialog = true;
  }

  // åˆ·æ–°ä½ç½®å’Œé’“ç‚¹
  async refreshLocation(): Promise<void> {
    this.currentLocation = 'æ­£åœ¨å®šä½...';

    try {
      const location = await LocationService.fetchCurrentLocation();
      this.locationInfo = location;

      if (location.isValid) {
        // æ›´æ–°ç”¨æˆ·æ ‡è®°
        if (this.locationMarker) {
          this.locationMarker.remove();
        }
        await this.addUserLocationMarker();
        this.moveToCurrentLocation();
        // é‡æ–°æœç´¢é’“ç‚¹
        await this.searchNearbySpots();
      } else {
        this.currentLocation = 'å®šä½å¤±è´¥';
      }
    } catch (err) {
      this.currentLocation = 'å®šä½å¤±è´¥';
    }
  }

  moveToCurrentLocation(): void {
    if (!this.mapController || !this.locationInfo.isValid) return;
    const position: mapCommon.LatLng = {
      latitude: this.locationInfo.latitude,
      longitude: this.locationInfo.longitude
    };
    const cameraUpdate = map.newLatLng(position, 14);
    this.mapController.animateCamera(cameraUpdate, 500);
  }

  goBack(): void {
    router.back();
  }

  onPageShow(): void {
    if (this.mapController) {
      this.mapController.show();
    }
  }

  onPageHide(): void {
    if (this.mapController) {
      this.mapController.hide();
    }
  }

  build() {
    Stack() {
      Column() {
        // é¡¶éƒ¨å¯¼èˆªæ 
        Row() {
          Image($r('app.media.Left'))
            .width(24)
            .height(24)
            .onClick(() => this.goBack())

          Text('é’“ç‚¹åœ°å›¾')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor(ThemeColors.TEXT_PRIMARY)
            .layoutWeight(1)
            .textAlign(TextAlign.Center)

          Text('ğŸ“')
            .fontSize(20)
            .onClick(() => this.refreshLocation())
        }
        .width('100%')
        .height(56)
        .padding({ left: 16, right: 16 })
        .backgroundColor(ThemeColors.BG_SECONDARY)

        // é’“ç‚¹æ•°é‡æç¤º
        Row() {
          Text(this.currentLocation)
            .fontSize(12)
            .fontColor(ThemeColors.TEXT_SECONDARY)
          if (this.isSearching) {
            LoadingProgress()
              .width(16)
              .height(16)
              .margin({ left: 8 })
          }
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 8, bottom: 8 })
        .backgroundColor(ThemeColors.BG_PRIMARY)

        // ç‚¹å‡»ä½ç½®åç§°æ˜¾ç¤º
        if (this.clickedLocationName) {
          Row() {
            Text('ğŸ“ ç‚¹å‡»ä½ç½®: ')
              .fontSize(12)
              .fontColor(ThemeColors.TEXT_SECONDARY)
            Text(this.clickedLocationName)
              .fontSize(12)
              .fontColor(ThemeColors.PRIMARY)
              .fontWeight(FontWeight.Medium)
              .layoutWeight(1)
            Text('âœ•')
              .fontSize(14)
              .fontColor(ThemeColors.TEXT_SECONDARY)
              .onClick(() => { this.clickedLocationName = '' })
          }
          .width('100%')
          .padding({ left: 16, right: 16, top: 6, bottom: 6 })
          .backgroundColor('#E3F2FD')
        }

        // åœ°å›¾ï¼ˆå…¨å±ï¼‰
        Stack() {
          if (this.mapOptions) {
            MapComponent({
              mapOptions: this.mapOptions,
              mapCallback: this.mapCallback
            })
              .width('100%')
              .height('100%')
          }

          if (!this.isMapReady) {
            Column() {
              LoadingProgress().width(48).height(48).color(ThemeColors.PRIMARY)
              Text('åœ°å›¾åŠ è½½ä¸­...').fontSize(14).fontColor(ThemeColors.TEXT_SECONDARY).margin({ top: 12 })
            }
            .width('100%')
            .height('100%')
            .justifyContent(FlexAlign.Center)
            .backgroundColor(ThemeColors.BG_PRIMARY)
          }
        }
        .layoutWeight(1)
        .width('100%')
      }
      .width('100%')
      .height('100%')

      // é¥µæ–™æ¨èå¼¹çª—
      if (this.showBaitDialog && this.selectedSpot) {
        this.BaitRecommendDialog()
      }
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  BaitRecommendDialog() {
    Column() {
      // é®ç½©
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0,0,0,0.5)')
        .onClick(() => { this.showBaitDialog = false })
    }
    .width('100%')
    .height('100%')
    .position({ x: 0, y: 0 })

    // å¼¹çª—å†…å®¹
    Column() {
      // æ ‡é¢˜
      Row() {
        Text(`${WaterTypeIcons[this.selectedSpot!.waterType]} ${this.selectedSpot!.name}`)
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeColors.TEXT_PRIMARY)
        Blank()
        Text('âœ•')
          .fontSize(20)
          .fontColor(ThemeColors.TEXT_SECONDARY)
          .onClick(() => { this.showBaitDialog = false })
      }
      .width('100%')
      .margin({ bottom: 8 })

      Text(`${WaterTypeNames[this.selectedSpot!.waterType]} Â· ${this.selectedSpot!.description}`)
        .fontSize(13)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .margin({ bottom: 16 })

      Divider().color('#eee').margin({ bottom: 16 })

      Text('ğŸ£ æ¨èé¥µæ–™')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .margin({ bottom: 12 })

      ForEach(this.recommendedBaits, (bait: BaitInfo) => {
        Row() {
          Text(bait.icon)
            .fontSize(28)
            .margin({ right: 12 })

          Column() {
            Text(bait.name)
              .fontSize(15)
              .fontWeight(FontWeight.Medium)
              .fontColor(ThemeColors.TEXT_PRIMARY)
            Text(bait.description)
              .fontSize(12)
              .fontColor(ThemeColors.TEXT_SECONDARY)
              .margin({ top: 2 })
            Text(`ç›®æ ‡é±¼: ${bait.targetFish.join('ã€')}`)
              .fontSize(11)
              .fontColor(ThemeColors.PRIMARY)
              .margin({ top: 4 })
          }
          .alignItems(HorizontalAlign.Start)
          .layoutWeight(1)

          Text(bait.season)
            .fontSize(11)
            .fontColor('#999')
            .padding({ left: 8, right: 8, top: 4, bottom: 4 })
            .backgroundColor('#f5f5f5')
            .borderRadius(4)
        }
        .width('100%')
        .padding(12)
        .backgroundColor(ThemeColors.BG_SECONDARY)
        .borderRadius(8)
        .margin({ bottom: 8 })
      })

      Button('æ¢ä¸€æ‰¹æ¨è')
        .width('100%')
        .height(44)
        .fontSize(14)
        .backgroundColor(ThemeColors.PRIMARY)
        .fontColor(Color.White)
        .margin({ top: 8 })
        .onClick(() => {
          this.recommendedBaits = FishingSpotService.recommendBaits(this.selectedSpot!.waterType);
        })
    }
    .width('90%')
    .padding(20)
    .backgroundColor(ThemeColors.BG_PRIMARY)
    .borderRadius(16)
    .position({ x: '5%', y: '20%' })
  }
}
