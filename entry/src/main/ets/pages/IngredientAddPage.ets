/**
 * é¥µçŸ¥é?- åŸæ–™æ–°å¢é¡µé¢
 * ç”¨æˆ·è‡ªå®šä¹‰æ·»åŠ é¥µæ–™åŸæ–?
 */
import { router } from '@kit.ArkUI';
import { ThemeColors } from '../theme/ThemeColors';
import { ThemeConstants } from '../theme/ThemeConstants';
import { userDataService, CustomFish } from '../services/UserDataService';
import { ALL_FISH_DATA, FishData } from '../data/FishData';

// åŸæ–™åˆ†ç±»ç±?
class IngredientCategoryItem {
  id: string = '';
  name: string = '';
  icon: string = '';
}

// å­åˆ†ç±»ç±»
class SubCategoryItem {
  id: string = '';
  name: string = '';
}

// å­£èŠ‚é€‰é¡¹
class SeasonItem {
  id: string = '';
  name: string = '';
}

// åˆ›å»ºåˆ†ç±»è¾…åŠ©å‡½æ•°
function makeCategory(id: string, name: string, icon: string): IngredientCategoryItem {
  const cat = new IngredientCategoryItem();
  cat.id = id;
  cat.name = name;
  cat.icon = icon;
  return cat;
}

function makeSubCategory(id: string, name: string): SubCategoryItem {
  const sub = new SubCategoryItem();
  sub.id = id;
  sub.name = name;
  return sub;
}

function makeSeason(id: string, name: string): SeasonItem {
  const s = new SeasonItem();
  s.id = id;
  s.name = name;
  return s;
}

// æ‰©å±•æ•°æ®ç±?
class PhysicalData {
  atomization: number = 5;
  viscosity: number = 5;
  weight: number = 5;
}

class DosageData {
  min: number = 10;
  max: number = 50;
  unit: string = 'g';
}

class ExtendedIngredientData {
  subCategory: string = '';
  seasons: string[] = [];
  physical: PhysicalData = new PhysicalData();
  dosage: DosageData = new DosageData();
}

@Entry
@Component
struct IngredientAddPage {
  // åŸºæœ¬ä¿¡æ¯
  @State ingredientName: string = '';
  @State selectedCategory: string = 'base';
  @State selectedSubCategory: string = 'grain';
  @State description: string = '';

  // é€‚ç”¨ä¿¡æ¯
  @State selectedFishIds: string[] = [];
  @State selectedSeasons: string[] = ['spring', 'summer', 'autumn', 'winter'];

  // ç‰©ç†ç‰¹æ€?
  @State atomization: number = 5;
  @State viscosity: number = 5;
  @State weight: number = 5;

  // ç”¨é‡èŒƒå›´
  @State dosageMin: number = 10;
  @State dosageMax: number = 50;
  @State dosageUnit: string = 'g';

  // å¼¹çª—çŠ¶æ€?
  @State showFishPicker: boolean = false;
  @State showToast: boolean = false;
  @State toastMessage: string = '';
  @State isSaving: boolean = false;

  private categories: IngredientCategoryItem[] = [
    makeCategory('base', 'åŸºç¡€é¥?, 'ğŸŒ¾'),
    makeCategory('protein', 'è›‹ç™½é¥?, 'ğŸ¦'),
    makeCategory('additive', 'æ·»åŠ å‰?, 'ğŸ’§'),
    makeCategory('state', 'çŠ¶æ€é¥µ', 'ğŸ§Š'),
    makeCategory('binder', 'ç²˜åˆå‰?, 'ğŸ¯'),
    makeCategory('natural', 'å¤©ç„¶é¥?, 'ğŸŒ¿'),
    makeCategory('pellet', 'é¢—ç²’é¥?, 'âš?),
    makeCategory('live', 'æ´»é¥µ', 'ğŸª±'),
    makeCategory('folk', 'æ°‘é—´åæ–¹', 'ğŸ§ª')
  ];

  private subCategories: Record<string, SubCategoryItem[]> = {
    'base': [makeSubCategory('grain', 'è°·ç‰©'), makeSubCategory('tuber', 'è–¯ç±»'), makeSubCategory('bean', 'è±†ç±»')],
    'protein': [makeSubCategory('aquatic', 'æ°´äº§'), makeSubCategory('insect', 'æ˜†è™«'), makeSubCategory('animal', 'åŠ¨ç‰©')],
    'additive': [makeSubCategory('essence', 'é¦™ç²¾'), makeSubCategory('attractant', 'è¯±é£Ÿå‰?), makeSubCategory('acid', 'é…¸ç±»'), makeSubCategory('condiment', 'è°ƒå‘³æ–?), makeSubCategory('oil', 'æ²¹ç±»')],
    'state': [makeSubCategory('atomizer', 'é›¾åŒ–ç±?), makeSubCategory('weight', 'å¢é‡ç±?)],
    'binder': [makeSubCategory('grain', 'è°·ç‰©æ·€ç²?), makeSubCategory('tuber', 'è–¯ç±»æ·€ç²?)],
    'natural': [makeSubCategory('plant', 'æ¤ç‰©'), makeSubCategory('seed', 'ç§å­')],
    'pellet': [makeSubCategory('other', 'é¢—ç²’')],
    'live': [makeSubCategory('worm', 'è •è™«'), makeSubCategory('baitfish', 'é¥µé±¼')],
    'folk': [makeSubCategory('medicine', 'è¯æ'), makeSubCategory('beverage', 'é¥®å“'), makeSubCategory('fermented', 'å‘é…µç‰?), makeSubCategory('other', 'å…¶ä»–')]
  };

  private seasons: SeasonItem[] = [
    makeSeason('spring', 'æ˜¥å­£'),
    makeSeason('summer', 'å¤å­£'),
    makeSeason('autumn', 'ç§‹å­£'),
    makeSeason('winter', 'å†¬å­£')
  ];

  async aboutToAppear(): Promise<void> {
    await userDataService.load();
  }

  build() {
    Column() {
      this.NavBar()

      Scroll() {
        Column({ space: 16 }) {
          // åŸæ–™åç§°
          this.NameSection()

          // åŸæ–™åˆ†ç±»
          this.CategorySection()

          // å­åˆ†ç±?
          this.SubCategorySection()

          // é€‚ç”¨é±¼ç§
          this.TargetFishSection()

          // é€‚ç”¨å­£èŠ‚
          this.SeasonSection()

          // ç‰©ç†ç‰¹æ€?
          this.PhysicalSection()

          // ç”¨é‡èŒƒå›´
          this.DosageSection()

          // åŸæ–™æè¿°/å¤‡æ³¨
          this.DescriptionSection()

          // ä¿å­˜æŒ‰é’®
          Button('ä¿å­˜åŸæ–™')
            .width('100%')
            .height(48)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .backgroundColor(this.isSaving ? ThemeColors.TEXT_MUTED : ThemeColors.PRIMARY)
            .fontColor(ThemeColors.TEXT_PRIMARY)
            .margin({ top: 16, bottom: 32 })
            .enabled(!this.isSaving)
            .onClick(() => this.saveIngredient())
        }
        .padding(16)
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)

      // é±¼ç§é€‰æ‹©å¼¹çª—
      if (this.showFishPicker) {
        this.FishPickerDialog()
      }

      // Toast æç¤º
      if (this.showToast) {
        Column() {
          Text(this.toastMessage)
            .fontSize(14)
            .fontColor(Color.White)
            .padding({ left: 16, right: 16, top: 10, bottom: 10 })
            .backgroundColor('rgba(0, 0, 0, 0.7)')
            .borderRadius(20)
        }
        .width('100%')
        .position({ x: 0, y: '40%' })
        .justifyContent(FlexAlign.Center)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(ThemeColors.BG_PRIMARY)
  }

  @Builder
  NavBar() {
    Row() {
      Text('â†?)
        .fontSize(24)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .onClick(() => router.back())
        .padding(8)

      Text('æ·»åŠ åŸæ–™')
        .fontSize(ThemeConstants.FONT_SIZE_LG)
        .fontWeight(FontWeight.Bold)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      Text('')
        .width(40)
    }
    .width('100%')
    .height(56)
    .padding({ left: 8, right: 16 })
    .margin({ top: 44 })
    .backgroundColor(ThemeColors.BG_SECONDARY)
  }

  @Builder
  NameSection() {
    Column({ space: 8 }) {
      Text('åŸæ–™åç§° *')
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .fontWeight(FontWeight.Medium)

      TextInput({ placeholder: 'è¯·è¾“å…¥åŸæ–™åç§?, text: this.ingredientName })
        .width('100%')
        .height(48)
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .backgroundColor(ThemeColors.BG_CARD)
        .borderRadius(ThemeConstants.RADIUS_SM)
        .padding({ left: 12, right: 12 })
        .onChange((value: string) => {
          this.ingredientName = value;
        })
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  CategorySection() {
    Column({ space: 8 }) {
      Text('åŸæ–™åˆ†ç±» *')
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .fontWeight(FontWeight.Medium)

      Column({ space: 8 }) {
        Row({ space: 8 }) {
          ForEach(this.categories.slice(0, 3), (cat: IngredientCategoryItem) => {
            this.CategoryItem(cat)
          })
        }
        .width('100%')

        Row({ space: 8 }) {
          ForEach(this.categories.slice(3, 6), (cat: IngredientCategoryItem) => {
            this.CategoryItem(cat)
          })
        }
        .width('100%')

        Row({ space: 8 }) {
          ForEach(this.categories.slice(6, 9), (cat: IngredientCategoryItem) => {
            this.CategoryItem(cat)
          })
        }
        .width('100%')
      }
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  CategoryItem(cat: IngredientCategoryItem) {
    Column({ space: 4 }) {
      Text(cat.icon)
        .fontSize(24)

      Text(cat.name)
        .fontSize(ThemeConstants.FONT_SIZE_XS)
        .fontColor(this.selectedCategory === cat.id ? ThemeColors.PRIMARY : ThemeColors.TEXT_SECONDARY)
    }
    .layoutWeight(1)
    .padding({ top: 12, bottom: 12 })
    .backgroundColor(this.selectedCategory === cat.id ? 'rgba(232, 168, 73, 0.15)' : ThemeColors.BG_CARD)
    .borderRadius(ThemeConstants.RADIUS_SM)
    .border({
      width: 1,
      color: this.selectedCategory === cat.id ? ThemeColors.PRIMARY : Color.Transparent
    })
    .onClick(() => {
      this.selectedCategory = cat.id;
      // é‡ç½®å­åˆ†ç±?
      const subs = this.subCategories[cat.id];
      if (subs && subs.length > 0) {
        this.selectedSubCategory = subs[0].id;
      }
    })
  }

  // è·å–å½“å‰åˆ†ç±»çš„å­åˆ†ç±»
  private getCurrentSubCategories(): SubCategoryItem[] {
    return this.subCategories[this.selectedCategory] || [];
  }

  @Builder
  SubCategorySection() {
    Column({ space: 8 }) {
      Text('å­åˆ†ç±?)
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .fontWeight(FontWeight.Medium)

      Flex({ wrap: FlexWrap.Wrap }) {
        ForEach(this.getCurrentSubCategories(), (sub: SubCategoryItem) => {
          Text(sub.name)
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(this.selectedSubCategory === sub.id ? ThemeColors.PRIMARY : ThemeColors.TEXT_SECONDARY)
            .padding({ left: 12, right: 12, top: 6, bottom: 6 })
            .margin({ right: 8, bottom: 8 })
            .backgroundColor(this.selectedSubCategory === sub.id ? 'rgba(232, 168, 73, 0.15)' : ThemeColors.BG_CARD)
            .borderRadius(ThemeConstants.RADIUS_FULL)
            .border({
              width: 1,
              color: this.selectedSubCategory === sub.id ? ThemeColors.PRIMARY : Color.Transparent
            })
            .onClick(() => {
              this.selectedSubCategory = sub.id;
            })
        })
      }
      .width('100%')
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  TargetFishSection() {
    Column({ space: 8 }) {
      Text('é€‚ç”¨é±¼ç§ *')
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .fontWeight(FontWeight.Medium)

      Row() {
        if (this.selectedFishIds.length === 0) {
          Text('ç‚¹å‡»é€‰æ‹©é€‚ç”¨é±¼ç§')
            .fontSize(ThemeConstants.FONT_SIZE_BASE)
            .fontColor(ThemeColors.TEXT_HINT)
        } else {
          Text(this.getSelectedFishNames())
            .fontSize(ThemeConstants.FONT_SIZE_BASE)
            .fontColor(ThemeColors.TEXT_PRIMARY)
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }
        Blank()
        Text('>')
          .fontSize(16)
          .fontColor(ThemeColors.TEXT_MUTED)
      }
      .width('100%')
      .height(48)
      .padding({ left: 12, right: 12 })
      .backgroundColor(ThemeColors.BG_CARD)
      .borderRadius(ThemeConstants.RADIUS_SM)
      .onClick(() => {
        this.showFishPicker = true;
      })
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  SeasonSection() {
    Column({ space: 8 }) {
      Text('é€‚ç”¨å­£èŠ‚')
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .fontWeight(FontWeight.Medium)

      Row({ space: 8 }) {
        ForEach(this.seasons, (season: SeasonItem) => {
          Text(season.name)
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(this.selectedSeasons.includes(season.id) ? ThemeColors.PRIMARY : ThemeColors.TEXT_SECONDARY)
            .padding({ left: 12, right: 12, top: 6, bottom: 6 })
            .backgroundColor(this.selectedSeasons.includes(season.id) ? 'rgba(232, 168, 73, 0.15)' : ThemeColors.BG_CARD)
            .borderRadius(ThemeConstants.RADIUS_FULL)
            .border({
              width: 1,
              color: this.selectedSeasons.includes(season.id) ? ThemeColors.PRIMARY : Color.Transparent
            })
            .onClick(() => {
              if (this.selectedSeasons.includes(season.id)) {
                // è‡³å°‘ä¿ç•™ä¸€ä¸ªå­£èŠ?
                if (this.selectedSeasons.length > 1) {
                  const idx = this.selectedSeasons.indexOf(season.id);
                  this.selectedSeasons.splice(idx, 1);
                  this.selectedSeasons = this.selectedSeasons.slice();
                }
              } else {
                this.selectedSeasons.push(season.id);
                this.selectedSeasons = this.selectedSeasons.slice();
              }
            })
        })
      }
      .width('100%')
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  PhysicalSection() {
    Column({ space: 12 }) {
      Text('ç‰©ç†ç‰¹æ€?)
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .fontWeight(FontWeight.Medium)

      // é›¾åŒ–æ€?
      Column({ space: 4 }) {
        Row() {
          Text('é›¾åŒ–æ€?)
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.TEXT_PRIMARY)
          Blank()
          Text(this.getPhysicalLabel(this.atomization))
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.PRIMARY_DARK)
        }
        .width('100%')

        Slider({ value: this.atomization, min: 1, max: 10, step: 1, style: SliderStyle.OutSet })
          .width('100%')
          .blockColor(ThemeColors.PRIMARY)
          .trackColor(ThemeColors.BG_TERTIARY)
          .selectedColor(ThemeColors.PRIMARY)
          .onChange((value: number) => { this.atomization = Math.round(value); })
      }
      .width('100%')

      // ç²˜åº¦
      Column({ space: 4 }) {
        Row() {
          Text('ç²˜åº¦')
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.TEXT_PRIMARY)
          Blank()
          Text(this.getPhysicalLabel(this.viscosity))
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.PRIMARY_DARK)
        }
        .width('100%')

        Slider({ value: this.viscosity, min: 1, max: 10, step: 1, style: SliderStyle.OutSet })
          .width('100%')
          .blockColor(ThemeColors.PRIMARY)
          .trackColor(ThemeColors.BG_TERTIARY)
          .selectedColor(ThemeColors.PRIMARY)
          .onChange((value: number) => { this.viscosity = Math.round(value); })
      }
      .width('100%')

      // æ¯”é‡
      Column({ space: 4 }) {
        Row() {
          Text('æ¯”é‡')
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.TEXT_PRIMARY)
          Blank()
          Text(this.getPhysicalLabel(this.weight))
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.PRIMARY_DARK)
        }
        .width('100%')

        Slider({ value: this.weight, min: 1, max: 10, step: 1, style: SliderStyle.OutSet })
          .width('100%')
          .blockColor(ThemeColors.PRIMARY)
          .trackColor(ThemeColors.BG_TERTIARY)
          .selectedColor(ThemeColors.PRIMARY)
          .onChange((value: number) => { this.weight = Math.round(value); })
      }
      .width('100%')
    }
    .width('100%')
    .padding(12)
    .backgroundColor(ThemeColors.BG_CARD)
    .borderRadius(ThemeConstants.RADIUS_SM)
    .alignItems(HorizontalAlign.Start)
  }

  private getPhysicalLabel(value: number): string {
    if (value <= 2) return 'å¾ˆä½';
    if (value <= 4) return 'è¾ƒä½';
    if (value <= 6) return 'ä¸­ç­‰';
    if (value <= 8) return 'è¾ƒé«˜';
    return 'å¾ˆé«˜';
  }

  @Builder
  DosageSection() {
    Column({ space: 8 }) {
      Text('å»ºè®®ç”¨é‡')
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .fontWeight(FontWeight.Medium)

      Row({ space: 8 }) {
        TextInput({ placeholder: 'æœ€å°?, text: this.dosageMin.toString() })
          .width(80)
          .height(40)
          .fontSize(ThemeConstants.FONT_SIZE_SM)
          .backgroundColor(ThemeColors.BG_CARD)
          .borderRadius(ThemeConstants.RADIUS_SM)
          .textAlign(TextAlign.Center)
          .type(InputType.Number)
          .onChange((value: string) => {
            const num = parseInt(value);
            if (!isNaN(num) && num >= 0) this.dosageMin = num;
          })

        Text('~')
          .fontSize(ThemeConstants.FONT_SIZE_BASE)
          .fontColor(ThemeColors.TEXT_SECONDARY)

        TextInput({ placeholder: 'æœ€å¤?, text: this.dosageMax.toString() })
          .width(80)
          .height(40)
          .fontSize(ThemeConstants.FONT_SIZE_SM)
          .backgroundColor(ThemeColors.BG_CARD)
          .borderRadius(ThemeConstants.RADIUS_SM)
          .textAlign(TextAlign.Center)
          .type(InputType.Number)
          .onChange((value: string) => {
            const num = parseInt(value);
            if (!isNaN(num) && num >= 0) this.dosageMax = num;
          })

        Text('å…?)
          .fontSize(ThemeConstants.FONT_SIZE_BASE)
          .fontColor(ThemeColors.TEXT_SECONDARY)
      }
      .width('100%')
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  DescriptionSection() {
    Column({ space: 8 }) {
      Text('å¤‡æ³¨è¯´æ˜')
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .fontWeight(FontWeight.Medium)

      TextArea({ placeholder: 'æè¿°åŸæ–™çš„ç‰¹ç‚¹ã€ä½¿ç”¨æŠ€å·§ç­‰', text: this.description })
        .width('100%')
        .height(80)
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .backgroundColor(ThemeColors.BG_CARD)
        .borderRadius(ThemeConstants.RADIUS_SM)
        .padding(12)
        .onChange((value: string) => {
          this.description = value;
        })
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  FishPickerDialog() {
    Stack() {
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0,0,0,0.5)')
        .onClick(() => { this.showFishPicker = false; })

      Column() {
        Row() {
          Text('é€‰æ‹©é€‚ç”¨é±¼ç§')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor(ThemeColors.TEXT_PRIMARY)
          Blank()
          Text('å®Œæˆ')
            .fontSize(16)
            .fontColor(ThemeColors.PRIMARY_DARK)
            .onClick(() => { this.showFishPicker = false; })
        }
        .width('100%')
        .padding({ bottom: 12 })

        Scroll() {
          Column({ space: 8 }) {
            // ç³»ç»Ÿé±¼ç§
            ForEach(ALL_FISH_DATA, (fish: FishData) => {
              Row() {
                Image(fish.icon)
                  .width(32)
                  .height(32)
                  .borderRadius(16)
                  .margin({ right: 12 })

                Text(fish.name)
                  .fontSize(16)
                  .fontColor(ThemeColors.TEXT_PRIMARY)
                  .layoutWeight(1)

                Checkbox()
                  .select(this.selectedFishIds.includes(fish.id))
                  .selectedColor(ThemeColors.PRIMARY)
                  .onChange((checked: boolean) => {
                    if (checked) {
                      this.selectedFishIds.push(fish.id);
                    } else {
                      const idx = this.selectedFishIds.indexOf(fish.id);
                      if (idx > -1) this.selectedFishIds.splice(idx, 1);
                    }
                    this.selectedFishIds = this.selectedFishIds.slice();
                  })
              }
              .width('100%')
              .padding(10)
              .backgroundColor(ThemeColors.BG_TERTIARY)
              .borderRadius(8)
            })

            // ç”¨æˆ·è‡ªå®šä¹‰é±¼ç§?
            ForEach(userDataService.getCustomFish(), (fish: CustomFish) => {
              Row() {
                Image(fish.icon || $r('app.media.fishImage'))
                  .width(32)
                  .height(32)
                  .borderRadius(16)
                  .margin({ right: 12 })

                Row({ space: 4 }) {
                  Text(fish.name)
                    .fontSize(16)
                    .fontColor(ThemeColors.TEXT_PRIMARY)

                  Text('è‡ªå®šä¹?)
                    .fontSize(10)
                    .fontColor(ThemeColors.PRIMARY_DARK)
                    .padding({ left: 4, right: 4, top: 2, bottom: 2 })
                    .backgroundColor('rgba(232, 168, 73, 0.15)')
                    .borderRadius(4)
                }
                .layoutWeight(1)

                Checkbox()
                  .select(this.selectedFishIds.includes(fish.id))
                  .selectedColor(ThemeColors.PRIMARY)
                  .onChange((checked: boolean) => {
                    if (checked) {
                      this.selectedFishIds.push(fish.id);
                    } else {
                      const idx = this.selectedFishIds.indexOf(fish.id);
                      if (idx > -1) this.selectedFishIds.splice(idx, 1);
                    }
                    this.selectedFishIds = this.selectedFishIds.slice();
                  })
              }
              .width('100%')
              .padding(10)
              .backgroundColor(ThemeColors.BG_TERTIARY)
              .borderRadius(8)
            })
          }
        }
        .height(400)
        .scrollBar(BarState.Auto)
      }
      .width('90%')
      .padding(20)
      .backgroundColor(ThemeColors.BG_PRIMARY)
      .borderRadius(16)
    }
    .width('100%')
    .height('100%')
    .position({ x: 0, y: 0 })
  }

  private getSelectedFishNames(): string {
    return this.selectedFishIds
      .map((id: string) => {
        // å…ˆä»ç³»ç»Ÿé±¼ç§æŸ¥æ‰¾
        const fish = ALL_FISH_DATA.find((f: FishData) => f.id === id);
        if (fish) {
          return fish.name;
        }
        // å†ä»ç”¨æˆ·è‡ªå®šä¹‰é±¼ç§æŸ¥æ‰?
        const customFish = userDataService.getCustomFish().find((f: CustomFish) => f.id === id);
        if (customFish) {
          return customFish.name;
        }
        return '';
      })
      .filter((name: string) => name !== '')
      .join('ã€?);
  }

  private showToastMessage(message: string): void {
    this.toastMessage = message;
    this.showToast = true;
    setTimeout(() => { this.showToast = false; }, 2000);
  }


  private async saveIngredient(): Promise<void> {
    if (this.isSaving) return;

    // éªŒè¯åç§°
    const trimmedName = this.ingredientName.trim();
    if (!trimmedName) {
      this.showToastMessage('è¯·è¾“å…¥åŸæ–™åç§?);
      return;
    }

    if (trimmedName.length < 2) {
      this.showToastMessage('åŸæ–™åç§°è‡³å°‘2ä¸ªå­—ç¬?);
      return;
    }

    if (trimmedName.length > 20) {
      this.showToastMessage('åŸæ–™åç§°ä¸èƒ½è¶…è¿‡20ä¸ªå­—ç¬?);
      return;
    }

    // éªŒè¯é±¼ç§
    if (this.selectedFishIds.length === 0) {
      this.showToastMessage('è¯·é€‰æ‹©é€‚ç”¨é±¼ç§');
      return;
    }

    // éªŒè¯ç”¨é‡
    if (this.dosageMin > this.dosageMax) {
      this.showToastMessage('æœ€å°ç”¨é‡ä¸èƒ½å¤§äºæœ€å¤§ç”¨é‡?);
      return;
    }

    this.isSaving = true;

    try {
      // æ„å»ºæ‰©å±•æ•°æ®
      const physical = new PhysicalData();
      physical.atomization = this.atomization;
      physical.viscosity = this.viscosity;
      physical.weight = this.weight;

      const dosage = new DosageData();
      dosage.min = this.dosageMin;
      dosage.max = this.dosageMax;
      dosage.unit = this.dosageUnit;

      const extData = new ExtendedIngredientData();
      extData.subCategory = this.selectedSubCategory;
      extData.seasons = this.selectedSeasons.slice();
      extData.physical = physical;
      extData.dosage = dosage;

      const extendedData: string = JSON.stringify(extData);

      // ä¿å­˜åˆ?UserDataService
      await userDataService.addIngredient(
        trimmedName,
        this.selectedCategory,
        this.description.trim(),
        this.selectedFishIds.slice(),
        extendedData  // å°†æ‰©å±•æ•°æ®å­˜å…?usage å­—æ®µ
      );

      this.showToastMessage('åŸæ–™ä¿å­˜æˆåŠŸ');

      setTimeout(() => {
        router.back();
      }, 800);

    } catch (error) {
      console.error('ä¿å­˜åŸæ–™å¤±è´¥:', error);
      this.showToastMessage('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
      this.isSaving = false;
    }
  }
}
