/**
 * é¥µçŸ¥é“ - åŸæ–™æ–°å¢é¡µé¢
 * ç”¨æˆ·è‡ªå®šä¹‰æ·»åŠ é¥µæ–™åŸæ–™
 */
import { router } from '@kit.ArkUI';
import { ThemeColors } from '../theme/ThemeColors';
import { ThemeConstants } from '../theme/ThemeConstants';
import { userDataService } from '../services/UserDataService';

// åŸæ–™åˆ†ç±»ç±»
class IngredientCategory {
  id: string = '';
  name: string = '';
  icon: string = '';
}

// åˆ›å»ºåˆ†ç±»è¾…åŠ©å‡½æ•°
function makeCategory(id: string, name: string, icon: string): IngredientCategory {
  const cat = new IngredientCategory();
  cat.id = id;
  cat.name = name;
  cat.icon = icon;
  return cat;
}

@Entry
@Component
struct IngredientAddPage {
  @State ingredientName: string = '';
  @State selectedCategory: string = 'base';
  @State description: string = '';
  @State targetFish: string = '';
  @State usage: string = '';

  private categories: IngredientCategory[] = [
    makeCategory('base', 'åŸºç¡€é¥µ', 'ğŸŒ¾'),
    makeCategory('protein', 'è›‹ç™½é¥µ', 'ğŸ¦'),
    makeCategory('additive', 'æ·»åŠ å‰‚', 'ğŸ’§'),
    makeCategory('state', 'çŠ¶æ€é¥µ', 'ğŸ§Š'),
    makeCategory('binder', 'ç²˜åˆå‰‚', 'ğŸ¯'),
    makeCategory('natural', 'å¤©ç„¶é¥µ', 'ğŸŒ¿'),
    makeCategory('pellet', 'é¢—ç²’é¥µ', 'âšª'),
    makeCategory('live', 'æ´»é¥µ', 'ğŸª±'),
    makeCategory('folk', 'æ°‘é—´åæ–¹', 'ğŸ§ª')
  ];

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      this.NavBar()

      // è¡¨å•å†…å®¹
      Scroll() {
        Column({ space: 20 }) {
          // åŸæ–™åç§°
          this.NameSection()

          // åŸæ–™åˆ†ç±»
          this.CategorySection()

          // åŸæ–™æè¿°
          this.DescriptionSection()

          // é€‚ç”¨é±¼ç§
          this.TargetFishSection()

          // ä½¿ç”¨æ–¹æ³•
          this.UsageSection()

          // ä¿å­˜æŒ‰é’®
          Button('ä¿å­˜åŸæ–™')
            .width('100%')
            .height(48)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .backgroundColor(ThemeColors.PRIMARY)
            .fontColor(ThemeColors.TEXT_PRIMARY)
            .margin({ top: 16, bottom: 32 })
            .onClick(() => this.saveIngredient())
        }
        .padding(16)
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(ThemeColors.BG_PRIMARY)
  }

  @Builder
  NavBar() {
    Row() {
      Text('â†')
        .fontSize(24)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .onClick(() => router.back())
        .padding(8)

      Text('æ·»åŠ åŸæ–™')
        .fontSize(ThemeConstants.FONT_SIZE_LG)
        .fontWeight(FontWeight.Bold)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      Text('')
        .width(40)
    }
    .width('100%')
    .height(56)
    .padding({ left: 8, right: 16 })
    .backgroundColor(ThemeColors.BG_SECONDARY)
  }

  @Builder
  NameSection() {
    Column({ space: 8 }) {
      Text('åŸæ–™åç§° *')
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .fontWeight(FontWeight.Medium)

      TextInput({ placeholder: 'è¯·è¾“å…¥åŸæ–™åç§°', text: this.ingredientName })
        .width('100%')
        .height(48)
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .backgroundColor(ThemeColors.BG_CARD)
        .borderRadius(ThemeConstants.RADIUS_SM)
        .padding({ left: 12, right: 12 })
        .onChange((value: string) => {
          this.ingredientName = value;
        })
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  CategorySection() {
    Column({ space: 8 }) {
      Text('åŸæ–™åˆ†ç±» *')
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .fontWeight(FontWeight.Medium)

      this.CategorySelector()
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  DescriptionSection() {
    Column({ space: 8 }) {
      Text('åŸæ–™æè¿°')
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .fontWeight(FontWeight.Medium)

      TextArea({ placeholder: 'æè¿°åŸæ–™çš„ç‰¹ç‚¹ã€æ¥æºç­‰', text: this.description })
        .width('100%')
        .height(100)
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .backgroundColor(ThemeColors.BG_CARD)
        .borderRadius(ThemeConstants.RADIUS_SM)
        .padding(12)
        .onChange((value: string) => {
          this.description = value;
        })
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  TargetFishSection() {
    Column({ space: 8 }) {
      Text('é€‚ç”¨é±¼ç§')
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .fontWeight(FontWeight.Medium)

      TextInput({ placeholder: 'å¦‚ï¼šé²«é±¼ã€é²¤é±¼ï¼ˆå¤šä¸ªç”¨é¡¿å·åˆ†éš”ï¼‰', text: this.targetFish })
        .width('100%')
        .height(48)
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .backgroundColor(ThemeColors.BG_CARD)
        .borderRadius(ThemeConstants.RADIUS_SM)
        .padding({ left: 12, right: 12 })
        .onChange((value: string) => {
          this.targetFish = value;
        })
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  UsageSection() {
    Column({ space: 8 }) {
      Text('ä½¿ç”¨æ–¹æ³•')
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .fontWeight(FontWeight.Medium)

      TextArea({ placeholder: 'æè¿°å¦‚ä½•ä½¿ç”¨è¿™ç§åŸæ–™', text: this.usage })
        .width('100%')
        .height(80)
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .backgroundColor(ThemeColors.BG_CARD)
        .borderRadius(ThemeConstants.RADIUS_SM)
        .padding(12)
        .onChange((value: string) => {
          this.usage = value;
        })
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  CategorySelector() {
    Column({ space: 8 }) {
      // ç¬¬ä¸€è¡Œ 3ä¸ª
      Row({ space: 8 }) {
        ForEach(this.categories.slice(0, 3), (cat: IngredientCategory) => {
          this.CategoryItem(cat)
        })
      }
      .width('100%')

      // ç¬¬äºŒè¡Œ 3ä¸ª
      Row({ space: 8 }) {
        ForEach(this.categories.slice(3, 6), (cat: IngredientCategory) => {
          this.CategoryItem(cat)
        })
      }
      .width('100%')

      // ç¬¬ä¸‰è¡Œ 3ä¸ª
      Row({ space: 8 }) {
        ForEach(this.categories.slice(6, 9), (cat: IngredientCategory) => {
          this.CategoryItem(cat)
        })
      }
      .width('100%')
    }
    .width('100%')
  }

  @Builder
  CategoryItem(cat: IngredientCategory) {
    Column({ space: 4 }) {
      Text(cat.icon)
        .fontSize(24)

      Text(cat.name)
        .fontSize(ThemeConstants.FONT_SIZE_XS)
        .fontColor(this.selectedCategory === cat.id ? ThemeColors.PRIMARY : ThemeColors.TEXT_SECONDARY)
    }
    .layoutWeight(1)
    .padding({ top: 12, bottom: 12 })
    .backgroundColor(this.selectedCategory === cat.id ? 'rgba(232, 168, 73, 0.15)' : ThemeColors.BG_CARD)
    .borderRadius(ThemeConstants.RADIUS_SM)
    .border({
      width: 1,
      color: this.selectedCategory === cat.id ? ThemeColors.PRIMARY : Color.Transparent
    })
    .onClick(() => {
      this.selectedCategory = cat.id;
    })
  }

  private async saveIngredient(): Promise<void> {
    if (!this.ingredientName.trim()) {
      console.info('è¯·è¾“å…¥åŸæ–™åç§°');
      return;
    }

    // è§£æç›®æ ‡é±¼ç§
    const fishList: string[] = [];
    const parts = this.targetFish.split(/[ã€,ï¼Œ]/);
    for (let i = 0; i < parts.length; i++) {
      const s = parts[i].trim();
      if (s.length > 0) {
        fishList.push(s);
      }
    }

    // ä¿å­˜åˆ° UserDataService
    await userDataService.addIngredient(
      this.ingredientName.trim(),
      this.selectedCategory,
      this.description.trim(),
      fishList,
      this.usage.trim()
    );

    console.info('åŸæ–™ä¿å­˜æˆåŠŸ:', this.ingredientName);
    router.back();
  }
}
