/**
 * é¥µçŸ¥é“ - é…æ–¹è¯¦æƒ…é¡µ
 * å‚è€ƒè®¾è®¡å›¾é‡æ–°è®¾è®¡
 */
import { ThemeColors } from '../theme/ThemeColors';
import { ThemeConstants } from '../theme/ThemeConstants';
import { Router } from '../router/Router';

// é…æ–¹ææ–™æŽ¥å£
interface RecipeIngredient {
  name: string;
  amount: string;
  unit: string;
}

// é…æ–¹è¯¦æƒ…æŽ¥å£
interface RecipeDetail {
  id: string;
  name: string;
  description: string;
  targetFish: string[];
  waterTypes: string[];
  seasons: string[];
  difficulty: string;
  prepTime: string;
  ingredients: RecipeIngredient[];
  steps: string[];
  tips: string[];
  rating: number;
  usageCount: number;
  // å‘³åž‹ç‰¹ç‚¹
  flavorPrimary: string;
  flavorIntensity: number;
  suitableTemp: string;
  // çŠ¶æ€ç‰¹æ€§
  atomization: number;
  viscosity: number;
  hookHolding: number;
  weight: number;
  // æŽ¨èç†ç”±
  reasons: RecommendReason[];
}

interface RecommendReason {
  title: string;
  description: string;
}

@Entry
@Component
struct RecipeDetailPage {
  @State recipe: RecipeDetail = {
    id: 'recipe_001',
    name: 'ç»å…¸çŽ‰ç±³é…’é¦™é¥µ',
    description: 'ä¸“ä¸ºæ°´åº“æ¹–æ³Šé’“é²¤é±¼è®¾è®¡ï¼Œé…’é¦™å‘³åž‹ï¼Œé€‚åˆ15-25Â°Cæ°´æ¸©ä½¿ç”¨ã€‚',
    targetFish: ['é²¤é±¼', 'è‰é±¼', 'é²«é±¼'],
    waterTypes: ['æ°´åº“', 'æ¹–æ³Š'],
    seasons: ['æ˜¥å­£', 'ç§‹å­£'],
    difficulty: 'ç®€å•',
    prepTime: '15åˆ†é’Ÿ',
    ingredients: [
      { name: 'çŽ‰ç±³ç²‰', amount: '300', unit: 'g' },
      { name: 'é¢ç²‰', amount: '100', unit: 'g' },
      { name: 'ç™½é…’', amount: '50', unit: 'ml' },
      { name: 'èœ‚èœœ', amount: '20', unit: 'ml' },
      { name: 'çŽ‰ç±³é¦™ç²¾', amount: '3', unit: 'ml' }
    ],
    steps: [
      'å°†çŽ‰ç±³ç²‰å’Œé¢ç²‰æŒ‰3:1æ¯”ä¾‹æ··åˆ',
      'åŠ å…¥é€‚é‡æ¸©æ°´ï¼Œæ…æ‹Œæˆç³ŠçŠ¶',
      'å€’å…¥ç™½é…’å’Œèœ‚èœœï¼Œå……åˆ†æ…æ‹Œ',
      'åŠ å…¥çŽ‰ç±³é¦™ç²¾ï¼Œæ‰æˆè½¯ç¡¬é€‚ä¸­çš„é¢å›¢',
      'å¯†å°é™ç½®30åˆ†é’ŸåŽä½¿ç”¨'
    ],
    tips: [
      'ç™½é…’é€‰ç”¨52åº¦ä»¥ä¸Šçš„é«˜åº¦é…’æ•ˆæžœæ›´å¥½',
      'é¢å›¢ä¸å®œå¤ªç¡¬ï¼Œå¦åˆ™å…¥æ°´åŽä¸æ˜“é›¾åŒ–',
      'å¯æ ¹æ®æ°´æ¸©è°ƒæ•´èœ‚èœœç”¨é‡ï¼Œæ°´æ¸©ä½Žå¤šåŠ '
    ],
    rating: 4.8,
    usageCount: 1256,
    flavorPrimary: 'é…’é¦™',
    flavorIntensity: 4,
    suitableTemp: '15-25Â°C',
    atomization: 3,
    viscosity: 4,
    hookHolding: 4,
    weight: 3,
    reasons: [
      { title: 'æ°´æ¸©é€‚ä¸­(18Â°C)', description: 'é…’é¦™æµ“éƒï¼Œå¿«é€Ÿè¯±é±¼' },
      { title: 'æ°´åº“æ·±æ°´çŽ¯å¢ƒ', description: 'å¢žåŠ ç²˜åº¦ï¼Œæ…¢é›¾åŒ–ç•™é±¼' },
      { title: 'ç›®æ ‡é²¤é±¼', description: 'ç”œé¦™ä¸ºä¸»ï¼Œå¤§é¢—ç²’' }
    ]
  };
  @State isFavorite: boolean = false;
  @State currentTab: number = 0;

  private tabTitles: string[] = ['æ¦‚è§ˆ', 'é…æ–™', 'æ­¥éª¤'];

  build() {
    Column() {
      this.HeaderBar()

      Scroll() {
        Column({ space: 0 }) {
          // é…æ–¹å¤´éƒ¨ä¿¡æ¯
          this.RecipeHeader()

          // Tabå¯¼èˆª
          this.TabNavigation()

          // Tabå†…å®¹
          if (this.currentTab === 0) {
            this.OverviewContent()
          } else if (this.currentTab === 1) {
            this.IngredientsContent()
          } else {
            this.StepsContent()
          }
        }
        .width('100%')
        .padding({ bottom: 100 })
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FFFBF5')
  }

  @Builder
  HeaderBar() {
    Row() {
      Row() {
        Text('â†')
          .fontSize(22)
          .fontColor(ThemeColors.TEXT_PRIMARY)
      }
      .width(40)
      .height(40)
      .justifyContent(FlexAlign.Center)
      .onClick(() => Router.back())

      Blank()

      Text('é…æ–¹è¯¦æƒ…')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor(ThemeColors.TEXT_PRIMARY)

      Blank()

      Row() {
        Text(this.isFavorite ? 'â™¥' : 'â™¡')
          .fontSize(22)
          .fontColor(this.isFavorite ? '#F44336' : ThemeColors.TEXT_PRIMARY)
      }
      .width(40)
      .height(40)
      .justifyContent(FlexAlign.Center)
      .onClick(() => { this.isFavorite = !this.isFavorite; })
    }
    .width('100%')
    .height(56)
    .padding({ left: 8, right: 8 })
    .margin({ top: 44 })
  }

  @Builder
  RecipeHeader() {
    Column({ space: 12 }) {
      // é…æ–¹åç§°å’Œè¯„åˆ†
      Row() {
        Text(this.recipe.name)
          .fontSize(22)
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeColors.TEXT_PRIMARY)
          .layoutWeight(1)

        Row({ space: 4 }) {
          Text('â˜†')
            .fontSize(18)
            .fontColor(ThemeColors.PRIMARY)
          Text(this.recipe.rating.toString())
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor(ThemeColors.PRIMARY)
        }
      }
      .width('100%')

      // é…æ–¹æè¿°
      Text(this.recipe.description)
        .fontSize(14)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .lineHeight(20)

      // æ ‡ç­¾è¡Œ
      Row({ space: 16 }) {
        this.InfoTag('â±ï¸', this.recipe.prepTime)
        this.InfoTag('ðŸ“Š', this.recipe.difficulty)
        this.InfoTag('ðŸ‘¥', `${this.recipe.usageCount}äººä½¿ç”¨`)
      }
    }
    .width('100%')
    .padding({ left: 20, right: 20, top: 16, bottom: 20 })
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  InfoTag(icon: string, text: string) {
    Row({ space: 4 }) {
      Text(icon)
        .fontSize(12)
      Text(text)
        .fontSize(12)
        .fontColor(ThemeColors.TEXT_SECONDARY)
    }
    .padding({ left: 10, right: 10, top: 6, bottom: 6 })
    .backgroundColor(Color.White)
    .borderRadius(16)
  }

  @Builder
  TabNavigation() {
    Row({ space: 0 }) {
      ForEach(this.tabTitles, (title: string, index: number) => {
        Column() {
          Text(title)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor(this.currentTab === index ? ThemeColors.PRIMARY : '#999999')
        }
        .layoutWeight(1)
        .height(44)
        .justifyContent(FlexAlign.Center)
        .backgroundColor(this.currentTab === index ? Color.White : Color.Transparent)
        .borderRadius(22)
        .onClick(() => { this.currentTab = index; })
      })
    }
    .width('100%')
    .height(52)
    .padding({ left: 20, right: 20 })
    .backgroundColor(Color.White)
  }

  // ========== æ¦‚è§ˆTab ==========
  @Builder
  OverviewContent() {
    Column({ space: 16 }) {
      // æ ‡ç­¾ä¿¡æ¯å¡ç‰‡
      this.TagsCard()

      // å‘³åž‹ç‰¹ç‚¹å¡ç‰‡
      this.FlavorCard()

      // çŠ¶æ€ç‰¹æ€§å¡ç‰‡
      this.StateCard()

      // æŽ¨èç†ç”±
      this.ReasonsCard()
    }
    .width('100%')
    .padding({ left: 20, right: 20, top: 16 })
  }

  @Builder
  TagsCard() {
    Column({ space: 12 }) {
      // ç›®æ ‡é±¼ç§
      Row({ space: 12 }) {
        Row({ space: 4 }) {
          Text('ðŸŸ')
            .fontSize(14)
          Text('ç›®æ ‡é±¼ç§')
            .fontSize(14)
            .fontColor(ThemeColors.TEXT_SECONDARY)
        }
        .width(90)

        Row({ space: 8 }) {
          ForEach(this.recipe.targetFish, (fish: string) => {
            Text(fish)
              .fontSize(13)
              .fontColor(ThemeColors.PRIMARY)
              .padding({ left: 12, right: 12, top: 6, bottom: 6 })
              .borderRadius(16)
              .border({ width: 1, color: ThemeColors.PRIMARY })
          })
        }
      }
      .width('100%')

      // é€‚ç”¨æ°´åŸŸ
      Row({ space: 12 }) {
        Row({ space: 4 }) {
          Text('ðŸ’§')
            .fontSize(14)
          Text('é€‚ç”¨æ°´åŸŸ')
            .fontSize(14)
            .fontColor(ThemeColors.TEXT_SECONDARY)
        }
        .width(90)

        Row({ space: 8 }) {
          ForEach(this.recipe.waterTypes, (water: string) => {
            Text(water)
              .fontSize(13)
              .fontColor(ThemeColors.TEXT_PRIMARY)
              .padding({ left: 12, right: 12, top: 6, bottom: 6 })
              .backgroundColor(ThemeColors.BG_TERTIARY)
              .borderRadius(16)
          })
        }
      }
      .width('100%')

      // é€‚ç”¨å­£èŠ‚
      Row({ space: 12 }) {
        Row({ space: 4 }) {
          Text('ðŸ‚')
            .fontSize(14)
          Text('é€‚ç”¨å­£èŠ‚')
            .fontSize(14)
            .fontColor(ThemeColors.TEXT_SECONDARY)
        }
        .width(90)

        Row({ space: 8 }) {
          ForEach(this.recipe.seasons, (season: string) => {
            Text(season)
              .fontSize(13)
              .fontColor(ThemeColors.TEXT_PRIMARY)
              .padding({ left: 12, right: 12, top: 6, bottom: 6 })
              .backgroundColor(ThemeColors.BG_TERTIARY)
              .borderRadius(16)
          })
        }
      }
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
  }

  @Builder
  FlavorCard() {
    Column({ space: 16 }) {
      Text('å‘³åž‹ç‰¹ç‚¹')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor(ThemeColors.TEXT_PRIMARY)

      Row() {
        // ä¸»å‘³åž‹
        Column({ space: 4 }) {
          Text('ä¸»å‘³åž‹')
            .fontSize(12)
            .fontColor(ThemeColors.TEXT_MUTED)
          Text(this.recipe.flavorPrimary)
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor(ThemeColors.PRIMARY)
        }
        .layoutWeight(1)

        // æµ“åº¦
        Column({ space: 4 }) {
          Text('æµ“åº¦')
            .fontSize(12)
            .fontColor(ThemeColors.TEXT_MUTED)
          Row({ space: 3 }) {
            ForEach([1, 2, 3, 4, 5], (i: number) => {
              Circle()
                .width(8)
                .height(8)
                .fill(i <= this.recipe.flavorIntensity ? ThemeColors.PRIMARY : '#E5E5E5')
            })
          }
        }
        .layoutWeight(1)

        // é€‚ç”¨æ°´æ¸©
        Column({ space: 4 }) {
          Text('é€‚ç”¨æ°´æ¸©')
            .fontSize(12)
            .fontColor(ThemeColors.TEXT_MUTED)
          Text(this.recipe.suitableTemp)
            .fontSize(16)
            .fontColor(ThemeColors.TEXT_PRIMARY)
        }
        .layoutWeight(1)
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  StateCard() {
    Column({ space: 16 }) {
      Text('çŠ¶æ€ç‰¹æ€§')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor(ThemeColors.TEXT_PRIMARY)

      Row() {
        this.StateItem('é›¾åŒ–', this.recipe.atomization)
        this.StateItem('ç²˜åº¦', this.recipe.viscosity)
        this.StateItem('æŒé’©', this.recipe.hookHolding)
        this.StateItem('æ¯”é‡', this.recipe.weight)
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  StateItem(label: string, value: number) {
    Column({ space: 8 }) {
      Text(label)
        .fontSize(12)
        .fontColor(ThemeColors.TEXT_MUTED)

      // è¿›åº¦æ¡
      Stack({ alignContent: Alignment.Start }) {
        Row()
          .width('100%')
          .height(6)
          .borderRadius(3)
          .backgroundColor('#F0F0F0')
        Row()
          .width(`${value * 20}%`)
          .height(6)
          .borderRadius(3)
          .backgroundColor(ThemeColors.PRIMARY)
      }
      .width('100%')

      Text(`${value}/5`)
        .fontSize(11)
        .fontColor(ThemeColors.TEXT_MUTED)
    }
    .layoutWeight(1)
    .padding({ left: 4, right: 4 })
  }

  @Builder
  ReasonsCard() {
    Column({ space: 12 }) {
      Text('ä¸ºä»€ä¹ˆæŽ¨è')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor(ThemeColors.TEXT_PRIMARY)

      ForEach(this.recipe.reasons, (reason: RecommendReason, index: number) => {
        Row({ space: 12 }) {
          // ç¼–å·åœ†åœˆ
          Row() {
            Text(`${index + 1}`)
              .fontSize(12)
              .fontColor(Color.White)
          }
          .width(24)
          .height(24)
          .borderRadius(12)
          .backgroundColor(ThemeColors.PRIMARY)
          .justifyContent(FlexAlign.Center)

          Column({ space: 2 }) {
            Text(reason.title)
              .fontSize(14)
              .fontColor(ThemeColors.TEXT_PRIMARY)
            Text(reason.description)
              .fontSize(13)
              .fontColor(ThemeColors.PRIMARY)
          }
          .alignItems(HorizontalAlign.Start)
          .layoutWeight(1)
        }
        .width('100%')
        .padding(12)
        .backgroundColor('#FFF9F0')
        .borderRadius(8)
      })
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  // ========== é…æ–™Tab ==========
  @Builder
  IngredientsContent() {
    Column({ space: 16 }) {
      // ææ–™æ¸…å•æ ‡é¢˜
      Row({ space: 8 }) {
        Text('ðŸ“¦')
          .fontSize(18)
        Text('ææ–™æ¸…å•')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor(ThemeColors.TEXT_PRIMARY)
      }
      .width('100%')
      .padding({ left: 4 })

      // ææ–™åˆ—è¡¨
      Column({ space: 0 }) {
        ForEach(this.recipe.ingredients, (item: RecipeIngredient, index: number) => {
          Row() {
            Text(item.name)
              .fontSize(15)
              .fontColor(ThemeColors.TEXT_PRIMARY)
            Blank()
            Text(`${item.amount}${item.unit}`)
              .fontSize(15)
              .fontColor(ThemeColors.PRIMARY)
          }
          .width('100%')
          .padding({ top: 16, bottom: 16, left: 16, right: 16 })
          .border({
            width: { bottom: index < this.recipe.ingredients.length - 1 ? 1 : 0 },
            color: '#F5F5F5'
          })
        })
      }
      .width('100%')
      .backgroundColor(Color.White)
      .borderRadius(12)
    }
    .width('100%')
    .padding({ left: 20, right: 20, top: 16 })
  }

  // ========== æ­¥éª¤Tab ==========
  @Builder
  StepsContent() {
    Column({ space: 16 }) {
      // åˆ¶ä½œæ­¥éª¤
      Column({ space: 16 }) {
        Row({ space: 8 }) {
          Text('ðŸ“')
            .fontSize(18)
          Text('åˆ¶ä½œæ­¥éª¤')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor(ThemeColors.TEXT_PRIMARY)
        }
        .width('100%')

        ForEach(this.recipe.steps, (step: string, index: number) => {
          Row({ space: 12 }) {
            // æ­¥éª¤ç¼–å·
            Row() {
              Text(`${index + 1}`)
                .fontSize(14)
                .fontWeight(FontWeight.Medium)
                .fontColor(Color.White)
            }
            .width(28)
            .height(28)
            .borderRadius(14)
            .backgroundColor(ThemeColors.PRIMARY)
            .justifyContent(FlexAlign.Center)

            Text(step)
              .fontSize(14)
              .fontColor(ThemeColors.TEXT_PRIMARY)
              .lineHeight(20)
              .layoutWeight(1)
          }
          .width('100%')
          .padding({ top: 8, bottom: 8 })
          .alignItems(VerticalAlign.Top)
        })
      }
      .width('100%')
      .padding(16)
      .backgroundColor(Color.White)
      .borderRadius(12)
      .alignItems(HorizontalAlign.Start)

      // ä½¿ç”¨æŠ€å·§
      Column({ space: 12 }) {
        Row({ space: 8 }) {
          Text('ðŸ’¡')
            .fontSize(18)
          Text('ä½¿ç”¨æŠ€å·§')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor(ThemeColors.TEXT_PRIMARY)
        }
        .width('100%')

        Column({ space: 8 }) {
          ForEach(this.recipe.tips, (tip: string) => {
            Row({ space: 8 }) {
              Text('â€¢')
                .fontSize(14)
                .fontColor(ThemeColors.PRIMARY)
              Text(tip)
                .fontSize(13)
                .fontColor(ThemeColors.TEXT_SECONDARY)
                .layoutWeight(1)
                .lineHeight(18)
            }
            .width('100%')
          })
        }
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#FFF9F0')
      .borderRadius(12)
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .padding({ left: 20, right: 20, top: 16 })
  }
}
