/**
 * é¥µçŸ¥é?- é¦–é¡µ
 * å¤©æ°”ä¿¡æ¯ã€å¿«é€Ÿé…æ–¹ç”Ÿæˆã€é™„è¿‘æ¸”ç‚?
 */
import { ThemeColors } from '../theme/ThemeColors';
import { ThemeConstants } from '../theme/ThemeConstants';
import { AppConstants } from '../common/constants/AppConstants';
import { router } from '@kit.ArkUI';
import { FishingSpotService } from '../services/FishingSpotService';
import { FishingSpot, BaitInfo, WaterTypeNames, WaterTypeImages } from '../data/FishingSpotData';
import { LocationService } from '../services/LocationService';
import { WeatherData, FishingIndex, fetchWeather, calculateFishingIndex } from '../services/WeatherService';
import { ALL_FISH_DATA, FishData, getFishByWaterType } from '../data/FishData';
import { userDataService, CustomFish } from '../services/UserDataService';
import { site } from '@kit.MapKit';

// æ°´åŸŸé€‰é¡¹æ¥å£
interface WaterOption {
  type: string;
  label: string;
  icon: Resource;
  iconActive: Resource;
}

// æ¨èé…æ–¹ç®€åŒ–ç»“æ?
class RecommendRecipe {
  id: string = '';
  name: string = '';
  targetFish: string = '';
  ingredients: string[] = [];
  tags: string[] = [];
  catchRate: number = 0;

  constructor() {}
}

@Component
export struct HomePage {
  @State selectedFish: string = 'crucian';
  @State selectedWater: string = AppConstants.WATER_RIVER;
  @State temperature: number = 0;
  @State weather: string = '--';
  @State city: string = 'å®šä½ä¸?..';
  @State windInfo: string = '-- --';
  @State pressure: number = 0;
  @State fishingIndex: FishingIndex = { level: 'æœªçŸ¥', color: '#999999', description: 'åŠ è½½ä¸?..' };
  @State isLoadingWeather: boolean = true;
  @State fishingSpots: FishingSpot[] = [];
  @State isLoadingSpots: boolean = false;
  @State showBaitDialog: boolean = false;
  @State selectedSpot: FishingSpot | null = null;
  @State recommendedBaits: BaitInfo[] = [];
  @State recommendedRecipes: RecommendRecipe[] = [];
  @State showFishPicker: boolean = false;
  @State currentFishList: FishData[] = [];  // å½“å‰æ°´åŸŸçš„é±¼ç§åˆ—è¡¨ï¼ˆç¼“å­˜ï¼?

  // æ°´åŸŸé€‰é¡¹ï¼ˆå››å¤§ç±»ï¼šæ± å¡˜ã€æ²³æµã€æ°´åº“ã€æ¹–æ³Šï¼‰
  private waterOptions: WaterOption[] = [
    { type: AppConstants.WATER_POND, label: 'æ± å¡˜', icon: $r('app.media.Pond'), iconActive: $r('app.media.Ponds') },
    { type: AppConstants.WATER_RIVER, label: 'æ²³æµ', icon: $r('app.media.River'), iconActive: $r('app.media.Rivers') },
    { type: AppConstants.WATER_RESERVOIR, label: 'æ°´åº“', icon: $r('app.media.Reservoir'), iconActive: $r('app.media.Reservoirs') },
    { type: AppConstants.WATER_LAKE, label: 'æ¹–æ³Š', icon: $r('app.media.Lake'), iconActive: $r('app.media.Lakes') }
  ];

  // é…æ–¹åº“æ•°æ®ï¼ˆæŒ‰æ°´åŸŸåˆ†ç±»ï¼‰
  private recipeDatabase: Map<string, RecommendRecipe[]> = new Map();

  // é¢„ç¼“å­˜å„æ°´åŸŸé±¼ç§ï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰
  private waterFishCache: Record<string, FishData[]> = {};

  // æ›´æ–°å½“å‰æ°´åŸŸçš„é±¼ç§åˆ—è¡?
  private updateCurrentFishList(): void {
    if (!this.waterFishCache[this.selectedWater]) {
      this.waterFishCache[this.selectedWater] = getFishByWaterType(this.selectedWater);
    }
    this.currentFishList = this.waterFishCache[this.selectedWater];
  }

  aboutToAppear(): void {
    // åˆå§‹åŒ–é…æ–¹æ•°æ®åº“
    this.initRecipeDatabase();

    // åˆå§‹åŒ–é±¼ç§åˆ—è¡?
    this.updateCurrentFishList();

    // åŠ è½½ç¼“å­˜çš„é’“ç‚¹æ•°æ?
    this.fishingSpots = FishingSpotService.cachedSpots;

    // æ ¹æ®é™„è¿‘æ¸”ç‚¹è‡ªåŠ¨é€‰æ‹©æœ€å¤šçš„æ°´åŸŸç±»å‹
    this.autoSelectWaterType();

    // å¦‚æœæ²¡æœ‰ç¼“å­˜ï¼Œä¸»åŠ¨æœç´¢ï¼ˆç­‰å¾…å®šä½å®Œæˆåå†æœç´¢ï¼?
    if (this.fishingSpots.length === 0) {
      this.loadNearbySpots();
    }

    // åŠ è½½å¤©æ°”æ•°æ®
    this.loadWeather();
  }

  // åˆå§‹åŒ–é…æ–¹æ•°æ®åº“
  private initRecipeDatabase(): void {
    // æ± å¡˜é…æ–¹
    const pondRecipes: RecommendRecipe[] = [];
    pondRecipes.push(this.createRecipe('r_001', 'æ± å¡˜é²«é±¼æ•£ç‚®', 'é²«é±¼', ['éº¸çš®', 'é›ªèŠ±ç²?, 'æ‹‰ä¸ç²?], ['æ˜¥å­£', 'æµ…æ°´'], 88));
    pondRecipes.push(this.createRecipe('r_002', 'é»‘å‘é²¤é±¼é¢—ç²’', 'é²¤é±¼', ['åŸå¡˜é¢—ç²’', 'å°è¯', 'çŠ¶æ€ç²‰'], ['å››å­£', 'é»‘å‘'], 92));
    pondRecipes.push(this.createRecipe('r_003', 'æ± å¡˜è‰é±¼é’è‰é¥?, 'è‰é±¼', ['å«©è‰', 'ç‰ç±³', 'éº¦éº¸'], ['å¤å­£', 'æµ®é’“'], 85));
    pondRecipes.push(this.createRecipe('r_004', 'æ± å¡˜é³™é±¼é…¸è‡­é¥?, 'é³™é±¼', ['è‡­è±†è…æ±', 'è’œç²‰', 'é›ªèŠ±ç²?], ['å¤å­£', 'æµ®é’“'], 86));
    pondRecipes.push(this.createRecipe('r_006', 'å—æ–¹ç½—éä¸“ç”¨é¥?, 'ç½—éé±?, ['ç½—éé¢—ç²’', 'è™¾ç²‰', 'èš¯èš“è†?], ['å¤å­£', 'åº•é’“'], 82));
    pondRecipes.push(this.createRecipe('r_008', 'æ± å¡˜é²¶é±¼è…¥é¥µ', 'é²¶é±¼', ['é¸¡è‚', 'èš¯èš“', 'è¡€ç²?], ['å¤œé’“', 'åº•é’“'], 88));
    this.recipeDatabase.set('pond', pondRecipes);

    // æ²³æµé…æ–¹
    const riverRecipes: RecommendRecipe[] = [];
    riverRecipes.push(this.createRecipe('r_101', 'é‡æ²³é²«é±¼èš¯èš“ä¼´ä¾£', 'é²«é±¼', ['èš¯èš“ç²?, 'çº¢è™«', 'é…’ç±³'], ['å››å­£', 'èµ°æ°´'], 90));
    riverRecipes.push(this.createRecipe('r_102', 'æ±Ÿæ²³é²¤é±¼ç‰ç±³é¥?, 'é²¤é±¼', ['å‘é…µç‰ç±³', 'èœ‚èœœ', 'éº¦ç²’'], ['å¤ç§‹', 'æ·±æ°´'], 95));
    riverRecipes.push(this.createRecipe('r_103', 'æ²³æµè‰é±¼å«©è‰é¥?, 'è‰é±¼', ['å«©è‰', 'èŠ¦è‹‡èŠ?, 'ç‰ç±³ç²?], ['å¤å­£', 'æµ®é’“'], 85));
    riverRecipes.push(this.createRecipe('r_105', 'æ²³æµé»„é¢¡é±¼é¥µ', 'é»„é¢¡é±?, ['èš¯èš“', 'é¸¡è‚', 'çº¢è™«'], ['å¤œé’“', 'çŸ³ç¼'], 85));
    riverRecipes.push(this.createRecipe('r_106', 'æ²³æµé³Šé±¼ç´ é¥µ', 'é³Šé±¼', ['éº¸çš®', 'ç‰ç±³ç²?, 'èœ‚èœœ'], ['æ˜¥å¤', 'ä¸­å±‚'], 82));
    riverRecipes.push(this.createRecipe('r_107', 'æ²³æµç¿˜å˜´è·¯äºšé¥?, 'ç¿˜å˜´', ['äº®ç‰‡', 'æ´»è™¾', 'å°é±¼'], ['å¤ç§‹', 'è·¯äºš'], 82));
    this.recipeDatabase.set('river', riverRecipes);

    // æ°´åº“é…æ–¹
    const reservoirRecipes: RecommendRecipe[] = [];
    reservoirRecipes.push(this.createRecipe('r_201', 'æ°´åº“å¤§é²¤å®ˆé’“é¥?, 'é²¤é±¼', ['å‘é…µç‰ç±³', 'çº¢è–¯', 'è¯é…’'], ['ç§‹å­£', 'å®ˆå¤§ç‰?], 98));
    reservoirRecipes.push(this.createRecipe('r_202', 'æ°´åº“è‰é±¼æµ®é’“é¥?, 'è‰é±¼', ['å«©ç‰ç±?, 'é’è‰', 'éº¦éº¸'], ['å¤å­£', 'æµ®é’“'], 90));
    reservoirRecipes.push(this.createRecipe('r_205', 'æ°´åº“é’é±¼èºè›³é¥?, 'é’é±¼', ['ç”°èº', 'èºè›³ç²?, 'èšŒè‚‰ç²?], ['å››å­£', 'åº•é’“'], 92));
    reservoirRecipes.push(this.createRecipe('r_206', 'æ°´åº“é³œé±¼æ´»é¥µ', 'é³œé±¼', ['æ´»æ³¥é³?, 'æ´»è™¾', 'å°é±¼'], ['æ˜¥ç§‹', 'æ´»é¥µ'], 95));
    reservoirRecipes.push(this.createRecipe('r_207', 'æ°´åº“æ­¦æ˜Œé±¼ç´ é¥?, 'æ­¦æ˜Œé±?, ['éº¸çš®', 'ç‰ç±³ç²?, 'èœ‚èœœ'], ['æ˜¥å¤', 'ä¸­å±‚'], 82));
    reservoirRecipes.push(this.createRecipe('r_210', 'å—æ–¹é²®é±¼ä¸“ç”¨é¥?, 'é²®é±¼', ['èŠ±ç”Ÿç²?, 'éº¸çš®', 'ç‰ç±³ç²?], ['å¤ç§‹', 'åº•é’“'], 85));
    this.recipeDatabase.set('reservoir', reservoirRecipes);

    // æ¹–æ³Šé…æ–¹
    const lakeRecipes: RecommendRecipe[] = [];
    lakeRecipes.push(this.createRecipe('r_301', 'æ¹–æ³Šé²«é±¼ä¼ ç»Ÿé’?, 'é²«é±¼', ['é…’ç±³', 'èš¯èš“', 'çº¢è™«'], ['å››å­£', 'ä¼ ç»Ÿé’?], 90));
    lakeRecipes.push(this.createRecipe('r_302', 'æ¹–æ³Šé²¤é±¼çˆ†ç‚¸é’?, 'é²¤é±¼', ['ç³ é¥¼', 'ç‰ç±³', 'éº¦ç²’'], ['å¤ç§‹', 'æµ·ç«¿'], 92));
    lakeRecipes.push(this.createRecipe('r_304', 'æ¹–æ³Šé³œé±¼æ´»é¥µ', 'é³œé±¼', ['æ´»æ³¥é³?, 'æ´»è™¾', 'å°é±¼'], ['å¤ç§‹', 'æ´»é¥µ'], 95));
    lakeRecipes.push(this.createRecipe('r_305', 'æ¹–æ³Šé’é±¼èºè›³é¥?, 'é’é±¼', ['ç”°èº', 'èºè›³ç²?, 'èšŒè‚‰'], ['å¤ç§‹', 'åº•é’“'], 90));
    lakeRecipes.push(this.createRecipe('r_306', 'æ¹–æ³Šé»‘é±¼é›·è›™', 'é»‘é±¼', ['é›·è›™', 'è½¯è™«', 'æ³¥é³…'], ['å¤å­£', 'è·¯äºš'], 85));
    lakeRecipes.push(this.createRecipe('r_315', 'æ¹–æ³Šé³Šé±¼ç´ é¥µ', 'é³Šé±¼', ['éº¸çš®', 'ç‰ç±³ç²?, 'æ‹‰ä¸ç²?], ['æ˜¥å¤', 'æµ®é’“'], 82));
    this.recipeDatabase.set('lake', lakeRecipes);
  }

  // åˆ›å»ºé…æ–¹å¯¹è±¡
  private createRecipe(id: string, name: string, fish: string, ings: string[], tags: string[], rate: number): RecommendRecipe {
    const r = new RecommendRecipe();
    r.id = id;
    r.name = name;
    r.targetFish = fish;
    r.ingredients = ings;
    r.tags = tags;
    r.catchRate = rate;
    return r;
  }

  // è·å–æ°´åŸŸæ¨èé…æ–¹
  private getRecipesForWater(waterType: string): RecommendRecipe[] {
    const recipes = this.recipeDatabase.get(waterType);
    if (recipes && recipes.length > 0) {
      // éšæœºæ‰“ä¹±å¹¶è¿”å›å‰3ä¸?
      const shuffled = recipes.slice();
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        const temp = shuffled[i];
        shuffled[i] = shuffled[j];
        shuffled[j] = temp;
      }
      return shuffled.slice(0, 3);
    }
    return [];
  }

  // é¡µé¢æ˜¾ç¤ºæ—¶åˆ·æ–°æ•°æ®ï¼ˆä»åœ°å›¾é¡µè¿”å›æ—¶åŒæ­¥ç¼“å­˜ï¼‰
  onPageShow(): void {
    const cachedSpots = FishingSpotService.cachedSpots;
    if (cachedSpots.length > 0 && cachedSpots.length !== this.fishingSpots.length) {
      this.fishingSpots = cachedSpots;
      this.autoSelectWaterType();
    }
  }

  // æ ¹æ®é™„è¿‘æ¸”ç‚¹è‡ªåŠ¨é€‰æ‹©æœ€å¤šçš„æ°´åŸŸç±»å‹
  private autoSelectWaterType(): void {
    if (this.fishingSpots.length === 0) return;

    // ç»Ÿè®¡å„æ°´åŸŸç±»å‹æ•°é‡?
    const waterCount: Record<string, number> = {
      'pond': 0,
      'river': 0,
      'reservoir': 0,
      'lake': 0
    };

    this.fishingSpots.forEach((spot: FishingSpot) => {
      if (waterCount[spot.waterType] !== undefined) {
        waterCount[spot.waterType]++;
      }
    });

    // æ‰¾å‡ºæ•°é‡æœ€å¤šçš„æ°´åŸŸç±»å‹
    let maxType = AppConstants.WATER_RIVER;
    let maxCount = 0;
    const types = Object.keys(waterCount);
    for (let i = 0; i < types.length; i++) {
      const t = types[i];
      if (waterCount[t] > maxCount) {
        maxCount = waterCount[t];
        maxType = t;
      }
    }

    // è®¾ç½®é€‰ä¸­çš„æ°´åŸŸç±»å?
    if (maxCount > 0 && this.selectedWater !== maxType) {
      this.selectedWater = maxType;
      this.updateCurrentFishList();
      // åŒæ—¶æ›´æ–°é±¼ç§ä¸ºè¯¥æ°´åŸŸçš„ç¬¬ä¸€ä¸?
      if (this.currentFishList.length > 0) {
        this.selectedFish = this.currentFishList[0].id;
      }
    }
  }

  // åŠ è½½å¤©æ°”æ•°æ®
  async loadWeather(): Promise<void> {
    console.info('HomePage', 'loadWeather started');
    this.isLoadingWeather = true;
    try {
      console.info('HomePage', 'Calling fetchWeather...');
      const weatherData = await fetchWeather();
      console.info('HomePage', `Weather loaded: isValid=${weatherData.isValid}, temp=${weatherData.temperature}, wind=${weatherData.windDirection} ${weatherData.windSpeed}, pressure=${weatherData.pressure}`);
      if (weatherData.isValid) {
        this.temperature = Math.round(weatherData.temperature);
        this.weather = weatherData.weatherText;
        this.windInfo = `${weatherData.windDirection} ${weatherData.windSpeed}km/h`;
        this.pressure = Math.round(weatherData.pressure);
        this.fishingIndex = calculateFishingIndex(weatherData);
        console.info('HomePage', `State updated: windInfo=${this.windInfo}, pressure=${this.pressure}`);

        // è·å–åŸå¸‚åï¼ˆé€†åœ°ç†ç¼–ç ï¼‰
        await this.fetchCityName();
      }
    } catch (err) {
      console.error('HomePage', `Load weather failed: ${err}`);
    } finally {
      this.isLoadingWeather = false;
      console.info('HomePage', 'loadWeather finished');
    }
  }

  // è·å–åŸå¸‚åç§°
  async fetchCityName(): Promise<void> {
    const location = LocationService.currentLocation;
    if (!location.isValid) {
      this.city = 'æœªçŸ¥ä½ç½®';
      return;
    }

    // æ£€æŸ¥æ˜¯å¦æ˜¯é»˜è®¤æ­¦æ±‰åæ ‡
    const isDefaultLocation = Math.abs(location.latitude - 30.5844) < 0.001 && 
                              Math.abs(location.longitude - 114.2986) < 0.001;

    try {
      const params: site.ReverseGeocodeParams = {
        location: {
          latitude: location.latitude,
          longitude: location.longitude
        },
        language: 'zh',
        radius: 100
      };

      const result = await site.reverseGeocode(params);
      if (result && result.addressComponent) {
        const addr = result.addressComponent;
        // æ˜¾ç¤º"å¸?åŒ?ï¼Œå¦‚"æ­¦æ±‰å¸?æ±Ÿå²¸åŒ?
        if (addr.adminLevel2 && addr.adminLevel3) {
          this.city = `${addr.adminLevel2} ${addr.adminLevel3}`;
        } else if (addr.adminLevel2) {
          this.city = addr.adminLevel2;
        } else if (addr.adminLevel3) {
          this.city = addr.adminLevel3;
        } else {
          // é€†åœ°ç†ç¼–ç æ²¡æœ‰è¿”å›åœ°å€ï¼Œæ ¹æ®åæ ‡åˆ¤æ–?
          this.city = isDefaultLocation ? 'æ­¦æ±‰å¸? : 'å®šä½ä¸?..';
        }
      } else {
        // æ²¡æœ‰ç»“æœï¼Œä½¿ç”¨é»˜è®?
        this.city = isDefaultLocation ? 'æ­¦æ±‰å¸? : 'å®šä½ä¸?..';
      }
    } catch (err) {
      console.error('Fetch city name failed:', err);
      // é€†åœ°ç†ç¼–ç å¤±è´¥ï¼Œæ ¹æ®åæ ‡æ˜¾ç¤º
      this.city = isDefaultLocation ? 'æ­¦æ±‰å¸? : this.getCityByCoordinates(location.latitude, location.longitude);
    }
  }

  // æ ¹æ®åæ ‡ç²—ç•¥åˆ¤æ–­åŸå¸‚ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
  private getCityByCoordinates(lat: number, lng: number): string {
    // æ­¦æ±‰å¸‚èŒƒå›´ï¼šçº¬åº¦29.97-31.37ï¼Œç»åº?13.70-115.08
    if (lat >= 29.97 && lat <= 31.37 && lng >= 113.70 && lng <= 115.08) {
      return 'æ­¦æ±‰å¸?;
    }
    // å…¶ä»–åŸå¸‚å¯ä»¥ç»§ç»­æ·»åŠ ...
    return `${lat.toFixed(2)}Â°N, ${lng.toFixed(2)}Â°E`;
  }

  // åŠ è½½é™„è¿‘é’“ç‚¹
  async loadNearbySpots(): Promise<void> {
    // å¦‚æœå®šä½è¿˜æ²¡å®Œæˆï¼Œç­‰å¾…å®šä½?
    let location = LocationService.currentLocation;
    if (!location.isValid) {
      this.isLoadingSpots = true;
      // ç­‰å¾…å®šä½å®Œæˆï¼ˆæœ€å¤šç­‰å¾?ç§’ï¼‰
      for (let i = 0; i < 10; i++) {
        await new Promise<void>((resolve) => setTimeout(resolve, 500));
        location = LocationService.currentLocation;
        if (location.isValid) break;
      }
    }

    if (!location.isValid) {
      this.isLoadingSpots = false;
      return;
    }

    this.isLoadingSpots = true;
    try {
      this.fishingSpots = await FishingSpotService.searchNearbySpots(
        location.latitude, location.longitude, 5000
      );
      FishingSpotService.updateCachedSpots(this.fishingSpots);
      // åŠ è½½å®Œæˆåè‡ªåŠ¨é€‰æ‹©æœ€å¤šçš„æ°´åŸŸç±»å‹
      this.autoSelectWaterType();
    } catch (err) {
      console.error('Load spots failed:', err);
    } finally {
      this.isLoadingSpots = false;
    }
  }

  // è·³è½¬åˆ°åœ°å›¾é¡µå¯¼èˆªï¼ˆä½¿ç”¨é«˜å¾·åœ°å›¾ï¼‰
  navigateToRoute(spot: FishingSpot): void {
    router.pushUrl({
      url: 'pages/MapPage',
      params: { 
        navigateToSpot: true,
        spotId: spot.id,
        spotName: spot.name,
        spotLat: spot.latitude,
        spotLng: spot.longitude,
        spotWaterType: spot.waterType,
        spotDistance: spot.distance
      }
    });
  }

  // ç‚¹å‡»é’“ç‚¹æ˜¾ç¤ºé…æ–¹æ¨è
  onSpotClick(spot: FishingSpot): void {
    this.selectedSpot = spot;
    this.recommendedRecipes = this.getRecipesForWater(spot.waterType);
    this.showBaitDialog = true;
  }

  private getSelectedFishName(): string {
    // å…ˆä»ç³»ç»Ÿé±¼ç§æŸ¥æ‰¾
    const fish = ALL_FISH_DATA.find((f: FishData) => f.id === this.selectedFish);
    if (fish) {
      return `${fish.name} (${fish.nameEn})`;
    }
    // å†ä»ç”¨æˆ·è‡ªå®šä¹‰é±¼ç§æŸ¥æ‰?
    const customFish = userDataService.getCustomFish().find((f: CustomFish) => f.id === this.selectedFish);
    if (customFish) {
      return customFish.nameEn ? `${customFish.name} (${customFish.nameEn})` : customFish.name;
    }
    return '';
  }

  build() {
    Stack() {
      Scroll() {
        Column({ space: ThemeConstants.SPACE_MD }) {
          // é¡¶éƒ¨æ ‡é¢˜æ ?
          this.HeaderBar()

          // å¤©æ°”å¡ç‰‡
          this.WeatherCard()

          // æ™ºèƒ½é…æ–¹åŒºåŸŸ
          this.GeneratorSection()

          // é™„è¿‘æ¸”ç‚¹
          this.NearbySpots()
        }
        .width('100%')
        .padding({ left: ThemeConstants.SPACE_MD, right: ThemeConstants.SPACE_MD, bottom: 80 })
      }
      .width('100%')
      .height('100%')
      .backgroundColor(ThemeColors.BG_PRIMARY)
      .scrollBar(BarState.Off)

      // é¥µæ–™æ¨èå¼¹çª—
      if (this.showBaitDialog && this.selectedSpot) {
        this.BaitRecommendDialog()
      }

      // é±¼ç§é€‰æ‹©å¼¹çª—
      if (this.showFishPicker) {
        this.FishPickerDialog()
      }
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  HeaderBar() {
    Row() {
      Row({ space: 8 }) {
        Image($r('app.media.hooks'))
          .width(28)
          .height(28)
        Text(AppConstants.APP_NAME)
          .fontSize(ThemeConstants.FONT_SIZE_XL)
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeColors.TEXT_PRIMARY)
      }
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .margin({ top: 44 })
  }

  @Builder
  WeatherCard() {
    Column({ space: ThemeConstants.SPACE_SM }) {
      // é’“é±¼æŒ‡æ•°
      Row({ space: 6 }) {
        Circle()
          .width(8)
          .height(8)
          .fill(this.fishingIndex.color)
        Text(`é’“é±¼æŒ‡æ•°: ${this.fishingIndex.level}`)
          .fontSize(ThemeConstants.FONT_SIZE_SM)
          .fontColor(this.fishingIndex.color)
      }
      .padding({ left: 12, right: 12, top: 6, bottom: 6 })
      .backgroundColor(this.fishingIndex.level === 'é€‚å®œ' ? 'rgba(76, 175, 80, 0.15)' :
        this.fishingIndex.level === 'ä¸€èˆ? ? 'rgba(255, 152, 0, 0.15)' : 'rgba(244, 67, 54, 0.15)')
      .borderRadius(ThemeConstants.RADIUS_FULL)

      // æ¸©åº¦å’Œå¤©æ°?
      Row() {
        Column({ space: 4 }) {
          if (this.isLoadingWeather) {
            Row() {
              LoadingProgress().width(24).height(24)
              Text('åŠ è½½ä¸?..').fontSize(14).fontColor(ThemeColors.TEXT_SECONDARY).margin({ left: 8 })
            }
          } else {
            Text(`${this.temperature}Â°C`)
              .fontSize(ThemeConstants.FONT_SIZE_4XL)
              .fontWeight(FontWeight.Bold)
              .fontColor(ThemeColors.TEXT_PRIMARY)
            Text(`${this.weather} Â· ${this.city}`)
              .fontSize(ThemeConstants.FONT_SIZE_SM)
              .fontColor(ThemeColors.TEXT_SECONDARY)
          }
        }
        .alignItems(HorizontalAlign.Start)

        Blank()

        // å¤©æ°”å›¾æ ‡
        Row() {
          Text(this.getWeatherEmoji())
            .fontSize(32)
        }
        .width(56)
        .height(56)
        .backgroundColor(ThemeColors.BG_TERTIARY)
        .borderRadius(ThemeConstants.RADIUS_BASE)
        .justifyContent(FlexAlign.Center)
      }
      .width('100%')

      // é£å‘å’Œæ°”å?
      Row({ space: ThemeConstants.SPACE_MD }) {
        // é£å‘
        Row({ space: 8 }) {
          Text('ğŸ’¨')
            .fontSize(14)
          Column({ space: 2 }) {
            Text('é£å‘')
              .fontSize(ThemeConstants.FONT_SIZE_XS)
              .fontColor(ThemeColors.TEXT_MUTED)
            Text(this.windInfo)
              .fontSize(ThemeConstants.FONT_SIZE_SM)
              .fontColor(ThemeColors.TEXT_PRIMARY)
          }
          .alignItems(HorizontalAlign.Start)
        }
        .padding({ left: 12, right: 12, top: 8, bottom: 8 })
        .backgroundColor(ThemeColors.BG_TERTIARY)
        .borderRadius(ThemeConstants.RADIUS_SM)

        // æ°”å‹
        Row({ space: 8 }) {
          Text('ğŸ“Š')
            .fontSize(14)
          Column({ space: 2 }) {
            Text('æ°”å‹')
              .fontSize(ThemeConstants.FONT_SIZE_XS)
              .fontColor(ThemeColors.TEXT_MUTED)
            Text(`${this.pressure} hPa`)
              .fontSize(ThemeConstants.FONT_SIZE_SM)
              .fontColor(ThemeColors.TEXT_PRIMARY)
          }
          .alignItems(HorizontalAlign.Start)
        }
        .padding({ left: 12, right: 12, top: 8, bottom: 8 })
        .backgroundColor(ThemeColors.BG_TERTIARY)
        .borderRadius(ThemeConstants.RADIUS_SM)
      }
      .width('100%')
      .margin({ top: 8 })
    }
    .width('100%')
    .padding(ThemeConstants.SPACE_MD)
    .linearGradient({
      direction: GradientDirection.RightBottom,
      colors: this.getWeatherGradient()
    })
    .borderRadius(ThemeConstants.RADIUS_MD)
  }

  // æ ¹æ®å¤©æ°”è·å–æ¸å˜èƒŒæ™¯è‰²ï¼ˆæŸ”å’Œç‰ˆï¼‰
  private getWeatherGradient(): [string, number][] {
    if (this.weather.includes('æ™?)) {
      return [['#E3F2FD', 0], ['#BBDEFB', 1]];  // æµ…è“
    }
    if (this.weather.includes('äº?) || this.weather.includes('å¤šäº‘')) {
      return [['#ECEFF1', 0], ['#CFD8DC', 1]];  // æµ…ç°è“?
    }
    if (this.weather.includes('é˜?)) {
      return [['#E0E0E0', 0], ['#BDBDBD', 1]];  // æµ…ç°
    }
    if (this.weather.includes('é›?)) {
      return [['#E8EAF6', 0], ['#C5CAE9', 1]];  // æµ…ç´«è“?
    }
    if (this.weather.includes('é›?)) {
      return [['#E3F2FD', 0], ['#E1F5FE', 1]];  // æµ…è“ç™?
    }
    if (this.weather.includes('é›?)) {
      return [['#EDE7F6', 0], ['#D1C4E9', 1]];  // æµ…ç´«
    }
    if (this.weather.includes('é›?) || this.weather.includes('éœ?)) {
      return [['#EFEBE9', 0], ['#D7CCC8', 1]];  // æµ…æ£•
    }
    // é»˜è®¤ - æµ…ç²‰è‰²ï¼ˆåŸæ¥çš„å¡ç‰‡è‰²ï¼?
    return [['#FFF8F0', 0], ['#FFF3E8', 1]];
  }

  // æ ¹æ®å¤©æ°”è·å–emoji
  private getWeatherEmoji(): string {
    if (this.weather.includes('æ™?)) return 'â˜€ï¸?;
    if (this.weather.includes('äº?)) return 'â›?;
    if (this.weather.includes('é˜?)) return 'â˜ï¸';
    if (this.weather.includes('é›?)) return 'ğŸŒ§ï¸?;
    if (this.weather.includes('é›?)) return 'â„ï¸';
    if (this.weather.includes('é›?)) return 'â›ˆï¸';
    if (this.weather.includes('é›?) || this.weather.includes('éœ?)) return 'ğŸŒ«ï¸?;
    return 'ğŸŒ¤ï¸?;
  }

  @Builder
  WeatherInfoItem(label: string, value: string) {
    Row({ space: 8 }) {
      Text('â†?)
        .fontSize(14)
        .fontColor(ThemeColors.TEXT_MUTED)
      Column({ space: 2 }) {
        Text(label)
          .fontSize(ThemeConstants.FONT_SIZE_XS)
          .fontColor(ThemeColors.TEXT_MUTED)
        Text(value)
          .fontSize(ThemeConstants.FONT_SIZE_SM)
          .fontColor(ThemeColors.TEXT_PRIMARY)
      }
      .alignItems(HorizontalAlign.Start)
    }
    .padding({ left: 12, right: 12, top: 8, bottom: 8 })
    .backgroundColor(ThemeColors.BG_TERTIARY)
    .borderRadius(ThemeConstants.RADIUS_SM)
  }

  @Builder
  GeneratorSection() {
    Column({ space: ThemeConstants.SPACE_MD }) {
      // æ ‡é¢˜
      Row() {
        Text('å¿«é€Ÿé…æ–?)
          .fontSize(ThemeConstants.FONT_SIZE_LG)
          .fontWeight(FontWeight.Medium)
          .fontColor(ThemeColors.TEXT_PRIMARY)
        Blank()
        Text('æŸ¥çœ‹å†å²')
          .fontSize(ThemeConstants.FONT_SIZE_SM)
          .fontColor(ThemeColors.PRIMARY_DARK)
          .onClick(() => {
            router.pushUrl({ url: 'pages/GeneratorHistoryPage' });
          })
      }
      .width('100%')

      Text('æ ¹æ®å¤©æ°”å’Œé™„è¿‘æ¸”ç‚¹ï¼Œä¸€é”®ç”Ÿæˆé…æ–¹ã€?)
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)

      // ç›®æ ‡é±¼ç§é€‰æ‹©
      Column({ space: 8 }) {
        Text('ç›®æ ‡é±¼ç§')
          .fontSize(ThemeConstants.FONT_SIZE_SM)
          .fontColor(ThemeColors.TEXT_SECONDARY)

        Row() {
          Text(this.getSelectedFishName())
            .fontSize(ThemeConstants.FONT_SIZE_BASE)
            .fontColor(ThemeColors.TEXT_PRIMARY)
          Blank()
          Text('â–?)
            .fontSize(12)
            .fontColor(ThemeColors.TEXT_MUTED)
        }
        .width('100%')
        .height(ThemeConstants.HEIGHT_MD)
        .padding({ left: 12, right: 12 })
        .backgroundColor(ThemeColors.BG_TERTIARY)
        .borderRadius(ThemeConstants.RADIUS_SM)
        .onClick(() => {
          this.showFishPicker = true;
        })
      }
      .width('100%')
      .alignItems(HorizontalAlign.Start)

      // æ°´åŸŸç±»å‹é€‰æ‹©
      Column({ space: 8 }) {
        Text('æ°´åŸŸç±»å‹')
          .fontSize(ThemeConstants.FONT_SIZE_SM)
          .fontColor(ThemeColors.TEXT_SECONDARY)

        // æ°´åŸŸæŒ‰é’® 2x2 å¸ƒå±€
        Column({ space: 8 }) {
          Row({ space: 8 }) {
            ForEach(this.waterOptions.slice(0, 2), (option: WaterOption) => {
              this.WaterTypeButton(option)
            })
          }
          .width('100%')

          Row({ space: 8 }) {
            ForEach(this.waterOptions.slice(2, 4), (option: WaterOption) => {
              this.WaterTypeButton(option)
            })
          }
          .width('100%')
        }
        .width('100%')
      }
      .width('100%')
      .alignItems(HorizontalAlign.Start)

      // ç”ŸæˆæŒ‰é’®
      Button() {
        Row({ space: 8 }) {
          Text('âœ?)
            .fontSize(16)
          Text('ä¸€é”®ç”Ÿæˆé…æ–?)
            .fontSize(ThemeConstants.FONT_SIZE_MD)
            .fontColor(ThemeColors.TEXT_PRIMARY)
            .fontWeight(FontWeight.Medium)
        }
      }
      .width('100%')
      .height(ThemeConstants.HEIGHT_LG)
      .backgroundColor(ThemeColors.PRIMARY)
      .borderRadius(ThemeConstants.RADIUS_SM)
      .margin({ top: 8 })
      .onClick(() => {
        // ç›´æ¥è·³è½¬åˆ°é…æ–¹è¯¦æƒ…é¡µï¼Œä¼ é€’é±¼ç§å’Œæ°´åŸŸå‚æ•°
        router.pushUrl({
          url: 'pages/GeneratedRecipePage',
          params: {
            fish: this.selectedFish,
            water: this.selectedWater,
            quickMode: true  // å¿«é€Ÿæ¨¡å¼æ ‡è®?
          }
        });
      })
    }
    .width('100%')
    .padding(ThemeConstants.SPACE_MD)
    .backgroundColor(ThemeColors.BG_CARD)
    .borderRadius(ThemeConstants.RADIUS_MD)
  }

  @Builder
  WaterTypeButton(option: WaterOption) {
    Row({ space: 6 }) {
      Image(this.selectedWater === option.type ? option.iconActive : option.icon)
        .width(16)
        .height(16)
        .fillColor(this.selectedWater === option.type ? ThemeColors.PRIMARY : ThemeColors.TEXT_MUTED)
      Text(option.label)
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(this.selectedWater === option.type ? ThemeColors.PRIMARY : ThemeColors.TEXT_SECONDARY)
    }
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
    .padding({ top: 10, bottom: 10 })
    .backgroundColor(this.selectedWater === option.type ? 'rgba(232, 168, 73, 0.15)' : ThemeColors.BG_TERTIARY)
    .borderRadius(ThemeConstants.RADIUS_SM)
    .border({
      width: 1,
      color: this.selectedWater === option.type ? ThemeColors.PRIMARY : Color.Transparent
    })
    .onClick(() => {
      if (this.selectedWater === option.type) return;  // é¿å…é‡å¤ç‚¹å‡»
      this.selectedWater = option.type;
      this.updateCurrentFishList();
      // åˆ‡æ¢æ°´åŸŸæ—¶ï¼Œé‡ç½®é±¼ç§ä¸ºè¯¥æ°´åŸŸçš„ç¬¬ä¸€ä¸ªé±¼ç§?
      if (this.currentFishList.length > 0 && !this.currentFishList.some((f: FishData) => f.id === this.selectedFish)) {
        this.selectedFish = this.currentFishList[0].id;
      }
    })
  }

  @Builder
  NearbySpots() {
    Column({ space: ThemeConstants.SPACE_MD }) {
      // æ ‡é¢˜
      Row() {
        Text('é™„è¿‘æ¸”ç‚¹')
          .fontSize(ThemeConstants.FONT_SIZE_LG)
          .fontWeight(FontWeight.Medium)
          .fontColor(ThemeColors.TEXT_PRIMARY)
        Blank()
        Text('åœ°å›¾æ¨¡å¼')
          .fontSize(ThemeConstants.FONT_SIZE_SM)
          .fontColor(ThemeColors.PRIMARY_DARK)
          .onClick(() => {
            router.pushUrl({ url: 'pages/MapPage' });
          })
      }
      .width('100%')

      // åŠ è½½ä¸?
      if (this.isLoadingSpots) {
        Row() {
          LoadingProgress().width(20).height(20)
          Text('æœç´¢é™„è¿‘é’“ç‚¹...').fontSize(14).fontColor(ThemeColors.TEXT_SECONDARY).margin({ left: 8 })
        }
        .width('100%')
        .padding(16)
        .justifyContent(FlexAlign.Center)
      } else if (this.fishingSpots.length === 0) {
        // æ— æ•°æ?
        Text('æš‚æ— é™„è¿‘é’“ç‚¹ï¼Œç‚¹å‡»åœ°å›¾æ¨¡å¼æœç´?)
          .fontSize(14)
          .fontColor(ThemeColors.TEXT_SECONDARY)
          .padding(16)
      } else {
        // é’“ç‚¹åˆ—è¡¨ï¼ˆæ˜¾ç¤ºæœ€å¤?0ä¸ªï¼‰
        ForEach(this.fishingSpots.slice(0, 10), (spot: FishingSpot) => {
          this.SpotCardReal(spot)
        })
      }
    }
    .width('100%')
  }

  @Builder
  SpotCardReal(spot: FishingSpot) {
    Row() {
      // ä½¿ç”¨å¸¦é¢œè‰²çš„æ²³æµå›¾æ ‡
      Image($r('app.media.River'))
        .width(36)
        .height(36)
        .margin({ right: 12 })

      Column({ space: 4 }) {
        Text(spot.name)
          .fontSize(ThemeConstants.FONT_SIZE_BASE)
          .fontWeight(FontWeight.Medium)
          .fontColor(ThemeColors.TEXT_PRIMARY)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
        Row({ space: 4 }) {
          Text('ğŸ“')
            .fontSize(12)
          Text(`${FishingSpotService.formatDistance(spot.distance || 0)} Â· ${WaterTypeNames[spot.waterType]}`)
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.TEXT_SECONDARY)
        }
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      // é¥µæ–™æ¨èæŒ‰é’®
      Row() {
        Text('ğŸ£')
          .fontSize(14)
      }
      .width(32)
      .height(32)
      .backgroundColor(ThemeColors.BG_TERTIARY)
      .borderRadius(16)
      .justifyContent(FlexAlign.Center)
      .margin({ right: 8 })
      .onClick(() => this.onSpotClick(spot))

      // å¯¼èˆªæŒ‰é’®
      Row() {
        Text('â†?)
          .fontSize(16)
          .fontColor(ThemeColors.TEXT_PRIMARY)
      }
      .width(36)
      .height(36)
      .backgroundColor(ThemeColors.PRIMARY)
      .borderRadius(18)
      .justifyContent(FlexAlign.Center)
      .onClick(() => this.navigateToRoute(spot))
    }
    .width('100%')
    .padding(ThemeConstants.SPACE_MD)
    .backgroundColor(ThemeColors.BG_CARD)
    .borderRadius(ThemeConstants.RADIUS_MD)
    .margin({ bottom: 8 })
  }

  @Builder
  SpotCard(name: string, distance: string, desc: string) {
    Row() {
      Column({ space: 4 }) {
        Text(name)
          .fontSize(ThemeConstants.FONT_SIZE_BASE)
          .fontWeight(FontWeight.Medium)
          .fontColor(ThemeColors.TEXT_PRIMARY)
        Row({ space: 4 }) {
          Text('ğŸ“')
            .fontSize(12)
          Text(`${distance} Â· ${desc}`)
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.TEXT_SECONDARY)
        }
      }
      .alignItems(HorizontalAlign.Start)

      Blank()

      Row() {
        Text('â†?)
          .fontSize(16)
          .fontColor(ThemeColors.TEXT_PRIMARY)
      }
      .width(32)
      .height(32)
      .backgroundColor(ThemeColors.PRIMARY)
      .borderRadius(16)
      .justifyContent(FlexAlign.Center)
    }
    .width('100%')
    .padding(ThemeConstants.SPACE_MD)
    .backgroundColor(ThemeColors.BG_CARD)
    .borderRadius(ThemeConstants.RADIUS_MD)
  }

  @Builder
  BaitRecommendDialog() {
    Column() {
      // é®ç½©
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0,0,0,0.5)')
        .onClick(() => { this.showBaitDialog = false })
    }
    .width('100%')
    .height('100%')
    .position({ x: 0, y: 0 })

    // å¼¹çª—å†…å®¹
    Column() {
      // æ ‡é¢˜
      Row() {
        Image(WaterTypeImages[this.selectedSpot!.waterType]?.active || $r('app.media.River'))
          .width(24)
          .height(24)
          .margin({ right: 8 })
        Text(this.selectedSpot!.name)
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeColors.TEXT_PRIMARY)
          .layoutWeight(1)
        Text('âœ?)
          .fontSize(20)
          .fontColor(ThemeColors.TEXT_SECONDARY)
          .onClick(() => { this.showBaitDialog = false })
      }
      .width('100%')
      .margin({ bottom: 8 })

      Text(`${WaterTypeNames[this.selectedSpot!.waterType]} Â· ${this.selectedSpot!.description}`)
        .fontSize(13)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .margin({ bottom: 16 })

      Divider().color('#eee').margin({ bottom: 16 })

      Text('ğŸ£ æ¨èé…æ–¹')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .margin({ bottom: 12 })

      ForEach(this.recommendedRecipes, (recipe: RecommendRecipe) => {
        Row() {
          Column() {
            Row({ space: 6 }) {
              Text(recipe.name)
                .fontSize(15)
                .fontWeight(FontWeight.Medium)
                .fontColor(ThemeColors.TEXT_PRIMARY)
              if (recipe.catchRate >= 90) {
                Text(`ğŸ”¥ ${recipe.catchRate}%`)
                  .fontSize(11)
                  .fontColor('#FF6B00')
              }
            }

            Row({ space: 4 }) {
              ForEach(recipe.tags, (tag: string) => {
                Text(tag)
                  .fontSize(10)
                  .fontColor('#666')
                  .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                  .backgroundColor('#f5f5f5')
                  .borderRadius(4)
              })
            }
            .margin({ top: 4 })

            Row({ space: 4 }) {
              ForEach(recipe.ingredients, (ing: string) => {
                Text(`â€?${ing}`)
                  .fontSize(11)
                  .fontColor(ThemeColors.TEXT_SECONDARY)
              })
            }
            .margin({ top: 4 })

            Text(`ç›®æ ‡é±? ${recipe.targetFish}`)
              .fontSize(11)
              .fontColor(ThemeColors.PRIMARY_DARK)
              .margin({ top: 4 })
          }
          .alignItems(HorizontalAlign.Start)
          .layoutWeight(1)

          // æŸ¥çœ‹è¯¦æƒ…æŒ‰é’®
          Text('â†?)
            .fontSize(16)
            .fontColor(ThemeColors.PRIMARY_DARK)
            .onClick(() => {
              this.showBaitDialog = false;
              router.pushUrl({
                url: 'pages/RecipeDetailPage',
                params: { recipeId: recipe.id }
              });
            })
        }
        .width('100%')
        .padding(12)
        .backgroundColor(ThemeColors.BG_SECONDARY)
        .borderRadius(8)
        .margin({ bottom: 8 })
      })

      // åº•éƒ¨æŒ‰é’®
      Row({ space: 12 }) {
        Button('æ¢ä¸€æ‰?)
          .layoutWeight(1)
          .height(44)
          .fontSize(14)
          .backgroundColor(ThemeColors.BG_TERTIARY)
          .fontColor(ThemeColors.TEXT_PRIMARY)
          .onClick(() => {
            this.recommendedRecipes = this.getRecipesForWater(this.selectedSpot!.waterType);
          })

        Button('å»è¿™é‡?)
          .layoutWeight(1)
          .height(44)
          .fontSize(14)
          .backgroundColor(ThemeColors.PRIMARY)
          .fontColor(Color.White)
          .onClick(() => {
            this.showBaitDialog = false;
            this.navigateToRoute(this.selectedSpot!);
          })
      }
      .width('100%')
      .margin({ top: 8 })
    }
    .width('90%')
    .padding(20)
    .backgroundColor(ThemeColors.BG_PRIMARY)
    .borderRadius(16)
    .position({ x: '5%', y: '15%' })
  }

  @Builder
  FishPickerDialog() {
    // é®ç½©å±?
    Column()
      .width('100%')
      .height('100%')
      .backgroundColor('rgba(0,0,0,0.5)')
      .position({ x: 0, y: 0 })
      .onClick(() => { this.showFishPicker = false })

    // å¼¹çª—å†…å®¹
    Column() {
      // æ ‡é¢˜
      Row() {
        Text('é€‰æ‹©ç›®æ ‡é±¼ç§')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeColors.TEXT_PRIMARY)
        Blank()
        Text('âœ?)
          .fontSize(20)
          .fontColor(ThemeColors.TEXT_SECONDARY)
          .onClick(() => { this.showFishPicker = false })
      }
      .width('100%')
      .padding({ bottom: 12 })

      // é±¼ç§åˆ—è¡¨ï¼ˆå¯æ»šåŠ¨ï¼?
      Scroll() {
        Column({ space: 8 }) {
          // ç³»ç»Ÿé±¼ç§
          ForEach(this.currentFishList, (fish: FishData) => {
            Row() {
              // é±¼å›¾ç‰?
              Image(fish.icon)
                .width(40)
                .height(40)
                .borderRadius(20)
                .margin({ right: 12 })

              Column({ space: 2 }) {
                Text(fish.name)
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .fontColor(ThemeColors.TEXT_PRIMARY)
                Text(fish.nameEn)
                  .fontSize(12)
                  .fontColor(ThemeColors.TEXT_SECONDARY)
              }
              .alignItems(HorizontalAlign.Start)
              .layoutWeight(1)

              // é€‰ä¸­æ ‡è®°
              if (this.selectedFish === fish.id) {
                Text('âœ?)
                  .fontSize(18)
                  .fontColor(ThemeColors.PRIMARY_DARK)
                  .fontWeight(FontWeight.Bold)
              }
            }
            .width('100%')
            .padding(12)
            .backgroundColor(this.selectedFish === fish.id ? 'rgba(232, 168, 73, 0.1)' : ThemeColors.BG_TERTIARY)
            .borderRadius(12)
            .border({
              width: this.selectedFish === fish.id ? 1 : 0,
              color: ThemeColors.PRIMARY
            })
            .onClick(() => {
              this.selectedFish = fish.id;
              this.showFishPicker = false;
            })
          })

          // ç”¨æˆ·è‡ªå®šä¹‰é±¼ç§ï¼ˆç­›é€‰å½“å‰æ°´åŸŸï¼‰
          ForEach(this.getCustomFishForCurrentWater(), (fish: CustomFish) => {
            Row() {
              // é±¼å›¾ç‰?
              Image(fish.icon || $r('app.media.fishImage'))
                .width(40)
                .height(40)
                .borderRadius(20)
                .margin({ right: 12 })

              Column({ space: 2 }) {
                Row({ space: 4 }) {
                  Text(fish.name)
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .fontColor(ThemeColors.TEXT_PRIMARY)

                  Text('è‡ªå®šä¹?)
                    .fontSize(10)
                    .fontColor(ThemeColors.PRIMARY_DARK)
                    .padding({ left: 4, right: 4, top: 2, bottom: 2 })
                    .backgroundColor('rgba(232, 168, 73, 0.15)')
                    .borderRadius(4)
                }
                Text(fish.nameEn || '')
                  .fontSize(12)
                  .fontColor(ThemeColors.TEXT_SECONDARY)
              }
              .alignItems(HorizontalAlign.Start)
              .layoutWeight(1)

              // é€‰ä¸­æ ‡è®°
              if (this.selectedFish === fish.id) {
                Text('âœ?)
                  .fontSize(18)
                  .fontColor(ThemeColors.PRIMARY_DARK)
                  .fontWeight(FontWeight.Bold)
              }
            }
            .width('100%')
            .padding(12)
            .backgroundColor(this.selectedFish === fish.id ? 'rgba(232, 168, 73, 0.1)' : ThemeColors.BG_TERTIARY)
            .borderRadius(12)
            .border({
              width: this.selectedFish === fish.id ? 1 : 0,
              color: ThemeColors.PRIMARY
            })
            .onClick(() => {
              this.selectedFish = fish.id;
              this.showFishPicker = false;
            })
          })
        }
        .width('100%')
      }
      .width('100%')
      .constraintSize({ maxHeight: 400 })
      .scrollBar(BarState.Auto)
    }
    .width('85%')
    .padding(20)
    .backgroundColor(ThemeColors.BG_PRIMARY)
    .borderRadius(16)
    .position({ x: '7.5%', y: '15%' })
  }

  // è·å–å½“å‰æ°´åŸŸçš„ç”¨æˆ·è‡ªå®šä¹‰é±¼ç§
  private getCustomFishForCurrentWater(): CustomFish[] {
    return userDataService.getCustomFish().filter((fish: CustomFish) =>
      fish.waterTypes.includes(this.selectedWater)
    );
  }
}
