/**
 * é¥µçŸ¥é“ - é¦–é¡µ
 * å¤©æ°”ä¿¡æ¯ã€å¿«é€Ÿé…æ–¹ç”Ÿæˆã€é™„è¿‘æ¸”ç‚¹
 */
import { ThemeColors } from '../theme/ThemeColors';
import { ThemeConstants } from '../theme/ThemeConstants';
import { AppConstants } from '../common/constants/AppConstants';
import { router } from '@kit.ArkUI';
import { FishingSpotService } from '../services/FishingSpotService';
import { FishingSpot, BaitInfo, WaterTypeNames, WaterTypeImages } from '../data/FishingSpotData';
import { LocationService } from '../services/LocationService';
import { WeatherData, FishingIndex, fetchWeather, calculateFishingIndex } from '../services/WeatherService';
import { ALL_FISH_DATA, FishData, getFishByWaterType } from '../data/FishData';
import { site } from '@kit.MapKit';

// æ°´åŸŸé€‰é¡¹æ¥å£
interface WaterOption {
  type: string;
  label: string;
  icon: Resource;
  iconActive: Resource;
}

@Component
export struct HomePage {
  @State selectedFish: string = 'crucian';
  @State selectedWater: string = AppConstants.WATER_RIVER;
  @State temperature: number = 0;
  @State weather: string = '--';
  @State city: string = 'å®šä½ä¸­...';
  @State windInfo: string = '-- --';
  @State pressure: number = 0;
  @State fishingIndex: FishingIndex = { level: 'æœªçŸ¥', color: '#999999', description: 'åŠ è½½ä¸­...' };
  @State isLoadingWeather: boolean = true;
  @State fishingSpots: FishingSpot[] = [];
  @State isLoadingSpots: boolean = false;
  @State showBaitDialog: boolean = false;
  @State selectedSpot: FishingSpot | null = null;
  @State recommendedBaits: BaitInfo[] = [];
  @State showFishPicker: boolean = false;
  @State currentFishList: FishData[] = [];  // å½“å‰æ°´åŸŸçš„é±¼ç§åˆ—è¡¨ï¼ˆç¼“å­˜ï¼‰

  // æ°´åŸŸé€‰é¡¹ï¼ˆå››å¤§ç±»ï¼šæ± å¡˜ã€æ²³æµã€æ°´åº“ã€æ¹–æ³Šï¼‰
  private waterOptions: WaterOption[] = [
    { type: AppConstants.WATER_POND, label: 'æ± å¡˜', icon: $r('app.media.Pond'), iconActive: $r('app.media.Ponds') },
    { type: AppConstants.WATER_RIVER, label: 'æ²³æµ', icon: $r('app.media.River'), iconActive: $r('app.media.Rivers') },
    { type: AppConstants.WATER_RESERVOIR, label: 'æ°´åº“', icon: $r('app.media.Reservoir'), iconActive: $r('app.media.Reservoirs') },
    { type: AppConstants.WATER_LAKE, label: 'æ¹–æ³Š', icon: $r('app.media.Lake'), iconActive: $r('app.media.Lakes') }
  ];

  // é¢„ç¼“å­˜å„æ°´åŸŸé±¼ç§ï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰
  private waterFishCache: Record<string, FishData[]> = {};

  // æ›´æ–°å½“å‰æ°´åŸŸçš„é±¼ç§åˆ—è¡¨
  private updateCurrentFishList(): void {
    if (!this.waterFishCache[this.selectedWater]) {
      this.waterFishCache[this.selectedWater] = getFishByWaterType(this.selectedWater);
    }
    this.currentFishList = this.waterFishCache[this.selectedWater];
  }

  aboutToAppear(): void {
    // åˆå§‹åŒ–é±¼ç§åˆ—è¡¨
    this.updateCurrentFishList();

    // åŠ è½½ç¼“å­˜çš„é’“ç‚¹æ•°æ®
    this.fishingSpots = FishingSpotService.cachedSpots;

    // æ ¹æ®é™„è¿‘æ¸”ç‚¹è‡ªåŠ¨é€‰æ‹©æœ€å¤šçš„æ°´åŸŸç±»å‹
    this.autoSelectWaterType();

    // å¦‚æœæ²¡æœ‰ç¼“å­˜ï¼Œä¸»åŠ¨æœç´¢
    if (this.fishingSpots.length === 0) {
      this.loadNearbySpots();
    }

    // åŠ è½½å¤©æ°”æ•°æ®
    this.loadWeather();
  }

  // æ ¹æ®é™„è¿‘æ¸”ç‚¹è‡ªåŠ¨é€‰æ‹©æœ€å¤šçš„æ°´åŸŸç±»å‹
  private autoSelectWaterType(): void {
    if (this.fishingSpots.length === 0) return;

    // ç»Ÿè®¡å„æ°´åŸŸç±»å‹æ•°é‡
    const waterCount: Record<string, number> = {
      'pond': 0,
      'river': 0,
      'reservoir': 0,
      'lake': 0
    };

    this.fishingSpots.forEach((spot: FishingSpot) => {
      if (waterCount[spot.waterType] !== undefined) {
        waterCount[spot.waterType]++;
      }
    });

    // æ‰¾å‡ºæ•°é‡æœ€å¤šçš„æ°´åŸŸç±»å‹
    let maxType = AppConstants.WATER_RIVER;
    let maxCount = 0;
    const types = Object.keys(waterCount);
    for (let i = 0; i < types.length; i++) {
      const t = types[i];
      if (waterCount[t] > maxCount) {
        maxCount = waterCount[t];
        maxType = t;
      }
    }

    // è®¾ç½®é€‰ä¸­çš„æ°´åŸŸç±»å‹
    if (maxCount > 0 && this.selectedWater !== maxType) {
      this.selectedWater = maxType;
      this.updateCurrentFishList();
      // åŒæ—¶æ›´æ–°é±¼ç§ä¸ºè¯¥æ°´åŸŸçš„ç¬¬ä¸€ä¸ª
      if (this.currentFishList.length > 0) {
        this.selectedFish = this.currentFishList[0].id;
      }
    }
  }

  // åŠ è½½å¤©æ°”æ•°æ®
  async loadWeather(): Promise<void> {
    this.isLoadingWeather = true;
    try {
      const weatherData = await fetchWeather();
      if (weatherData.isValid) {
        this.temperature = Math.round(weatherData.temperature);
        this.weather = weatherData.weatherText;
        this.windInfo = `${weatherData.windDirection} ${weatherData.windSpeed}km/h`;
        this.pressure = Math.round(weatherData.pressure);
        this.fishingIndex = calculateFishingIndex(weatherData);

        // è·å–åŸå¸‚åï¼ˆé€†åœ°ç†ç¼–ç ï¼‰
        await this.fetchCityName();
      }
    } catch (err) {
      console.error('Load weather failed:', err);
    } finally {
      this.isLoadingWeather = false;
    }
  }

  // è·å–åŸå¸‚åç§°
  async fetchCityName(): Promise<void> {
    const location = LocationService.currentLocation;
    if (!location.isValid) {
      this.city = 'æœªçŸ¥ä½ç½®';
      return;
    }

    try {
      const params: site.ReverseGeocodeParams = {
        location: {
          latitude: location.latitude,
          longitude: location.longitude
        },
        language: 'zh',
        radius: 100
      };

      const result = await site.reverseGeocode(params);
      if (result && result.addressComponent) {
        const addr = result.addressComponent;
        // æ˜¾ç¤º"å¸‚+åŒº"ï¼Œå¦‚"æ­¦æ±‰å¸‚ æ±Ÿå²¸åŒº"
        if (addr.adminLevel2 && addr.adminLevel3) {
          this.city = `${addr.adminLevel2} ${addr.adminLevel3}`;
        } else if (addr.adminLevel2) {
          this.city = addr.adminLevel2;
        } else if (addr.adminLevel3) {
          this.city = addr.adminLevel3;
        } else {
          this.city = 'å½“å‰ä½ç½®';
        }
      }
    } catch (err) {
      console.error('Fetch city name failed:', err);
      this.city = 'å½“å‰ä½ç½®';
    }
  }

  // åŠ è½½é™„è¿‘é’“ç‚¹
  async loadNearbySpots(): Promise<void> {
    const location = LocationService.currentLocation;
    if (!location.isValid) return;

    this.isLoadingSpots = true;
    try {
      this.fishingSpots = await FishingSpotService.searchNearbySpots(
        location.latitude, location.longitude, 5000
      );
      FishingSpotService.updateCachedSpots(this.fishingSpots);
      // åŠ è½½å®Œæˆåè‡ªåŠ¨é€‰æ‹©æœ€å¤šçš„æ°´åŸŸç±»å‹
      this.autoSelectWaterType();
    } catch (err) {
      console.error('Load spots failed:', err);
    } finally {
      this.isLoadingSpots = false;
    }
  }

  // è·³è½¬åˆ°è·¯çº¿è¯¦æƒ…
  navigateToRoute(spot: FishingSpot): void {
    router.pushUrl({
      url: 'pages/RouteDetailPage',
      params: { spotId: spot.id }
    });
  }

  // ç‚¹å‡»é’“ç‚¹æ˜¾ç¤ºé¥µæ–™æ¨è
  onSpotClick(spot: FishingSpot): void {
    this.selectedSpot = spot;
    this.recommendedBaits = FishingSpotService.recommendBaits(spot.waterType);
    this.showBaitDialog = true;
  }

  private getSelectedFishName(): string {
    const fish = ALL_FISH_DATA.find((f: FishData) => f.id === this.selectedFish);
    return fish ? `${fish.name} (${fish.nameEn})` : '';
  }

  build() {
    Stack() {
      Scroll() {
        Column({ space: ThemeConstants.SPACE_MD }) {
          // é¡¶éƒ¨æ ‡é¢˜æ 
          this.HeaderBar()

          // å¤©æ°”å¡ç‰‡
          this.WeatherCard()

          // æ™ºèƒ½é…æ–¹åŒºåŸŸ
          this.GeneratorSection()

          // é™„è¿‘æ¸”ç‚¹
          this.NearbySpots()
        }
        .width('100%')
        .padding({ left: ThemeConstants.SPACE_MD, right: ThemeConstants.SPACE_MD, bottom: 80 })
      }
      .width('100%')
      .height('100%')
      .backgroundColor(ThemeColors.BG_PRIMARY)
      .scrollBar(BarState.Off)

      // é¥µæ–™æ¨èå¼¹çª—
      if (this.showBaitDialog && this.selectedSpot) {
        this.BaitRecommendDialog()
      }

      // é±¼ç§é€‰æ‹©å¼¹çª—
      if (this.showFishPicker) {
        this.FishPickerDialog()
      }
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  HeaderBar() {
    Row() {
      Row({ space: 8 }) {
        Image($r('app.media.hooks'))
          .width(28)
          .height(28)
        Text(AppConstants.APP_NAME)
          .fontSize(ThemeConstants.FONT_SIZE_XL)
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeColors.TEXT_PRIMARY)
      }
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .margin({ top: 44 })
  }

  @Builder
  WeatherCard() {
    Column({ space: ThemeConstants.SPACE_SM }) {
      // é’“é±¼æŒ‡æ•°
      Row({ space: 6 }) {
        Circle()
          .width(8)
          .height(8)
          .fill(this.fishingIndex.color)
        Text(`é’“é±¼æŒ‡æ•°: ${this.fishingIndex.level}`)
          .fontSize(ThemeConstants.FONT_SIZE_SM)
          .fontColor(this.fishingIndex.color)
      }
      .padding({ left: 12, right: 12, top: 6, bottom: 6 })
      .backgroundColor(this.fishingIndex.level === 'é€‚å®œ' ? 'rgba(76, 175, 80, 0.15)' :
        this.fishingIndex.level === 'ä¸€èˆ¬' ? 'rgba(255, 152, 0, 0.15)' : 'rgba(244, 67, 54, 0.15)')
      .borderRadius(ThemeConstants.RADIUS_FULL)

      // æ¸©åº¦å’Œå¤©æ°”
      Row() {
        Column({ space: 4 }) {
          if (this.isLoadingWeather) {
            Row() {
              LoadingProgress().width(24).height(24)
              Text('åŠ è½½ä¸­...').fontSize(14).fontColor(ThemeColors.TEXT_SECONDARY).margin({ left: 8 })
            }
          } else {
            Text(`${this.temperature}Â°C`)
              .fontSize(ThemeConstants.FONT_SIZE_4XL)
              .fontWeight(FontWeight.Bold)
              .fontColor(ThemeColors.TEXT_PRIMARY)
            Text(`${this.weather} Â· ${this.city}`)
              .fontSize(ThemeConstants.FONT_SIZE_SM)
              .fontColor(ThemeColors.TEXT_SECONDARY)
          }
        }
        .alignItems(HorizontalAlign.Start)

        Blank()

        // å¤©æ°”å›¾æ ‡
        Row() {
          Text(this.getWeatherEmoji())
            .fontSize(32)
        }
        .width(56)
        .height(56)
        .backgroundColor(ThemeColors.BG_TERTIARY)
        .borderRadius(ThemeConstants.RADIUS_BASE)
        .justifyContent(FlexAlign.Center)
      }
      .width('100%')

      // é£å‘å’Œæ°”å‹
      Row({ space: ThemeConstants.SPACE_MD }) {
        this.WeatherInfoItem('é£å‘', this.windInfo)
        this.WeatherInfoItem('æ°”å‹', `${this.pressure} hPa`)
      }
      .width('100%')
      .margin({ top: 8 })
    }
    .width('100%')
    .padding(ThemeConstants.SPACE_MD)
    .backgroundColor(ThemeColors.BG_CARD)
    .borderRadius(ThemeConstants.RADIUS_MD)
  }

  // æ ¹æ®å¤©æ°”è·å–emoji
  private getWeatherEmoji(): string {
    if (this.weather.includes('æ™´')) return 'â˜€ï¸';
    if (this.weather.includes('äº‘')) return 'â›…';
    if (this.weather.includes('é˜´')) return 'â˜ï¸';
    if (this.weather.includes('é›¨')) return 'ğŸŒ§ï¸';
    if (this.weather.includes('é›ª')) return 'â„ï¸';
    if (this.weather.includes('é›·')) return 'â›ˆï¸';
    if (this.weather.includes('é›¾') || this.weather.includes('éœ¾')) return 'ğŸŒ«ï¸';
    return 'ğŸŒ¤ï¸';
  }

  @Builder
  WeatherInfoItem(label: string, value: string) {
    Row({ space: 8 }) {
      Text('â†’')
        .fontSize(14)
        .fontColor(ThemeColors.TEXT_MUTED)
      Column({ space: 2 }) {
        Text(label)
          .fontSize(ThemeConstants.FONT_SIZE_XS)
          .fontColor(ThemeColors.TEXT_MUTED)
        Text(value)
          .fontSize(ThemeConstants.FONT_SIZE_SM)
          .fontColor(ThemeColors.TEXT_PRIMARY)
      }
      .alignItems(HorizontalAlign.Start)
    }
    .padding({ left: 12, right: 12, top: 8, bottom: 8 })
    .backgroundColor(ThemeColors.BG_TERTIARY)
    .borderRadius(ThemeConstants.RADIUS_SM)
  }

  @Builder
  GeneratorSection() {
    Column({ space: ThemeConstants.SPACE_MD }) {
      // æ ‡é¢˜
      Row() {
        Text('å¿«é€Ÿé…æ–¹')
          .fontSize(ThemeConstants.FONT_SIZE_LG)
          .fontWeight(FontWeight.Medium)
          .fontColor(ThemeColors.TEXT_PRIMARY)
        Blank()
        Text('æŸ¥çœ‹å†å²')
          .fontSize(ThemeConstants.FONT_SIZE_SM)
          .fontColor(ThemeColors.PRIMARY)
          .onClick(() => {
            router.pushUrl({ url: 'pages/GeneratorHistoryPage' });
          })
      }
      .width('100%')

      Text('æ ¹æ®å¤©æ°”å’Œé™„è¿‘æ¸”ç‚¹ï¼Œä¸€é”®ç”Ÿæˆé…æ–¹ã€‚')
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)

      // ç›®æ ‡é±¼ç§é€‰æ‹©
      Column({ space: 8 }) {
        Text('ç›®æ ‡é±¼ç§')
          .fontSize(ThemeConstants.FONT_SIZE_SM)
          .fontColor(ThemeColors.TEXT_SECONDARY)

        Row() {
          Text(this.getSelectedFishName())
            .fontSize(ThemeConstants.FONT_SIZE_BASE)
            .fontColor(ThemeColors.TEXT_PRIMARY)
          Blank()
          Text('â–¼')
            .fontSize(12)
            .fontColor(ThemeColors.TEXT_MUTED)
        }
        .width('100%')
        .height(ThemeConstants.HEIGHT_MD)
        .padding({ left: 12, right: 12 })
        .backgroundColor(ThemeColors.BG_TERTIARY)
        .borderRadius(ThemeConstants.RADIUS_SM)
        .onClick(() => {
          this.showFishPicker = true;
        })
      }
      .width('100%')
      .alignItems(HorizontalAlign.Start)

      // æ°´åŸŸç±»å‹é€‰æ‹©
      Column({ space: 8 }) {
        Text('æ°´åŸŸç±»å‹')
          .fontSize(ThemeConstants.FONT_SIZE_SM)
          .fontColor(ThemeColors.TEXT_SECONDARY)

        // æ°´åŸŸæŒ‰é’® 2x2 å¸ƒå±€
        Column({ space: 8 }) {
          Row({ space: 8 }) {
            ForEach(this.waterOptions.slice(0, 2), (option: WaterOption) => {
              this.WaterTypeButton(option)
            })
          }
          .width('100%')

          Row({ space: 8 }) {
            ForEach(this.waterOptions.slice(2, 4), (option: WaterOption) => {
              this.WaterTypeButton(option)
            })
          }
          .width('100%')
        }
        .width('100%')
      }
      .width('100%')
      .alignItems(HorizontalAlign.Start)

      // ç”ŸæˆæŒ‰é’®
      Button() {
        Row({ space: 8 }) {
          Text('âœ¨')
            .fontSize(16)
          Text('ä¸€é”®ç”Ÿæˆé…æ–¹')
            .fontSize(ThemeConstants.FONT_SIZE_MD)
            .fontColor(ThemeColors.TEXT_PRIMARY)
            .fontWeight(FontWeight.Medium)
        }
      }
      .width('100%')
      .height(ThemeConstants.HEIGHT_LG)
      .backgroundColor(ThemeColors.PRIMARY)
      .borderRadius(ThemeConstants.RADIUS_SM)
      .margin({ top: 8 })
      .onClick(() => {
        // ç›´æ¥è·³è½¬åˆ°é…æ–¹è¯¦æƒ…é¡µï¼Œä¼ é€’é±¼ç§å’Œæ°´åŸŸå‚æ•°
        router.pushUrl({
          url: 'pages/GeneratedRecipePage',
          params: {
            fish: this.selectedFish,
            water: this.selectedWater,
            quickMode: true  // å¿«é€Ÿæ¨¡å¼æ ‡è®°
          }
        });
      })
    }
    .width('100%')
    .padding(ThemeConstants.SPACE_MD)
    .backgroundColor(ThemeColors.BG_CARD)
    .borderRadius(ThemeConstants.RADIUS_MD)
  }

  @Builder
  WaterTypeButton(option: WaterOption) {
    Row({ space: 6 }) {
      Image(this.selectedWater === option.type ? option.iconActive : option.icon)
        .width(16)
        .height(16)
        .fillColor(this.selectedWater === option.type ? ThemeColors.PRIMARY : ThemeColors.TEXT_MUTED)
      Text(option.label)
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(this.selectedWater === option.type ? ThemeColors.PRIMARY : ThemeColors.TEXT_SECONDARY)
    }
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
    .padding({ top: 10, bottom: 10 })
    .backgroundColor(this.selectedWater === option.type ? 'rgba(232, 168, 73, 0.15)' : ThemeColors.BG_TERTIARY)
    .borderRadius(ThemeConstants.RADIUS_SM)
    .border({
      width: 1,
      color: this.selectedWater === option.type ? ThemeColors.PRIMARY : Color.Transparent
    })
    .onClick(() => {
      if (this.selectedWater === option.type) return;  // é¿å…é‡å¤ç‚¹å‡»
      this.selectedWater = option.type;
      this.updateCurrentFishList();
      // åˆ‡æ¢æ°´åŸŸæ—¶ï¼Œé‡ç½®é±¼ç§ä¸ºè¯¥æ°´åŸŸçš„ç¬¬ä¸€ä¸ªé±¼ç§
      if (this.currentFishList.length > 0 && !this.currentFishList.some((f: FishData) => f.id === this.selectedFish)) {
        this.selectedFish = this.currentFishList[0].id;
      }
    })
  }

  @Builder
  NearbySpots() {
    Column({ space: ThemeConstants.SPACE_MD }) {
      // æ ‡é¢˜
      Row() {
        Text('é™„è¿‘æ¸”ç‚¹')
          .fontSize(ThemeConstants.FONT_SIZE_LG)
          .fontWeight(FontWeight.Medium)
          .fontColor(ThemeColors.TEXT_PRIMARY)
        Blank()
        Text('åœ°å›¾æ¨¡å¼')
          .fontSize(ThemeConstants.FONT_SIZE_SM)
          .fontColor(ThemeColors.PRIMARY)
          .onClick(() => {
            router.pushUrl({ url: 'pages/MapPage' });
          })
      }
      .width('100%')

      // åŠ è½½ä¸­
      if (this.isLoadingSpots) {
        Row() {
          LoadingProgress().width(20).height(20)
          Text('æœç´¢é™„è¿‘é’“ç‚¹...').fontSize(14).fontColor(ThemeColors.TEXT_SECONDARY).margin({ left: 8 })
        }
        .width('100%')
        .padding(16)
        .justifyContent(FlexAlign.Center)
      } else if (this.fishingSpots.length === 0) {
        // æ— æ•°æ®
        Text('æš‚æ— é™„è¿‘é’“ç‚¹ï¼Œç‚¹å‡»åœ°å›¾æ¨¡å¼æœç´¢')
          .fontSize(14)
          .fontColor(ThemeColors.TEXT_SECONDARY)
          .padding(16)
      } else {
        // é’“ç‚¹åˆ—è¡¨
        ForEach(this.fishingSpots.slice(0, 5), (spot: FishingSpot) => {
          this.SpotCardReal(spot)
        })
      }
    }
    .width('100%')
  }

  @Builder
  SpotCardReal(spot: FishingSpot) {
    Row() {
      // ä½¿ç”¨å¸¦é¢œè‰²çš„æ²³æµå›¾æ ‡
      Image($r('app.media.River'))
        .width(36)
        .height(36)
        .margin({ right: 12 })

      Column({ space: 4 }) {
        Text(spot.name)
          .fontSize(ThemeConstants.FONT_SIZE_BASE)
          .fontWeight(FontWeight.Medium)
          .fontColor(ThemeColors.TEXT_PRIMARY)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
        Row({ space: 4 }) {
          Text('ğŸ“')
            .fontSize(12)
          Text(`${FishingSpotService.formatDistance(spot.distance || 0)} Â· ${WaterTypeNames[spot.waterType]}`)
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.TEXT_SECONDARY)
        }
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      // é¥µæ–™æ¨èæŒ‰é’®
      Row() {
        Text('ğŸ£')
          .fontSize(14)
      }
      .width(32)
      .height(32)
      .backgroundColor(ThemeColors.BG_TERTIARY)
      .borderRadius(16)
      .justifyContent(FlexAlign.Center)
      .margin({ right: 8 })
      .onClick(() => this.onSpotClick(spot))

      // å¯¼èˆªæŒ‰é’®
      Row() {
        Text('â†’')
          .fontSize(16)
          .fontColor(ThemeColors.TEXT_PRIMARY)
      }
      .width(36)
      .height(36)
      .backgroundColor(ThemeColors.PRIMARY)
      .borderRadius(18)
      .justifyContent(FlexAlign.Center)
      .onClick(() => this.navigateToRoute(spot))
    }
    .width('100%')
    .padding(ThemeConstants.SPACE_MD)
    .backgroundColor(ThemeColors.BG_CARD)
    .borderRadius(ThemeConstants.RADIUS_MD)
    .margin({ bottom: 8 })
  }

  @Builder
  SpotCard(name: string, distance: string, desc: string) {
    Row() {
      Column({ space: 4 }) {
        Text(name)
          .fontSize(ThemeConstants.FONT_SIZE_BASE)
          .fontWeight(FontWeight.Medium)
          .fontColor(ThemeColors.TEXT_PRIMARY)
        Row({ space: 4 }) {
          Text('ğŸ“')
            .fontSize(12)
          Text(`${distance} Â· ${desc}`)
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.TEXT_SECONDARY)
        }
      }
      .alignItems(HorizontalAlign.Start)

      Blank()

      Row() {
        Text('â†’')
          .fontSize(16)
          .fontColor(ThemeColors.TEXT_PRIMARY)
      }
      .width(32)
      .height(32)
      .backgroundColor(ThemeColors.PRIMARY)
      .borderRadius(16)
      .justifyContent(FlexAlign.Center)
    }
    .width('100%')
    .padding(ThemeConstants.SPACE_MD)
    .backgroundColor(ThemeColors.BG_CARD)
    .borderRadius(ThemeConstants.RADIUS_MD)
  }

  @Builder
  BaitRecommendDialog() {
    Column() {
      // é®ç½©
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0,0,0,0.5)')
        .onClick(() => { this.showBaitDialog = false })
    }
    .width('100%')
    .height('100%')
    .position({ x: 0, y: 0 })

    // å¼¹çª—å†…å®¹
    Column() {
      // æ ‡é¢˜
      Row() {
        Image(WaterTypeImages[this.selectedSpot!.waterType]?.active || $r('app.media.River'))
          .width(24)
          .height(24)
          .margin({ right: 8 })
        Text(this.selectedSpot!.name)
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeColors.TEXT_PRIMARY)
          .layoutWeight(1)
        Text('âœ•')
          .fontSize(20)
          .fontColor(ThemeColors.TEXT_SECONDARY)
          .onClick(() => { this.showBaitDialog = false })
      }
      .width('100%')
      .margin({ bottom: 8 })

      Text(`${WaterTypeNames[this.selectedSpot!.waterType]} Â· ${this.selectedSpot!.description}`)
        .fontSize(13)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .margin({ bottom: 16 })

      Divider().color('#eee').margin({ bottom: 16 })

      Text('ğŸ£ æ¨èé¥µæ–™')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .margin({ bottom: 12 })

      ForEach(this.recommendedBaits, (bait: BaitInfo) => {
        Row() {
          Text(bait.icon)
            .fontSize(28)
            .margin({ right: 12 })

          Column() {
            Text(bait.name)
              .fontSize(15)
              .fontWeight(FontWeight.Medium)
              .fontColor(ThemeColors.TEXT_PRIMARY)
            Text(bait.description)
              .fontSize(12)
              .fontColor(ThemeColors.TEXT_SECONDARY)
              .margin({ top: 2 })
            Text(`ç›®æ ‡é±¼: ${bait.targetFish.join('ã€')}`)
              .fontSize(11)
              .fontColor(ThemeColors.PRIMARY)
              .margin({ top: 4 })
          }
          .alignItems(HorizontalAlign.Start)
          .layoutWeight(1)

          Text(bait.season)
            .fontSize(11)
            .fontColor('#999')
            .padding({ left: 8, right: 8, top: 4, bottom: 4 })
            .backgroundColor('#f5f5f5')
            .borderRadius(4)
        }
        .width('100%')
        .padding(12)
        .backgroundColor(ThemeColors.BG_SECONDARY)
        .borderRadius(8)
        .margin({ bottom: 8 })
      })

      // åº•éƒ¨æŒ‰é’®
      Row({ space: 12 }) {
        Button('æ¢ä¸€æ‰¹')
          .layoutWeight(1)
          .height(44)
          .fontSize(14)
          .backgroundColor(ThemeColors.BG_TERTIARY)
          .fontColor(ThemeColors.TEXT_PRIMARY)
          .onClick(() => {
            this.recommendedBaits = FishingSpotService.recommendBaits(this.selectedSpot!.waterType);
          })

        Button('å»è¿™é‡Œ')
          .layoutWeight(1)
          .height(44)
          .fontSize(14)
          .backgroundColor(ThemeColors.PRIMARY)
          .fontColor(Color.White)
          .onClick(() => {
            this.showBaitDialog = false;
            this.navigateToRoute(this.selectedSpot!);
          })
      }
      .width('100%')
      .margin({ top: 8 })
    }
    .width('90%')
    .padding(20)
    .backgroundColor(ThemeColors.BG_PRIMARY)
    .borderRadius(16)
    .position({ x: '5%', y: '15%' })
  }

  @Builder
  FishPickerDialog() {
    // é®ç½©å±‚
    Column()
      .width('100%')
      .height('100%')
      .backgroundColor('rgba(0,0,0,0.5)')
      .position({ x: 0, y: 0 })
      .onClick(() => { this.showFishPicker = false })

    // å¼¹çª—å†…å®¹
    Column() {
      // æ ‡é¢˜
      Row() {
        Text('é€‰æ‹©ç›®æ ‡é±¼ç§')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeColors.TEXT_PRIMARY)
        Blank()
        Text('âœ•')
          .fontSize(20)
          .fontColor(ThemeColors.TEXT_SECONDARY)
          .onClick(() => { this.showFishPicker = false })
      }
      .width('100%')
      .padding({ bottom: 12 })

      // é±¼ç§åˆ—è¡¨ï¼ˆå¯æ»šåŠ¨ï¼‰
      Scroll() {
        Column({ space: 8 }) {
          ForEach(this.currentFishList, (fish: FishData) => {
            Row() {
              // é±¼å›¾ç‰‡
              Image(fish.icon)
                .width(40)
                .height(40)
                .borderRadius(20)
                .margin({ right: 12 })

              Column({ space: 2 }) {
                Text(fish.name)
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .fontColor(ThemeColors.TEXT_PRIMARY)
                Text(fish.nameEn)
                  .fontSize(12)
                  .fontColor(ThemeColors.TEXT_SECONDARY)
              }
              .alignItems(HorizontalAlign.Start)
              .layoutWeight(1)

              // é€‰ä¸­æ ‡è®°
              if (this.selectedFish === fish.id) {
                Text('âœ“')
                  .fontSize(18)
                  .fontColor(ThemeColors.PRIMARY)
                  .fontWeight(FontWeight.Bold)
              }
            }
            .width('100%')
            .padding(12)
            .backgroundColor(this.selectedFish === fish.id ? 'rgba(232, 168, 73, 0.1)' : ThemeColors.BG_TERTIARY)
            .borderRadius(12)
            .border({
              width: this.selectedFish === fish.id ? 1 : 0,
              color: ThemeColors.PRIMARY
            })
            .onClick(() => {
              this.selectedFish = fish.id;
              this.showFishPicker = false;
            })
          })
        }
        .width('100%')
      }
      .width('100%')
      .constraintSize({ maxHeight: 400 })
      .scrollBar(BarState.Auto)
    }
    .width('85%')
    .padding(20)
    .backgroundColor(ThemeColors.BG_PRIMARY)
    .borderRadius(16)
    .position({ x: '7.5%', y: '15%' })
  }
}
