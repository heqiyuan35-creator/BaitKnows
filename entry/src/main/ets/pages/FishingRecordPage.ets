/**
 * é¥µçŸ¥é?- æ¸”è·è®°å½•åˆ—è¡¨é¡?
 * å±•ç¤ºç»Ÿè®¡æ•°æ®å’Œæ¸”è·è®°å½•åˆ—è¡?
 */
import { ThemeColors } from '../theme/ThemeColors';
import { ThemeConstants } from '../theme/ThemeConstants';
import { Router } from '../router/Router';
import { FishingRecord } from '../common/types/UserTypes';
import { fishingRecordService, RecordStatistics } from '../services/FishingRecordService';
import { StatCard } from '../components/StatCard';
import { EmptyState } from '../components/EmptyState';

// æŒ‰æœˆä»½åˆ†ç»„çš„è®°å½•
interface MonthGroup {
  month: string;
  records: FishingRecord[];
}

@Entry
@Component
export struct FishingRecordPage {
  // åˆ·æ–°è§¦å‘å™¨ï¼Œå½“å€¼å˜åŒ–æ—¶é‡æ–°åŠ è½½æ•°æ®ï¼ˆä½œä¸ºå­ç»„ä»¶æ—¶ä½¿ç”¨ï¼‰
  @Prop @Watch('onRefreshTriggerChange') refreshTrigger: number = 0;
  @State records: FishingRecord[] = [];
  @State statistics: RecordStatistics = new RecordStatistics();
  @State isLoading: boolean = true;
  @State groupedRecords: MonthGroup[] = [];

  aboutToAppear(): void {
    // æ¯æ¬¡ç»„ä»¶å‡ºç°æ—¶å¼ºåˆ¶é‡æ–°åŠ è½½æ•°æ?
    this.loadData(true);
  }

  // ç›‘å¬åˆ·æ–°è§¦å‘å™¨å˜åŒ?
  onRefreshTriggerChange(): void {
    this.loadData(true);
  }

  onPageShow(): void {
    // é¡µé¢æ˜¾ç¤ºæ—¶ä¹Ÿåˆ·æ–°ï¼ˆä½œä¸ºç‹¬ç«‹é¡µé¢æ—¶ï¼?
    this.loadData(true);
  }

  private async loadData(forceReload: boolean = false): Promise<void> {
    this.isLoading = true;
    try {
      if (forceReload) {
        await fishingRecordService.reload();
      } else {
        await fishingRecordService.load();
      }
      this.records = fishingRecordService.records;
      this.statistics = fishingRecordService.getStatistics();
      this.groupRecordsByMonth();
    } catch (error) {
      console.error('åŠ è½½è®°å½•å¤±è´¥:', error);
    }
    this.isLoading = false;
  }

  // æŒ‰æœˆä»½åˆ†ç»„è®°å½?
  private groupRecordsByMonth(): void {
    const groups: Map<string, FishingRecord[]> = new Map();

    for (const record of this.records) {
      const date = new Date(record.date);
      const monthKey = `${date.getFullYear()}å¹?{date.getMonth() + 1}æœˆ`;

      if (!groups.has(monthKey)) {
        groups.set(monthKey, []);
      }
      groups.get(monthKey)?.push(record);
    }

    this.groupedRecords = [];
    groups.forEach((records, month) => {
      const group: MonthGroup = { month: month, records: records };
      this.groupedRecords.push(group);
    });
  }

  private formatDate(timestamp: number): string {
    const date = new Date(timestamp);
    const month = date.getMonth() + 1;
    const day = date.getDate();
    const weekDays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
    const weekDay = weekDays[date.getDay()];
    return `${month}æœ?{day}æ—?${weekDay}`;
  }

  private getWeatherIcon(weather: string): string {
    const icons: Record<string, string> = {
      'æ™´æœ—': 'â˜€ï¸?,
      'å¤šäº‘': 'â›?,
      'é˜´å¤©': 'â˜ï¸',
      'å°é›¨': 'ğŸŒ§ï¸?,
      'å¤§é£': 'ğŸ’¨'
    };
    return icons[weather] || 'ğŸŒ¤ï¸?;
  }

  // æˆªæ–­é±¼ç§åç§°ï¼Œæœ€å¤šæ˜¾ç¤?ç§é±¼
  private formatFishName(name: string): string {
    if (!name) return 'æœªçŸ¥é±¼ç§';
    const fishList = name.split('ã€?);
    if (fishList.length <= 2) return name;
    return fishList.slice(0, 2).join('ã€?) + 'ç­?;
  }

  build() {
    Column() {
      if (this.isLoading) {
        this.LoadingView()
      } else {
        // å†…å®¹åŒºåŸŸ
        Scroll() {
          Column({ space: ThemeConstants.SPACE_MD }) {
            // çŠ¶æ€æ å ä½
            Row()
              .width('100%')
              .height(36)

            // é¡¶éƒ¨æ ‡é¢˜æ ?
            this.HeaderBar()

            // ç»Ÿè®¡å¡ç‰‡åŒºåŸŸ
            this.StatisticsSection()

            // æ¸”è·åˆ†æå…¥å£å¡ç‰‡
            Column() {
              this.AnalysisEntryCard()
            }
            .padding({ left: ThemeConstants.SPACE_MD, right: ThemeConstants.SPACE_MD })

            // è®°å½•åˆ—è¡¨
            if (this.records.length === 0) {
              this.EmptyView()
            } else {
              this.RecordListSection()
            }
          }
          .padding({ top: 8, bottom: 100 })
          .alignItems(HorizontalAlign.Start)
        }
        .layoutWeight(1)
        .scrollBar(BarState.Off)
        .align(Alignment.Top)
      }

      // åº•éƒ¨æ·»åŠ æŒ‰é’®
      this.AddButton()
    }
    .width('100%')
    .height('100%')
    .backgroundColor(ThemeColors.BG_PRIMARY)
  }

  @Builder
  HeaderBar() {
    Row() {
      Text('æ¸”è·è®°å½•')
        .fontSize(ThemeConstants.FONT_SIZE_XL)
        .fontWeight(FontWeight.Bold)
        .fontColor(ThemeColors.TEXT_PRIMARY)
    }
    .width('100%')
    .height(48)
    .padding({ left: ThemeConstants.SPACE_MD, right: ThemeConstants.SPACE_MD })
  }

  @Builder
  LoadingView() {
    Column() {
      LoadingProgress()
        .width(48)
        .height(48)
        .color(ThemeColors.PRIMARY)
      Text('åŠ è½½ä¸?..')
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .margin({ top: 12 })
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
  }

  @Builder
  AnalysisEntryCard() {
    Row() {
      // å·¦ä¾§å›¾æ ‡å’Œæ–‡å­?
      Row({ space: 12 }) {
        Column() {
          Text('ğŸ“Š')
            .fontSize(28)
        }
        .width(52)
        .height(52)
        .linearGradient({
          direction: GradientDirection.RightBottom,
          colors: [['#FFE4B5', 0], ['#FFD700', 1]]
        })
        .borderRadius(14)
        .justifyContent(FlexAlign.Center)

        Column({ space: 4 }) {
          Text('æ¸”è·åˆ†æ')
            .fontSize(ThemeConstants.FONT_SIZE_MD)
            .fontWeight(FontWeight.Bold)
            .fontColor(ThemeColors.TEXT_PRIMARY)
          Text('æŸ¥çœ‹æˆå°±ã€ç”»åƒã€è¶£å‘³æ•°æ?)
            .fontSize(ThemeConstants.FONT_SIZE_XS)
            .fontColor(ThemeColors.TEXT_SECONDARY)
        }
        .alignItems(HorizontalAlign.Start)
      }

      Blank()

      // å³ä¾§ç®­å¤´
      Row() {
        Text('â†?)
          .fontSize(18)
          .fontColor(ThemeColors.PRIMARY_DARK)
      }
      .width(36)
      .height(36)
      .backgroundColor('rgba(232, 168, 73, 0.15)')
      .borderRadius(18)
      .justifyContent(FlexAlign.Center)
    }
    .width('100%')
    .padding(ThemeConstants.SPACE_MD)
    .backgroundColor(ThemeColors.BG_CARD)
    .borderRadius(ThemeConstants.RADIUS_MD)
    .shadow({ radius: 8, color: 'rgba(232, 168, 73, 0.15)', offsetY: 4 })
    .onClick(() => {
      Router.push('pages/RecordAnalysisPage');
    })
  }

  @Builder
  StatisticsSection() {
    Column({ space: ThemeConstants.SPACE_SM }) {
      // ç¬¬ä¸€è¡Œï¼šæ€»æ¸”è·ã€æœ€å¤§å•å°?
      Row({ space: ThemeConstants.SPACE_SM }) {
        StatCard({
          label: 'æ€»æ¸”è?,
          value: this.statistics.totalWeight.toFixed(1),
          unit: 'kg',
          valueColor: ThemeColors.PRIMARY
        })

        StatCard({
          label: 'æœ€å¤§å•å°?,
          value: this.statistics.maxSingle.toFixed(1),
          unit: 'kg',
          valueColor: ThemeColors.SUCCESS
        })
      }
      .width('100%')

      // ç¬¬äºŒè¡Œï¼šæœ¬æœˆå‡ºé’“ã€æ€»å‡ºé’“ã€æ€»å°¾æ•?
      Row({ space: ThemeConstants.SPACE_SM }) {
        StatCard({
          label: 'æœ¬æœˆå‡ºé’“',
          value: this.statistics.monthTrips.toString(),
          unit: 'æ¬?,
          valueColor: ThemeColors.INFO
        })

        StatCard({
          label: 'æ€»å‡ºé’?,
          value: this.statistics.totalTrips.toString(),
          unit: 'æ¬?,
          valueColor: ThemeColors.WARNING
        })

        StatCard({
          label: 'æ€»å°¾æ•?,
          value: this.statistics.totalCount.toString(),
          unit: 'å°?,
          valueColor: ThemeColors.PRIMARY
        })
      }
      .width('100%')
    }
    .padding({ left: ThemeConstants.SPACE_MD, right: ThemeConstants.SPACE_MD })
  }

  @Builder
  EmptyView() {
    EmptyState({
      icon: 'ğŸ£',
      title: 'æš‚æ— æ¸”è·è®°å½•',
      subtitle: 'è®°å½•æ¯ä¸€æ¬¡é’“é±¼çš„æ”¶è·ï¼Œè§è¯ä½ çš„æˆé•?
    })
  }

  @Builder
  RecordListSection() {
    Column({ space: ThemeConstants.SPACE_MD }) {
      ForEach(this.groupedRecords, (group: MonthGroup) => {
        Column({ space: ThemeConstants.SPACE_SM }) {
          // æœˆä»½æ ‡é¢˜
          Text(group.month)
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.TEXT_SECONDARY)
            .fontWeight(FontWeight.Medium)
            .width('100%')
            .padding({ left: ThemeConstants.SPACE_MD })

          // è¯¥æœˆçš„è®°å½?
          ForEach(group.records, (record: FishingRecord) => {
            this.RecordItem(record)
          }, (record: FishingRecord) => record.id)
        }
      }, (group: MonthGroup) => group.month)
    }
    .padding({ left: ThemeConstants.SPACE_MD, right: ThemeConstants.SPACE_MD })
  }

  @Builder
  RecordItem(record: FishingRecord) {
    Column({ space: 10 }) {
      // ç¬¬ä¸€è¡Œï¼šæ—¥æœŸå’Œå¤©æ°?
      Row() {
        Row({ space: 6 }) {
          Text('ğŸ“…')
            .fontSize(14)
          Text(this.formatDate(record.date))
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.TEXT_SECONDARY)
        }

        Blank()

        Row({ space: 4 }) {
          Text(this.getWeatherIcon(record.weather))
            .fontSize(14)
          Text(record.weather)
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.TEXT_SECONDARY)
        }
        .padding({ left: 8, right: 8, top: 2, bottom: 2 })
        .backgroundColor(ThemeColors.BG_TERTIARY)
        .borderRadius(ThemeConstants.RADIUS_FULL)
      }
      .width('100%')

      // ç¬¬äºŒè¡Œï¼šé’“ç‚¹
      Row({ space: 6 }) {
        Text('ğŸ“')
          .fontSize(14)
        Text(record.location || 'æœªå¡«å†™é’“ç‚?)
          .fontSize(ThemeConstants.FONT_SIZE_BASE)
          .fontColor(ThemeColors.TEXT_PRIMARY)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
      }
      .width('100%')

      // ç¬¬ä¸‰è¡Œï¼šé±¼ç§ã€æ•°é‡ã€é‡é‡?
      Row() {
        Row({ space: 6 }) {
          Text('ğŸŸ')
            .fontSize(16)
            .flexShrink(0)
          Text(this.formatFishName(record.fishName))
            .fontSize(ThemeConstants.FONT_SIZE_MD)
            .fontWeight(FontWeight.Medium)
            .fontColor(ThemeColors.TEXT_PRIMARY)
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .constraintSize({ maxWidth: '45%' })
          Text(`Ã— ${record.count}å°¾`)
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.TEXT_SECONDARY)
            .flexShrink(0)
        }
        .flexShrink(1)

        Blank()

        Row() {
          Text(`${record.weight}`)
            .fontSize(ThemeConstants.FONT_SIZE_XL)
            .fontWeight(FontWeight.Bold)
            .fontColor(ThemeColors.PRIMARY_DARK)
          Text('kg')
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.TEXT_SECONDARY)
            .margin({ left: 2, top: 4 })
        }
        .flexShrink(0)
      }
      .width('100%')

      // ç¬¬å››è¡Œï¼šé…æ–¹ï¼ˆå¦‚æœ‰ï¼‰
      if (record.recipeName) {
        Row({ space: 6 }) {
          Text('ğŸ§ª')
            .fontSize(14)
          Text(record.recipeName)
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.TEXT_SECONDARY)
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }
        .width('100%')
      }
    }
    .width('100%')
    .padding(ThemeConstants.SPACE_MD)
    .backgroundColor(ThemeColors.BG_CARD)
    .borderRadius(ThemeConstants.RADIUS_MD)
    .shadow({ radius: 4, color: 'rgba(0,0,0,0.05)', offsetY: 2 })
    .onClick(() => {
      Router.goToRecordDetail(record.id);
    })
  }

  @Builder
  AddButton() {
    Row() {
      Button('+ æ·»åŠ è®°å½•')
        .fontSize(ThemeConstants.FONT_SIZE_MD)
        .fontColor(Color.White)
        .backgroundColor(ThemeColors.PRIMARY)
        .borderRadius(ThemeConstants.RADIUS_FULL)
        .height(48)
        .width('90%')
        .shadow({ radius: 8, color: 'rgba(232, 168, 73, 0.3)', offsetY: 4 })
        .onClick(() => {
          Router.goToAddRecord();
        })
    }
    .width('100%')
    .justifyContent(FlexAlign.Center)
    .padding({ bottom: 20 })
    .position({ x: 0, y: '100%' })
    .translate({ y: -80 })
  }
}
