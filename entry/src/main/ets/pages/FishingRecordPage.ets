/**
 * é¥µçŸ¥é“ - æ¸”è·è®°å½•é¡µé¢
 * ç»Ÿè®¡æ•°æ®ã€è®°å½•åˆ—è¡¨
 */
import { ThemeColors } from '../theme/ThemeColors';
import { ThemeConstants } from '../theme/ThemeConstants';
import { Router } from '../router/Router';
import { FishingRecord } from '../common/types/UserTypes';
import { fishingRecordService, RecordStatistics } from '../services/FishingRecordService';
import { AppConstants } from '../common/constants/AppConstants';

@Component
export struct FishingRecordPage {
  @State stats: RecordStatistics = new RecordStatistics();
  @State records: FishingRecord[] = [];
  @State isLoading: boolean = true;
  @State isRefreshing: boolean = false;

  aboutToAppear(): void {
    this.loadData();
  }

  private async loadData(): Promise<void> {
    this.isLoading = true;
    await fishingRecordService.load();
    this.records = fishingRecordService.getRecentRecords(20);
    this.stats = fishingRecordService.getStatistics();
    this.isLoading = false;
  }

  private async refreshData(): Promise<void> {
    this.isRefreshing = true;
    await fishingRecordService.load();
    this.records = fishingRecordService.getRecentRecords(20);
    this.stats = fishingRecordService.getStatistics();
    this.isRefreshing = false;
  }

  private formatDate(timestamp: number): string {
    const date = new Date(timestamp);
    const month = date.getMonth() + 1;
    const day = date.getDate();
    return `${month}æœˆ${day}æ—¥`;
  }

  private getWeatherIcon(weather: string): string {
    const icons: Record<string, string> = {
      'æ™´æœ—': 'â˜€ï¸',
      'å¤šäº‘': 'â›…',
      'é˜´å¤©': 'â˜ï¸',
      'å°é›¨': 'ğŸŒ§ï¸',
      'å¤§é£': 'ğŸ’¨'
    };
    return icons[weather] || 'ğŸŒ¤ï¸';
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      this.HeaderBar()

      if (this.isLoading) {
        Column() {
          LoadingProgress().width(40).height(40).color(ThemeColors.PRIMARY)
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      } else {
        Refresh({ refreshing: $$this.isRefreshing }) {
          Scroll() {
            Column({ space: ThemeConstants.SPACE_MD }) {
              // ç»Ÿè®¡å¡ç‰‡
              this.StatsCards()

              // æœ€è¿‘è®°å½•æ ‡é¢˜
              Row() {
                Text('æœ€è¿‘è®°å½•')
                  .fontSize(ThemeConstants.FONT_SIZE_MD)
                  .fontWeight(FontWeight.Medium)
                  .fontColor(ThemeColors.TEXT_PRIMARY)
                Blank()
                if (this.records.length > 0) {
                  Text(`å…± ${this.stats.totalTrips} æ¡`)
                    .fontSize(ThemeConstants.FONT_SIZE_SM)
                    .fontColor(ThemeColors.TEXT_SECONDARY)
                }
              }
              .width('100%')
              .padding({ left: ThemeConstants.SPACE_MD, right: ThemeConstants.SPACE_MD })

              // è®°å½•åˆ—è¡¨
              if (this.records.length === 0) {
                this.EmptyView()
              } else {
                ForEach(this.records, (record: FishingRecord) => {
                  this.RecordCard(record)
                })
              }
            }
            .padding({ bottom: 100 })
          }
          .scrollBar(BarState.Off)
        }
        .onRefreshing(() => {
          this.refreshData();
        })
        .layoutWeight(1)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(ThemeColors.BG_PRIMARY)
  }

  @Builder
  HeaderBar() {
    Row() {
      Text('æ¸”è·è®°å½•')
        .fontSize(ThemeConstants.FONT_SIZE_XL)
        .fontWeight(FontWeight.Bold)
        .fontColor(ThemeColors.TEXT_PRIMARY)
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .margin({ top: 44 })
    .justifyContent(FlexAlign.Center)
  }

  @Builder
  StatsCards() {
    Row({ space: ThemeConstants.SPACE_SM }) {
      this.StatItem('æ€»æ¸”è·', `${this.stats.totalWeight}`, 'kg', ThemeColors.PRIMARY)
      this.StatItem('æœ€å¤§å•å°¾', `${this.stats.maxSingle}`, 'kg', ThemeColors.TEXT_PRIMARY)
      this.StatItem('æœ¬æœˆå‡ºé’“', `${this.stats.monthTrips}`, 'æ¬¡', ThemeColors.TEXT_PRIMARY)
    }
    .width('100%')
    .padding({ left: ThemeConstants.SPACE_MD, right: ThemeConstants.SPACE_MD })
  }

  @Builder
  StatItem(label: string, value: string, unit: string, valueColor: string) {
    Column({ space: 4 }) {
      Row() {
        Text(value)
          .fontSize(ThemeConstants.FONT_SIZE_2XL)
          .fontWeight(FontWeight.Bold)
          .fontColor(valueColor)
        Text(unit)
          .fontSize(ThemeConstants.FONT_SIZE_XS)
          .fontColor(ThemeColors.TEXT_MUTED)
          .margin({ left: 2, top: 8 })
      }
      Text(label)
        .fontSize(ThemeConstants.FONT_SIZE_XS)
        .fontColor(ThemeColors.TEXT_SECONDARY)
    }
    .layoutWeight(1)
    .padding({ top: 14, bottom: 14 })
    .backgroundColor(ThemeColors.BG_CARD)
    .borderRadius(ThemeConstants.RADIUS_SM)
    .shadow({ radius: 6, color: 'rgba(0,0,0,0.04)', offsetY: 2 })
  }

  @Builder
  EmptyView() {
    Column({ space: 12 }) {
      Text('ğŸ£')
        .fontSize(48)
      Text('æš‚æ— æ¸”è·è®°å½•')
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .fontColor(ThemeColors.TEXT_SECONDARY)
      Text('ç‚¹å‡»åº•éƒ¨ + æŒ‰é’®æ·»åŠ ç¬¬ä¸€æ¡è®°å½•')
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_MUTED)
    }
    .width('100%')
    .padding({ top: 60, bottom: 60 })
  }

  @Builder
  RecordCard(record: FishingRecord) {
    Row({ space: 12 }) {
      // å·¦ä¾§æ—¥æœŸ
      Column({ space: 2 }) {
        Text(this.formatDate(record.date).split('æœˆ')[0])
          .fontSize(ThemeConstants.FONT_SIZE_2XL)
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeColors.PRIMARY)
        Text('æœˆ')
          .fontSize(ThemeConstants.FONT_SIZE_XS)
          .fontColor(ThemeColors.TEXT_MUTED)
      }
      .width(48)
      .alignItems(HorizontalAlign.Center)

      // åˆ†å‰²çº¿
      Column()
        .width(1)
        .height(60)
        .backgroundColor(ThemeColors.DIVIDER)

      // ä¸­é—´ä¿¡æ¯
      Column({ space: 6 }) {
        Row({ space: 6 }) {
          Text(record.fishName || 'æœªçŸ¥é±¼ç§')
            .fontSize(ThemeConstants.FONT_SIZE_MD)
            .fontWeight(FontWeight.Medium)
            .fontColor(ThemeColors.TEXT_PRIMARY)

          Row({ space: 4 }) {
            Text(this.getWeatherIcon(record.weather))
              .fontSize(12)
            Text(record.weather)
              .fontSize(ThemeConstants.FONT_SIZE_XS)
              .fontColor(ThemeColors.TEXT_MUTED)
          }
        }

        Row({ space: 8 }) {
          Text(`ğŸ“ ${record.location || 'æœªçŸ¥åœ°ç‚¹'}`)
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.TEXT_SECONDARY)
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .layoutWeight(1)
        }

        Row({ space: 12 }) {
          Text(`ğŸŸ ${record.count}å°¾`)
            .fontSize(ThemeConstants.FONT_SIZE_XS)
            .fontColor(ThemeColors.TEXT_MUTED)

          if (record.recipeName) {
            Text(`ğŸ§ª ${record.recipeName}`)
              .fontSize(ThemeConstants.FONT_SIZE_XS)
              .fontColor(ThemeColors.TEXT_MUTED)
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
          }
        }
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      // å³ä¾§é‡é‡
      Column({ space: 2 }) {
        Text(`${record.weight}`)
          .fontSize(ThemeConstants.FONT_SIZE_XL)
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeColors.PRIMARY)
        Text('kg')
          .fontSize(ThemeConstants.FONT_SIZE_XS)
          .fontColor(ThemeColors.TEXT_MUTED)
      }
      .alignItems(HorizontalAlign.End)

      // ç®­å¤´
      Text('â€º')
        .fontSize(20)
        .fontColor(ThemeColors.TEXT_MUTED)
    }
    .width('100%')
    .padding(ThemeConstants.SPACE_MD)
    .margin({ left: ThemeConstants.SPACE_MD, right: ThemeConstants.SPACE_MD })
    .backgroundColor(ThemeColors.BG_CARD)
    .borderRadius(ThemeConstants.RADIUS_MD)
    .shadow({ radius: 8, color: 'rgba(0,0,0,0.05)', offsetY: 2 })
    .onClick(() => {
      Router.goToRecordDetail(record.id);
    })
  }
}
