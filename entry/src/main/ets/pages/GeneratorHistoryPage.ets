/**
 * é¥µçŸ¥é?- é…æ–¹ç”Ÿæˆå†å²é¡µé¢
 */
import { ThemeColors } from '../theme/ThemeColors';
import { ThemeConstants } from '../theme/ThemeConstants';
import { Router } from '../router/Router';
import { GeneratedRecipe } from '../common/types/RecipeTypes';
import { generatorHistoryService } from '../services/GeneratorHistoryService';
import { promptAction } from '@kit.ArkUI';

@Entry
@Component
struct GeneratorHistoryPage {
  @State historyList: GeneratedRecipe[] = [];
  @State isLoading: boolean = true;
  @State showClearDialog: boolean = false;

  aboutToAppear(): void {
    this.loadHistory();
  }

  private async loadHistory(): Promise<void> {
    this.isLoading = true;
    await generatorHistoryService.load();
    this.historyList = generatorHistoryService.history;
    this.isLoading = false;
  }

  private formatDate(timestamp: number): string {
    const date = new Date(timestamp);
    const month = date.getMonth() + 1;
    const day = date.getDate();
    const hour = date.getHours().toString().padStart(2, '0');
    const minute = date.getMinutes().toString().padStart(2, '0');
    return `${month}æœ?{day}æ—?${hour}:${minute}`;
  }

  private getWaterTypeName(type: string): string {
    const names: Record<string, string> = {
      'river': 'æ²³æµ',
      'pond': 'é»‘å‘',
      'reservoir': 'æ°´åº“',
      'wild_pond': 'é‡å¡˜'
    };
    return names[type] || 'æœªçŸ¥';
  }

  private getSeasonName(season: string): string {
    const names: Record<string, string> = {
      'spring': 'æ˜¥å­£',
      'summer': 'å¤å­£',
      'autumn': 'ç§‹å­£',
      'winter': 'å†¬å­£'
    };
    return names[season] || 'æœªçŸ¥';
  }

  private getModeName(mode: string): string {
    const names: Record<string, string> = {
      'conservative': 'ä¿å®ˆ',
      'balanced': 'å‡è¡¡',
      'aggressive': 'æ¿€è¿?
    };
    return names[mode] || 'å‡è¡¡';
  }

  private async deleteItem(recipeId: string): Promise<void> {
    const success = await generatorHistoryService.deleteHistory(recipeId);
    if (success) {
      this.historyList = generatorHistoryService.history;
      promptAction.showToast({ message: 'å·²åˆ é™? });
    }
  }

  private async clearAllHistory(): Promise<void> {
    await generatorHistoryService.clearAll();
    this.historyList = [];
    this.showClearDialog = false;
    promptAction.showToast({ message: 'å·²æ¸…ç©ºå†å²è®°å½? });
  }

  build() {
    Stack() {
      Column() {
        // é¡¶éƒ¨å¯¼èˆªæ ?
        this.HeaderBar()

        if (this.isLoading) {
          this.LoadingView()
        } else if (this.historyList.length === 0) {
          this.EmptyView()
        } else {
          this.HistoryList()
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor(ThemeColors.BG_PRIMARY)

      // æ¸…ç©ºç¡®è®¤å¼¹çª—
      if (this.showClearDialog) {
        this.ClearDialog()
      }
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  HeaderBar() {
    Row() {
      Image($r('app.media.Left'))
        .width(24)
        .height(24)
        .fillColor(ThemeColors.TEXT_PRIMARY)
        .onClick(() => Router.back())

      Blank()

      Text('ç”Ÿæˆå†å²')
        .fontSize(ThemeConstants.FONT_SIZE_LG)
        .fontWeight(FontWeight.Medium)
        .fontColor(ThemeColors.TEXT_PRIMARY)

      Blank()

      if (this.historyList.length > 0) {
        Text('æ¸…ç©º')
          .fontSize(ThemeConstants.FONT_SIZE_SM)
          .fontColor('#FF4444')
          .onClick(() => { this.showClearDialog = true; })
      } else {
        Row().width(24)
      }
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16, top: 40 })
  }

  @Builder
  LoadingView() {
    Column() {
      LoadingProgress()
        .width(48)
        .height(48)
        .color(ThemeColors.PRIMARY)
      Text('åŠ è½½ä¸?..')
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .margin({ top: 12 })
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
  }

  @Builder
  EmptyView() {
    Column({ space: 12 }) {
      Text('ğŸ“‹')
        .fontSize(48)
      Text('æš‚æ— ç”Ÿæˆå†å²')
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .fontColor(ThemeColors.TEXT_SECONDARY)
      Text('ç”Ÿæˆé…æ–¹åä¼šè‡ªåŠ¨ä¿å­˜åˆ°è¿™é‡?)
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_MUTED)
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
  }

  @Builder
  HistoryList() {
    Scroll() {
      Column({ space: ThemeConstants.SPACE_SM }) {
        ForEach(this.historyList, (recipe: GeneratedRecipe) => {
          this.HistoryCard(recipe)
        })
      }
      .padding({ left: ThemeConstants.SPACE_MD, right: ThemeConstants.SPACE_MD, top: ThemeConstants.SPACE_MD, bottom: 40 })
    }
    .layoutWeight(1)
    .scrollBar(BarState.Off)
  }

  @Builder
  HistoryCard(recipe: GeneratedRecipe) {
    Column({ space: 10 }) {
      // æ ‡é¢˜è¡?
      Row() {
        Column({ space: 4 }) {
          Text(recipe.name)
            .fontSize(ThemeConstants.FONT_SIZE_MD)
            .fontWeight(FontWeight.Medium)
            .fontColor(ThemeColors.TEXT_PRIMARY)
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })

          Text(this.formatDate(recipe.createTime))
            .fontSize(ThemeConstants.FONT_SIZE_XS)
            .fontColor(ThemeColors.TEXT_MUTED)
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)

        // å‘³å‹æ ‡ç­¾
        Text(`${recipe.flavorProfile.primary}${recipe.flavorProfile.secondary}`)
          .fontSize(ThemeConstants.FONT_SIZE_XS)
          .fontColor(ThemeColors.PRIMARY_DARK)
          .padding({ left: 8, right: 8, top: 4, bottom: 4 })
          .backgroundColor('rgba(232, 168, 73, 0.15)')
          .borderRadius(ThemeConstants.RADIUS_FULL)
      }
      .width('100%')

      // æ¡ä»¶æ ‡ç­¾
      Row({ space: 6 }) {
        this.TagItem(`ğŸŒ¡ï¸?${recipe.conditions.temperature}Â°C`)
        this.TagItem(`ğŸ’§ ${this.getWaterTypeName(recipe.conditions.waterType)}`)
        this.TagItem(`ğŸ‚ ${this.getSeasonName(recipe.conditions.season)}`)
      }

      // åº•éƒ¨ä¿¡æ¯
      Row() {
        Text(`${recipe.ingredients.length} ç§åŸæ–?Â· ${recipe.totalWeight}g`)
          .fontSize(ThemeConstants.FONT_SIZE_SM)
          .fontColor(ThemeColors.TEXT_SECONDARY)

        Blank()

        Text('åˆ é™¤')
          .fontSize(ThemeConstants.FONT_SIZE_SM)
          .fontColor(ThemeColors.ERROR)
          .onClick(() => { this.deleteItem(recipe.id); })
      }
      .width('100%')
    }
    .width('100%')
    .padding(ThemeConstants.SPACE_MD)
    .backgroundColor(ThemeColors.BG_CARD)
    .borderRadius(ThemeConstants.RADIUS_MD)
    .shadow({ radius: 8, color: 'rgba(0,0,0,0.05)', offsetY: 2 })
  }

  @Builder
  TagItem(text: string) {
    Text(text)
      .fontSize(ThemeConstants.FONT_SIZE_XS)
      .fontColor(ThemeColors.TEXT_SECONDARY)
      .padding({ left: 8, right: 8, top: 4, bottom: 4 })
      .backgroundColor(ThemeColors.BG_TERTIARY)
      .borderRadius(4)
  }

  @Builder
  ClearDialog() {
    Stack() {
      // é®ç½©
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0,0,0,0.5)')
        .onClick(() => { this.showClearDialog = false; })

      // å¼¹çª—
      Column({ space: 16 }) {
        Text('æ¸…ç©ºå†å²')
          .fontSize(ThemeConstants.FONT_SIZE_LG)
          .fontWeight(FontWeight.Medium)
          .fontColor(ThemeColors.TEXT_PRIMARY)

        Text('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç”Ÿæˆå†å²å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€?)
          .fontSize(ThemeConstants.FONT_SIZE_BASE)
          .fontColor(ThemeColors.TEXT_SECONDARY)
          .textAlign(TextAlign.Center)

        Row({ space: 12 }) {
          Button('å–æ¶ˆ')
            .fontSize(ThemeConstants.FONT_SIZE_BASE)
            .fontColor(ThemeColors.TEXT_PRIMARY)
            .backgroundColor(ThemeColors.BG_TERTIARY)
            .layoutWeight(1)
            .height(44)
            .onClick(() => { this.showClearDialog = false; })

          Button('æ¸…ç©º')
            .fontSize(ThemeConstants.FONT_SIZE_BASE)
            .fontColor(Color.White)
            .backgroundColor('#FF4444')
            .layoutWeight(1)
            .height(44)
            .onClick(() => { this.clearAllHistory(); })
        }
        .width('100%')
      }
      .width('80%')
      .padding(24)
      .backgroundColor(ThemeColors.BG_CARD)
      .borderRadius(ThemeConstants.RADIUS_LG)
    }
    .width('100%')
    .height('100%')
    .position({ x: 0, y: 0 })
  }
}
