/**
 * é¥µçŸ¥é?- æ·»åŠ æ¸”è·è®°å½•é¡?
 * è®°å½•é’“é±¼æˆæœ
 */
import { ThemeColors } from '../theme/ThemeColors';
import { ThemeConstants } from '../theme/ThemeConstants';
import { Router, RouteParams } from '../router/Router';
import { FishingRecord } from '../common/types/UserTypes';
import { fishingRecordService } from '../services/FishingRecordService';
import { userDataService, CustomRecipe } from '../services/UserDataService';
import { storageService } from '../services/StorageService';
import { promptAction } from '@kit.ArkUI';
import { picker } from '@kit.CoreFileKit';
import { fileIo } from '@kit.CoreFileKit';
import { speechRecognizer } from '@kit.CoreSpeechKit';
import { abilityAccessCtrl, Permissions, common } from '@kit.AbilityKit';

// é¢„è®¾é…æ–¹ç®€è¦ä¿¡æ¯ï¼ˆç”¨äºé…æ–¹é€‰æ‹©ï¼?
class PresetRecipeInfo {
  id: string = '';
  name: string = '';
  targetFish: string[] = [];

  constructor(id: string, name: string, fish: string[]) {
    this.id = id;
    this.name = name;
    this.targetFish = fish;
  }
}

// é¢„è®¾é…æ–¹æ•°æ®åº“ï¼ˆç®€åŒ–ç‰ˆï¼Œç”¨äºé…æ–¹é€‰æ‹©ï¼?
const PRESET_RECIPES: Map<string, PresetRecipeInfo> = new Map([
  // æ± å¡˜
  ['r_001', new PresetRecipeInfo('r_001', 'æ± å¡˜é²«é±¼æ•£ç‚®', ['é²«é±¼'])],
  ['r_002', new PresetRecipeInfo('r_002', 'é»‘å‘é²¤é±¼é¢—ç²’', ['é²¤é±¼'])],
  ['r_003', new PresetRecipeInfo('r_003', 'æ± å¡˜è‰é±¼é’è‰é¥?, ['è‰é±¼'])],
  ['r_004', new PresetRecipeInfo('r_004', 'æ± å¡˜é³™é±¼é…¸è‡­é¥?, ['é³™é±¼'])],
  ['r_005', new PresetRecipeInfo('r_005', 'æ± å¡˜é²¢é±¼é…¸é¥µ', ['é²¢é±¼'])],
  ['r_006', new PresetRecipeInfo('r_006', 'å—æ–¹ç½—éä¸“ç”¨é¥?, ['ç½—éé±?])],
  ['r_007', new PresetRecipeInfo('r_007', 'é»‘å‘å‰å°¾ä¸“ç”¨é¥?, ['æ–‘ç‚¹å‰å°¾é®?])],
  ['r_008', new PresetRecipeInfo('r_008', 'æ± å¡˜é²¶é±¼è…¥é¥µ', ['é²¶é±¼'])],
  // æ²³æµ
  ['r_101', new PresetRecipeInfo('r_101', 'é‡æ²³é²«é±¼èš¯èš“ä¼´ä¾£', ['é²«é±¼'])],
  ['r_102', new PresetRecipeInfo('r_102', 'æ±Ÿæ²³é²¤é±¼ç‰ç±³é¥?, ['é²¤é±¼'])],
  ['r_103', new PresetRecipeInfo('r_103', 'æ²³æµè‰é±¼å«©è‰é¥?, ['è‰é±¼'])],
  ['r_105', new PresetRecipeInfo('r_105', 'æ²³æµé»„é¢¡é±¼é¥µ', ['é»„é¢¡é±?])],
  ['r_106', new PresetRecipeInfo('r_106', 'æ²³æµé³Šé±¼ç´ é¥µ', ['é³Šé±¼'])],
  ['r_107', new PresetRecipeInfo('r_107', 'æ²³æµç¿˜å˜´è·¯äºšé¥?, ['ç¿˜å˜´'])],
  // æ°´åº“
  ['r_201', new PresetRecipeInfo('r_201', 'æ°´åº“å¤§é²¤å®ˆé’“é¥?, ['é²¤é±¼'])],
  ['r_202', new PresetRecipeInfo('r_202', 'æ°´åº“è‰é±¼æµ®é’“é¥?, ['è‰é±¼'])],
  ['r_205', new PresetRecipeInfo('r_205', 'æ°´åº“é’é±¼èºè›³é¥?, ['é’é±¼'])],
  ['r_206', new PresetRecipeInfo('r_206', 'æ°´åº“é³œé±¼æ´»é¥µ', ['é³œé±¼'])],
  ['r_207', new PresetRecipeInfo('r_207', 'æ°´åº“æ­¦æ˜Œé±¼ç´ é¥?, ['æ­¦æ˜Œé±?])],
  ['r_210', new PresetRecipeInfo('r_210', 'å—æ–¹é²®é±¼ä¸“ç”¨é¥?, ['é²®é±¼'])],
  // æ¹–æ³Š
  ['r_301', new PresetRecipeInfo('r_301', 'æ¹–æ³Šé²«é±¼ä¼ ç»Ÿé’?, ['é²«é±¼'])],
  ['r_302', new PresetRecipeInfo('r_302', 'æ¹–æ³Šé²¤é±¼çˆ†ç‚¸é’?, ['é²¤é±¼'])],
  ['r_304', new PresetRecipeInfo('r_304', 'æ¹–æ³Šé³œé±¼æ´»é¥µ', ['é³œé±¼'])],
  ['r_305', new PresetRecipeInfo('r_305', 'æ¹–æ³Šé’é±¼èºè›³é¥?, ['é’é±¼'])],
  ['r_306', new PresetRecipeInfo('r_306', 'æ¹–æ³Šé»‘é±¼é›·è›™', ['é»‘é±¼'])],
  ['r_315', new PresetRecipeInfo('r_315', 'æ¹–æ³Šé³Šé±¼ç´ é¥µ', ['é³Šé±¼'])]
]);

// å­˜å‚¨é”?
const STORAGE_LAST_LOCATION = 'last_fishing_location';
const STORAGE_LAST_WEATHER = 'last_fishing_weather';

// é±¼ç§é€‰é¡¹
interface FishOption {
  name: string;
  icon: Resource;
}

// é…æ–¹é€‰é¡¹
interface RecipeOption {
  id: string;
  name: string;
  targetFish: string;
  isUserRecipe: boolean;
  isFavorite: boolean;
}

@Entry
@Component
struct AddRecordPage {
  @State selectedDate: string = '';
  @State location: string = '';
  @State selectedFishList: string[] = [];  // æ”¹ä¸ºæ•°ç»„æ”¯æŒå¤šé€?
  @State weight: string = '';
  @State count: string = '1';
  @State selectedRecipeId: string = '';
  @State selectedRecipe: string = '';
  @State weather: string = 'æ™´æœ—';
  @State notes: string = '';
  @State isSaving: boolean = false;
  @State hasSaved: boolean = false;  // æ˜¯å¦å·²ä¿å­˜è¿‡ï¼Œé˜²æ­¢é‡å¤ä¿å­?
  @State showRecipeSelector: boolean = false;
  @State recipeOptions: RecipeOption[] = [];
  @State avgWeight: string = '';  // å¹³å‡å•å°¾é‡é‡æç¤º
  @State photos: string[] = [];   // æ¸”è·å›¾ç‰‡
  @State isRecording: boolean = false;  // æ˜¯å¦æ­£åœ¨å½•éŸ³
  @State recordingText: string = '';    // å®æ—¶è¯†åˆ«æ–‡å­—
  @State isAsrInitializing: boolean = false;  // ASRå¼•æ“åˆå§‹åŒ–ä¸­
  private asrEngine: speechRecognizer.SpeechRecognitionEngine | null = null;
  private asrSessionId: string = '';    // è¯­éŸ³è¯†åˆ«ä¼šè¯ID

  private fishOptions: FishOption[] = [
    { name: 'é²¤é±¼', icon: $r('app.media.Carp') },
    { name: 'è‰é±¼', icon: $r('app.media.Grass_carp') },
    { name: 'é²«é±¼', icon: $r('app.media.Crucian_carp') },
    { name: 'é’é±¼', icon: $r('app.media.Black_carp') },
    { name: 'é²¶é±¼', icon: $r('app.media.Catfish') },
    { name: 'é²¢é±¼', icon: $r('app.media.Silvercarp') },
    { name: 'é³™é±¼', icon: $r('app.media.Bigheadcarp') },
    { name: 'é»‘é±¼', icon: $r('app.media.Snakehead_fish') },
    { name: 'å…¶ä»–', icon: $r('app.media.Fish') }
  ];

  private weatherOptions: string[] = ['æ™´æœ—', 'å¤šäº‘', 'é˜´å¤©', 'å°é›¨', 'å¤§é£'];

  // åˆ‡æ¢é±¼ç§é€‰æ‹©
  private toggleFishSelection(fishName: string): void {
    const index = this.selectedFishList.indexOf(fishName);
    if (index >= 0) {
      this.selectedFishList = this.selectedFishList.filter((f: string) => f !== fishName);
    } else {
      this.selectedFishList = [...this.selectedFishList, fishName];
    }
  }

  // æ£€æŸ¥é±¼ç§æ˜¯å¦å·²é€‰ä¸­
  private isFishSelected(fishName: string): boolean {
    return this.selectedFishList.includes(fishName);
  }

  aboutToAppear(): void {
    // é»˜è®¤ä»Šå¤©æ—¥æœŸ
    const today = new Date();
    const year = today.getFullYear();
    const month = (today.getMonth() + 1).toString().padStart(2, '0');
    const day = today.getDate().toString().padStart(2, '0');
    this.selectedDate = `${year}-${month}-${day}`;

    // åŠ è½½ä¸Šæ¬¡ä½¿ç”¨çš„é’“ç‚¹å’Œå¤©æ°”
    this.loadLastSettings();

    // åŠ è½½é…æ–¹é€‰é¡¹
    this.loadRecipeOptions();
  }

  private async loadLastSettings(): Promise<void> {
    const lastLocation = await storageService.load<string>(STORAGE_LAST_LOCATION, '');
    const lastWeather = await storageService.load<string>(STORAGE_LAST_WEATHER, 'æ™´æœ—');

    if (lastLocation) {
      this.location = lastLocation;
    }
    if (lastWeather) {
      this.weather = lastWeather;
    }
  }

  private async saveLastSettings(): Promise<void> {
    if (this.location.trim()) {
      await storageService.save(STORAGE_LAST_LOCATION, this.location.trim());
    }
    await storageService.save(STORAGE_LAST_WEATHER, this.weather);
  }

  // è®¡ç®—å¹³å‡å•å°¾é‡é‡
  private calculateAvgWeight(): void {
    const w = parseFloat(this.weight) || 0;
    const c = parseInt(this.count) || 0;
    if (w > 0 && c > 0) {
      const avg = Math.round((w / c) * 100) / 100;
      this.avgWeight = `å¹³å‡å•å°¾: ${avg} kg`;
    } else {
      this.avgWeight = '';
    }
  }

  private async loadRecipeOptions(): Promise<void> {
    await userDataService.load();

    // è·å–æ”¶è—çš„é…æ–¹ID
    const favoriteIds = userDataService.getFavoriteRecipes();

    // è·å–ç”¨æˆ·è‡ªå®šä¹‰é…æ–?
    const userRecipes = userDataService.getCustomRecipes();

    const options: RecipeOption[] = [];

    // æ·»åŠ æ‰€æœ‰é¢„è®¾é…æ–?
    PRESET_RECIPES.forEach((preset: PresetRecipeInfo, id: string) => {
      const isFavorite = favoriteIds.includes(id);
      const opt: RecipeOption = {
        id: preset.id,
        name: preset.name,
        targetFish: preset.targetFish.join('ã€?),
        isUserRecipe: false,
        isFavorite: isFavorite
      };
      options.push(opt);
    });

    // æ·»åŠ ç”¨æˆ·è‡ªå®šä¹‰é…æ–?
    for (const ur of userRecipes) {
      const opt: RecipeOption = {
        id: ur.id,
        name: ur.name,
        targetFish: ur.targetFish.join('ã€?),
        isUserRecipe: true,
        isFavorite: true
      };
      options.push(opt);
    }

    this.recipeOptions = options;
  }

  build() {
    Column() {
      this.HeaderBar()

      Scroll() {
        Column({ space: ThemeConstants.SPACE_MD }) {
          // æ—¥æœŸé€‰æ‹©
          this.FormItem('ğŸ“… æ—¥æœŸ', this.selectedDate)

          // é’“ç‚¹ä½ç½®
          this.InputItem('ğŸ“ é’“ç‚¹ä½ç½®', 'è¯·è¾“å…¥é’“ç‚¹åç§?, this.location, (value: string) => {
            this.location = value;
          })

          // å¤©æ°”é€‰æ‹©
          this.WeatherSelector()

          // é±¼ç§é€‰æ‹©
          this.FishSelector()

          // é‡é‡è¾“å…¥
          this.InputItem('âš–ï¸ æ€»é‡é‡?(kg)', 'è¯·è¾“å…¥é‡é‡?, this.weight, (value: string) => {
            this.weight = value;
            this.calculateAvgWeight();
          })

          // æ•°é‡è¾“å…¥
          Column({ space: 8 }) {
            this.InputItem('ğŸ”¢ æ•°é‡ (å°?', 'è¯·è¾“å…¥æ•°é‡?, this.count, (value: string) => {
              this.count = value;
              this.calculateAvgWeight();
            })

            // å¹³å‡å•å°¾é‡é‡æç¤º
            if (this.avgWeight) {
              Text(this.avgWeight)
                .fontSize(ThemeConstants.FONT_SIZE_XS)
                .fontColor(ThemeColors.PRIMARY_DARK)
                .width('100%')
                .textAlign(TextAlign.End)
            }
          }

          // ä½¿ç”¨é…æ–¹
          this.RecipeSelector()

          // æ¸”è·å›¾ç‰‡
          this.PhotoSelector()

          // å¤‡æ³¨
          this.NotesInput()

          // ä¿å­˜æŒ‰é’®
          this.SaveButton()
        }
        .padding({ left: ThemeConstants.SPACE_MD, right: ThemeConstants.SPACE_MD, bottom: 40 })
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)

      // é…æ–¹é€‰æ‹©å¼¹çª—
      if (this.showRecipeSelector) {
        this.RecipeSelectorDialog()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(ThemeColors.BG_PRIMARY)
  }

  @Builder
  HeaderBar() {
    Column() {
      // çŠ¶æ€æ å ä½
      Row()
        .width('100%')
        .height(36)

      Row() {
        Image($r('app.media.Left'))
          .width(24)
          .height(24)
          .fillColor(ThemeColors.TEXT_PRIMARY)
          .onClick(() => Router.back())

        Blank()

        Text('æ·»åŠ è®°å½•')
          .fontSize(ThemeConstants.FONT_SIZE_LG)
          .fontWeight(FontWeight.Medium)
          .fontColor(ThemeColors.TEXT_PRIMARY)

        Blank()

        Row().width(24)
      }
      .width('100%')
      .height(48)
      .padding({ left: 16, right: 16 })
    }
    .width('100%')
  }


  @Builder
  FormItem(label: string, value: string) {
    Column({ space: 8 }) {
      Text(label)
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .width('100%')

      Row() {
        Text(value)
          .fontSize(ThemeConstants.FONT_SIZE_BASE)
          .fontColor(ThemeColors.TEXT_PRIMARY)
        Blank()
        Text('>')
          .fontSize(ThemeConstants.FONT_SIZE_MD)
          .fontColor(ThemeColors.TEXT_MUTED)
      }
      .width('100%')
      .height(48)
      .padding({ left: ThemeConstants.SPACE_MD, right: ThemeConstants.SPACE_MD })
      .backgroundColor(ThemeColors.BG_CARD)
      .borderRadius(ThemeConstants.RADIUS_SM)
    }
  }

  @Builder
  InputItem(label: string, placeholder: string, value: string, onChange: (value: string) => void) {
    Column({ space: 8 }) {
      Text(label)
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .width('100%')

      TextInput({ placeholder: placeholder, text: value })
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .placeholderColor(ThemeColors.TEXT_HINT)
        .backgroundColor(ThemeColors.BG_CARD)
        .borderRadius(ThemeConstants.RADIUS_SM)
        .height(50)
        .padding({ left: ThemeConstants.SPACE_MD, right: ThemeConstants.SPACE_MD })
        .shadow({ radius: 4, color: 'rgba(0,0,0,0.04)', offsetY: 1 })
        .onChange(onChange)
    }
  }

  @Builder
  WeatherSelector() {
    Column({ space: 8 }) {
      Text('ğŸŒ¤ï¸?å¤©æ°”')
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .width('100%')

      Scroll() {
        Row({ space: 8 }) {
          ForEach(this.weatherOptions, (option: string) => {
            Column({ space: 4 }) {
              Text(this.getWeatherIcon(option))
                .fontSize(20)
              Text(option)
                .fontSize(ThemeConstants.FONT_SIZE_XS)
                .fontColor(this.weather === option ? ThemeColors.TEXT_PRIMARY : ThemeColors.TEXT_SECONDARY)
            }
            .width(60)
            .padding({ top: 10, bottom: 10 })
            .backgroundColor(this.weather === option ? ThemeColors.PRIMARY : ThemeColors.BG_CARD)
            .borderRadius(ThemeConstants.RADIUS_SM)
            .shadow(this.weather === option ? { radius: 4, color: 'rgba(232,168,73,0.3)', offsetY: 2 } : undefined)
            .onClick(() => {
              this.weather = option;
            })
          })
        }
      }
      .scrollable(ScrollDirection.Horizontal)
      .scrollBar(BarState.Off)
      .width('100%')
    }
  }

  private getWeatherIcon(weather: string): string {
    const icons: Record<string, string> = {
      'æ™´æœ—': 'â˜€ï¸?,
      'å¤šäº‘': 'â›?,
      'é˜´å¤©': 'â˜ï¸',
      'å°é›¨': 'ğŸŒ§ï¸?,
      'å¤§é£': 'ğŸ’¨'
    };
    return icons[weather] || 'ğŸŒ¤ï¸?;
  }

  @Builder
  FishSelector() {
    Column({ space: 8 }) {
      Row() {
        Text('ğŸŸ é±¼ç§')
          .fontSize(ThemeConstants.FONT_SIZE_SM)
          .fontColor(ThemeColors.TEXT_SECONDARY)
        
        if (this.selectedFishList.length > 0) {
          Text(`ï¼ˆå·²é€?{this.selectedFishList.length}ç§ï¼‰`)
            .fontSize(ThemeConstants.FONT_SIZE_XS)
            .fontColor(ThemeColors.PRIMARY_DARK)
            .margin({ left: 4 })
        }
      }
      .width('100%')

      Flex({ wrap: FlexWrap.Wrap }) {
        ForEach(this.fishOptions, (option: FishOption) => {
          Stack() {
            Column({ space: 4 }) {
              Image(option.icon)
                .width(28)
                .height(28)
                .objectFit(ImageFit.Contain)
              Text(option.name)
                .fontSize(ThemeConstants.FONT_SIZE_XS)
                .fontColor(this.isFishSelected(option.name) ? ThemeColors.TEXT_PRIMARY : ThemeColors.TEXT_SECONDARY)
            }
            .width(64)
            .padding({ top: 8, bottom: 8 })
            .backgroundColor(this.isFishSelected(option.name) ? ThemeColors.PRIMARY : ThemeColors.BG_CARD)
            .borderRadius(ThemeConstants.RADIUS_SM)
            .shadow(this.isFishSelected(option.name) ? { radius: 4, color: 'rgba(232,168,73,0.3)', offsetY: 2 } : undefined)

            // é€‰ä¸­æ ‡è®°
            if (this.isFishSelected(option.name)) {
              Text('âœ?)
                .fontSize(10)
                .fontColor(Color.White)
                .backgroundColor(ThemeColors.SUCCESS)
                .borderRadius(8)
                .width(16)
                .height(16)
                .textAlign(TextAlign.Center)
                .position({ x: 48, y: 0 })
            }
          }
          .margin({ right: 8, bottom: 8 })
          .onClick(() => {
            this.toggleFishSelection(option.name);
          })
        })
      }
      .width('100%')
    }
  }

  @Builder
  PhotoSelector() {
    Column({ space: 8 }) {
      Text('ğŸ“· æ¸”è·å›¾ç‰‡ (å¯é€?')
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .width('100%')

      Scroll() {
        Row({ space: 8 }) {
          // å·²é€‰å›¾ç‰?
          ForEach(this.photos, (photo: string, index: number) => {
            Stack() {
              Image(photo)
                .width(80)
                .height(80)
                .objectFit(ImageFit.Cover)
                .borderRadius(ThemeConstants.RADIUS_SM)

              // åˆ é™¤æŒ‰é’®
              Text('Ã—')
                .fontSize(14)
                .fontColor(Color.White)
                .backgroundColor('rgba(0,0,0,0.5)')
                .borderRadius(10)
                .width(20)
                .height(20)
                .textAlign(TextAlign.Center)
                .position({ x: 56, y: 4 })
                .onClick(() => {
                  this.photos = this.photos.filter((_: string, i: number) => i !== index);
                })
            }
            .width(80)
            .height(80)
          }, (photo: string, index: number) => `photo_${index}_${photo}`)

          // æ·»åŠ æŒ‰é’®ï¼ˆæœ€å¤?å¼ ï¼‰
          if (this.photos.length < 3) {
            Column() {
              Text('ğŸ“·')
                .fontSize(24)
              Text('æ·»åŠ å›¾ç‰‡')
                .fontSize(ThemeConstants.FONT_SIZE_XS)
                .fontColor(ThemeColors.TEXT_SECONDARY)
                .margin({ top: 4 })
            }
            .width(80)
            .height(80)
            .justifyContent(FlexAlign.Center)
            .backgroundColor(ThemeColors.BG_CARD)
            .borderRadius(ThemeConstants.RADIUS_SM)
            .border({ width: 1, color: ThemeColors.TEXT_MUTED, style: BorderStyle.Dashed })
            .onClick(() => {
              this.selectPhoto();
            })
          }
        }
      }
      .scrollable(ScrollDirection.Horizontal)
      .scrollBar(BarState.Off)
      .width('100%')
    }
  }

  // é€‰æ‹©å›¾ç‰‡
  private async selectPhoto(): Promise<void> {
    try {
      const photoPicker = new picker.PhotoViewPicker();
      const result = await photoPicker.select({
        MIMEType: picker.PhotoViewMIMETypes.IMAGE_TYPE,
        maxSelectNumber: 3 - this.photos.length
      });

      if (result.photoUris && result.photoUris.length > 0) {
        this.photos = [...this.photos, ...result.photoUris];
      }
    } catch (error) {
      console.error('é€‰æ‹©å›¾ç‰‡å¤±è´¥:', error);
      promptAction.showToast({ message: 'é€‰æ‹©å›¾ç‰‡å¤±è´¥' });
    }
  }

  @Builder
  NotesInput() {
    Column({ space: 8 }) {
      Row() {
        Text('ğŸ“ å¤‡æ³¨')
          .fontSize(ThemeConstants.FONT_SIZE_SM)
          .fontColor(ThemeColors.TEXT_SECONDARY)

        Blank()

        // è¯­éŸ³è¾“å…¥æŒ‰é’®
        Row({ space: 4 }) {
          if (this.isAsrInitializing) {
            LoadingProgress()
              .width(14)
              .height(14)
              .color(ThemeColors.PRIMARY)
          } else {
            Text(this.isRecording ? 'ğŸ”´' : 'ğŸ¤')
              .fontSize(16)
          }
          Text(this.isAsrInitializing ? 'åˆå§‹åŒ?..' : (this.isRecording ? 'å½•éŸ³ä¸?..' : 'è¯­éŸ³è¾“å…¥'))
            .fontSize(ThemeConstants.FONT_SIZE_XS)
            .fontColor(this.isRecording ? ThemeColors.ERROR : ThemeColors.PRIMARY)
        }
        .padding({ left: 8, right: 8, top: 4, bottom: 4 })
        .backgroundColor(this.isRecording ? 'rgba(255,77,79,0.1)' : ThemeColors.PRIMARY_LIGHT)
        .borderRadius(ThemeConstants.RADIUS_FULL)
        .enabled(!this.isAsrInitializing)
        .opacity(this.isAsrInitializing ? 0.6 : 1)
        .onClick(() => {
          if (this.isRecording) {
            this.stopVoiceInput();
          } else {
            this.startVoiceInput();
          }
        })
      }
      .width('100%')

      // å®æ—¶è¯†åˆ«æ–‡å­—æ˜¾ç¤º
      if (this.isRecording && this.recordingText) {
        Text(this.recordingText)
          .fontSize(ThemeConstants.FONT_SIZE_SM)
          .fontColor(ThemeColors.PRIMARY_DARK)
          .width('100%')
          .padding(8)
          .backgroundColor(ThemeColors.PRIMARY_LIGHT)
          .borderRadius(ThemeConstants.RADIUS_SM)
      }

      TextArea({ placeholder: 'è®°å½•ä¸€äº›å¿ƒå¾—ä½“ä¼?..', text: this.notes })
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .placeholderColor(ThemeColors.TEXT_HINT)
        .backgroundColor(ThemeColors.BG_CARD)
        .borderRadius(ThemeConstants.RADIUS_SM)
        .height(100)
        .padding(ThemeConstants.SPACE_MD)
        .onChange((value: string) => {
          this.notes = value;
        })
    }
  }

  // æ£€æŸ¥éº¦å…‹é£æƒé™
  private async checkMicPermission(): Promise<boolean> {
    const atManager = abilityAccessCtrl.createAtManager();
    const context = getContext(this) as common.UIAbilityContext;
    const tokenId = context.applicationInfo.accessTokenId;
    const grantStatus = atManager.checkAccessTokenSync(tokenId, 'ohos.permission.MICROPHONE');
    return grantStatus === abilityAccessCtrl.GrantStatus.PERMISSION_GRANTED;
  }

  // è¯·æ±‚éº¦å…‹é£æƒé™?
  private async requestMicPermission(): Promise<boolean> {
    const permissions: Permissions[] = ['ohos.permission.MICROPHONE'];
    const atManager = abilityAccessCtrl.createAtManager();
    const context = getContext(this) as common.UIAbilityContext;
    const result = await atManager.requestPermissionsFromUser(context, permissions);
    return result.authResults[0] === abilityAccessCtrl.GrantStatus.PERMISSION_GRANTED;
  }

  // åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«å¼•æ“ï¼ˆå¼‚æ­¥ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ï¼?
  private async initAsrEngine(): Promise<boolean> {
    if (this.asrEngine) return true;

    return new Promise((resolve) => {
      // ä½¿ç”¨ setTimeout å°†å¼•æ“åˆ›å»ºæ¨è¿Ÿåˆ°ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯ï¼Œé¿å…é˜»å¡UI
      setTimeout(() => {
        const extraParam: Record<string, Object> = {
          'locate': 'CN',
          'recognizerMode': 'short'
        };

        // ä¼˜å…ˆä½¿ç”¨ç¦»çº¿æ¨¡å¼ï¼ˆæ›´ç¨³å®šï¼Œä¸ä¾èµ–ç½‘ç»œï¼?
        const initParams: speechRecognizer.CreateEngineParams = {
          language: 'zh-CN',
          online: 1,  // 1=ç¦»çº¿æ¨¡å¼
          extraParams: extraParam
        };

        speechRecognizer.createEngine(initParams, (err, engine) => {
          if (!err && engine) {
            this.asrEngine = engine;
            this.setupAsrListener();
            resolve(true);
          } else {
            console.error('ç¦»çº¿è¯­éŸ³è¯†åˆ«å¼•æ“åˆ›å»ºå¤±è´¥:', JSON.stringify(err));
            // ç¦»çº¿å¤±è´¥ï¼Œå°è¯•åœ¨çº¿æ¨¡å¼?
            const onlineParams: speechRecognizer.CreateEngineParams = {
              language: 'zh-CN',
              online: 0,  // 0=åœ¨çº¿æ¨¡å¼
              extraParams: extraParam
            };
            speechRecognizer.createEngine(onlineParams, (err2, engine2) => {
              if (!err2 && engine2) {
                this.asrEngine = engine2;
                this.setupAsrListener();
                resolve(true);
              } else {
                console.error('åœ¨çº¿è¯­éŸ³è¯†åˆ«å¼•æ“ä¹Ÿå¤±è´?', JSON.stringify(err2));
                resolve(false);
              }
            });
          }
        });
      }, 0);
    });
  }

  // è®¾ç½®è¯­éŸ³è¯†åˆ«ç›‘å¬
  private setupAsrListener(): void {
    if (!this.asrEngine) return;

    const listener: speechRecognizer.RecognitionListener = {
      onStart: (sessionId: string, eventMessage: string) => {
        console.info('è¯­éŸ³è¯†åˆ«å¼€å§?);
      },
      onEvent: (sessionId: string, eventCode: number, eventMessage: string) => {
        console.info('è¯­éŸ³è¯†åˆ«äº‹ä»¶:', eventCode);
      },
      onResult: (sessionId: string, result: speechRecognizer.SpeechRecognitionResult) => {
        const text = result.result || '';
        this.recordingText = text;
        if (result.isFinal) {
          // æœ€ç»ˆç»“æœè¿½åŠ åˆ°å¤‡æ³¨
          this.notes = this.notes ? this.notes + text : text;
          this.recordingText = '';
        }
      },
      onComplete: (sessionId: string, eventMessage: string) => {
        this.isRecording = false;
        this.recordingText = '';
        console.info('è¯­éŸ³è¯†åˆ«å®Œæˆ');
      },
      onError: (sessionId: string, errorCode: number, errorMessage: string) => {
        this.isRecording = false;
        this.recordingText = '';
        console.error('è¯­éŸ³è¯†åˆ«é”™è¯¯:', errorCode, errorMessage);
        promptAction.showToast({ message: 'è¯­éŸ³è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•' });
      }
    };
    this.asrEngine.setListener(listener);
  }

  // å¼€å§‹è¯­éŸ³è¾“å…?
  private async startVoiceInput(): Promise<void> {
    // é˜²æ­¢é‡å¤ç‚¹å‡»
    if (this.isAsrInitializing || this.isRecording) return;

    // æ£€æŸ¥æƒé™?
    const hasPermission = await this.checkMicPermission();
    if (!hasPermission) {
      const granted = await this.requestMicPermission();
      if (!granted) {
        promptAction.showToast({ message: 'éœ€è¦éº¦å…‹é£æƒé™æ‰èƒ½ä½¿ç”¨è¯­éŸ³è¾“å…¥' });
        return;
      }
    }

    // æ˜¾ç¤ºåˆå§‹åŒ–çŠ¶æ€?
    this.isAsrInitializing = true;

    // åˆå§‹åŒ–å¼•æ“?
    const initialized = await this.initAsrEngine();
    this.isAsrInitializing = false;

    if (!initialized) {
      promptAction.showToast({ message: 'è¯­éŸ³è¯†åˆ«åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥è®¾å¤‡æ˜¯å¦æ”¯æŒ? });
      return;
    }

    // å¼€å§‹è¯†åˆ?
    this.asrSessionId = `asr_${Date.now()}`;
    const audioParam: speechRecognizer.AudioInfo = {
      audioType: 'pcm',
      sampleRate: 16000,
      soundChannel: 1,
      sampleBit: 16
    };

    const extraParam: Record<string, Object> = {
      'recognitionMode': 0,
      'vadBegin': 2000,
      'vadEnd': 3000,
      'maxAudioDuration': 60000
    };

    const recognizerParams: speechRecognizer.StartParams = {
      sessionId: this.asrSessionId,
      audioInfo: audioParam,
      extraParams: extraParam
    };

    this.asrEngine!.startListening(recognizerParams);
    this.isRecording = true;
    this.recordingText = '';
  }

  // åœæ­¢è¯­éŸ³è¾“å…¥
  private stopVoiceInput(): void {
    if (this.asrEngine && this.isRecording) {
      this.asrEngine.finish(this.asrSessionId);
      this.isRecording = false;
    }
  }

  @Builder
  RecipeSelector() {
    Column({ space: 8 }) {
      Text('ğŸ§ª ä½¿ç”¨é…æ–¹ (å¯é€?')
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .width('100%')

      Row() {
        Text(this.selectedRecipe || 'ç‚¹å‡»é€‰æ‹©é…æ–¹')
          .fontSize(ThemeConstants.FONT_SIZE_BASE)
          .fontColor(this.selectedRecipe ? ThemeColors.TEXT_PRIMARY : ThemeColors.TEXT_HINT)
          .layoutWeight(1)

        if (this.selectedRecipe) {
          Text('Ã—')
            .fontSize(ThemeConstants.FONT_SIZE_MD)
            .fontColor(ThemeColors.TEXT_MUTED)
            .padding({ left: 8, right: 8 })
            .onClick(() => {
              this.selectedRecipeId = '';
              this.selectedRecipe = '';
            })
        }

        Text('>')
          .fontSize(ThemeConstants.FONT_SIZE_MD)
          .fontColor(ThemeColors.TEXT_MUTED)
      }
      .width('100%')
      .height(50)
      .padding({ left: ThemeConstants.SPACE_MD, right: ThemeConstants.SPACE_MD })
      .backgroundColor(ThemeColors.BG_CARD)
      .borderRadius(ThemeConstants.RADIUS_SM)
      .shadow({ radius: 4, color: 'rgba(0,0,0,0.04)', offsetY: 1 })
      .onClick(() => {
        this.showRecipeSelector = true;
      })
    }
  }

  @Builder
  RecipeSelectorDialog() {
    Stack() {
      // é®ç½©
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0,0,0,0.5)')
        .onClick(() => {
          this.showRecipeSelector = false;
        })

      // å¼¹çª—å†…å®¹
      Column() {
        // æ ‡é¢˜æ ?
        Row() {
          Text('é€‰æ‹©é…æ–¹')
            .fontSize(ThemeConstants.FONT_SIZE_LG)
            .fontWeight(FontWeight.Bold)
            .fontColor(ThemeColors.TEXT_PRIMARY)

          Blank()

          Text('Ã—')
            .fontSize(24)
            .fontColor(ThemeColors.TEXT_SECONDARY)
            .onClick(() => {
              this.showRecipeSelector = false;
            })
        }
        .width('100%')
        .padding({ left: ThemeConstants.SPACE_MD, right: ThemeConstants.SPACE_MD, top: ThemeConstants.SPACE_MD })

        // æ‰‹åŠ¨è¾“å…¥
        Row({ space: 8 }) {
          TextInput({ placeholder: 'æˆ–æ‰‹åŠ¨è¾“å…¥é…æ–¹åç§?, text: this.selectedRecipe })
            .fontSize(ThemeConstants.FONT_SIZE_BASE)
            .fontColor(ThemeColors.TEXT_PRIMARY)
            .placeholderColor(ThemeColors.TEXT_HINT)
            .backgroundColor(ThemeColors.BG_TERTIARY)
            .borderRadius(ThemeConstants.RADIUS_SM)
            .height(44)
            .layoutWeight(1)
            .padding({ left: ThemeConstants.SPACE_MD, right: ThemeConstants.SPACE_MD })
            .onChange((value: string) => {
              this.selectedRecipe = value;
              this.selectedRecipeId = '';
            })

          Button('ç¡®å®š')
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(Color.White)
            .backgroundColor(ThemeColors.PRIMARY)
            .borderRadius(ThemeConstants.RADIUS_SM)
            .height(44)
            .onClick(() => {
              this.showRecipeSelector = false;
            })
        }
        .width('100%')
        .padding({ left: ThemeConstants.SPACE_MD, right: ThemeConstants.SPACE_MD, top: ThemeConstants.SPACE_MD })

        // é…æ–¹åˆ—è¡¨
        if (this.recipeOptions.length > 0) {
          Text('å¯é€‰é…æ–?)
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.TEXT_SECONDARY)
            .width('100%')
            .padding({ left: ThemeConstants.SPACE_MD, top: ThemeConstants.SPACE_MD })

          Scroll() {
            Column({ space: 8 }) {
              ForEach(this.recipeOptions, (option: RecipeOption) => {
                Row() {
                  Column({ space: 4 }) {
                    Row({ space: 6 }) {
                      Text(option.name)
                        .fontSize(ThemeConstants.FONT_SIZE_BASE)
                        .fontColor(ThemeColors.TEXT_PRIMARY)
                        .maxLines(1)
                        .textOverflow({ overflow: TextOverflow.Ellipsis })
                        .layoutWeight(1)
                      if (option.isFavorite) {
                        Text('â¤ï¸')
                          .fontSize(12)
                      }
                      if (option.isUserRecipe) {
                        Text('è‡ªåˆ›')
                          .fontSize(ThemeConstants.FONT_SIZE_XS)
                          .fontColor(ThemeColors.PRIMARY_DARK)
                          .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                          .backgroundColor(ThemeColors.PRIMARY_LIGHT)
                          .borderRadius(4)
                      }
                    }
                    .width('100%')
                    Text(`ğŸŸ ${option.targetFish}`)
                      .fontSize(ThemeConstants.FONT_SIZE_XS)
                      .fontColor(ThemeColors.TEXT_SECONDARY)
                  }
                  .alignItems(HorizontalAlign.Start)
                  .layoutWeight(1)

                  if (this.selectedRecipeId === option.id) {
                    Text('âœ?)
                      .fontSize(18)
                      .fontColor(ThemeColors.PRIMARY_DARK)
                  }
                }
                .width('100%')
                .padding(ThemeConstants.SPACE_MD)
                .backgroundColor(this.selectedRecipeId === option.id ? ThemeColors.PRIMARY_LIGHT : ThemeColors.BG_CARD)
                .borderRadius(ThemeConstants.RADIUS_SM)
                .onClick(() => {
                  this.selectedRecipeId = option.id;
                  this.selectedRecipe = option.name;
                  this.showRecipeSelector = false;
                })
              })
            }
            .padding({ left: ThemeConstants.SPACE_MD, right: ThemeConstants.SPACE_MD, bottom: ThemeConstants.SPACE_MD })
          }
          .layoutWeight(1)
          .scrollBar(BarState.Off)
        } else {
          Column() {
            Text('ğŸ“­')
              .fontSize(40)
            Text('æš‚æ— å¯é€‰é…æ–?)
              .fontSize(ThemeConstants.FONT_SIZE_SM)
              .fontColor(ThemeColors.TEXT_SECONDARY)
              .margin({ top: 8 })
            Text('å¯ä»¥æ‰‹åŠ¨è¾“å…¥é…æ–¹åç§°')
              .fontSize(ThemeConstants.FONT_SIZE_XS)
              .fontColor(ThemeColors.TEXT_MUTED)
              .margin({ top: 4 })
          }
          .width('100%')
          .padding({ top: 40, bottom: 40 })
        }
      }
      .width('90%')
      .height('60%')
      .backgroundColor(ThemeColors.BG_SECONDARY)
      .borderRadius(ThemeConstants.RADIUS_LG)
    }
    .width('100%')
    .height('100%')
    .position({ x: 0, y: 0 })
  }

  @Builder
  SaveButton() {
    Button() {
      if (this.isSaving) {
        Row({ space: 8 }) {
          LoadingProgress()
            .width(20)
            .height(20)
            .color(ThemeColors.TEXT_PRIMARY)
          Text('ä¿å­˜ä¸?..')
            .fontSize(ThemeConstants.FONT_SIZE_MD)
            .fontColor(ThemeColors.TEXT_PRIMARY)
        }
      } else {
        Row({ space: 8 }) {
          Text('âœ?)
            .fontSize(18)
            .fontColor(ThemeColors.TEXT_PRIMARY)
          Text('ä¿å­˜è®°å½•')
            .fontSize(ThemeConstants.FONT_SIZE_MD)
            .fontColor(ThemeColors.TEXT_PRIMARY)
            .fontWeight(FontWeight.Medium)
        }
      }
    }
    .backgroundColor(ThemeColors.PRIMARY)
    .borderRadius(ThemeConstants.RADIUS_MD)
    .width('100%')
    .height(52)
    .margin({ top: ThemeConstants.SPACE_LG })
    .enabled(!this.isSaving && !this.hasSaved)
    .opacity(this.hasSaved ? 0.5 : 1)
    .shadow({ radius: 8, color: 'rgba(232,168,73,0.4)', offsetY: 4 })
    .onClick(() => {
      this.saveRecord();
    })
  }

  // æ˜¾ç¤ºç‚«è€€å¼¹çª—
  private showVictoryDialog(record: FishingRecord): void {
    promptAction.showDialog({
      title: 'ğŸ‰ è®°å½•ä¿å­˜æˆåŠŸ',
      message: 'è¦ç”Ÿæˆä¸€å¼ ç²¾ç¾çš„æ¸”è·åˆ†äº«å›¾ç‚«è€€ä¸€ä¸‹å—ï¼?,
      buttons: [
        { text: 'è·³è¿‡', color: ThemeColors.TEXT_MUTED },
        { text: 'ç‚«è€€ä¸€ä¸?ğŸ†', color: ThemeColors.PRIMARY }
      ]
    }).then((result) => {
      if (result.index === 1) {
        const params: Record<string, FishingRecord> = { 'record': record };
        Router.push('pages/VictorySharePage', params as RouteParams);
      } else {
        Router.back();
      }
    }).catch(() => {
      Router.back();
    });
  }

  private saveRecord(): void {
    // é˜²æ­¢é‡å¤æäº¤
    if (this.isSaving || this.hasSaved) {
      return;
    }
    
    // éªŒè¯å¿…å¡«å­—æ®µ
    if (!this.location.trim()) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥é’“ç‚¹ä½ç½? });
      return;
    }
    if (this.selectedFishList.length === 0) {
      promptAction.showToast({ message: 'è¯·é€‰æ‹©é±¼ç§' });
      return;
    }
    if (!this.weight || parseFloat(this.weight) <= 0) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥æœ‰æ•ˆé‡é‡? });
      return;
    }

    this.isSaving = true;

    // åˆ›å»ºè®°å½•
    const record = new FishingRecord();
    record.location = this.location.trim();
    record.fishName = this.selectedFishList.join('ã€?);  // å¤šé±¼ç§ç”¨é¡¿å·è¿æ¥
    record.fishIcon = 'ğŸŸ';
    record.weight = parseFloat(this.weight) || 0;
    record.count = parseInt(this.count) || 1;
    record.maxSingle = record.count > 0 ? Math.round((record.weight / record.count) * 100) / 100 : record.weight;
    record.recipeName = this.selectedRecipe.trim();
    record.recipeId = this.selectedRecipeId;
    record.weather = this.weather;
    record.notes = this.notes.trim();
    record.photos = this.photos;  // ä¿å­˜å›¾ç‰‡
    record.date = new Date(this.selectedDate).getTime();
    record.dateStr = this.selectedDate;

    // ä¿å­˜è®°å½•
    fishingRecordService.addRecord(record).then(() => {
      // ä¿å­˜ä¸Šæ¬¡ä½¿ç”¨çš„é’“ç‚¹å’Œå¤©æ°”
      this.saveLastSettings();

      this.isSaving = false;
      this.hasSaved = true;  // æ ‡è®°å·²ä¿å­˜ï¼Œé˜²æ­¢é‡å¤ä¿å­˜
      
      // æ˜¾ç¤ºç‚«è€€å¼¹çª—
      this.showVictoryDialog(record);
    }).catch(() => {
      this.isSaving = false;
      promptAction.showToast({ message: 'ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•' });
    });
  }
}
