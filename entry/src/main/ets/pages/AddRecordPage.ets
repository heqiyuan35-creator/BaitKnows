/**
 * é¥µçŸ¥é“ - æ·»åŠ æ¸”è·è®°å½•é¡µ
 * è®°å½•é’“é±¼æˆæœ
 */
import { ThemeColors } from '../theme/ThemeColors';
import { ThemeConstants } from '../theme/ThemeConstants';
import { Router } from '../router/Router';
import { FishingRecord } from '../common/types/UserTypes';
import { fishingRecordService } from '../services/FishingRecordService';
import { promptAction } from '@kit.ArkUI';

// é±¼ç§é€‰é¡¹
interface FishOption {
  name: string;
  icon: Resource;
}

@Entry
@Component
struct AddRecordPage {
  @State selectedDate: string = '';
  @State location: string = '';
  @State selectedFish: string = '';
  @State weight: string = '';
  @State count: string = '1';
  @State selectedRecipe: string = '';
  @State weather: string = 'æ™´æœ—';
  @State notes: string = '';
  @State isSaving: boolean = false;

  private fishOptions: FishOption[] = [
    { name: 'é²¤é±¼', icon: $r('app.media.Carp') },
    { name: 'è‰é±¼', icon: $r('app.media.Grass_carp') },
    { name: 'é²«é±¼', icon: $r('app.media.Crucian_carp') },
    { name: 'é’é±¼', icon: $r('app.media.Black_carp') },
    { name: 'é²¶é±¼', icon: $r('app.media.Catfish') },
    { name: 'é²¢é±¼', icon: $r('app.media.Fish') },
    { name: 'é³™é±¼', icon: $r('app.media.Fish') },
    { name: 'é»‘é±¼', icon: $r('app.media.Fish') },
    { name: 'å…¶ä»–', icon: $r('app.media.Fish') }
  ];

  private weatherOptions: string[] = ['æ™´æœ—', 'å¤šäº‘', 'é˜´å¤©', 'å°é›¨', 'å¤§é£'];

  aboutToAppear(): void {
    // é»˜è®¤ä»Šå¤©æ—¥æœŸ
    const today = new Date();
    const year = today.getFullYear();
    const month = (today.getMonth() + 1).toString().padStart(2, '0');
    const day = today.getDate().toString().padStart(2, '0');
    this.selectedDate = `${year}-${month}-${day}`;
  }

  build() {
    Column() {
      this.HeaderBar()

      Scroll() {
        Column({ space: ThemeConstants.SPACE_MD }) {
          // æ—¥æœŸé€‰æ‹©
          this.FormItem('ğŸ“… æ—¥æœŸ', this.selectedDate)

          // é’“ç‚¹ä½ç½®
          this.InputItem('ğŸ“ é’“ç‚¹ä½ç½®', 'è¯·è¾“å…¥é’“ç‚¹åç§°', this.location, (value: string) => {
            this.location = value;
          })

          // å¤©æ°”é€‰æ‹©
          this.WeatherSelector()

          // é±¼ç§é€‰æ‹©
          this.FishSelector()

          // é‡é‡è¾“å…¥
          this.InputItem('âš–ï¸ æ€»é‡é‡ (kg)', 'è¯·è¾“å…¥é‡é‡', this.weight, (value: string) => {
            this.weight = value;
          })

          // æ•°é‡è¾“å…¥
          this.InputItem('ğŸ”¢ æ•°é‡ (å°¾)', 'è¯·è¾“å…¥æ•°é‡', this.count, (value: string) => {
            this.count = value;
          })

          // ä½¿ç”¨é…æ–¹
          this.InputItem('ğŸ§ª ä½¿ç”¨é…æ–¹', 'è¯·è¾“å…¥é…æ–¹åç§°', this.selectedRecipe, (value: string) => {
            this.selectedRecipe = value;
          })

          // å¤‡æ³¨
          this.NotesInput()

          // ä¿å­˜æŒ‰é’®
          this.SaveButton()
        }
        .padding({ left: ThemeConstants.SPACE_MD, right: ThemeConstants.SPACE_MD, bottom: 40 })
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(ThemeColors.BG_PRIMARY)
  }

  @Builder
  HeaderBar() {
    Row() {
      Image($r('app.media.Left'))
        .width(24)
        .height(24)
        .fillColor(ThemeColors.TEXT_PRIMARY)
        .onClick(() => Router.back())

      Blank()

      Text('æ·»åŠ è®°å½•')
        .fontSize(ThemeConstants.FONT_SIZE_LG)
        .fontWeight(FontWeight.Medium)
        .fontColor(ThemeColors.TEXT_PRIMARY)

      Blank()

      Row().width(24)
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16, top: 40 })
  }


  @Builder
  FormItem(label: string, value: string) {
    Column({ space: 8 }) {
      Text(label)
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .width('100%')

      Row() {
        Text(value)
          .fontSize(ThemeConstants.FONT_SIZE_BASE)
          .fontColor(ThemeColors.TEXT_PRIMARY)
        Blank()
        Text('>')
          .fontSize(ThemeConstants.FONT_SIZE_MD)
          .fontColor(ThemeColors.TEXT_MUTED)
      }
      .width('100%')
      .height(48)
      .padding({ left: ThemeConstants.SPACE_MD, right: ThemeConstants.SPACE_MD })
      .backgroundColor(ThemeColors.BG_CARD)
      .borderRadius(ThemeConstants.RADIUS_SM)
    }
  }

  @Builder
  InputItem(label: string, placeholder: string, value: string, onChange: (value: string) => void) {
    Column({ space: 8 }) {
      Text(label)
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .width('100%')

      TextInput({ placeholder: placeholder, text: value })
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .placeholderColor(ThemeColors.TEXT_HINT)
        .backgroundColor(ThemeColors.BG_CARD)
        .borderRadius(ThemeConstants.RADIUS_SM)
        .height(50)
        .padding({ left: ThemeConstants.SPACE_MD, right: ThemeConstants.SPACE_MD })
        .shadow({ radius: 4, color: 'rgba(0,0,0,0.04)', offsetY: 1 })
        .onChange(onChange)
    }
  }

  @Builder
  WeatherSelector() {
    Column({ space: 8 }) {
      Text('ğŸŒ¤ï¸ å¤©æ°”')
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .width('100%')

      Scroll() {
        Row({ space: 8 }) {
          ForEach(this.weatherOptions, (option: string) => {
            Column({ space: 4 }) {
              Text(this.getWeatherIcon(option))
                .fontSize(20)
              Text(option)
                .fontSize(ThemeConstants.FONT_SIZE_XS)
                .fontColor(this.weather === option ? ThemeColors.TEXT_PRIMARY : ThemeColors.TEXT_SECONDARY)
            }
            .width(60)
            .padding({ top: 10, bottom: 10 })
            .backgroundColor(this.weather === option ? ThemeColors.PRIMARY : ThemeColors.BG_CARD)
            .borderRadius(ThemeConstants.RADIUS_SM)
            .shadow(this.weather === option ? { radius: 4, color: 'rgba(232,168,73,0.3)', offsetY: 2 } : undefined)
            .onClick(() => {
              this.weather = option;
            })
          })
        }
      }
      .scrollable(ScrollDirection.Horizontal)
      .scrollBar(BarState.Off)
      .width('100%')
    }
  }

  private getWeatherIcon(weather: string): string {
    const icons: Record<string, string> = {
      'æ™´æœ—': 'â˜€ï¸',
      'å¤šäº‘': 'â›…',
      'é˜´å¤©': 'â˜ï¸',
      'å°é›¨': 'ğŸŒ§ï¸',
      'å¤§é£': 'ğŸ’¨'
    };
    return icons[weather] || 'ğŸŒ¤ï¸';
  }

  @Builder
  FishSelector() {
    Column({ space: 8 }) {
      Text('ğŸŸ é±¼ç§')
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .width('100%')

      Flex({ wrap: FlexWrap.Wrap }) {
        ForEach(this.fishOptions, (option: FishOption) => {
          Column({ space: 4 }) {
            Image(option.icon)
              .width(28)
              .height(28)
              .objectFit(ImageFit.Contain)
            Text(option.name)
              .fontSize(ThemeConstants.FONT_SIZE_XS)
              .fontColor(this.selectedFish === option.name ? ThemeColors.TEXT_PRIMARY : ThemeColors.TEXT_SECONDARY)
          }
          .width(64)
          .padding({ top: 8, bottom: 8 })
          .backgroundColor(this.selectedFish === option.name ? ThemeColors.PRIMARY : ThemeColors.BG_CARD)
          .borderRadius(ThemeConstants.RADIUS_SM)
          .margin({ right: 8, bottom: 8 })
          .shadow(this.selectedFish === option.name ? { radius: 4, color: 'rgba(232,168,73,0.3)', offsetY: 2 } : undefined)
          .onClick(() => {
            this.selectedFish = option.name;
          })
        })
      }
      .width('100%')
    }
  }

  @Builder
  NotesInput() {
    Column({ space: 8 }) {
      Text('ğŸ“ å¤‡æ³¨')
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .width('100%')

      TextArea({ placeholder: 'è®°å½•ä¸€äº›å¿ƒå¾—ä½“ä¼š...', text: this.notes })
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .placeholderColor(ThemeColors.TEXT_HINT)
        .backgroundColor(ThemeColors.BG_CARD)
        .borderRadius(ThemeConstants.RADIUS_SM)
        .height(100)
        .padding(ThemeConstants.SPACE_MD)
        .onChange((value: string) => {
          this.notes = value;
        })
    }
  }

  @Builder
  SaveButton() {
    Button() {
      if (this.isSaving) {
        Row({ space: 8 }) {
          LoadingProgress()
            .width(20)
            .height(20)
            .color(ThemeColors.TEXT_PRIMARY)
          Text('ä¿å­˜ä¸­...')
            .fontSize(ThemeConstants.FONT_SIZE_MD)
            .fontColor(ThemeColors.TEXT_PRIMARY)
        }
      } else {
        Row({ space: 8 }) {
          Text('âœ“')
            .fontSize(18)
            .fontColor(ThemeColors.TEXT_PRIMARY)
          Text('ä¿å­˜è®°å½•')
            .fontSize(ThemeConstants.FONT_SIZE_MD)
            .fontColor(ThemeColors.TEXT_PRIMARY)
            .fontWeight(FontWeight.Medium)
        }
      }
    }
    .backgroundColor(ThemeColors.PRIMARY)
    .borderRadius(ThemeConstants.RADIUS_MD)
    .width('100%')
    .height(52)
    .margin({ top: ThemeConstants.SPACE_LG })
    .enabled(!this.isSaving)
    .shadow({ radius: 8, color: 'rgba(232,168,73,0.4)', offsetY: 4 })
    .onClick(() => {
      this.saveRecord();
    })
  }

  private saveRecord(): void {
    // éªŒè¯å¿…å¡«å­—æ®µ
    if (!this.location.trim()) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥é’“ç‚¹ä½ç½®' });
      return;
    }
    if (!this.selectedFish) {
      promptAction.showToast({ message: 'è¯·é€‰æ‹©é±¼ç§' });
      return;
    }
    if (!this.weight || parseFloat(this.weight) <= 0) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥æœ‰æ•ˆé‡é‡' });
      return;
    }

    this.isSaving = true;

    // åˆ›å»ºè®°å½•
    const record = new FishingRecord();
    record.location = this.location.trim();
    record.fishName = this.selectedFish;
    record.fishIcon = 'ğŸŸ';
    record.weight = parseFloat(this.weight) || 0;
    record.count = parseInt(this.count) || 1;
    record.maxSingle = record.count > 0 ? Math.round((record.weight / record.count) * 100) / 100 : record.weight;
    record.recipeName = this.selectedRecipe.trim();
    record.weather = this.weather;
    record.notes = this.notes.trim();
    record.date = new Date(this.selectedDate).getTime();
    record.dateStr = this.selectedDate;

    // ä¿å­˜è®°å½•
    fishingRecordService.addRecord(record).then(() => {
      this.isSaving = false;
      promptAction.showToast({ message: 'ğŸ‰ è®°å½•ä¿å­˜æˆåŠŸ' });
      Router.back();
    }).catch(() => {
      this.isSaving = false;
      promptAction.showToast({ message: 'ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•' });
    });
  }
}
