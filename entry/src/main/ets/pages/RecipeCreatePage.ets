/**
 * é¥µçŸ¥é?- é…æ–¹åˆ›ä½œé¡µé¢
 * ç”¨æˆ·è‡ªå®šä¹‰åˆ›å»ºé±¼é¥µé…æ–?
 */
import { router } from '@kit.ArkUI';
import { ThemeColors } from '../theme/ThemeColors';
import { ThemeConstants } from '../theme/ThemeConstants';
import { ALL_FISH_DATA, FishData } from '../data/FishData';
import { getAllIngredients, Ingredient } from '../data/IngredientDatabase';
import { userDataService, CustomRecipeIngredient, RecipeStateProfile, RecipeFlavorProfile, CustomIngredient, CustomFish } from '../services/UserDataService';

// é…æ–¹åŸæ–™é¡?
class RecipeIngredientItem {
  ingredientId: string = '';
  name: string = '';
  ratio: number = 1;
  weight: number = 0;
  category: string = '';
}

// ç»Ÿä¸€åŸæ–™æ˜¾ç¤ºé¡¹ï¼ˆç”¨äºé€‰æ‹©å¼¹çª—ï¼?
class IngredientDisplayItem {
  id: string = '';
  name: string = '';
  category: string = '';
  isCustom: boolean = false;
}

// ç»Ÿä¸€é±¼ç§æ˜¾ç¤ºé¡¹ï¼ˆç”¨äºé€‰æ‹©å¼¹çª—ï¼?
class FishDisplayItem {
  id: string = '';
  name: string = '';
  icon: Resource | string = $r('app.media.fishImage');
  waterTypes: string[] = [];
  isCustom: boolean = false;
}

// é€‰é¡¹ç±?
class SelectOption {
  id: string = '';
  name: string = '';
}

// åˆ›å»ºé€‰é¡¹è¾…åŠ©å‡½æ•°
function makeOption(id: string, name: string): SelectOption {
  const opt = new SelectOption();
  opt.id = id;
  opt.name = name;
  return opt;
}

@Entry
@Component
struct RecipeCreatePage {
  @State recipeName: string = '';
  @State selectedFishIds: string[] = [];
  @State selectedWaterType: string = 'pond';
  @State selectedSeason: string = 'spring';
  @State ingredients: RecipeIngredientItem[] = [];
  @State steps: string[] = [''];
  @State tips: string = '';
  @State showFishPicker: boolean = false;
  @State showIngredientPicker: boolean = false;

  // æ–°å¢å­—æ®µ
  @State difficulty: string = 'medium';
  @State prepTime: string = '15åˆ†é’Ÿ';
  @State totalWeight: number = 500;

  // çŠ¶æ€ç‰¹æ€?
  @State atomization: number = 3;
  @State viscosity: number = 3;
  @State hookHolding: number = 3;
  @State baitWeight: number = 3;

  // å‘³å‹ç‰¹æ€?
  @State primaryFlavor: string = 'fishy';
  @State secondaryFlavor: string = '';
  @State flavorIntensity: number = 3;

  // æç¤ºä¿¡æ¯
  @State toastMessage: string = '';
  @State showToast: boolean = false;
  @State isSaving: boolean = false;

  private waterTypes: SelectOption[] = [
    makeOption('pond', 'æ± å¡˜'),
    makeOption('river', 'æ²³æµ'),
    makeOption('reservoir', 'æ°´åº“'),
    makeOption('lake', 'æ¹–æ³Š')
  ];

  private seasons: SelectOption[] = [
    makeOption('spring', 'æ˜¥å­£'),
    makeOption('summer', 'å¤å­£'),
    makeOption('autumn', 'ç§‹å­£'),
    makeOption('winter', 'å†¬å­£')
  ];

  private difficulties: SelectOption[] = [
    makeOption('easy', 'ç®€å?),
    makeOption('medium', 'ä¸­ç­‰'),
    makeOption('hard', 'å›°éš¾')
  ];

  private flavors: SelectOption[] = [
    makeOption('fishy', 'è…?),
    makeOption('fragrant', 'é¦?),
    makeOption('sweet', 'ç”?),
    makeOption('sour', 'é…?),
    makeOption('smelly', 'è‡?),
    makeOption('plain', 'æœ¬å‘³')
  ];

  async aboutToAppear(): Promise<void> {
    // ç¡®ä¿ç”¨æˆ·æ•°æ®æœåŠ¡å·²åŠ è½?
    await userDataService.load();
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ ?
      this.NavBar()

      // è¡¨å•å†…å®¹
      Scroll() {
        Column({ space: 16 }) {
          // é…æ–¹åç§°
          this.FormSection('é…æ–¹åç§°')

          // ç›®æ ‡é±¼ç§
          this.FishSelectorSection()

          // é€‚åˆæ°´åŸŸ
          this.WaterTypeSection()

          // é€‚åˆå­£èŠ‚
          this.SeasonSection()

          // éš¾åº¦å’Œå‡†å¤‡æ—¶é—?
          this.DifficultySection()

          // æ€»é‡é‡?
          this.TotalWeightSection()

          // åŸæ–™é…æ¯”
          this.IngredientSection()

          // çŠ¶æ€ç‰¹æ€?
          this.StateProfileSection()

          // å‘³å‹ç‰¹æ€?
          this.FlavorProfileSection()

          // åˆ¶ä½œæ­¥éª¤
          this.StepsSection()

          // ä½¿ç”¨æŠ€å·?
          this.TipsSection()

          // ä¿å­˜æŒ‰é’®
          Button('ä¿å­˜é…æ–¹')
            .width('100%')
            .height(48)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .backgroundColor(ThemeColors.PRIMARY)
            .fontColor(ThemeColors.TEXT_PRIMARY)
            .margin({ top: 16, bottom: 32 })
            .onClick(() => this.saveRecipe())
        }
        .padding(16)
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)

      // é±¼ç§é€‰æ‹©å¼¹çª—
      if (this.showFishPicker) {
        this.FishPickerDialog()
      }

      // åŸæ–™é€‰æ‹©å¼¹çª—
      if (this.showIngredientPicker) {
        this.IngredientPickerDialog()
      }

      // Toast æç¤º
      if (this.showToast) {
        Column() {
          Text(this.toastMessage)
            .fontSize(14)
            .fontColor(Color.White)
            .padding({ left: 16, right: 16, top: 10, bottom: 10 })
            .backgroundColor('rgba(0, 0, 0, 0.7)')
            .borderRadius(20)
        }
        .width('100%')
        .position({ x: 0, y: '40%' })
        .justifyContent(FlexAlign.Center)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(ThemeColors.BG_PRIMARY)
  }

  @Builder
  NavBar() {
    Row() {
      Text('â†?)
        .fontSize(24)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .onClick(() => router.back())
        .padding(8)

      Text('åˆ›å»ºé…æ–¹')
        .fontSize(ThemeConstants.FONT_SIZE_LG)
        .fontWeight(FontWeight.Bold)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      Text('')
        .width(40)
    }
    .width('100%')
    .height(56)
    .padding({ left: 8, right: 16 })
    .margin({ top: 44 })
    .backgroundColor(ThemeColors.BG_SECONDARY)
  }

  @Builder
  FormSection(title: string) {
    Column({ space: 8 }) {
      Text(title)
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .fontWeight(FontWeight.Medium)

      TextInput({ placeholder: 'è¯·è¾“å…¥é…æ–¹åç§?, text: this.recipeName })
        .width('100%')
        .height(44)
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .backgroundColor(ThemeColors.BG_CARD)
        .borderRadius(ThemeConstants.RADIUS_SM)
        .padding({ left: 12, right: 12 })
        .onChange((value: string) => {
          this.recipeName = value;
        })
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  FishSelectorSection() {
    Column({ space: 8 }) {
      Text('ç›®æ ‡é±¼ç§')
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .fontWeight(FontWeight.Medium)

      Row() {
        if (this.selectedFishIds.length === 0) {
          Text('ç‚¹å‡»é€‰æ‹©ç›®æ ‡é±¼ç§')
            .fontSize(ThemeConstants.FONT_SIZE_BASE)
            .fontColor(ThemeColors.TEXT_HINT)
        } else {
          Text(this.getSelectedFishNames())
            .fontSize(ThemeConstants.FONT_SIZE_BASE)
            .fontColor(ThemeColors.TEXT_PRIMARY)
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }
        Blank()
        Text('>')
          .fontSize(16)
          .fontColor(ThemeColors.TEXT_MUTED)
      }
      .width('100%')
      .height(44)
      .padding({ left: 12, right: 12 })
      .backgroundColor(ThemeColors.BG_CARD)
      .borderRadius(ThemeConstants.RADIUS_SM)
      .onClick(() => {
        this.showFishPicker = true;
      })
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  WaterTypeSection() {
    Column({ space: 8 }) {
      Text('é€‚åˆæ°´åŸŸ')
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .fontWeight(FontWeight.Medium)

      Row({ space: 8 }) {
        ForEach(this.waterTypes, (item: SelectOption) => {
          Text(item.name)
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(this.getWaterTypeColor(item.id))
            .padding({ left: 16, right: 16, top: 8, bottom: 8 })
            .backgroundColor(this.getWaterTypeBgColor(item.id))
            .borderRadius(ThemeConstants.RADIUS_FULL)
            .border({
              width: 1,
              color: this.selectedWaterType === item.id && this.isWaterTypeAvailable(item.id) ?
                ThemeColors.PRIMARY : Color.Transparent
            })
            .opacity(this.isWaterTypeAvailable(item.id) ? 1.0 : 0.4)
            .onClick(() => {
              if (this.isWaterTypeAvailable(item.id)) {
                this.selectedWaterType = item.id;
              }
            })
        })
      }
      .width('100%')

      // æç¤ºä¿¡æ¯
      if (this.selectedFishIds.length > 0 && !this.isWaterTypeAvailable(this.selectedWaterType)) {
        Text('å½“å‰é€‰æ‹©çš„æ°´åŸŸä¸é€‚åˆæ‰€é€‰é±¼ç§ï¼Œè¯·é‡æ–°é€‰æ‹©')
          .fontSize(12)
          .fontColor(ThemeColors.ERROR)
          .margin({ top: 4 })
      }
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  // è·å–æ°´åŸŸæ–‡å­—é¢œè‰²
  private getWaterTypeColor(waterTypeId: string): ResourceColor {
    if (!this.isWaterTypeAvailable(waterTypeId)) {
      return ThemeColors.TEXT_MUTED;
    }
    return this.selectedWaterType === waterTypeId ? ThemeColors.PRIMARY : ThemeColors.TEXT_SECONDARY;
  }

  // è·å–æ°´åŸŸèƒŒæ™¯é¢œè‰²
  private getWaterTypeBgColor(waterTypeId: string): ResourceColor {
    if (!this.isWaterTypeAvailable(waterTypeId)) {
      return ThemeColors.BG_CARD;
    }
    return this.selectedWaterType === waterTypeId ? 'rgba(232, 168, 73, 0.15)' : ThemeColors.BG_CARD;
  }

  // æ£€æŸ¥æ°´åŸŸæ˜¯å¦å¯ç”¨ï¼ˆæ ¹æ®é€‰ä¸­çš„é±¼ç§ï¼‰
  private isWaterTypeAvailable(waterTypeId: string): boolean {
    if (this.selectedFishIds.length === 0) {
      return true; // æ²¡é€‰é±¼ç§æ—¶æ‰€æœ‰æ°´åŸŸéƒ½å¯ç”¨
    }

    // è·å–æ‰€æœ‰é€‰ä¸­é±¼ç§çš„æ°´åŸŸäº¤é›?
    const availableWaterTypes = this.getAvailableWaterTypes();
    return availableWaterTypes.includes(waterTypeId);
  }

  // è·å–é€‰ä¸­é±¼ç§çš„å¯ç”¨æ°´åŸŸï¼ˆæ”¯æŒç³»ç»Ÿé±¼ç§å’Œç”¨æˆ·è‡ªå®šä¹‰é±¼ç§ï¼?
  private getAvailableWaterTypes(): string[] {
    if (this.selectedFishIds.length === 0) {
      return ['pond', 'river', 'reservoir', 'lake'];
    }

    // æ”¶é›†æ‰€æœ‰é€‰ä¸­é±¼ç§çš„æ°´åŸ?
    const allWaterTypes: Set<string> = new Set();
    for (const fishId of this.selectedFishIds) {
      // å…ˆä»ç³»ç»Ÿé±¼ç§æŸ¥æ‰¾
      const fish = ALL_FISH_DATA.find((f: FishData) => f.id === fishId);
      if (fish) {
        for (const wt of fish.waterTypes) {
          allWaterTypes.add(wt);
        }
      } else {
        // å†ä»ç”¨æˆ·è‡ªå®šä¹‰é±¼ç§æŸ¥æ‰?
        const customFish = userDataService.getCustomFish().find((f: CustomFish) => f.id === fishId);
        if (customFish) {
          for (const wt of customFish.waterTypes) {
            allWaterTypes.add(wt);
          }
        }
      }
    }

    return Array.from(allWaterTypes);
  }

  // è·å–æ‰€æœ‰é±¼ç§åˆ—è¡¨ï¼ˆç³»ç»Ÿ + ç”¨æˆ·è‡ªå®šä¹‰ï¼‰
  private getAllFishItems(): FishDisplayItem[] {
    const items: FishDisplayItem[] = [];

    // æ·»åŠ ç³»ç»Ÿé±¼ç§
    for (const fish of ALL_FISH_DATA) {
      const item = new FishDisplayItem();
      item.id = fish.id;
      item.name = fish.name;
      item.icon = fish.icon;
      item.waterTypes = fish.waterTypes;
      item.isCustom = false;
      items.push(item);
    }

    // æ·»åŠ ç”¨æˆ·è‡ªå®šä¹‰é±¼ç§?
    const customFishList = userDataService.getCustomFish();
    for (const fish of customFishList) {
      const item = new FishDisplayItem();
      item.id = fish.id;
      item.name = fish.name;
      item.icon = fish.icon || $r('app.media.fishImage');
      item.waterTypes = fish.waterTypes;
      item.isCustom = true;
      items.push(item);
    }

    return items;
  }

  @Builder
  SeasonSection() {
    Column({ space: 8 }) {
      Text('é€‚åˆå­£èŠ‚')
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .fontWeight(FontWeight.Medium)

      Row({ space: 8 }) {
        ForEach(this.seasons, (item: SelectOption) => {
          Text(item.name)
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(this.selectedSeason === item.id ? ThemeColors.PRIMARY : ThemeColors.TEXT_SECONDARY)
            .padding({ left: 16, right: 16, top: 8, bottom: 8 })
            .backgroundColor(this.selectedSeason === item.id ? 'rgba(232, 168, 73, 0.15)' : ThemeColors.BG_CARD)
            .borderRadius(ThemeConstants.RADIUS_FULL)
            .border({
              width: 1,
              color: this.selectedSeason === item.id ? ThemeColors.PRIMARY : Color.Transparent
            })
            .onClick(() => {
              this.selectedSeason = item.id;
            })
        })
      }
      .width('100%')
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  DifficultySection() {
    Column({ space: 8 }) {
      Text('åˆ¶ä½œéš¾åº¦')
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .fontWeight(FontWeight.Medium)

      Row({ space: 8 }) {
        ForEach(this.difficulties, (item: SelectOption) => {
          Text(item.name)
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(this.difficulty === item.id ? ThemeColors.PRIMARY : ThemeColors.TEXT_SECONDARY)
            .padding({ left: 16, right: 16, top: 8, bottom: 8 })
            .backgroundColor(this.difficulty === item.id ? 'rgba(232, 168, 73, 0.15)' : ThemeColors.BG_CARD)
            .borderRadius(ThemeConstants.RADIUS_FULL)
            .border({
              width: 1,
              color: this.difficulty === item.id ? ThemeColors.PRIMARY : Color.Transparent
            })
            .onClick(() => {
              this.difficulty = item.id;
            })
        })
      }
      .width('100%')

      // å‡†å¤‡æ—¶é—´
      Row() {
        Text('å‡†å¤‡æ—¶é—´')
          .fontSize(ThemeConstants.FONT_SIZE_SM)
          .fontColor(ThemeColors.TEXT_SECONDARY)

        Blank()

        TextInput({ placeholder: 'å¦‚ï¼š15åˆ†é’Ÿ', text: this.prepTime })
          .width(120)
          .height(36)
          .fontSize(ThemeConstants.FONT_SIZE_SM)
          .backgroundColor(ThemeColors.BG_CARD)
          .borderRadius(ThemeConstants.RADIUS_SM)
          .textAlign(TextAlign.Center)
          .onChange((value: string) => {
            this.prepTime = value;
          })
      }
      .width('100%')
      .margin({ top: 8 })
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  TotalWeightSection() {
    Column({ space: 8 }) {
      Text('é…æ–¹æ€»é‡é‡?)
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .fontWeight(FontWeight.Medium)

      Row() {
        TextInput({ placeholder: '500', text: this.totalWeight.toString() })
          .width(100)
          .height(40)
          .fontSize(ThemeConstants.FONT_SIZE_BASE)
          .backgroundColor(ThemeColors.BG_CARD)
          .borderRadius(ThemeConstants.RADIUS_SM)
          .textAlign(TextAlign.Center)
          .type(InputType.Number)
          .onChange((value: string) => {
            const num = parseInt(value);
            if (!isNaN(num) && num > 0) {
              this.totalWeight = num;
            }
          })

        Text('å…?)
          .fontSize(ThemeConstants.FONT_SIZE_BASE)
          .fontColor(ThemeColors.TEXT_SECONDARY)
          .margin({ left: 8 })
      }
      .width('100%')
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  IngredientSection() {
    Column({ space: 8 }) {
      Text('åŸæ–™é…æ¯”')
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .fontWeight(FontWeight.Medium)

      Column({ space: 8 }) {
        ForEach(this.ingredients, (item: RecipeIngredientItem, index: number) => {
          Row() {
            Text(item.name)
              .fontSize(ThemeConstants.FONT_SIZE_BASE)
              .fontColor(ThemeColors.TEXT_PRIMARY)
              .layoutWeight(1)

            Text(`${item.ratio}ä»½`)
              .fontSize(ThemeConstants.FONT_SIZE_SM)
              .fontColor(ThemeColors.TEXT_SECONDARY)
              .margin({ right: 12 })

            Text('Ã—')
              .fontSize(16)
              .fontColor(ThemeColors.ERROR)
              .onClick(() => {
                this.ingredients.splice(index, 1);
                this.ingredients = this.ingredients.slice();
              })
          }
          .width('100%')
          .height(44)
          .padding({ left: 12, right: 12 })
          .backgroundColor(ThemeColors.BG_CARD)
          .borderRadius(ThemeConstants.RADIUS_SM)
        })

        // æ·»åŠ åŸæ–™æŒ‰é’®
        Row() {
          Text('+ æ·»åŠ åŸæ–™')
            .fontSize(ThemeConstants.FONT_SIZE_BASE)
            .fontColor(ThemeColors.PRIMARY_DARK)
        }
        .width('100%')
        .height(44)
        .justifyContent(FlexAlign.Center)
        .backgroundColor(ThemeColors.BG_CARD)
        .borderRadius(ThemeConstants.RADIUS_SM)
        .border({ width: 1, color: ThemeColors.PRIMARY, style: BorderStyle.Dashed })
        .onClick(() => {
          this.showIngredientPicker = true;
        })
      }
      .width('100%')
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  StepsSection() {
    Column({ space: 8 }) {
      Text('åˆ¶ä½œæ­¥éª¤')
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .fontWeight(FontWeight.Medium)

      Column({ space: 8 }) {
        ForEach(this.steps, (step: string, index: number) => {
          Row() {
            Text(`${index + 1}.`)
              .fontSize(ThemeConstants.FONT_SIZE_BASE)
              .fontColor(ThemeColors.PRIMARY_DARK)
              .fontWeight(FontWeight.Bold)
              .margin({ right: 8 })

            TextInput({ placeholder: 'è¾“å…¥æ­¥éª¤å†…å®¹', text: step })
              .layoutWeight(1)
              .height(40)
              .fontSize(ThemeConstants.FONT_SIZE_BASE)
              .backgroundColor(Color.Transparent)
              .onChange((value: string) => {
                this.steps[index] = value;
              })

            if (this.steps.length > 1) {
              Text('Ã—')
                .fontSize(16)
                .fontColor(ThemeColors.ERROR)
                .margin({ left: 8 })
                .onClick(() => {
                  this.steps.splice(index, 1);
                  this.steps = this.steps.slice();
                })
            }
          }
          .width('100%')
          .padding({ left: 12, right: 12 })
          .backgroundColor(ThemeColors.BG_CARD)
          .borderRadius(ThemeConstants.RADIUS_SM)
        })

        // æ·»åŠ æ­¥éª¤æŒ‰é’®
        Row() {
          Text('+ æ·»åŠ æ­¥éª¤')
            .fontSize(ThemeConstants.FONT_SIZE_BASE)
            .fontColor(ThemeColors.PRIMARY_DARK)
        }
        .width('100%')
        .height(44)
        .justifyContent(FlexAlign.Center)
        .backgroundColor(ThemeColors.BG_CARD)
        .borderRadius(ThemeConstants.RADIUS_SM)
        .border({ width: 1, color: ThemeColors.PRIMARY, style: BorderStyle.Dashed })
        .onClick(() => {
          this.steps.push('');
          this.steps = this.steps.slice();
        })
      }
      .width('100%')
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  TipsSection() {
    Column({ space: 8 }) {
      Text('ä½¿ç”¨æŠ€å·?)
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .fontWeight(FontWeight.Medium)

      TextArea({ placeholder: 'è¾“å…¥ä½¿ç”¨æŠ€å·§å’Œæ³¨æ„äº‹é¡¹', text: this.tips })
        .width('100%')
        .height(100)
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .backgroundColor(ThemeColors.BG_CARD)
        .borderRadius(ThemeConstants.RADIUS_SM)
        .padding(12)
        .onChange((value: string) => {
          this.tips = value;
        })
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  StateProfileSection() {
    Column({ space: 12 }) {
      Text('çŠ¶æ€ç‰¹æ€?)
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .fontWeight(FontWeight.Medium)

      // é›¾åŒ–æ€?
      Column({ space: 4 }) {
        Row() {
          Text('é›¾åŒ–æ€?)
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.TEXT_PRIMARY)
          Blank()
          Text(this.getStateLabel(this.atomization))
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.PRIMARY_DARK)
        }
        .width('100%')

        Slider({
          value: this.atomization,
          min: 1,
          max: 5,
          step: 1,
          style: SliderStyle.OutSet
        })
          .width('100%')
          .blockColor(ThemeColors.PRIMARY)
          .trackColor(ThemeColors.BG_TERTIARY)
          .selectedColor(ThemeColors.PRIMARY)
          .onChange((newValue: number) => {
            this.atomization = Math.round(newValue);
          })
      }
      .width('100%')

      // ç²˜åº¦
      Column({ space: 4 }) {
        Row() {
          Text('ç²˜åº¦')
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.TEXT_PRIMARY)
          Blank()
          Text(this.getStateLabel(this.viscosity))
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.PRIMARY_DARK)
        }
        .width('100%')

        Slider({
          value: this.viscosity,
          min: 1,
          max: 5,
          step: 1,
          style: SliderStyle.OutSet
        })
          .width('100%')
          .blockColor(ThemeColors.PRIMARY)
          .trackColor(ThemeColors.BG_TERTIARY)
          .selectedColor(ThemeColors.PRIMARY)
          .onChange((newValue: number) => {
            this.viscosity = Math.round(newValue);
          })
      }
      .width('100%')

      // é™„é’©æ€?
      Column({ space: 4 }) {
        Row() {
          Text('é™„é’©æ€?)
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.TEXT_PRIMARY)
          Blank()
          Text(this.getStateLabel(this.hookHolding))
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.PRIMARY_DARK)
        }
        .width('100%')

        Slider({
          value: this.hookHolding,
          min: 1,
          max: 5,
          step: 1,
          style: SliderStyle.OutSet
        })
          .width('100%')
          .blockColor(ThemeColors.PRIMARY)
          .trackColor(ThemeColors.BG_TERTIARY)
          .selectedColor(ThemeColors.PRIMARY)
          .onChange((newValue: number) => {
            this.hookHolding = Math.round(newValue);
          })
      }
      .width('100%')

      // æ¯”é‡
      Column({ space: 4 }) {
        Row() {
          Text('æ¯”é‡')
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.TEXT_PRIMARY)
          Blank()
          Text(this.getStateLabel(this.baitWeight))
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.PRIMARY_DARK)
        }
        .width('100%')

        Slider({
          value: this.baitWeight,
          min: 1,
          max: 5,
          step: 1,
          style: SliderStyle.OutSet
        })
          .width('100%')
          .blockColor(ThemeColors.PRIMARY)
          .trackColor(ThemeColors.BG_TERTIARY)
          .selectedColor(ThemeColors.PRIMARY)
          .onChange((newValue: number) => {
            this.baitWeight = Math.round(newValue);
          })
      }
      .width('100%')
    }
    .width('100%')
    .padding(12)
    .backgroundColor(ThemeColors.BG_CARD)
    .borderRadius(ThemeConstants.RADIUS_SM)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  SliderRow(label: string, value: number, onChange: (value: number) => void) {
    Column({ space: 4 }) {
      Row() {
        Text(label)
          .fontSize(ThemeConstants.FONT_SIZE_SM)
          .fontColor(ThemeColors.TEXT_PRIMARY)

        Blank()

        Text(this.getStateLabel(value))
          .fontSize(ThemeConstants.FONT_SIZE_SM)
          .fontColor(ThemeColors.PRIMARY_DARK)
      }
      .width('100%')

      Slider({
        value: value,
        min: 1,
        max: 5,
        step: 1,
        style: SliderStyle.OutSet
      })
        .width('100%')
        .blockColor(ThemeColors.PRIMARY)
        .trackColor(ThemeColors.BG_TERTIARY)
        .selectedColor(ThemeColors.PRIMARY)
        .onChange((newValue: number) => {
          onChange(Math.round(newValue));
        })
    }
    .width('100%')
  }

  private getStateLabel(value: number): string {
    const labels: string[] = ['å¾ˆä½', 'è¾ƒä½', 'ä¸­ç­‰', 'è¾ƒé«˜', 'å¾ˆé«˜'];
    return labels[value - 1] || 'ä¸­ç­‰';
  }

  @Builder
  FlavorProfileSection() {
    Column({ space: 12 }) {
      Text('å‘³å‹ç‰¹æ€?)
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .fontWeight(FontWeight.Medium)

      // ä¸»å‘³å?
      Column({ space: 8 }) {
        Text('ä¸»å‘³å?)
          .fontSize(ThemeConstants.FONT_SIZE_SM)
          .fontColor(ThemeColors.TEXT_PRIMARY)

        Flex({ wrap: FlexWrap.Wrap }) {
          ForEach(this.flavors, (item: SelectOption) => {
            Text(item.name)
              .fontSize(ThemeConstants.FONT_SIZE_SM)
              .fontColor(this.primaryFlavor === item.id ? ThemeColors.PRIMARY : ThemeColors.TEXT_SECONDARY)
              .padding({ left: 12, right: 12, top: 6, bottom: 6 })
              .margin({ right: 8, bottom: 8 })
              .backgroundColor(this.primaryFlavor === item.id ? 'rgba(232, 168, 73, 0.15)' : ThemeColors.BG_TERTIARY)
              .borderRadius(ThemeConstants.RADIUS_FULL)
              .border({
                width: 1,
                color: this.primaryFlavor === item.id ? ThemeColors.PRIMARY : Color.Transparent
              })
              .onClick(() => {
                this.primaryFlavor = item.id;
              })
          })
        }
        .width('100%')
      }

      // å‰¯å‘³å?
      Column({ space: 8 }) {
        Text('å‰¯å‘³å‹ï¼ˆå¯é€‰ï¼‰')
          .fontSize(ThemeConstants.FONT_SIZE_SM)
          .fontColor(ThemeColors.TEXT_PRIMARY)

        Flex({ wrap: FlexWrap.Wrap }) {
          Text('æ—?)
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(this.secondaryFlavor === '' ? ThemeColors.PRIMARY : ThemeColors.TEXT_SECONDARY)
            .padding({ left: 12, right: 12, top: 6, bottom: 6 })
            .margin({ right: 8, bottom: 8 })
            .backgroundColor(this.secondaryFlavor === '' ? 'rgba(232, 168, 73, 0.15)' : ThemeColors.BG_TERTIARY)
            .borderRadius(ThemeConstants.RADIUS_FULL)
            .border({
              width: 1,
              color: this.secondaryFlavor === '' ? ThemeColors.PRIMARY : Color.Transparent
            })
            .onClick(() => {
              this.secondaryFlavor = '';
            })

          ForEach(this.flavors, (item: SelectOption) => {
            Text(item.name)
              .fontSize(ThemeConstants.FONT_SIZE_SM)
              .fontColor(this.secondaryFlavor === item.id ? ThemeColors.PRIMARY : ThemeColors.TEXT_SECONDARY)
              .padding({ left: 12, right: 12, top: 6, bottom: 6 })
              .margin({ right: 8, bottom: 8 })
              .backgroundColor(this.secondaryFlavor === item.id ? 'rgba(232, 168, 73, 0.15)' : ThemeColors.BG_TERTIARY)
              .borderRadius(ThemeConstants.RADIUS_FULL)
              .border({
                width: 1,
                color: this.secondaryFlavor === item.id ? ThemeColors.PRIMARY : Color.Transparent
              })
              .onClick(() => {
                this.secondaryFlavor = item.id;
              })
          })
        }
        .width('100%')
      }

      // å‘³å‹æµ“åº¦
      Column({ space: 4 }) {
        Row() {
          Text('å‘³å‹æµ“åº¦')
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.TEXT_PRIMARY)
          Blank()
          Text(this.getStateLabel(this.flavorIntensity))
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.PRIMARY_DARK)
        }
        .width('100%')

        Slider({
          value: this.flavorIntensity,
          min: 1,
          max: 5,
          step: 1,
          style: SliderStyle.OutSet
        })
          .width('100%')
          .blockColor(ThemeColors.PRIMARY)
          .trackColor(ThemeColors.BG_TERTIARY)
          .selectedColor(ThemeColors.PRIMARY)
          .onChange((newValue: number) => {
            this.flavorIntensity = Math.round(newValue);
          })
      }
      .width('100%')
    }
    .width('100%')
    .padding(12)
    .backgroundColor(ThemeColors.BG_CARD)
    .borderRadius(ThemeConstants.RADIUS_SM)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  FishPickerDialog() {
    Stack() {
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0,0,0,0.5)')
        .onClick(() => {
          this.showFishPicker = false;
        })

      Column() {
        Row() {
          Text('é€‰æ‹©ç›®æ ‡é±¼ç§')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor(ThemeColors.TEXT_PRIMARY)
          Blank()
          Text('å®Œæˆ')
            .fontSize(16)
            .fontColor(ThemeColors.PRIMARY_DARK)
            .onClick(() => {
              this.showFishPicker = false;
            })
        }
        .width('100%')
        .padding({ bottom: 12 })

        Scroll() {
          Column({ space: 8 }) {
            // æ˜¾ç¤ºæ‰€æœ‰é±¼ç§ï¼ˆç³»ç»Ÿ + ç”¨æˆ·è‡ªå®šä¹‰ï¼‰
            ForEach(this.getAllFishItems(), (fish: FishDisplayItem) => {
              Row() {
                Image(fish.icon)
                  .width(36)
                  .height(36)
                  .borderRadius(18)
                  .margin({ right: 12 })

                Column() {
                  Row({ space: 4 }) {
                    Text(fish.name)
                      .fontSize(16)
                      .fontColor(ThemeColors.TEXT_PRIMARY)

                    if (fish.isCustom) {
                      Text('è‡ªå®šä¹?)
                        .fontSize(10)
                        .fontColor(ThemeColors.PRIMARY_DARK)
                        .padding({ left: 4, right: 4, top: 2, bottom: 2 })
                        .backgroundColor('rgba(232, 168, 73, 0.15)')
                        .borderRadius(4)
                    }
                  }
                }
                .alignItems(HorizontalAlign.Start)
                .layoutWeight(1)

                Checkbox()
                  .select(this.selectedFishIds.includes(fish.id))
                  .selectedColor(ThemeColors.PRIMARY)
                  .onChange((checked: boolean) => {
                    if (checked) {
                      this.selectedFishIds.push(fish.id);
                    } else {
                      const idx = this.selectedFishIds.indexOf(fish.id);
                      if (idx > -1) {
                        this.selectedFishIds.splice(idx, 1);
                      }
                    }
                    this.selectedFishIds = this.selectedFishIds.slice();

                    // æ£€æŸ¥å½“å‰æ°´åŸŸæ˜¯å¦ä»ç„¶å¯ç”¨ï¼Œå¦‚æœä¸å¯ç”¨åˆ™è‡ªåŠ¨åˆ‡æ¢
                    if (!this.isWaterTypeAvailable(this.selectedWaterType)) {
                      const available = this.getAvailableWaterTypes();
                      if (available.length > 0) {
                        this.selectedWaterType = available[0];
                      }
                    }
                  })
              }
              .width('100%')
              .padding(12)
              .backgroundColor(ThemeColors.BG_TERTIARY)
              .borderRadius(8)
            })
          }
        }
        .height(400)
        .scrollBar(BarState.Auto)
      }
      .width('90%')
      .padding(20)
      .backgroundColor(ThemeColors.BG_PRIMARY)
      .borderRadius(16)
    }
    .width('100%')
    .height('100%')
    .position({ x: 0, y: 0 })
  }

  @Builder
  IngredientPickerDialog() {
    Stack() {
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0,0,0,0.5)')
        .onClick(() => {
          this.showIngredientPicker = false;
        })

      Column() {
        Row() {
          Text('é€‰æ‹©åŸæ–™')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor(ThemeColors.TEXT_PRIMARY)
          Blank()
          Text('âœ?)
            .fontSize(20)
            .fontColor(ThemeColors.TEXT_SECONDARY)
            .onClick(() => {
              this.showIngredientPicker = false;
            })
        }
        .width('100%')
        .padding({ bottom: 12 })

        Scroll() {
          Column({ space: 8 }) {
            // ç”¨æˆ·è‡ªå®šä¹‰åŸæ–™ï¼ˆå¦‚æœæœ‰ï¼‰
            ForEach(this.getCustomIngredientItems(), (item: IngredientDisplayItem) => {
              Row() {
                Column() {
                  Row({ space: 4 }) {
                    Text(item.name)
                      .fontSize(16)
                      .fontColor(ThemeColors.TEXT_PRIMARY)

                    Text('è‡ªå®šä¹?)
                      .fontSize(10)
                      .fontColor(Color.White)
                      .padding({ left: 4, right: 4, top: 2, bottom: 2 })
                      .backgroundColor(ThemeColors.PRIMARY)
                      .borderRadius(4)
                  }

                  Text(this.getCategoryName(item.category))
                    .fontSize(12)
                    .fontColor(ThemeColors.TEXT_MUTED)
                    .margin({ top: 2 })
                }
                .alignItems(HorizontalAlign.Start)
                .layoutWeight(1)

                Text('+')
                  .fontSize(20)
                  .fontColor(ThemeColors.PRIMARY_DARK)
                  .padding(8)
                  .onClick(() => {
                    this.addIngredientToRecipe(item);
                  })
              }
              .width('100%')
              .padding(12)
              .backgroundColor('rgba(232, 168, 73, 0.1)')
              .borderRadius(8)
            })

            // ç³»ç»ŸåŸæ–™
            ForEach(this.getSystemIngredientItems(), (item: IngredientDisplayItem) => {
              Row() {
                Column() {
                  Text(item.name)
                    .fontSize(16)
                    .fontColor(ThemeColors.TEXT_PRIMARY)

                  Text(this.getCategoryName(item.category))
                    .fontSize(12)
                    .fontColor(ThemeColors.TEXT_MUTED)
                    .margin({ top: 2 })
                }
                .alignItems(HorizontalAlign.Start)
                .layoutWeight(1)

                Text('+')
                  .fontSize(20)
                  .fontColor(ThemeColors.PRIMARY_DARK)
                  .padding(8)
                  .onClick(() => {
                    this.addIngredientToRecipe(item);
                  })
              }
              .width('100%')
              .padding(12)
              .backgroundColor(ThemeColors.BG_TERTIARY)
              .borderRadius(8)
            })
          }
        }
        .height(450)
        .scrollBar(BarState.Auto)
      }
      .width('90%')
      .padding(20)
      .backgroundColor(ThemeColors.BG_PRIMARY)
      .borderRadius(16)
    }
    .width('100%')
    .height('100%')
    .position({ x: 0, y: 0 })
  }

  // è·å–ç”¨æˆ·è‡ªå®šä¹‰åŸæ–™åˆ—è¡?
  private getCustomIngredientItems(): IngredientDisplayItem[] {
    const customList = userDataService.getCustomIngredients();
    const result: IngredientDisplayItem[] = [];
    for (let i = 0; i < customList.length; i++) {
      const c = customList[i];
      const item = new IngredientDisplayItem();
      item.id = c.id;
      item.name = c.name;
      item.category = c.category;
      item.isCustom = true;
      result.push(item);
    }
    return result;
  }

  // è·å–ç³»ç»ŸåŸæ–™åˆ—è¡¨
  private getSystemIngredientItems(): IngredientDisplayItem[] {
    const systemList = getAllIngredients();
    const result: IngredientDisplayItem[] = [];
    for (let i = 0; i < systemList.length; i++) {
      const s = systemList[i];
      const item = new IngredientDisplayItem();
      item.id = s.id;
      item.name = s.name;
      item.category = s.category;
      item.isCustom = false;
      result.push(item);
    }
    return result;
  }

  // æ·»åŠ åŸæ–™åˆ°é…æ–?
  private addIngredientToRecipe(item: IngredientDisplayItem): void {
    // æ£€æŸ¥æ˜¯å¦å·²æ·»åŠ 
    const exists = this.ingredients.some((ing: RecipeIngredientItem) => ing.ingredientId === item.id);
    if (!exists) {
      const newItem = new RecipeIngredientItem();
      newItem.ingredientId = item.id;
      newItem.name = item.name;
      newItem.ratio = 1;
      newItem.category = item.category;
      this.ingredients.push(newItem);
      this.ingredients = this.ingredients.slice();
    }
    this.showIngredientPicker = false;
  }

  // è·å–åŸæ–™åˆ†ç±»åç§°
  private getCategoryName(category: string): string {
    const categoryNames: Record<string, string> = {
      'base': 'åŸºç¡€é¥µæ–™',
      'protein': 'è›‹ç™½è´¨ç±»',
      'additive': 'æ·»åŠ å‰?,
      'state': 'çŠ¶æ€è°ƒèŠ?,
      'binder': 'ç²˜åˆå‰?,
      'natural': 'å¤©ç„¶åŸæ–™',
      'pellet': 'é¢—ç²’é¥?,
      'live': 'æ´»é¥µ',
      'folk': 'æ°‘é—´åæ–¹'
    };
    return categoryNames[category] || 'å…¶ä»–';
  }

  private getSelectedFishNames(): string {
    return this.selectedFishIds
      .map((id: string) => {
        // å…ˆä»ç³»ç»Ÿé±¼ç§æŸ¥æ‰¾
        const fish = ALL_FISH_DATA.find((f: FishData) => f.id === id);
        if (fish) {
          return fish.name;
        }
        // å†ä»ç”¨æˆ·è‡ªå®šä¹‰é±¼ç§æŸ¥æ‰?
        const customFish = userDataService.getCustomFish().find((f: CustomFish) => f.id === id);
        if (customFish) {
          return customFish.name;
        }
        return '';
      })
      .filter((name: string) => name !== '')
      .join('ã€?);
  }

  private async saveRecipe(): Promise<void> {
    // é˜²æ­¢é‡å¤æäº¤
    if (this.isSaving) {
      return;
    }

    // éªŒè¯é…æ–¹åç§°
    const trimmedName = this.recipeName.trim();
    if (!trimmedName) {
      this.showToastMessage('è¯·è¾“å…¥é…æ–¹åç§?);
      return;
    }

    if (trimmedName.length < 2) {
      this.showToastMessage('é…æ–¹åç§°è‡³å°‘2ä¸ªå­—ç¬?);
      return;
    }

    if (trimmedName.length > 20) {
      this.showToastMessage('é…æ–¹åç§°ä¸èƒ½è¶…è¿‡20ä¸ªå­—ç¬?);
      return;
    }

    // æ£€æŸ¥é…æ–¹åç§°æ˜¯å¦é‡å¤?
    if (userDataService.isRecipeNameExists(trimmedName)) {
      this.showToastMessage('é…æ–¹åç§°å·²å­˜åœ¨ï¼Œè¯·æ¢ä¸€ä¸ªåç§?);
      return;
    }

    // éªŒè¯ç›®æ ‡é±¼ç§
    if (this.selectedFishIds.length === 0) {
      this.showToastMessage('è¯·é€‰æ‹©ç›®æ ‡é±¼ç§');
      return;
    }

    // éªŒè¯åŸæ–™
    if (this.ingredients.length === 0) {
      this.showToastMessage('è¯·è‡³å°‘æ·»åŠ ä¸€ç§åŸæ–?);
      return;
    }

    // éªŒè¯æ°´åŸŸæ˜¯å¦å¯ç”¨
    if (!this.isWaterTypeAvailable(this.selectedWaterType)) {
      this.showToastMessage('è¯·é€‰æ‹©é€‚åˆæ‰€é€‰é±¼ç§çš„æ°´åŸŸ');
      return;
    }

    // éªŒè¯åˆ¶ä½œæ­¥éª¤
    const validSteps = this.steps.filter((s: string) => s.trim().length > 0);
    if (validSteps.length === 0) {
      this.showToastMessage('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªåˆ¶ä½œæ­¥éª?);
      return;
    }

    // å¼€å§‹ä¿å­?
    this.isSaving = true;

    try {
      // è½¬æ¢åŸæ–™æ ¼å¼
      const recipeIngredients: CustomRecipeIngredient[] = [];
      for (let i = 0; i < this.ingredients.length; i++) {
        const item = this.ingredients[i];
        const ri = new CustomRecipeIngredient();
        ri.ingredientId = item.ingredientId;
        ri.name = item.name;
        ri.ratio = item.ratio;
        ri.weight = item.weight;
        ri.category = item.category;
        recipeIngredients.push(ri);
      }

      // æ„å»ºçŠ¶æ€ç‰¹æ€?
      const stateProfile = new RecipeStateProfile();
      stateProfile.atomization = this.atomization;
      stateProfile.viscosity = this.viscosity;
      stateProfile.hookHolding = this.hookHolding;
      stateProfile.weight = this.baitWeight;

      // æ„å»ºå‘³å‹ç‰¹æ€?
      const flavorProfile = new RecipeFlavorProfile();
      flavorProfile.primary = this.primaryFlavor;
      flavorProfile.secondary = this.secondaryFlavor;
      flavorProfile.intensity = this.flavorIntensity;

      // ä¿å­˜åˆ?UserDataService
      await userDataService.addRecipe(
        trimmedName,
        this.selectedFishIds.slice(),
        this.selectedWaterType,
        this.selectedSeason,
        recipeIngredients,
        validSteps,
        this.tips.trim(),
        stateProfile,
        flavorProfile,
        this.totalWeight,
        this.difficulty,
        this.prepTime
      );

      console.info('é…æ–¹ä¿å­˜æˆåŠŸ:', trimmedName);

      // æ˜¾ç¤ºæˆåŠŸæç¤ºåè·³è½?
      this.showToastMessage('é…æ–¹ä¿å­˜æˆåŠŸ');

      // å»¶è¿Ÿè·³è½¬ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æç¤º
      setTimeout(() => {
        router.replaceUrl({
          url: 'pages/RecipeBrowserPage'
        });
      }, 800);

    } catch (error) {
      console.error('ä¿å­˜é…æ–¹å¤±è´¥:', error);
      this.showToastMessage('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
      this.isSaving = false;
    }
  }

  // æ˜¾ç¤º Toast æç¤º
  private showToastMessage(message: string): void {
    this.toastMessage = message;
    this.showToast = true;

    // 2ç§’åè‡ªåŠ¨éšè—
    setTimeout(() => {
      this.showToast = false;
    }, 2000);
  }
}
