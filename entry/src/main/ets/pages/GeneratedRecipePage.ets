/**
 * é¥µçŸ¥é?- ç”Ÿæˆé…æ–¹ç»“æœé¡?
 * æŒ‰è®¾è®¡å›¾é‡åšï¼šTabå¯¼èˆªã€é…æ–™å›¾æ ‡ã€æ­¥éª¤ç¼–å·ã€ä½¿ç”¨æŠ€å·?
 */
import { router } from '@kit.ArkUI';
import { ThemeColors } from '../theme/ThemeColors';
import { GeneratedRecipe, RecipeIngredient, GenerateReason, GenerateRecipeInput } from '../common/types/RecipeTypes';
import { generatorHistoryService } from '../services/GeneratorHistoryService';
import { generateSmartRecipe, getNextRecipeVariant, getSmartRecipeEngine, recordRecipeSave } from '../services/engine/SmartRecipeEngine';
import { fetchWeather } from '../services/WeatherService';
import { promptAction } from '@kit.ArkUI';
import { userDataService, CustomRecipeIngredient, RecipeStateProfile, RecipeFlavorProfile } from '../services/UserDataService';

// æ­¥éª¤ä¿¡æ¯ç±?
class StepInfo {
  title: string = '';
  desc: string = '';

  constructor(title: string = '', desc: string = '') {
    this.title = title;
    this.desc = desc;
  }
}

@Entry
@Component
struct GeneratedRecipePage {
  @State recipe: GeneratedRecipe = new GeneratedRecipe();
  @State isFavorite: boolean = false;
  @State isLoaded: boolean = false;
  @State currentTab: number = 0;
  @State isSaved: boolean = false;
  @State showNameDialog: boolean = false;
  @State customRecipeName: string = '';
  @State nameError: string = '';

  private tabTitles: string[] = ['æ¦‚è§ˆ', 'é…æ–™', 'æ­¥éª¤'];
  private originalInput: GenerateRecipeInput | null = null;

  aboutToAppear(): void {
    try {
      const params = router.getParams();
      if (params) {
        const p = params as Record<string, Object>;
        if (p.recipe) {
          // ä»é±¼é¥µç”Ÿæˆå™¨ä¼ å…¥çš„å®Œæ•´é…æ–?
          const data: Record<string, Object> = JSON.parse(p.recipe as string);
          this.recipe = this.parseRecipe(data);
          this.isLoaded = true;
        } else if (p.quickMode) {
          // å¿«é€Ÿæ¨¡å¼ï¼šä»é¦–é¡µä¼ å…¥é±¼ç§å’Œæ°´åŸŸï¼Œè‡ªåŠ¨ç”Ÿæˆ?
          this.quickGenerate(p.fish as string, p.water as string);
          return;
        }
      }
    } catch (err) {
      console.error('Parse recipe failed:', err);
    }
    if (!this.isLoaded) {
      this.isLoaded = true;
    }

    // ä¿å­˜åˆ°ç”Ÿæˆå†å?
    if (this.recipe.id) {
      this.saveToHistory();
    }
  }

  // å¿«é€Ÿç”Ÿæˆé…æ–?
  private async quickGenerate(fishId: string, waterType: string): Promise<void> {
    try {
      // è·å–å½“å‰å¤©æ°”æ¸©åº¦
      let temperature = 20;
      try {
        const weather = await fetchWeather();
        if (weather.isValid) {
          temperature = Math.round(weather.temperature);
        }
      } catch (e) {
        console.error('Fetch weather failed:', e);
      }

      // æ„å»ºè¾“å…¥å‚æ•°
      const input = new GenerateRecipeInput();
      input.targetFishId = fishId || 'crucian';
      input.waterType = (waterType as 'river' | 'pond' | 'reservoir' | 'wild_pond') || 'pond';
      input.temperature = temperature;
      input.season = getSmartRecipeEngine().getCurrentSeason();
      input.fishDensity = 'medium';
      input.fishActivity = 'normal';
      input.fishingMethod = 'rub';
      input.mode = 'balanced';

      // ä½¿ç”¨æ™ºèƒ½é…æ–¹å¼•æ“ç”Ÿæˆé…æ–¹
      const recipe = generateSmartRecipe(input);
      this.recipe = recipe;
      this.isLoaded = true;

      // ä¿å­˜åˆ°å†å?
      this.saveToHistory();
    } catch (err) {
      console.error('Quick generate failed:', err);
      this.isLoaded = true;
    }
  }

  private async saveToHistory(): Promise<void> {
    await generatorHistoryService.load();
    await generatorHistoryService.addHistory(this.recipe);
  }

  private parseRecipe(data: Record<string, Object>): GeneratedRecipe {
    const r = new GeneratedRecipe();
    const d = data;
    r.id = d.id as string || '';
    r.name = d.name as string || 'æ™ºèƒ½é…æ–¹';
    r.totalWeight = d.totalWeight as number || 500;
    r.mode = d.mode as string || 'balanced';
    r.createTime = d.createTime as number || Date.now();

    const ings = d.ingredients as Array<Record<string, Object>>;
    if (ings) {
      for (let i = 0; i < ings.length; i++) {
        const ing = new RecipeIngredient();
        ing.id = ings[i].id as string || '';
        ing.name = ings[i].name as string || '';
        ing.category = ings[i].category as 'main' | 'auxiliary' | 'state' | 'additive';
        ing.percentage = ings[i].percentage as number || 0;
        ing.weight = ings[i].weight as number || 0;
        ing.purpose = ings[i].purpose as string || '';
        r.ingredients.push(ing);
      }
    }

    const fp = d.flavorProfile as Record<string, Object>;
    if (fp) {
      r.flavorProfile.primary = fp.primary as string || '';
      r.flavorProfile.secondary = fp.secondary as string || '';
      r.flavorProfile.intensity = fp.intensity as number || 5;
      r.flavorProfile.suitableTemp = fp.suitableTemp as string || '';
    }

    const sp = d.stateProfile as Record<string, Object>;
    if (sp) {
      r.stateProfile.atomization = sp.atomization as number || 3;
      r.stateProfile.viscosity = sp.viscosity as number || 3;
      r.stateProfile.hookHolding = sp.hookHolding as number || 3;
      r.stateProfile.weight = sp.weight as number || 3;
    }

    const us = d.usage as Record<string, Object>;
    if (us) {
      r.usage.waterRatio = us.waterRatio as string || '1:1';
      r.usage.restTime = us.restTime as string || '5-10åˆ†é’Ÿ';
      r.usage.firstCast = us.firstCast as string || '';
      r.usage.nestSuggestion = us.nestSuggestion as string || '';
    }

    const reasons = d.reasons as Array<Record<string, Object>>;
    if (reasons) {
      for (let i = 0; i < reasons.length; i++) {
        const reason = new GenerateReason();
        reason.condition = reasons[i].condition as string || '';
        reason.decision = reasons[i].decision as string || '';
        reason.icon = reasons[i].icon as string || '';
        r.reasons.push(reason);
      }
    }

    const cond = d.conditions as Record<string, Object>;
    if (cond) {
      r.conditions.targetFishId = cond.targetFishId as string || '';
      r.conditions.waterType = cond.waterType as 'river' | 'pond' | 'reservoir' | 'wild_pond';
      r.conditions.temperature = cond.temperature as number || 20;
      r.conditions.season = cond.season as 'spring' | 'summer' | 'autumn' | 'winter';
    }

    return r;
  }

  build() {
    Stack() {
      Column() {
        this.HeaderBar()

        if (!this.isLoaded) {
          Column() {
            LoadingProgress().width(40).height(40)
            Text('åŠ è½½ä¸?..').fontSize(14).fontColor(ThemeColors.TEXT_SECONDARY).margin({ top: 12 })
          }.width('100%').layoutWeight(1).justifyContent(FlexAlign.Center)
        } else {
          Scroll() {
            Column({ space: 0 }) {
              // é…æ–¹å¤´éƒ¨ä¿¡æ¯
              this.RecipeHeader()

              // Tabå¯¼èˆª
              this.TabNavigation()

              // Tabå†…å®¹
              if (this.currentTab === 0) {
                this.OverviewContent()
              } else if (this.currentTab === 1) {
                this.IngredientsContent()
              } else {
                this.StepsContent()
              }

              // åº•éƒ¨æ“ä½œæŒ‰é’®
              this.ActionButtons()
            }
            .width('100%')
            .padding({ bottom: 40 })
          }
          .layoutWeight(1)
          .scrollBar(BarState.Off)
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#FFFBF5')

      // å‘½åå¯¹è¯æ¡?
      if (this.showNameDialog) {
        this.NameDialog()
      }
    }
    .width('100%')
    .height('100%')
  }

  @Builder NameDialog() {
    Column() {
      // é®ç½©å±?
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('#00000066')
        .onClick(() => {
          this.showNameDialog = false;
          this.nameError = '';
        })
    }
    .width('100%')
    .height('100%')
    .position({ x: 0, y: 0 })

    Column({ space: 16 }) {
      Text('ä¿å­˜é…æ–¹').fontSize(18).fontWeight(FontWeight.Medium).fontColor(ThemeColors.TEXT_PRIMARY)

      Column({ space: 8 }) {
        Text('é…æ–¹åç§°').fontSize(14).fontColor(ThemeColors.TEXT_SECONDARY).alignSelf(ItemAlign.Start)
        TextInput({ text: this.customRecipeName, placeholder: 'è¯·è¾“å…¥é…æ–¹åç§? })
          .fontSize(15)
          .height(44)
          .backgroundColor('#F5F5F5')
          .borderRadius(8)
          .padding({ left: 12, right: 12 })
          .onChange((value: string) => {
            this.customRecipeName = value;
            this.nameError = '';
          })

        if (this.nameError.length > 0) {
          Text(this.nameError).fontSize(12).fontColor('#F44336').alignSelf(ItemAlign.Start)
        }
      }
      .width('100%')

      Row({ space: 12 }) {
        Button('å–æ¶ˆ')
          .fontSize(14)
          .fontColor(ThemeColors.TEXT_PRIMARY)
          .backgroundColor('#F5F5F5')
          .borderRadius(20)
          .layoutWeight(1)
          .height(40)
          .onClick(() => {
            this.showNameDialog = false;
            this.nameError = '';
          })

        Button('ä¿å­˜')
          .fontSize(14)
          .fontColor(Color.White)
          .backgroundColor(ThemeColors.PRIMARY)
          .borderRadius(20)
          .layoutWeight(1)
          .height(40)
          .onClick(() => {
            this.confirmSaveRecipe();
          })
      }
      .width('100%')
    }
    .width('85%')
    .padding(20)
    .backgroundColor(Color.White)
    .borderRadius(16)
    .position({ x: '7.5%', y: '35%' })
  }

  @Builder HeaderBar() {
    Row() {
      Row() {
        Text('â†?).fontSize(22).fontColor(ThemeColors.TEXT_PRIMARY)
      }
      .width(40)
      .height(40)
      .justifyContent(FlexAlign.Center)
      .onClick(() => router.back())

      Blank()

      Text('é…æ–¹è¯¦æƒ…').fontSize(18).fontWeight(FontWeight.Medium).fontColor(ThemeColors.TEXT_PRIMARY)

      Blank()

      Row() {
        Text(this.isFavorite ? 'â™? : 'â™?)
          .fontSize(22)
          .fontColor(this.isFavorite ? '#F44336' : ThemeColors.TEXT_PRIMARY)
      }
      .width(40)
      .height(40)
      .justifyContent(FlexAlign.Center)
      .onClick(() => { this.isFavorite = !this.isFavorite; })
    }
    .width('100%')
    .height(56)
    .padding({ left: 8, right: 8 })
    .margin({ top: 44 })
  }

  @Builder RecipeHeader() {
    Column({ space: 12 }) {
      // é…æ–¹åç§°
      Text(this.recipe.name)
        .fontSize(22)
        .fontWeight(FontWeight.Bold)
        .fontColor(ThemeColors.TEXT_PRIMARY)

      // é…æ–¹æè¿°
      Text(this.getRecipeDescription())
        .fontSize(14)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .lineHeight(20)

      // æ ‡ç­¾è¡Œï¼šæ—¶é—´ã€éš¾åº¦ã€è¯„åˆ?
      Row({ space: 12 }) {
        this.InfoTagWithImage($r('app.media.time'), `${this.recipe.usage.restTime}`)
        this.InfoTagWithImage($r('app.media.Difficulty'), this.getDifficultyText())
        this.InfoTagWithImage($r('app.media.Twinkle'), '4.8')
      }
    }
    .width('100%')
    .padding({ left: 20, right: 20, top: 16, bottom: 20 })
    .alignItems(HorizontalAlign.Start)
  }

  @Builder InfoTagWithImage(icon: Resource, text: string) {
    Row({ space: 4 }) {
      Image(icon).width(14).height(14)
      Text(text).fontSize(12).fontColor(ThemeColors.TEXT_SECONDARY)
    }
    .padding({ left: 10, right: 10, top: 6, bottom: 6 })
    .backgroundColor(Color.White)
    .borderRadius(16)
  }

  @Builder TabNavigation() {
    Row({ space: 0 }) {
      ForEach(this.tabTitles, (title: string, index: number) => {
        Row() {
          Text(title)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor(this.currentTab === index ? ThemeColors.PRIMARY : '#999999')
        }
        .layoutWeight(1)
        .height(40)
        .justifyContent(FlexAlign.Center)
        .backgroundColor(this.currentTab === index ? Color.White : Color.Transparent)
        .borderRadius(20)
        .onClick(() => { this.currentTab = index; })
      })
    }
    .width('100%')
    .height(52)
    .padding({ left: 20, right: 20 })
    .backgroundColor(Color.White)
  }

  // ========== æ¦‚è§ˆTab ==========
  @Builder OverviewContent() {
    Column({ space: 16 }) {
      // å‘³å‹å¡ç‰‡
      this.FlavorCard()

      // çŠ¶æ€ç‰¹æ€§å¡ç‰?
      this.StateCard()

      // æ¨èç†ç”±
      this.ReasonsCard()
    }
    .width('100%')
    .padding({ left: 20, right: 20, top: 16 })
  }

  @Builder FlavorCard() {
    Column({ space: 12 }) {
      Text('å‘³å‹ç‰¹ç‚¹').fontSize(16).fontWeight(FontWeight.Medium).fontColor(ThemeColors.TEXT_PRIMARY)

      Row({ space: 20 }) {
        Column({ space: 4 }) {
          Text('ä¸»å‘³å?).fontSize(12).fontColor(ThemeColors.TEXT_MUTED)
          Text(this.recipe.flavorProfile.primary + this.recipe.flavorProfile.secondary)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor(ThemeColors.PRIMARY_DARK)
        }

        Column({ space: 4 }) {
          Text('æµ“åº¦').fontSize(12).fontColor(ThemeColors.TEXT_MUTED)
          Row({ space: 2 }) {
            ForEach([1, 2, 3, 4, 5], (i: number) => {
              Row()
                .width(8)
                .height(8)
                .borderRadius(4)
                .backgroundColor(i <= Math.round(this.recipe.flavorProfile.intensity / 2) ? ThemeColors.PRIMARY : '#E5E5E5')
            })
          }
        }

        Column({ space: 4 }) {
          Text('é€‚ç”¨æ°´æ¸©').fontSize(12).fontColor(ThemeColors.TEXT_MUTED)
          Text(this.recipe.flavorProfile.suitableTemp || '15-25Â°C')
            .fontSize(14)
            .fontColor(ThemeColors.TEXT_PRIMARY)
        }
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder StateCard() {
    Column({ space: 12 }) {
      Text('çŠ¶æ€ç‰¹æ€?).fontSize(16).fontWeight(FontWeight.Medium).fontColor(ThemeColors.TEXT_PRIMARY)

      Row() {
        this.StateItem('é›¾åŒ–', this.recipe.stateProfile.atomization)
        this.StateItem('ç²˜åº¦', this.recipe.stateProfile.viscosity)
        this.StateItem('æŒé’©', this.recipe.stateProfile.hookHolding)
        this.StateItem('æ¯”é‡', this.recipe.stateProfile.weight)
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder StateItem(label: string, value: number) {
    Column({ space: 6 }) {
      Text(label).fontSize(12).fontColor(ThemeColors.TEXT_MUTED)
      // è¿›åº¦æ¡æ ·å¼?
      Stack({ alignContent: Alignment.Start }) {
        Row().width('100%').height(6).borderRadius(3).backgroundColor('#F0F0F0')
        Row().width(`${value * 20}%`).height(6).borderRadius(3).backgroundColor(ThemeColors.PRIMARY)
      }.width('100%')
      Text(`${value}/5`).fontSize(11).fontColor(ThemeColors.TEXT_MUTED)
    }
    .layoutWeight(1)
    .padding({ left: 4, right: 4 })
  }

  @Builder ReasonsCard() {
    Column({ space: 12 }) {
      Text('ä¸ºä»€ä¹ˆæ¨è?).fontSize(16).fontWeight(FontWeight.Medium).fontColor(ThemeColors.TEXT_PRIMARY)

      ForEach(this.recipe.reasons, (reason: GenerateReason, index: number) => {
        Row({ space: 12 }) {
          // ç¼–å·åœ†åœˆ
          Row() {
            Text(`${index + 1}`).fontSize(12).fontColor(Color.White)
          }
          .width(24)
          .height(24)
          .borderRadius(12)
          .backgroundColor(ThemeColors.PRIMARY)
          .justifyContent(FlexAlign.Center)

          Column({ space: 2 }) {
            Text(reason.condition).fontSize(14).fontColor(ThemeColors.TEXT_PRIMARY)
            Text(reason.decision).fontSize(13).fontColor(ThemeColors.PRIMARY_DARK)
          }
          .alignItems(HorizontalAlign.Start)
          .layoutWeight(1)
        }
        .width('100%')
        .padding(12)
        .backgroundColor('#FFF9F0')
        .borderRadius(8)
      })
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  // ========== é…æ–™Tab ==========
  @Builder IngredientsContent() {
    Column({ space: 16 }) {
      // æ€»é‡æç¤º
      Row({ space: 8 }) {
        Image($r('app.media.Recipes')).width(16).height(16)
        Text(`æ€»é‡ ${this.recipe.totalWeight}g`).fontSize(14).fontColor(ThemeColors.TEXT_SECONDARY)
      }
      .width('100%')
      .padding({ left: 4 })

      // é…æ–™åˆ—è¡¨
      Column({ space: 0 }) {
        ForEach(this.recipe.ingredients, (ing: RecipeIngredient, index: number) => {
          this.IngredientItem(ing, index)
        })
      }
      .width('100%')
      .backgroundColor(Color.White)
      .borderRadius(12)
      .clip(true)
    }
    .width('100%')
    .padding({ left: 20, right: 20, top: 16 })
  }

  @Builder IngredientItem(ing: RecipeIngredient, index: number) {
    Row({ space: 12 }) {
      // é…æ–™å›¾æ ‡ï¼ˆåœ†å½¢ï¼‰
      Row() {
        Text(this.getIngredientIcon(ing.category)).fontSize(20)
      }
      .width(48)
      .height(48)
      .borderRadius(24)
      .backgroundColor(this.getIngredientBgColor(ing.category))
      .justifyContent(FlexAlign.Center)

      // é…æ–™ä¿¡æ¯
      Column({ space: 4 }) {
        Text(ing.name).fontSize(15).fontColor(ThemeColors.TEXT_PRIMARY)
        Text(ing.purpose || this.getCategoryName(ing.category))
          .fontSize(12)
          .fontColor(ThemeColors.TEXT_MUTED)
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      // ç”¨é‡
      Column({ space: 2 }) {
        Text(`${ing.weight}g`).fontSize(16).fontWeight(FontWeight.Medium).fontColor(ThemeColors.PRIMARY_DARK)
        Text(`${ing.percentage}%`).fontSize(12).fontColor(ThemeColors.TEXT_MUTED)
      }
      .alignItems(HorizontalAlign.End)
    }
    .width('100%')
    .padding(16)
    .border({
      width: { bottom: index < this.recipe.ingredients.length - 1 ? 1 : 0 },
      color: '#F5F5F5'
    })
  }

  // ========== æ­¥éª¤Tab ==========
  @Builder StepsContent() {
    Column({ space: 16 }) {
      // ä½¿ç”¨æ­¥éª¤
      this.UsageStepsCard()

      // ä½¿ç”¨æŠ€å·?
      this.TipsCard()

      // å¤‡æ³¨
      this.NotesCard()
    }
    .width('100%')
    .padding({ left: 20, right: 20, top: 16 })
  }

  @Builder UsageStepsCard() {
    Column({ space: 16 }) {
      Text('ä½¿ç”¨æ­¥éª¤').fontSize(16).fontWeight(FontWeight.Medium).fontColor(ThemeColors.TEXT_PRIMARY)

      // åŠ¨æ€ç”Ÿæˆæ­¥éª?
      ForEach(this.generateDynamicSteps(), (step: StepInfo, index: number) => {
        this.StepItem(index + 1, step.title, step.desc)
      })
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  // åŠ¨æ€ç”Ÿæˆæ­¥éª?- æ ¹æ®åŸæ–™å’ŒçŠ¶æ€ç‰¹æ€§ç”Ÿæˆä¸åŒæ­¥éª?
  private generateDynamicSteps(): StepInfo[] {
    const steps: StepInfo[] = [];
    const sp = this.recipe.stateProfile;
    const usage = this.recipe.usage;
    const fp = this.recipe.flavorProfile;
    const ings = this.recipe.ingredients;

    // è·å–ä¸»è¦åŸæ–™åç§°
    const mainIngs = ings.filter((ing: RecipeIngredient) => ing.category === 'main').map((ing: RecipeIngredient) => ing.name);
    const auxIngs = ings.filter((ing: RecipeIngredient) => ing.category === 'auxiliary').map((ing: RecipeIngredient) => ing.name);
    const stateIngs = ings.filter((ing: RecipeIngredient) => ing.category === 'state').map((ing: RecipeIngredient) => ing.name);
    const addIngs = ings.filter((ing: RecipeIngredient) => ing.category === 'additive').map((ing: RecipeIngredient) => ing.name);

    // æ­¥éª¤1ï¼šå‡†å¤‡ææ–?- åˆ—å‡ºå…·ä½“åŸæ–™
    let prepDesc = `å‡†å¤‡${mainIngs.join('ã€?)}ç­‰ä¸»æ–™`;
    if (auxIngs.length > 0) {
      prepDesc += `ï¼?{auxIngs.join('ã€?)}ä½œä¸ºè¾…æ–™`;
    }
    prepDesc += `ï¼Œæ€»é‡${this.recipe.totalWeight}g`;
    steps.push(new StepInfo('å‡†å¤‡ææ–™', prepDesc));

    // æ­¥éª¤2ï¼šæ··åˆå¹²æ–?- æ ¹æ®å…·ä½“åŸæ–™è°ƒæ•´
    let mixDesc = '';
    if (mainIngs.length > 1) {
      mixDesc = `å…ˆå°†${mainIngs[0]}å’?{mainIngs.slice(1).join('ã€?)}æ··åˆå‡åŒ€`;
    } else if (mainIngs.length === 1) {
      mixDesc = `å°?{mainIngs[0]}å€’å…¥ç›†ä¸­`;
    } else {
      mixDesc = 'å°†æ‰€æœ‰å¹²æ–™å€’å…¥ç›†ä¸­';
    }
    if (auxIngs.length > 0) {
      mixDesc += `ï¼Œå†åŠ å…¥${auxIngs.join('ã€?)}æ…æ‹Œ`;
    }
    steps.push(new StepInfo('æ··åˆå¹²æ–™', mixDesc));

    // æ­¥éª¤3ï¼šåŠ æ°´å¼€é¥?- æ ¹æ®å‘³å‹å’ŒçŠ¶æ€è°ƒæ•?
    let waterDesc = `æŒ?{usage.waterRatio}æ¯”ä¾‹`;
    if (fp.primary.includes('è…?)) {
      waterDesc += 'ç”¨å¸¸æ¸©æ°´å¼€é¥µï¼Œ';
    } else if (fp.primary.includes('é¦?)) {
      waterDesc += 'ç”¨æ¸©æ°´å¼€é¥µæ•ˆæœæ›´ä½³ï¼Œ';
    } else {
      waterDesc += 'åŠ æ°´ï¼?;
    }
    if (sp.atomization >= 4) {
      waterDesc += 'äº”æŒ‡å¼ å¼€å¿«é€Ÿæ…æ‹Œï¼Œè®©é¥µæ–™å……åˆ†å¸æ°?;
    } else if (sp.viscosity >= 4) {
      waterDesc += 'é¡ºæ—¶é’ˆæ…¢æ…¢æ…æ‹Œï¼Œé¿å…å‡ºä¸è¿‡å¤š';
    } else if (sp.weight >= 4) {
      waterDesc += 'æ…æ‹Œå‡åŒ€åé€‚å½“å‹å®';
    } else {
      waterDesc += 'å¿«é€Ÿæ…æ‹Œè‡³æ— å¹²ç²?;
    }
    steps.push(new StepInfo('åŠ æ°´å¼€é¥?, waterDesc));

    // æ­¥éª¤4ï¼šæ·»åŠ çŠ¶æ€é¥µ - å¦‚æœæœ‰çš„è¯?
    if (stateIngs.length > 0) {
      let stateDesc = `åŠ å…¥${stateIngs.join('ã€?)}`;
      if (stateIngs.some((n: string) => n.includes('æ‹‰ä¸'))) {
        stateDesc += 'ï¼Œè½»è½»ç¿»æ‹Œå‡åŒ€ï¼Œä¸è¦è¿‡åº¦æ‰“æ?;
      } else if (stateIngs.some((n: string) => n.includes('é›ªèŠ±'))) {
        stateDesc += 'ï¼Œå¢åŠ é›¾åŒ–æ•ˆæ?;
      } else if (stateIngs.some((n: string) => n.includes('ç²?))) {
        stateDesc += 'ï¼Œå¢åŠ é™„é’©æ€?;
      } else {
        stateDesc += 'ï¼Œè°ƒæ•´é¥µæ–™çŠ¶æ€?;
      }
      steps.push(new StepInfo('æ·»åŠ çŠ¶æ€é¥µ', stateDesc));
    }

    // æ­¥éª¤5ï¼šé™ç½®é†’é¥?- æ ¹æ®çŠ¶æ€è°ƒæ•?
    let restDesc = `é™ç½®${usage.restTime}`;
    if (sp.viscosity >= 4) {
      restDesc += 'ï¼Œè®©æ‹‰ä¸ç²‰å……åˆ†å‡ºä¸ï¼ŒæœŸé—´å¯ç¿»åŠ¨ä¸€æ¬?;
    } else if (sp.atomization >= 4) {
      restDesc += 'ï¼Œä¿æŒè“¬æ¾çŠ¶æ€ï¼Œä¸è¦å‹å®';
    } else if (fp.intensity >= 7) {
      restDesc += 'ï¼Œè®©å‘³å‹å……åˆ†èåˆ';
    } else {
      restDesc += 'ï¼Œè®©é¥µæ–™å……åˆ†å¸æ°´';
    }
    steps.push(new StepInfo('é™ç½®é†’é¥µ', restDesc));

    // æ­¥éª¤6ï¼šæ·»åŠ æ·»åŠ å‰‚ - å¦‚æœæœ‰çš„è¯?
    if (addIngs.length > 0) {
      let addDesc = `æœ€ååŠ å…?{addIngs.join('ã€?)}`;
      if (addIngs.some((n: string) => n.includes('è¯±é£Ÿ') || n.includes('DMPT'))) {
        addDesc += 'ï¼Œå°‘é‡å¤šæ¬¡ï¼Œè¾¹åŠ è¾¹æ…æ‹?;
      } else if (addIngs.some((n: string) => n.includes('é¦™ç²¾') || n.includes('essence'))) {
        addDesc += 'ï¼Œæ»´å…¥åå¿«é€Ÿæ…åŒ€';
      } else {
        addDesc += 'ï¼Œå‡åŒ€æ’’å…¥åè½»è½»ç¿»æ‹?;
      }
      steps.push(new StepInfo('æ·»åŠ å°è¯', addDesc));
    }

    // æ­¥éª¤7ï¼šæ‰“æ‰æˆå?- æ ¹æ®çŠ¶æ€ç‰¹æ€§è°ƒæ•?
    let shapeDesc = '';
    if (sp.hookHolding >= 4 && sp.viscosity >= 4) {
      shapeDesc = 'æ‰“æ‰20-30ä¸‹å¢åŠ ç²˜æ€§ï¼Œæ“æˆè½¯ç¡¬é€‚ä¸­çš„é¥µå›?;
    } else if (sp.atomization >= 4) {
      shapeDesc = 'è½»è½»æ”¶æ‹¢æˆå›¢å³å¯ï¼Œä¿æŒè“¬æ¾é›¾åŒ–æ•ˆæ?;
    } else if (sp.weight >= 4) {
      shapeDesc = 'ç”¨åŠ›æ‰“æ‰ç´§å®ï¼Œå¢åŠ æ¯”é‡ç¡®ä¿å¿«é€Ÿåˆ°åº?;
    } else if (sp.viscosity <= 2) {
      shapeDesc = 'ä¸éœ€è¿‡åº¦æ‰“æ‰ï¼Œä¿æŒæ•£è½çŠ¶æ€?;
    } else {
      shapeDesc = 'æ ¹æ®é±¼æƒ…é€‚å½“æ‰“æ‰ï¼Œè°ƒæ•´è½¯ç¡¬åº¦';
    }
    steps.push(new StepInfo('æ‰“æ‰æˆå‹', shapeDesc));

    return steps;
  }

  @Builder StepItem(num: number, title: string, desc: string) {
    Row({ space: 12 }) {
      // æ­¥éª¤ç¼–å·
      Row() {
        Text(`${num}`).fontSize(14).fontWeight(FontWeight.Medium).fontColor(Color.White)
      }
      .width(28)
      .height(28)
      .borderRadius(14)
      .backgroundColor(ThemeColors.PRIMARY)
      .justifyContent(FlexAlign.Center)

      Column({ space: 4 }) {
        Text(title).fontSize(15).fontWeight(FontWeight.Medium).fontColor(ThemeColors.TEXT_PRIMARY)
        Text(desc).fontSize(13).fontColor(ThemeColors.TEXT_SECONDARY).lineHeight(18)
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
    }
    .width('100%')
    .padding({ top: 8, bottom: 8 })
  }

  @Builder TipsCard() {
    Column({ space: 12 }) {
      Row({ space: 6 }) {
        Image($r('app.media.Twinkles')).width(18).height(18)
        Text('ä½¿ç”¨æŠ€å·?).fontSize(16).fontWeight(FontWeight.Medium).fontColor(ThemeColors.TEXT_PRIMARY)
      }

      Column({ space: 8 }) {
        ForEach(this.generateDynamicTips(), (tip: string) => {
          this.TipItem(tip)
        })
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FFF9F0')
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  // åŠ¨æ€ç”Ÿæˆä½¿ç”¨æŠ€å·?
  private generateDynamicTips(): string[] {
    const tips: string[] = [];
    const sp = this.recipe.stateProfile;
    const fp = this.recipe.flavorProfile;
    const usage = this.recipe.usage;
    const ings = this.recipe.ingredients;
    const temp = this.recipe.conditions.temperature;
    const water = this.recipe.conditions.waterType;

    // æŠ€å·?ï¼šé¦–é’“å»ºè®?- æ ¹æ®çŠ¶æ€å’Œæ°´åŸŸ
    if (usage.firstCast) {
      tips.push(usage.firstCast);
    } else if (sp.atomization >= 4) {
      tips.push('å‰å‡ ç«¿ç”¨å¤§é¥µå¿«é€ŸæŠ½çªï¼Œå½¢æˆé›¾åŒ–å¸¦è¯±é±?);
    } else if (sp.weight >= 4) {
      tips.push('é¦–ç«¿æ“å¤§é¥µæ‰¾åº•ï¼Œç¡®å®šæ°´æ·±åå†è°ƒæ•´');
    } else {
      tips.push('å‰å‡ ç«¿å¯é€‚å½“åŠ å¤§é¥µå›¢ï¼Œå¿«é€Ÿè¯±é±¼è¿›çª?);
    }

    // æŠ€å·?ï¼šæ‰“çªå»ºè®?- æ ¹æ®æ°´åŸŸå’ŒåŸæ–?
    if (usage.nestSuggestion) {
      tips.push(usage.nestSuggestion);
    } else if (water === 'river') {
      tips.push('é‡æ²³èµ°æ°´å¯ç”¨é…’ç±³æ‰“åº•ï¼Œæ•£ç‚®å¸¦çª?);
    } else if (water === 'pond') {
      tips.push('é»‘å‘å»ºè®®æ•£ç‚®å¸¦çªï¼Œè¾¹é’“è¾¹è¯?);
    } else {
      tips.push('å¯é…åˆæ•£ç‚®æˆ–é…’ç±³æ‰“çªï¼Œæ•ˆæœæ›´ä½?);
    }

    // æŠ€å·?ï¼šæ ¹æ®å‘³å‹è°ƒæ•?
    if (fp.primary.includes('è…?) && fp.intensity >= 6) {
      tips.push('è…¥å‘³è¾ƒé‡ï¼Œå°æ‚é±¼å¤šæ—¶å¯é€‚å½“å‡å°‘ç”¨é‡');
    } else if (fp.primary.includes('é¦?) && temp > 25) {
      tips.push('é«˜æ¸©å¤©æ°”é¦™å‘³æŒ¥å‘å¿«ï¼Œå¯é€‚å½“è¡¥å……æ·»åŠ å‰?);
    } else if (fp.primary.includes('é…?)) {
      tips.push('é…¸å‘³é¥µæ–™é€‚åˆé’“é²¢é³™ï¼Œæ³¨æ„æ§åˆ¶é›¾åŒ–èŠ‚å¥');
    }

    // æŠ€å·?ï¼šæ ¹æ®çŠ¶æ€ç‰¹æ€?
    if (sp.viscosity >= 4 && sp.hookHolding >= 4) {
      tips.push('é¥µæ–™ç²˜åº¦é«˜ï¼Œæ³¨æ„æ§åˆ¶é¥µå›¢å¤§å°é¿å…æŒ¡å£');
    } else if (sp.atomization >= 4 && sp.viscosity <= 2) {
      tips.push('é›¾åŒ–å¿«ç²˜åº¦ä½ï¼Œé€‚åˆå¿«é¢‘ç‡æŠ½ç«?);
    }

    // æŠ€å·?ï¼šæ ¹æ®æ¸©åº?
    if (temp < 10) {
      tips.push('ä½æ¸©å¤©æ°”é±¼å£è½»ï¼Œé¥µå›¢å®œå°å®œè½¯');
    } else if (temp > 30) {
      tips.push('é«˜æ¸©å¤©æ°”é±¼èº²æ·±æ°´ï¼Œå¯å°è¯•é’“æ·±æˆ–æ—©æ™šå‡ºé’?);
    }

    // ç¡®ä¿è‡³å°‘3æ¡æŠ€å·?
    if (tips.length < 3) {
      tips.push('æ ¹æ®é±¼å£è°ƒæ•´é¥µæ–™è½¯ç¡¬åº¦å’Œå¤§å°');
    }

    return tips.slice(0, 4);  // æœ€å¤šæ˜¾ç¤?æ?
  }

  @Builder TipItem(text: string) {
    Row({ space: 8 }) {
      Text('â€?).fontSize(14).fontColor(ThemeColors.PRIMARY_DARK)
      Text(text).fontSize(13).fontColor(ThemeColors.TEXT_SECONDARY).layoutWeight(1)
    }.width('100%')
  }

  @Builder NotesCard() {
    Column({ space: 12 }) {
      Row({ space: 6 }) {
        Image($r('app.media.Temperature')).width(18).height(18)
        Text('å¤‡æ³¨').fontSize(16).fontWeight(FontWeight.Medium).fontColor(ThemeColors.TEXT_PRIMARY)
      }

      Text(this.getNotesText())
        .fontSize(13)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .lineHeight(20)
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder ActionButtons() {
    Row({ space: 12 }) {
      Button('æ¢ä¸€æ?)
        .fontSize(14)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .backgroundColor('#F5F5F5')
        .borderRadius(24)
        .layoutWeight(1)
        .height(48)
        .onClick(() => {
          this.regenerateRecipe();
        })

      Button(this.isSaved ? 'å·²ä¿å­? : 'ä¿å­˜é…æ–¹')
        .fontSize(14)
        .fontColor(Color.White)
        .backgroundColor(this.isSaved ? '#AAAAAA' : ThemeColors.PRIMARY)
        .borderRadius(24)
        .layoutWeight(1)
        .height(48)
        .onClick(() => {
          if (!this.isSaved) {
            this.showSaveDialog();
          }
        })
    }
    .width('100%')
    .padding({ left: 20, right: 20, top: 24 })
  }

  // æ¢ä¸€æ¢ï¼šä½¿ç”¨æ™ºèƒ½å˜ä½“ç®¡ç†å™¨è·å–ä¸åŒé…æ–?
  private async regenerateRecipe(): Promise<void> {
    try {
      // ä½¿ç”¨æ™ºèƒ½é…æ–¹å¼•æ“çš„å˜ä½“åŠŸèƒ?
      const newRecipe = getNextRecipeVariant();

      if (newRecipe !== null) {
        this.recipe = newRecipe;
        this.isSaved = false;

        // ä¿å­˜åˆ°å†å?
        this.saveToHistory();

        promptAction.showToast({ message: 'å·²ä¸ºæ‚¨æ¢ä¸€ä¸ªé…æ–?, duration: 1500 });
      } else {
        // å¦‚æœå˜ä½“ç®¡ç†å™¨è¿”å›nullï¼Œé‡æ–°ç”Ÿæˆ?
        let temperature = this.recipe.conditions.temperature || 20;
        try {
          const weather = await fetchWeather();
          if (weather.isValid) {
            temperature = Math.round(weather.temperature);
          }
        } catch (e) {
          console.error('Fetch weather failed:', e);
        }

        const input = new GenerateRecipeInput();
        input.targetFishId = this.recipe.conditions.targetFishId || 'crucian';
        input.waterType = this.recipe.conditions.waterType || 'pond';
        input.temperature = temperature;
        input.season = this.recipe.conditions.season || getSmartRecipeEngine().getCurrentSeason();
        input.fishDensity = this.recipe.conditions.fishDensity || 'medium';
        input.fishActivity = this.recipe.conditions.fishActivity || 'normal';
        input.fishingMethod = this.recipe.conditions.fishingMethod || 'rub';
        input.mode = this.recipe.conditions.mode || 'balanced';

        const recipe = generateSmartRecipe(input);
        this.recipe = recipe;
        this.isSaved = false;

        this.saveToHistory();
        promptAction.showToast({ message: 'å·²ä¸ºæ‚¨æ¢ä¸€ä¸ªé…æ–?, duration: 1500 });
      }
    } catch (err) {
      console.error('Regenerate recipe failed:', err);
      promptAction.showToast({ message: 'ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•', duration: 1500 });
    }
  }

  // æ˜¾ç¤ºä¿å­˜å¯¹è¯æ¡?
  private async showSaveDialog(): Promise<void> {
    await userDataService.load();
    this.customRecipeName = this.recipe.name;
    this.nameError = '';
    this.showNameDialog = true;
  }

  // ç¡®è®¤ä¿å­˜é…æ–¹
  private async confirmSaveRecipe(): Promise<void> {
    const name = this.customRecipeName.trim();

    // éªŒè¯åç§°
    if (name.length === 0) {
      this.nameError = 'è¯·è¾“å…¥é…æ–¹åç§?;
      return;
    }

    if (name.length > 20) {
      this.nameError = 'åç§°ä¸èƒ½è¶…è¿‡20ä¸ªå­—ç¬?;
      return;
    }

    // æ£€æŸ¥é‡å?
    if (userDataService.isRecipeNameExists(name)) {
      this.nameError = 'è¯¥åç§°å·²å­˜åœ¨ï¼Œè¯·æ¢ä¸€ä¸?;
      return;
    }

    // ä¿å­˜é…æ–¹
    try {
      // è½¬æ¢é…æ–™æ ¼å¼ - ä¿å­˜å®Œæ•´ä¿¡æ¯
      const ingredients: CustomRecipeIngredient[] = [];
      for (let i = 0; i < this.recipe.ingredients.length; i++) {
        const ing = this.recipe.ingredients[i];
        const customIng = new CustomRecipeIngredient();
        customIng.ingredientId = ing.id;
        customIng.name = ing.name;
        customIng.ratio = ing.percentage;
        customIng.weight = ing.weight;
        customIng.purpose = ing.purpose;
        customIng.category = ing.category;
        ingredients.push(customIng);
      }

      // æ„å»ºåŠ¨æ€æ­¥éª?
      const dynamicSteps = this.generateDynamicSteps();
      const steps: string[] = [];
      for (let i = 0; i < dynamicSteps.length; i++) {
        steps.push(`${dynamicSteps[i].title}ï¼?{dynamicSteps[i].desc}`);
      }

      // æ„å»ºæŠ€å·?
      const tips = `${this.recipe.usage.firstCast || 'å‰å‡ ç«¿å¯é€‚å½“åŠ å¤§é¥µå›¢ï¼Œå¿«é€Ÿè¯±é±?}ï¼?{this.recipe.usage.nestSuggestion || 'å¯é…åˆæ•£ç‚®æ‰“çªï¼Œæ•ˆæœæ›´ä½³'}`;

      // æ„å»ºçŠ¶æ€ç‰¹æ€?
      const stateProfile = new RecipeStateProfile();
      stateProfile.atomization = this.recipe.stateProfile.atomization;
      stateProfile.viscosity = this.recipe.stateProfile.viscosity;
      stateProfile.hookHolding = this.recipe.stateProfile.hookHolding;
      stateProfile.weight = this.recipe.stateProfile.weight;

      // æ„å»ºå‘³å‹ç‰¹æ€?
      const flavorProfile = new RecipeFlavorProfile();
      flavorProfile.primary = this.recipe.flavorProfile.primary;
      flavorProfile.secondary = this.recipe.flavorProfile.secondary;
      flavorProfile.intensity = this.recipe.flavorProfile.intensity;
      flavorProfile.suitableTemp = this.recipe.flavorProfile.suitableTemp;

      // ä¿å­˜é…æ–¹ - åŒ…å«å®Œæ•´æ•°æ®
      await userDataService.addRecipe(
        name,
        [this.recipe.conditions.targetFishId],
        this.recipe.conditions.waterType,
        this.recipe.conditions.season,
        ingredients,
        steps,
        tips,
        stateProfile,
        flavorProfile,
        this.recipe.totalWeight
      );

      // è®°å½•åˆ°åå¥½å­¦ä¹ å™¨
      recordRecipeSave(this.recipe);

      this.isSaved = true;
      this.showNameDialog = false;
      promptAction.showToast({ message: 'é…æ–¹å·²ä¿å­?, duration: 1500 });
    } catch (err) {
      console.error('Save recipe failed:', err);
      this.nameError = 'ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•';
    }
  }

  // ä¿å­˜é…æ–¹åˆ°ç”¨æˆ·æ•°æ?(æ—§æ–¹æ³•ä¿ç•™å…¼å®?
  private async saveRecipeToUserData(): Promise<void> {
    this.showSaveDialog();
  }

  // ========== è¾…åŠ©æ–¹æ³• ==========
  private getRecipeDescription(): string {
    const fish = this.getFishName();
    const water = this.getWaterName();
    const season = this.getSeasonName();
    return `ä¸“ä¸º${season}${water}é’?{fish}è®¾è®¡ï¼?{this.recipe.flavorProfile.primary}${this.recipe.flavorProfile.secondary}å‘³å‹ï¼Œé€‚åˆ${this.recipe.flavorProfile.suitableTemp || '15-25Â°C'}æ°´æ¸©ä½¿ç”¨ã€‚`;
  }

  private getDifficultyText(): string {
    const count = this.recipe.ingredients.length;
    if (count <= 3) return 'ç®€å?;
    if (count <= 5) return 'ä¸­ç­‰';
    return 'å¤æ‚';
  }

  private getFishName(): string {
    const fishId = this.recipe.conditions.targetFishId;
    if (fishId === 'crucian') return 'é²«é±¼';
    if (fishId === 'carp') return 'é²¤é±¼';
    if (fishId === 'grass') return 'è‰é±¼';
    if (fishId === 'black') return 'é’é±¼';
    if (fishId === 'catfish') return 'é²¶é±¼';
    return 'ç›®æ ‡é±?;
  }

  private getWaterName(): string {
    const waterType = this.recipe.conditions.waterType;
    if (waterType === 'river') return 'é‡æ²³';
    if (waterType === 'pond') return 'é»‘å‘';
    if (waterType === 'reservoir') return 'æ°´åº“';
    if (waterType === 'wild_pond') return 'é‡å¡˜';
    return '';
  }

  private getSeasonName(): string {
    const season = this.recipe.conditions.season;
    if (season === 'spring') return 'æ˜¥å­£';
    if (season === 'summer') return 'å¤å­£';
    if (season === 'autumn') return 'ç§‹å­£';
    if (season === 'winter') return 'å†¬å­£';
    return '';
  }

  private getCategoryName(cat: string): string {
    if (cat === 'main') return 'ä¸»é¥µ';
    if (cat === 'auxiliary') return 'è¾…é¥µ';
    if (cat === 'state') return 'çŠ¶æ€é¥µ';
    if (cat === 'additive') return 'æ·»åŠ å‰?;
    return '';
  }

  private getIngredientIcon(cat: string): string {
    if (cat === 'main') return 'ğŸŒ¾';
    if (cat === 'auxiliary') return 'ğŸ¥œ';
    if (cat === 'state') return 'ğŸ’§';
    if (cat === 'additive') return 'âœ?;
    return 'ğŸ“¦';
  }

  private getIngredientBgColor(cat: string): string {
    if (cat === 'main') return '#FFF3E0';
    if (cat === 'auxiliary') return '#E8F5E9';
    if (cat === 'state') return '#E3F2FD';
    if (cat === 'additive') return '#FCE4EC';
    return '#F5F5F5';
  }

  private getNotesText(): string {
    const temp = this.recipe.conditions.temperature;
    const water = this.recipe.conditions.waterType;
    const fp = this.recipe.flavorProfile;
    const sp = this.recipe.stateProfile;
    const ings = this.recipe.ingredients;

    let notes: string[] = [];

    // æ¸©åº¦ç›¸å…³å¤‡æ³¨
    if (temp < 10) {
      notes.push(`å½“å‰æ°”æ¸©${temp}Â°Cï¼Œæ°´æ¸©è¾ƒä½ï¼Œå»ºè®®é€‚å½“å¢åŠ è…¥å‘³æ¯”ä¾‹ï¼Œé¥µæ–™çŠ¶æ€åè½¯ç²˜ï¼Œå¼€é¥µæ—¶å¯ç”¨æ¸©æ°´ã€‚`);
    } else if (temp < 15) {
      notes.push(`å½“å‰æ°”æ¸©${temp}Â°Cï¼Œæ—©æ™šæ¸©å·®å¤§ï¼Œå»ºè®®å‡†å¤‡ä¸¤å¥—é¥µæ–™ï¼Œæ—©æ™šç”¨è…¥ï¼Œä¸­åˆç”¨é¦™ã€‚`);
    } else if (temp > 30) {
      notes.push(`å½“å‰æ°”æ¸©${temp}Â°Cï¼Œæ°´æ¸©è¾ƒé«˜ï¼Œå»ºè®®æ¸…æ·¡ä¸ºä¸»ï¼Œå¯é€‚å½“åŠ å…¥æœé…¸ç±»æ·»åŠ å‰‚ï¼Œé¿å…é¥µæ–™å˜è´¨ã€‚`);
    } else if (temp > 25) {
      notes.push(`å½“å‰æ°”æ¸©${temp}Â°Cï¼Œæ¸©åº¦é€‚å®œä½†åé«˜ï¼Œæ³¨æ„é¥µæ–™ä¿é²œï¼Œå¼€å¥½çš„é¥µæ–™å°½å¿«ä½¿ç”¨ã€‚`);
    } else {
      notes.push(`å½“å‰æ°”æ¸©${temp}Â°Cï¼Œæ¸©åº¦é€‚å®œï¼ŒæŒ‰é…æ–¹æ­£å¸¸ä½¿ç”¨å³å¯ã€‚`);
    }

    // æ°´åŸŸç›¸å…³å¤‡æ³¨
    if (water === 'river') {
      notes.push('é‡æ²³ç¯å¢ƒå¤æ‚ï¼Œæ³¨æ„è§‚å¯Ÿæ°´æµæ–¹å‘ï¼Œé€‰æ‹©ç¼“æµåŒºä½œé’“ã€?);
    } else if (water === 'pond') {
      notes.push('é»‘å‘ç«äº‰æ¿€çƒˆï¼Œæ³¨æ„è§‚å¯Ÿå‘¨å›´é’“å‹ç”¨é¥µï¼Œé€‚æ—¶è°ƒæ•´ã€?);
    } else if (water === 'reservoir') {
      notes.push('æ°´åº“æ°´é¢å¤§ï¼Œå»ºè®®æå‰æ‰“çªï¼Œè€å¿ƒå®ˆé’“ã€?);
    }

    // å‘³å‹ç›¸å…³å¤‡æ³¨
    if (fp.intensity >= 8) {
      notes.push('æœ¬é…æ–¹å‘³å‹è¾ƒæµ“ï¼Œå¦‚é‡æ»‘å£é±¼å¯é€‚å½“å‡å°‘æ·»åŠ å‰‚ç”¨é‡ã€?);
    } else if (fp.intensity <= 3) {
      notes.push('æœ¬é…æ–¹å‘³å‹æ¸…æ·¡ï¼Œé€‚åˆé’“æ»‘å£é±¼æˆ–å¤§ä¸ªä½“é±¼ã€?);
    }

    // çŠ¶æ€ç›¸å…³å¤‡æ³?
    if (sp.atomization >= 4 && sp.viscosity <= 2) {
      notes.push('é›¾åŒ–è¾ƒå¿«ï¼Œé€‚åˆå¿«é¢‘ç‡ä½œé’“ï¼Œæ³¨æ„è¡¥çªèŠ‚å¥ã€?);
    }

    // åŸæ–™ç›¸å…³å¤‡æ³¨
    const hasLiveBait = ings.some((ing: RecipeIngredient) =>
      ing.name.includes('çº¢è™«') || ing.name.includes('èš¯èš“') || ing.name.includes('æ´»é¥µ'));
    if (hasLiveBait) {
      notes.push('å«æ´»é¥µæˆåˆ†ï¼Œæ³¨æ„ä¿æŒæ–°é²œåº¦ã€?);
    }

    // é€šç”¨å»ºè®®
    notes.push('å¦‚é‡é±¼å£ä¸ä½³ï¼Œå¯å°è¯•è°ƒæ•´æ°´æ¯”æˆ–æ›´æ¢æ·»åŠ å‰‚ã€?);

    return notes.slice(0, 3).join('\n\n');
  }
}
