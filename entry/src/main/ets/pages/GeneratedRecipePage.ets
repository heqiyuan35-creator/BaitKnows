/**
 * é¥µçŸ¥é“ - ç”Ÿæˆé…æ–¹ç»“æœé¡µ
 * æŒ‰è®¾è®¡å›¾é‡åšï¼šTabå¯¼èˆªã€é…æ–™å›¾æ ‡ã€æ­¥éª¤ç¼–å·ã€ä½¿ç”¨æŠ€å·§
 */
import { router } from '@kit.ArkUI';
import { ThemeColors } from '../theme/ThemeColors';
import { GeneratedRecipe, RecipeIngredient, GenerateReason, GenerateRecipeInput } from '../common/types/RecipeTypes';
import { generatorHistoryService } from '../services/GeneratorHistoryService';
import { generateRecipe, getCurrentSeason } from '../services/RecipeGeneratorService';
import { fetchWeather } from '../services/WeatherService';
import { promptAction } from '@kit.ArkUI';
import { userDataService, CustomRecipeIngredient } from '../services/UserDataService';

@Entry
@Component
struct GeneratedRecipePage {
  @State recipe: GeneratedRecipe = new GeneratedRecipe();
  @State isFavorite: boolean = false;
  @State isLoaded: boolean = false;
  @State currentTab: number = 0;
  @State isSaved: boolean = false;

  private tabTitles: string[] = ['æ¦‚è§ˆ', 'é…æ–™', 'æ­¥éª¤'];
  private originalInput: GenerateRecipeInput | null = null;

  aboutToAppear(): void {
    try {
      const params = router.getParams();
      if (params) {
        const p = params as Record<string, Object>;
        if (p.recipe) {
          // ä»é±¼é¥µç”Ÿæˆå™¨ä¼ å…¥çš„å®Œæ•´é…æ–¹
          const data: Record<string, Object> = JSON.parse(p.recipe as string);
          this.recipe = this.parseRecipe(data);
          this.isLoaded = true;
        } else if (p.quickMode) {
          // å¿«é€Ÿæ¨¡å¼ï¼šä»é¦–é¡µä¼ å…¥é±¼ç§å’Œæ°´åŸŸï¼Œè‡ªåŠ¨ç”Ÿæˆ
          this.quickGenerate(p.fish as string, p.water as string);
          return;
        }
      }
    } catch (err) {
      console.error('Parse recipe failed:', err);
    }
    if (!this.isLoaded) {
      this.isLoaded = true;
    }

    // ä¿å­˜åˆ°ç”Ÿæˆå†å²
    if (this.recipe.id) {
      this.saveToHistory();
    }
  }

  // å¿«é€Ÿç”Ÿæˆé…æ–¹
  private async quickGenerate(fishId: string, waterType: string): Promise<void> {
    try {
      // è·å–å½“å‰å¤©æ°”æ¸©åº¦
      let temperature = 20;
      try {
        const weather = await fetchWeather();
        if (weather.isValid) {
          temperature = Math.round(weather.temperature);
        }
      } catch (e) {
        console.error('Fetch weather failed:', e);
      }

      // æ„å»ºè¾“å…¥å‚æ•°
      const input = new GenerateRecipeInput();
      input.targetFishId = fishId || 'crucian';
      input.waterType = (waterType as 'river' | 'pond' | 'reservoir' | 'wild_pond') || 'pond';
      input.temperature = temperature;
      input.season = getCurrentSeason();
      input.fishDensity = 'medium';
      input.fishActivity = 'normal';
      input.fishingMethod = 'rub';
      input.mode = 'balanced';

      // ç”Ÿæˆé…æ–¹
      const recipe = generateRecipe(input);
      this.recipe = recipe;
      this.isLoaded = true;

      // ä¿å­˜åˆ°å†å²
      this.saveToHistory();
    } catch (err) {
      console.error('Quick generate failed:', err);
      this.isLoaded = true;
    }
  }

  private async saveToHistory(): Promise<void> {
    await generatorHistoryService.load();
    await generatorHistoryService.addHistory(this.recipe);
  }

  private parseRecipe(data: Record<string, Object>): GeneratedRecipe {
    const r = new GeneratedRecipe();
    const d = data;
    r.id = d.id as string || '';
    r.name = d.name as string || 'æ™ºèƒ½é…æ–¹';
    r.totalWeight = d.totalWeight as number || 500;
    r.mode = d.mode as string || 'balanced';
    r.createTime = d.createTime as number || Date.now();

    const ings = d.ingredients as Array<Record<string, Object>>;
    if (ings) {
      for (let i = 0; i < ings.length; i++) {
        const ing = new RecipeIngredient();
        ing.id = ings[i].id as string || '';
        ing.name = ings[i].name as string || '';
        ing.category = ings[i].category as 'main' | 'auxiliary' | 'state' | 'additive';
        ing.percentage = ings[i].percentage as number || 0;
        ing.weight = ings[i].weight as number || 0;
        ing.purpose = ings[i].purpose as string || '';
        r.ingredients.push(ing);
      }
    }

    const fp = d.flavorProfile as Record<string, Object>;
    if (fp) {
      r.flavorProfile.primary = fp.primary as string || '';
      r.flavorProfile.secondary = fp.secondary as string || '';
      r.flavorProfile.intensity = fp.intensity as number || 5;
      r.flavorProfile.suitableTemp = fp.suitableTemp as string || '';
    }

    const sp = d.stateProfile as Record<string, Object>;
    if (sp) {
      r.stateProfile.atomization = sp.atomization as number || 3;
      r.stateProfile.viscosity = sp.viscosity as number || 3;
      r.stateProfile.hookHolding = sp.hookHolding as number || 3;
      r.stateProfile.weight = sp.weight as number || 3;
    }

    const us = d.usage as Record<string, Object>;
    if (us) {
      r.usage.waterRatio = us.waterRatio as string || '1:1';
      r.usage.restTime = us.restTime as string || '5-10åˆ†é’Ÿ';
      r.usage.firstCast = us.firstCast as string || '';
      r.usage.nestSuggestion = us.nestSuggestion as string || '';
    }

    const reasons = d.reasons as Array<Record<string, Object>>;
    if (reasons) {
      for (let i = 0; i < reasons.length; i++) {
        const reason = new GenerateReason();
        reason.condition = reasons[i].condition as string || '';
        reason.decision = reasons[i].decision as string || '';
        reason.icon = reasons[i].icon as string || '';
        r.reasons.push(reason);
      }
    }

    const cond = d.conditions as Record<string, Object>;
    if (cond) {
      r.conditions.targetFishId = cond.targetFishId as string || '';
      r.conditions.waterType = cond.waterType as 'river' | 'pond' | 'reservoir' | 'wild_pond';
      r.conditions.temperature = cond.temperature as number || 20;
      r.conditions.season = cond.season as 'spring' | 'summer' | 'autumn' | 'winter';
    }

    return r;
  }

  build() {
    Column() {
      this.HeaderBar()

      if (!this.isLoaded) {
        Column() {
          LoadingProgress().width(40).height(40)
          Text('åŠ è½½ä¸­...').fontSize(14).fontColor(ThemeColors.TEXT_SECONDARY).margin({ top: 12 })
        }.width('100%').layoutWeight(1).justifyContent(FlexAlign.Center)
      } else {
        Scroll() {
          Column({ space: 0 }) {
            // é…æ–¹å¤´éƒ¨ä¿¡æ¯
            this.RecipeHeader()

            // Tabå¯¼èˆª
            this.TabNavigation()

            // Tabå†…å®¹
            if (this.currentTab === 0) {
              this.OverviewContent()
            } else if (this.currentTab === 1) {
              this.IngredientsContent()
            } else {
              this.StepsContent()
            }

            // åº•éƒ¨æ“ä½œæŒ‰é’®
            this.ActionButtons()
          }
          .width('100%')
          .padding({ bottom: 40 })
        }
        .layoutWeight(1)
        .scrollBar(BarState.Off)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FFFBF5')
  }

  @Builder HeaderBar() {
    Row() {
      Row() {
        Text('â†').fontSize(22).fontColor(ThemeColors.TEXT_PRIMARY)
      }
      .width(40)
      .height(40)
      .justifyContent(FlexAlign.Center)
      .onClick(() => router.back())

      Blank()

      Text('é…æ–¹è¯¦æƒ…').fontSize(18).fontWeight(FontWeight.Medium).fontColor(ThemeColors.TEXT_PRIMARY)

      Blank()

      Row() {
        Text(this.isFavorite ? 'â™¥' : 'â™¡')
          .fontSize(22)
          .fontColor(this.isFavorite ? '#F44336' : ThemeColors.TEXT_PRIMARY)
      }
      .width(40)
      .height(40)
      .justifyContent(FlexAlign.Center)
      .onClick(() => { this.isFavorite = !this.isFavorite; })
    }
    .width('100%')
    .height(56)
    .padding({ left: 8, right: 8 })
    .margin({ top: 44 })
  }

  @Builder RecipeHeader() {
    Column({ space: 12 }) {
      // é…æ–¹åç§°
      Text(this.recipe.name)
        .fontSize(22)
        .fontWeight(FontWeight.Bold)
        .fontColor(ThemeColors.TEXT_PRIMARY)

      // é…æ–¹æè¿°
      Text(this.getRecipeDescription())
        .fontSize(14)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .lineHeight(20)

      // æ ‡ç­¾è¡Œï¼šæ—¶é—´ã€éš¾åº¦ã€è¯„åˆ†
      Row({ space: 12 }) {
        this.InfoTagWithImage($r('app.media.time'), `${this.recipe.usage.restTime}`)
        this.InfoTagWithImage($r('app.media.Difficulty'), this.getDifficultyText())
        this.InfoTagWithImage($r('app.media.Twinkle'), '4.8')
      }
    }
    .width('100%')
    .padding({ left: 20, right: 20, top: 16, bottom: 20 })
    .alignItems(HorizontalAlign.Start)
  }

  @Builder InfoTagWithImage(icon: Resource, text: string) {
    Row({ space: 4 }) {
      Image(icon).width(14).height(14)
      Text(text).fontSize(12).fontColor(ThemeColors.TEXT_SECONDARY)
    }
    .padding({ left: 10, right: 10, top: 6, bottom: 6 })
    .backgroundColor(Color.White)
    .borderRadius(16)
  }

  @Builder TabNavigation() {
    Row({ space: 0 }) {
      ForEach(this.tabTitles, (title: string, index: number) => {
        Row() {
          Text(title)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor(this.currentTab === index ? ThemeColors.PRIMARY : '#999999')
        }
        .layoutWeight(1)
        .height(40)
        .justifyContent(FlexAlign.Center)
        .backgroundColor(this.currentTab === index ? Color.White : Color.Transparent)
        .borderRadius(20)
        .onClick(() => { this.currentTab = index; })
      })
    }
    .width('100%')
    .height(52)
    .padding({ left: 20, right: 20 })
    .backgroundColor(Color.White)
  }

  // ========== æ¦‚è§ˆTab ==========
  @Builder OverviewContent() {
    Column({ space: 16 }) {
      // å‘³å‹å¡ç‰‡
      this.FlavorCard()

      // çŠ¶æ€ç‰¹æ€§å¡ç‰‡
      this.StateCard()

      // æ¨èç†ç”±
      this.ReasonsCard()
    }
    .width('100%')
    .padding({ left: 20, right: 20, top: 16 })
  }

  @Builder FlavorCard() {
    Column({ space: 12 }) {
      Text('å‘³å‹ç‰¹ç‚¹').fontSize(16).fontWeight(FontWeight.Medium).fontColor(ThemeColors.TEXT_PRIMARY)

      Row({ space: 20 }) {
        Column({ space: 4 }) {
          Text('ä¸»å‘³å‹').fontSize(12).fontColor(ThemeColors.TEXT_MUTED)
          Text(this.recipe.flavorProfile.primary + this.recipe.flavorProfile.secondary)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor(ThemeColors.PRIMARY)
        }

        Column({ space: 4 }) {
          Text('æµ“åº¦').fontSize(12).fontColor(ThemeColors.TEXT_MUTED)
          Row({ space: 2 }) {
            ForEach([1, 2, 3, 4, 5], (i: number) => {
              Row()
                .width(8)
                .height(8)
                .borderRadius(4)
                .backgroundColor(i <= Math.round(this.recipe.flavorProfile.intensity / 2) ? ThemeColors.PRIMARY : '#E5E5E5')
            })
          }
        }

        Column({ space: 4 }) {
          Text('é€‚ç”¨æ°´æ¸©').fontSize(12).fontColor(ThemeColors.TEXT_MUTED)
          Text(this.recipe.flavorProfile.suitableTemp || '15-25Â°C')
            .fontSize(14)
            .fontColor(ThemeColors.TEXT_PRIMARY)
        }
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder StateCard() {
    Column({ space: 12 }) {
      Text('çŠ¶æ€ç‰¹æ€§').fontSize(16).fontWeight(FontWeight.Medium).fontColor(ThemeColors.TEXT_PRIMARY)

      Row() {
        this.StateItem('é›¾åŒ–', this.recipe.stateProfile.atomization)
        this.StateItem('ç²˜åº¦', this.recipe.stateProfile.viscosity)
        this.StateItem('æŒé’©', this.recipe.stateProfile.hookHolding)
        this.StateItem('æ¯”é‡', this.recipe.stateProfile.weight)
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder StateItem(label: string, value: number) {
    Column({ space: 6 }) {
      Text(label).fontSize(12).fontColor(ThemeColors.TEXT_MUTED)
      // è¿›åº¦æ¡æ ·å¼
      Stack({ alignContent: Alignment.Start }) {
        Row().width('100%').height(6).borderRadius(3).backgroundColor('#F0F0F0')
        Row().width(`${value * 20}%`).height(6).borderRadius(3).backgroundColor(ThemeColors.PRIMARY)
      }.width('100%')
      Text(`${value}/5`).fontSize(11).fontColor(ThemeColors.TEXT_MUTED)
    }
    .layoutWeight(1)
    .padding({ left: 4, right: 4 })
  }

  @Builder ReasonsCard() {
    Column({ space: 12 }) {
      Text('ä¸ºä»€ä¹ˆæ¨è').fontSize(16).fontWeight(FontWeight.Medium).fontColor(ThemeColors.TEXT_PRIMARY)

      ForEach(this.recipe.reasons, (reason: GenerateReason, index: number) => {
        Row({ space: 12 }) {
          // ç¼–å·åœ†åœˆ
          Row() {
            Text(`${index + 1}`).fontSize(12).fontColor(Color.White)
          }
          .width(24)
          .height(24)
          .borderRadius(12)
          .backgroundColor(ThemeColors.PRIMARY)
          .justifyContent(FlexAlign.Center)

          Column({ space: 2 }) {
            Text(reason.condition).fontSize(14).fontColor(ThemeColors.TEXT_PRIMARY)
            Text(reason.decision).fontSize(13).fontColor(ThemeColors.PRIMARY)
          }
          .alignItems(HorizontalAlign.Start)
          .layoutWeight(1)
        }
        .width('100%')
        .padding(12)
        .backgroundColor('#FFF9F0')
        .borderRadius(8)
      })
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  // ========== é…æ–™Tab ==========
  @Builder IngredientsContent() {
    Column({ space: 16 }) {
      // æ€»é‡æç¤º
      Row({ space: 8 }) {
        Image($r('app.media.Recipes')).width(16).height(16)
        Text(`æ€»é‡ ${this.recipe.totalWeight}g`).fontSize(14).fontColor(ThemeColors.TEXT_SECONDARY)
      }
      .width('100%')
      .padding({ left: 4 })

      // é…æ–™åˆ—è¡¨
      Column({ space: 0 }) {
        ForEach(this.recipe.ingredients, (ing: RecipeIngredient, index: number) => {
          this.IngredientItem(ing, index)
        })
      }
      .width('100%')
      .backgroundColor(Color.White)
      .borderRadius(12)
      .clip(true)
    }
    .width('100%')
    .padding({ left: 20, right: 20, top: 16 })
  }

  @Builder IngredientItem(ing: RecipeIngredient, index: number) {
    Row({ space: 12 }) {
      // é…æ–™å›¾æ ‡ï¼ˆåœ†å½¢ï¼‰
      Row() {
        Text(this.getIngredientIcon(ing.category)).fontSize(20)
      }
      .width(48)
      .height(48)
      .borderRadius(24)
      .backgroundColor(this.getIngredientBgColor(ing.category))
      .justifyContent(FlexAlign.Center)

      // é…æ–™ä¿¡æ¯
      Column({ space: 4 }) {
        Text(ing.name).fontSize(15).fontColor(ThemeColors.TEXT_PRIMARY)
        Text(ing.purpose || this.getCategoryName(ing.category))
          .fontSize(12)
          .fontColor(ThemeColors.TEXT_MUTED)
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      // ç”¨é‡
      Column({ space: 2 }) {
        Text(`${ing.weight}g`).fontSize(16).fontWeight(FontWeight.Medium).fontColor(ThemeColors.PRIMARY)
        Text(`${ing.percentage}%`).fontSize(12).fontColor(ThemeColors.TEXT_MUTED)
      }
      .alignItems(HorizontalAlign.End)
    }
    .width('100%')
    .padding(16)
    .border({
      width: { bottom: index < this.recipe.ingredients.length - 1 ? 1 : 0 },
      color: '#F5F5F5'
    })
  }

  // ========== æ­¥éª¤Tab ==========
  @Builder StepsContent() {
    Column({ space: 16 }) {
      // ä½¿ç”¨æ­¥éª¤
      this.UsageStepsCard()

      // ä½¿ç”¨æŠ€å·§
      this.TipsCard()

      // å¤‡æ³¨
      this.NotesCard()
    }
    .width('100%')
    .padding({ left: 20, right: 20, top: 16 })
  }

  @Builder UsageStepsCard() {
    Column({ space: 16 }) {
      Text('ä½¿ç”¨æ­¥éª¤').fontSize(16).fontWeight(FontWeight.Medium).fontColor(ThemeColors.TEXT_PRIMARY)

      // æ­¥éª¤1ï¼šå‡†å¤‡
      this.StepItem(1, 'å‡†å¤‡ææ–™', `æŒ‰é…æ–¹æ¯”ä¾‹å‡†å¤‡å¥½æ‰€æœ‰åŸæ–™ï¼Œæ€»é‡${this.recipe.totalWeight}g`)

      // æ­¥éª¤2ï¼šæ··åˆ
      this.StepItem(2, 'æ··åˆå¹²æ–™', 'å°†æ‰€æœ‰å¹²æ–™å€’å…¥ç›†ä¸­ï¼Œå……åˆ†æ…æ‹Œå‡åŒ€')

      // æ­¥éª¤3ï¼šåŠ æ°´
      this.StepItem(3, 'åŠ æ°´å¼€é¥µ', `æŒ‰${this.recipe.usage.waterRatio}æ¯”ä¾‹åŠ æ°´ï¼Œå¿«é€Ÿæ…æ‹Œ`)

      // æ­¥éª¤4ï¼šé™ç½®
      this.StepItem(4, 'é™ç½®é†’é¥µ', `é™ç½®${this.recipe.usage.restTime}ï¼Œè®©é¥µæ–™å……åˆ†å¸æ°´`)

      // æ­¥éª¤5ï¼šæ‰“æ‰
      this.StepItem(5, 'æ‰“æ‰æˆå‹', 'æ ¹æ®éœ€è¦é€‚å½“æ‰“æ‰ï¼Œè°ƒæ•´è½¯ç¡¬åº¦')
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder StepItem(num: number, title: string, desc: string) {
    Row({ space: 12 }) {
      // æ­¥éª¤ç¼–å·
      Row() {
        Text(`${num}`).fontSize(14).fontWeight(FontWeight.Medium).fontColor(Color.White)
      }
      .width(28)
      .height(28)
      .borderRadius(14)
      .backgroundColor(ThemeColors.PRIMARY)
      .justifyContent(FlexAlign.Center)

      Column({ space: 4 }) {
        Text(title).fontSize(15).fontWeight(FontWeight.Medium).fontColor(ThemeColors.TEXT_PRIMARY)
        Text(desc).fontSize(13).fontColor(ThemeColors.TEXT_SECONDARY).lineHeight(18)
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
    }
    .width('100%')
    .padding({ top: 8, bottom: 8 })
  }

  @Builder TipsCard() {
    Column({ space: 12 }) {
      Row({ space: 6 }) {
        Image($r('app.media.Twinkles')).width(18).height(18)
        Text('ä½¿ç”¨æŠ€å·§').fontSize(16).fontWeight(FontWeight.Medium).fontColor(ThemeColors.TEXT_PRIMARY)
      }

      Column({ space: 8 }) {
        this.TipItem(this.recipe.usage.firstCast || 'å‰å‡ ç«¿å¯é€‚å½“åŠ å¤§é¥µå›¢ï¼Œå¿«é€Ÿè¯±é±¼')
        this.TipItem(this.recipe.usage.nestSuggestion || 'å¯é…åˆæ•£ç‚®æ‰“çªï¼Œæ•ˆæœæ›´ä½³')
        this.TipItem('æ ¹æ®é±¼å£è°ƒæ•´é¥µæ–™è½¯ç¡¬åº¦')
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FFF9F0')
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder TipItem(text: string) {
    Row({ space: 8 }) {
      Text('â€¢').fontSize(14).fontColor(ThemeColors.PRIMARY)
      Text(text).fontSize(13).fontColor(ThemeColors.TEXT_SECONDARY).layoutWeight(1)
    }.width('100%')
  }

  @Builder NotesCard() {
    Column({ space: 12 }) {
      Row({ space: 6 }) {
        Image($r('app.media.Temperature')).width(18).height(18)
        Text('å¤‡æ³¨').fontSize(16).fontWeight(FontWeight.Medium).fontColor(ThemeColors.TEXT_PRIMARY)
      }

      Text(this.getNotesText())
        .fontSize(13)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .lineHeight(20)
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder ActionButtons() {
    Row({ space: 12 }) {
      Button('æ¢ä¸€æ¢')
        .fontSize(14)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .backgroundColor('#F5F5F5')
        .borderRadius(24)
        .layoutWeight(1)
        .height(48)
        .onClick(() => {
          this.regenerateRecipe();
        })

      Button(this.isSaved ? 'å·²ä¿å­˜' : 'ä¿å­˜é…æ–¹')
        .fontSize(14)
        .fontColor(Color.White)
        .backgroundColor(this.isSaved ? '#AAAAAA' : ThemeColors.PRIMARY)
        .borderRadius(24)
        .layoutWeight(1)
        .height(48)
        .onClick(() => {
          if (!this.isSaved) {
            this.saveRecipeToUserData();
          }
        })
    }
    .width('100%')
    .padding({ left: 20, right: 20, top: 24 })
  }

  // æ¢ä¸€æ¢ï¼šé‡æ–°ç”Ÿæˆé…æ–¹
  private async regenerateRecipe(): Promise<void> {
    try {
      // è·å–å½“å‰å¤©æ°”æ¸©åº¦
      let temperature = this.recipe.conditions.temperature || 20;
      try {
        const weather = await fetchWeather();
        if (weather.isValid) {
          temperature = Math.round(weather.temperature);
        }
      } catch (e) {
        console.error('Fetch weather failed:', e);
      }

      // æ„å»ºè¾“å…¥å‚æ•°
      const input = new GenerateRecipeInput();
      input.targetFishId = this.recipe.conditions.targetFishId || 'crucian';
      input.waterType = this.recipe.conditions.waterType || 'pond';
      input.temperature = temperature;
      input.season = this.recipe.conditions.season || getCurrentSeason();

      // éšæœºå˜åŒ–å‚æ•°ä»¥è·å¾—ä¸åŒé…æ–¹
      const randomDensity = Math.floor(Math.random() * 3);
      if (randomDensity === 0) {
        input.fishDensity = 'low';
      } else if (randomDensity === 1) {
        input.fishDensity = 'medium';
      } else {
        input.fishDensity = 'high';
      }

      const randomActivity = Math.floor(Math.random() * 3);
      if (randomActivity === 0) {
        input.fishActivity = 'poor';
      } else if (randomActivity === 1) {
        input.fishActivity = 'normal';
      } else {
        input.fishActivity = 'good';
      }

      const randomMethod = Math.floor(Math.random() * 4);
      if (randomMethod === 0) {
        input.fishingMethod = 'rub';
      } else if (randomMethod === 1) {
        input.fishingMethod = 'pull';
      } else if (randomMethod === 2) {
        input.fishingMethod = 'scatter';
      } else {
        input.fishingMethod = 'wrap';
      }

      const randomMode = Math.floor(Math.random() * 3);
      if (randomMode === 0) {
        input.mode = 'conservative';
      } else if (randomMode === 1) {
        input.mode = 'balanced';
      } else {
        input.mode = 'aggressive';
      }

      // æ¸©åº¦ä¹Ÿå¯ä»¥å°å¹…æ³¢åŠ¨
      input.temperature = temperature + Math.floor(Math.random() * 6) - 3;

      // ç”Ÿæˆæ–°é…æ–¹
      const newRecipe = generateRecipe(input);
      this.recipe = newRecipe;
      this.isSaved = false;

      // ä¿å­˜åˆ°å†å²
      this.saveToHistory();

      promptAction.showToast({ message: 'å·²ä¸ºæ‚¨æ¢ä¸€ä¸ªé…æ–¹', duration: 1500 });
    } catch (err) {
      console.error('Regenerate recipe failed:', err);
      promptAction.showToast({ message: 'ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•', duration: 1500 });
    }
  }

  // ä¿å­˜é…æ–¹åˆ°ç”¨æˆ·æ•°æ®
  private async saveRecipeToUserData(): Promise<void> {
    try {
      await userDataService.load();

      // è½¬æ¢é…æ–™æ ¼å¼
      const ingredients: CustomRecipeIngredient[] = [];
      for (let i = 0; i < this.recipe.ingredients.length; i++) {
        const ing = this.recipe.ingredients[i];
        const customIng = new CustomRecipeIngredient();
        customIng.ingredientId = ing.id;
        customIng.name = ing.name;
        customIng.ratio = ing.percentage;
        ingredients.push(customIng);
      }

      // æ„å»ºæ­¥éª¤
      const steps: string[] = [
        `æŒ‰é…æ–¹æ¯”ä¾‹å‡†å¤‡å¥½æ‰€æœ‰åŸæ–™ï¼Œæ€»é‡${this.recipe.totalWeight}g`,
        'å°†æ‰€æœ‰å¹²æ–™å€’å…¥ç›†ä¸­ï¼Œå……åˆ†æ…æ‹Œå‡åŒ€',
        `æŒ‰${this.recipe.usage.waterRatio}æ¯”ä¾‹åŠ æ°´ï¼Œå¿«é€Ÿæ…æ‹Œ`,
        `é™ç½®${this.recipe.usage.restTime}ï¼Œè®©é¥µæ–™å……åˆ†å¸æ°´`,
        'æ ¹æ®éœ€è¦é€‚å½“æ‰“æ‰ï¼Œè°ƒæ•´è½¯ç¡¬åº¦'
      ];

      // æ„å»ºæŠ€å·§
      const tips = `${this.recipe.usage.firstCast || 'å‰å‡ ç«¿å¯é€‚å½“åŠ å¤§é¥µå›¢ï¼Œå¿«é€Ÿè¯±é±¼'}ï¼›${this.recipe.usage.nestSuggestion || 'å¯é…åˆæ•£ç‚®æ‰“çªï¼Œæ•ˆæœæ›´ä½³'}`;

      // ä¿å­˜é…æ–¹
      await userDataService.addRecipe(
        this.recipe.name,
        [this.recipe.conditions.targetFishId],
        this.recipe.conditions.waterType,
        this.recipe.conditions.season,
        ingredients,
        steps,
        tips
      );

      this.isSaved = true;
      this.isFavorite = true;
      promptAction.showToast({ message: 'é…æ–¹å·²ä¿å­˜', duration: 1500 });
    } catch (err) {
      console.error('Save recipe failed:', err);
      promptAction.showToast({ message: 'ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', duration: 1500 });
    }
  }

  // ========== è¾…åŠ©æ–¹æ³• ==========
  private getRecipeDescription(): string {
    const fish = this.getFishName();
    const water = this.getWaterName();
    const season = this.getSeasonName();
    return `ä¸“ä¸º${season}${water}é’“${fish}è®¾è®¡ï¼Œ${this.recipe.flavorProfile.primary}${this.recipe.flavorProfile.secondary}å‘³å‹ï¼Œé€‚åˆ${this.recipe.flavorProfile.suitableTemp || '15-25Â°C'}æ°´æ¸©ä½¿ç”¨ã€‚`;
  }

  private getDifficultyText(): string {
    const count = this.recipe.ingredients.length;
    if (count <= 3) return 'ç®€å•';
    if (count <= 5) return 'ä¸­ç­‰';
    return 'å¤æ‚';
  }

  private getFishName(): string {
    const fishId = this.recipe.conditions.targetFishId;
    if (fishId === 'crucian') return 'é²«é±¼';
    if (fishId === 'carp') return 'é²¤é±¼';
    if (fishId === 'grass') return 'è‰é±¼';
    if (fishId === 'black') return 'é’é±¼';
    if (fishId === 'catfish') return 'é²¶é±¼';
    return 'ç›®æ ‡é±¼';
  }

  private getWaterName(): string {
    const waterType = this.recipe.conditions.waterType;
    if (waterType === 'river') return 'é‡æ²³';
    if (waterType === 'pond') return 'é»‘å‘';
    if (waterType === 'reservoir') return 'æ°´åº“';
    if (waterType === 'wild_pond') return 'é‡å¡˜';
    return '';
  }

  private getSeasonName(): string {
    const season = this.recipe.conditions.season;
    if (season === 'spring') return 'æ˜¥å­£';
    if (season === 'summer') return 'å¤å­£';
    if (season === 'autumn') return 'ç§‹å­£';
    if (season === 'winter') return 'å†¬å­£';
    return '';
  }

  private getCategoryName(cat: string): string {
    if (cat === 'main') return 'ä¸»é¥µ';
    if (cat === 'auxiliary') return 'è¾…é¥µ';
    if (cat === 'state') return 'çŠ¶æ€é¥µ';
    if (cat === 'additive') return 'æ·»åŠ å‰‚';
    return '';
  }

  private getIngredientIcon(cat: string): string {
    if (cat === 'main') return 'ğŸŒ¾';
    if (cat === 'auxiliary') return 'ğŸ¥œ';
    if (cat === 'state') return 'ğŸ’§';
    if (cat === 'additive') return 'âœ¨';
    return 'ğŸ“¦';
  }

  private getIngredientBgColor(cat: string): string {
    if (cat === 'main') return '#FFF3E0';
    if (cat === 'auxiliary') return '#E8F5E9';
    if (cat === 'state') return '#E3F2FD';
    if (cat === 'additive') return '#FCE4EC';
    return '#F5F5F5';
  }

  private getNotesText(): string {
    const temp = this.recipe.conditions.temperature;
    let note = `å½“å‰æ°”æ¸©${temp}Â°Cï¼Œ`;
    if (temp < 15) {
      note += 'æ°´æ¸©è¾ƒä½ï¼Œå»ºè®®é€‚å½“å¢åŠ è…¥å‘³æ¯”ä¾‹ï¼Œé¥µæ–™çŠ¶æ€åè½¯ç²˜ã€‚';
    } else if (temp > 28) {
      note += 'æ°´æ¸©è¾ƒé«˜ï¼Œå»ºè®®æ¸…æ·¡ä¸ºä¸»ï¼Œå¯é€‚å½“åŠ å…¥æœé…¸ç±»æ·»åŠ å‰‚ã€‚';
    } else {
      note += 'æ¸©åº¦é€‚å®œï¼ŒæŒ‰é…æ–¹æ­£å¸¸ä½¿ç”¨å³å¯ã€‚';
    }
    return note + '\n\nå¦‚é‡é±¼å£ä¸ä½³ï¼Œå¯å°è¯•è°ƒæ•´æ°´æ¯”æˆ–æ·»åŠ å°è¯ã€‚';
  }
}
