/**
 * é¥µçŸ¥é?- æ”¶è—é¡µé¢
 * å±•ç¤ºç”¨æˆ·æ”¶è—çš„é…æ–?
 */
import { ThemeColors } from '../theme/ThemeColors';
import { ThemeConstants } from '../theme/ThemeConstants';
import { Router } from '../router/Router';
import { userDataService, CustomRecipe } from '../services/UserDataService';
import { router } from '@kit.ArkUI';

// æ”¶è—é…æ–¹æ¥å£
class FavoriteRecipe {
  id: string = '';
  name: string = '';
  targetFish: string = '';
  rating: number = 4.5;
  usageCount: number = 0;
  addTime: string = '';
  isUserRecipe: boolean = false;
}

// é¢„è®¾é…æ–¹ç®€è¦ä¿¡æ¯ï¼ˆç”¨äºæ˜¾ç¤ºæ”¶è—çš„é¢„è®¾é…æ–¹ï¼‰
class PresetRecipeInfo {
  id: string = '';
  name: string = '';
  targetFish: string = '';
  rating: number = 4.5;

  constructor(id: string, name: string, fish: string, rating: number) {
    this.id = id;
    this.name = name;
    this.targetFish = fish;
    this.rating = rating;
  }
}

// é¢„è®¾é…æ–¹æ•°æ®åº“ï¼ˆç®€åŒ–ç‰ˆï¼Œç”¨äºæ”¶è—é¡µæ˜¾ç¤ºï¼?
const PRESET_RECIPES: Map<string, PresetRecipeInfo> = new Map([
  // æ± å¡˜
  ['r_001', new PresetRecipeInfo('r_001', 'æ± å¡˜é²«é±¼æ•£ç‚®', 'é²«é±¼', 4.6)],
  ['r_002', new PresetRecipeInfo('r_002', 'é»‘å‘é²¤é±¼é¢—ç²’', 'é²¤é±¼', 4.8)],
  ['r_003', new PresetRecipeInfo('r_003', 'æ± å¡˜è‰é±¼é’è‰é¥?, 'è‰é±¼', 4.5)],
  ['r_004', new PresetRecipeInfo('r_004', 'æ± å¡˜é³™é±¼é…¸è‡­é¥?, 'é³™é±¼', 4.6)],
  ['r_005', new PresetRecipeInfo('r_005', 'æ± å¡˜é²¢é±¼é…¸é¥µ', 'é²¢é±¼', 4.5)],
  ['r_006', new PresetRecipeInfo('r_006', 'å—æ–¹ç½—éä¸“ç”¨é¥?, 'ç½—éé±?, 4.4)],
  ['r_007', new PresetRecipeInfo('r_007', 'é»‘å‘å‰å°¾ä¸“ç”¨é¥?, 'æ–‘ç‚¹å‰å°¾é®?, 4.5)],
  ['r_008', new PresetRecipeInfo('r_008', 'æ± å¡˜é²¶é±¼è…¥é¥µ', 'é²¶é±¼', 4.6)],
  // æ²³æµ
  ['r_101', new PresetRecipeInfo('r_101', 'é‡æ²³é²«é±¼èš¯èš“ä¼´ä¾£', 'é²«é±¼', 4.7)],
  ['r_102', new PresetRecipeInfo('r_102', 'æ±Ÿæ²³é²¤é±¼ç‰ç±³é¥?, 'é²¤é±¼', 4.8)],
  ['r_103', new PresetRecipeInfo('r_103', 'æ²³æµè‰é±¼å«©è‰é¥?, 'è‰é±¼', 4.6)],
  ['r_105', new PresetRecipeInfo('r_105', 'æ²³æµé»„é¢¡é±¼é¥µ', 'é»„é¢¡é±?, 4.5)],
  ['r_106', new PresetRecipeInfo('r_106', 'æ²³æµé³Šé±¼ç´ é¥µ', 'é³Šé±¼', 4.5)],
  ['r_107', new PresetRecipeInfo('r_107', 'æ²³æµç¿˜å˜´è·¯äºšé¥?, 'ç¿˜å˜´', 4.7)],
  // æ°´åº“
  ['r_201', new PresetRecipeInfo('r_201', 'æ°´åº“å¤§é²¤å®ˆé’“é¥?, 'é²¤é±¼', 4.9)],
  ['r_202', new PresetRecipeInfo('r_202', 'æ°´åº“è‰é±¼æµ®é’“é¥?, 'è‰é±¼', 4.7)],
  ['r_205', new PresetRecipeInfo('r_205', 'æ°´åº“é’é±¼èºè›³é¥?, 'é’é±¼', 4.8)],
  ['r_206', new PresetRecipeInfo('r_206', 'æ°´åº“é³œé±¼æ´»é¥µ', 'é³œé±¼', 4.9)],
  ['r_207', new PresetRecipeInfo('r_207', 'æ°´åº“æ­¦æ˜Œé±¼ç´ é¥?, 'æ­¦æ˜Œé±?, 4.5)],
  ['r_210', new PresetRecipeInfo('r_210', 'å—æ–¹é²®é±¼ä¸“ç”¨é¥?, 'é²®é±¼', 4.6)],
  // æ¹–æ³Š
  ['r_301', new PresetRecipeInfo('r_301', 'æ¹–æ³Šé²«é±¼ä¼ ç»Ÿé’?, 'é²«é±¼', 4.7)],
  ['r_302', new PresetRecipeInfo('r_302', 'æ¹–æ³Šé²¤é±¼çˆ†ç‚¸é’?, 'é²¤é±¼', 4.8)],
  ['r_304', new PresetRecipeInfo('r_304', 'æ¹–æ³Šé³œé±¼æ´»é¥µ', 'é³œé±¼', 4.9)],
  ['r_305', new PresetRecipeInfo('r_305', 'æ¹–æ³Šé’é±¼èºè›³é¥?, 'é’é±¼', 4.8)],
  ['r_306', new PresetRecipeInfo('r_306', 'æ¹–æ³Šé»‘é±¼é›·è›™', 'é»‘é±¼', 4.7)],
  ['r_315', new PresetRecipeInfo('r_315', 'æ¹–æ³Šé³Šé±¼ç´ é¥µ', 'é³Šé±¼', 4.5)]
]);

@Entry
@Component
struct FavoritePage {
  @State favorites: FavoriteRecipe[] = [];
  @State isLoading: boolean = true;

  aboutToAppear(): void {
    this.loadFavorites();
  }

  onPageShow(): void {
    this.loadFavorites();
  }

  private async loadFavorites(): Promise<void> {
    this.isLoading = true;
    await userDataService.load(true);

    const favoriteIds = userDataService.getFavoriteRecipes();
    const userRecipes = userDataService.getCustomRecipes();
    const result: FavoriteRecipe[] = [];

    // éå†æ”¶è—IDåˆ—è¡¨
    for (let i = 0; i < favoriteIds.length; i++) {
      const id = favoriteIds[i];
      
      // æ£€æŸ¥æ˜¯å¦æ˜¯é¢„è®¾é…æ–¹
      const preset = PRESET_RECIPES.get(id);
      if (preset) {
        const fav = new FavoriteRecipe();
        fav.id = preset.id;
        fav.name = preset.name;
        fav.targetFish = preset.targetFish;
        fav.rating = preset.rating;
        fav.usageCount = Math.floor(Math.random() * 10);
        fav.addTime = this.formatDate(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000);
        fav.isUserRecipe = false;
        result.push(fav);
        continue;
      }

      // æ£€æŸ¥æ˜¯å¦æ˜¯ç”¨æˆ·é…æ–¹
      for (let j = 0; j < userRecipes.length; j++) {
        const ur = userRecipes[j];
        if (ur.id === id) {
          const fav = new FavoriteRecipe();
          fav.id = ur.id;
          fav.name = ur.name;
          fav.targetFish = this.getFishName(ur.targetFish);
          fav.rating = 4.5;
          fav.usageCount = 0;
          fav.addTime = this.formatDate(ur.createdAt);
          fav.isUserRecipe = true;
          result.push(fav);
          break;
        }
      }
    }

    this.favorites = result;
    this.isLoading = false;
  }

  // æ ¼å¼åŒ–æ—¥æœ?
  private formatDate(timestamp: number): string {
    const date = new Date(timestamp);
    return `${date.getMonth() + 1}æœ?{date.getDate()}æ—¥`;
  }

  // è·å–é±¼ç§åç§°
  private getFishName(fishIds: string[]): string {
    if (fishIds.length === 0) return 'ç»¼åˆ';
    const fishMap: Map<string, string> = new Map([
      ['crucian', 'é²«é±¼'], ['carp', 'é²¤é±¼'], ['grass', 'è‰é±¼'],
      ['black_carp', 'é’é±¼'], ['catfish', 'é²¶é±¼'], ['bighead', 'é³™é±¼'],
      ['silver', 'é²¢é±¼'], ['tilapia', 'ç½—éé±?], ['grass_carp', 'è‰é±¼'],
      ['silver_carp', 'é²¢é±¼'], ['bighead_carp', 'é³™é±¼'], ['yellow_catfish', 'é»„é¢¡é±?],
      ['mandarin_fish', 'é³œé±¼'], ['snakehead', 'é»‘é±¼'], ['bream', 'é³Šé±¼'],
      ['topmouth_culter', 'ç¿˜å˜´']
    ]);
    const name = fishMap.get(fishIds[0]);
    return name !== undefined ? name : fishIds[0];
  }

  build() {
    Column() {
      this.HeaderBar()

      if (this.isLoading) {
        Column() {
          LoadingProgress().width(40).height(40)
          Text('åŠ è½½ä¸?..').fontSize(14).fontColor(ThemeColors.TEXT_SECONDARY).margin({ top: 12 })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      } else if (this.favorites.length === 0) {
        this.EmptyState()
      } else {
        Scroll() {
          Column({ space: ThemeConstants.SPACE_SM }) {
            ForEach(this.favorites, (item: FavoriteRecipe) => {
              this.FavoriteCard(item)
            })
          }
          .padding({ left: ThemeConstants.SPACE_MD, right: ThemeConstants.SPACE_MD, top: 16, bottom: 40 })
        }
        .layoutWeight(1)
        .scrollBar(BarState.Off)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(ThemeColors.BG_PRIMARY)
  }

  @Builder
  HeaderBar() {
    Row() {
      Image($r('app.media.Left'))
        .width(24)
        .height(24)
        .fillColor(ThemeColors.TEXT_PRIMARY)
        .onClick(() => Router.back())

      Blank()

      Text('æˆ‘çš„æ”¶è—')
        .fontSize(ThemeConstants.FONT_SIZE_LG)
        .fontWeight(FontWeight.Medium)
        .fontColor(ThemeColors.TEXT_PRIMARY)

      Blank()

      Row().width(24)
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16, top: 40 })
  }

  @Builder
  EmptyState() {
    Column({ space: ThemeConstants.SPACE_MD }) {
      Text('ğŸ“¦')
        .fontSize(60)
      Text('æš‚æ— æ”¶è—')
        .fontSize(ThemeConstants.FONT_SIZE_MD)
        .fontColor(ThemeColors.TEXT_SECONDARY)
      Text('æµè§ˆé…æ–¹åº“ï¼Œç‚¹å‡»çˆ±å¿ƒæ”¶è—å–œæ¬¢çš„é…æ–?)
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_MUTED)
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
  }

  @Builder
  FavoriteCard(item: FavoriteRecipe) {
    Row({ space: ThemeConstants.SPACE_MD }) {
      // å·¦ä¾§å›¾æ ‡
      Column() {
        Image($r('app.media.hook'))
          .width(32)
          .height(32)
      }
      .width(56)
      .height(56)
      .backgroundColor(item.isUserRecipe ? 'rgba(232, 168, 73, 0.15)' : ThemeColors.BG_TERTIARY)
      .borderRadius(ThemeConstants.RADIUS_SM)
      .justifyContent(FlexAlign.Center)

      // ä¸­é—´ä¿¡æ¯
      Column({ space: 4 }) {
        Row({ space: 6 }) {
          Text(item.name)
            .fontSize(ThemeConstants.FONT_SIZE_MD)
            .fontWeight(FontWeight.Medium)
            .fontColor(ThemeColors.TEXT_PRIMARY)
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .layoutWeight(1)

          if (item.isUserRecipe) {
            Text('æˆ‘çš„')
              .fontSize(10)
              .fontColor(ThemeColors.PRIMARY_DARK)
              .padding({ left: 6, right: 6, top: 2, bottom: 2 })
              .backgroundColor('rgba(232, 168, 73, 0.15)')
              .borderRadius(4)
          }
        }
        .width('100%')

        Row({ space: ThemeConstants.SPACE_SM }) {
          Text(`ğŸŸ ${item.targetFish}`)
            .fontSize(ThemeConstants.FONT_SIZE_XS)
            .fontColor(ThemeColors.TEXT_SECONDARY)
          Text(`â­?${item.rating.toFixed(1)}`)
            .fontSize(ThemeConstants.FONT_SIZE_XS)
            .fontColor(ThemeColors.PRIMARY_DARK)
        }

        Text(`${item.addTime}æ”¶è—`)
          .fontSize(ThemeConstants.FONT_SIZE_XS)
          .fontColor(ThemeColors.TEXT_MUTED)
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      // å³ä¾§ç®­å¤´
      Text('>')
        .fontSize(ThemeConstants.FONT_SIZE_MD)
        .fontColor(ThemeColors.TEXT_MUTED)
    }
    .width('100%')
    .padding(ThemeConstants.SPACE_MD)
    .backgroundColor(ThemeColors.BG_CARD)
    .borderRadius(ThemeConstants.RADIUS_MD)
    .onClick(() => {
      router.pushUrl({
        url: 'pages/RecipeDetailPage',
        params: { recipeId: item.id }
      });
    })
  }
}
