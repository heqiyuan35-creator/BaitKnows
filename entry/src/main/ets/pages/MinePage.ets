/**
 * é¥µçŸ¥é?- æˆ‘çš„é¡µé¢
 * ç”¨æˆ·ä¿¡æ¯ã€ç­‰çº§ç³»ç»Ÿã€åŠŸèƒ½å…¥å?
 */
import { ThemeColors } from '../theme/ThemeColors';
import { ThemeConstants } from '../theme/ThemeConstants';
import { Router, RouteParams } from '../router/Router';
import { AppConstants } from '../common/constants/AppConstants';
import { router, promptAction } from '@kit.ArkUI';
import { UserProfile, LEVEL_CONFIGS } from '../common/types/UserTypes';
import { userService } from '../services/UserService';
import { userDataService } from '../services/UserDataService';
import { fishingRecordService } from '../services/FishingRecordService';

// èœå•é¡¹æ¥å?
interface MenuItem {
  icon: Resource;
  title: string;
  subtitle: string;
  route: string;
}

@Component
export struct MinePage {
  @Prop @Watch('onRefreshTriggerChange') refreshTrigger: number = 0;
  @State profile: UserProfile = new UserProfile();
  @State levelProgress: number = 0;
  @State nextLevelExp: number = 100;
  @State isLoading: boolean = true;
  @State cacheSize: string = '12.5 MB';

  private menuItems: MenuItem[] = [
    { icon: $r('app.media.Recipe'), title: 'æˆ‘çš„æ”¶è—', subtitle: 'æ”¶è—çš„é…æ–?, route: AppConstants.ROUTE_FAVORITE },
    { icon: $r('app.media.time'), title: 'ç”Ÿæˆå†å²', subtitle: 'é…æ–¹ç”Ÿæˆè®°å½•', route: AppConstants.ROUTE_GENERATOR_HISTORY }
  ];

  aboutToAppear(): void {
    this.loadUserData();
  }

  // é¡µé¢æ˜¾ç¤ºæ—¶åˆ·æ–°æ•°æ®ï¼ˆä»å…¶ä»–é¡µé¢è¿”å›æ—¶ï¼?
  onPageShow(): void {
    this.loadUserData();
  }

  // ç›‘å¬åˆ·æ–°è§¦å‘å™¨å˜åŒ?
  onRefreshTriggerChange(): void {
    this.loadUserData();
  }

  private async loadUserData(): Promise<void> {
    this.isLoading = true;
    await userService.load();
    await userDataService.load();
    
    // åŒæ­¥æ”¶è—æ•°é‡
    const favoriteCount = userDataService.getFavoriteRecipes().length;
    if (userService.profile.favoriteCount !== favoriteCount) {
      await userService.updateFavoriteCount(favoriteCount);
    }
    
    this.profile = userService.profile;
    this.levelProgress = userService.getLevelProgress();

    // è®¡ç®—ä¸‹ä¸€ç­‰çº§æ‰€éœ€ç»éªŒ
    const currentConfig = userService.getLevelConfig(this.profile.experience);
    this.nextLevelExp = currentConfig.maxExp;

    this.isLoading = false;
  }

  private getLevelIcon(): string {
    const config = LEVEL_CONFIGS.find(c => c.level === this.profile.level);
    return config?.icon || 'ğŸ£';
  }

  build() {
    Column() {
      // é¡¶éƒ¨ç”¨æˆ·ä¿¡æ¯åŒ?
      this.UserHeader()

      Scroll() {
        Column({ space: ThemeConstants.SPACE_MD }) {
          // ç­‰çº§å¡ç‰‡
          this.LevelCard()

          // ç»Ÿè®¡å¡ç‰‡
          this.StatsRow()

          // åŠŸèƒ½èœå•
          this.MenuSection()

          // æ•°æ®ç®¡ç†
          this.DataSection()

          // å…³äºåº”ç”¨
          this.AboutSection()
        }
        .padding({ bottom: 100 })
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(ThemeColors.BG_PRIMARY)
  }

  @Builder
  UserHeader() {
    Column({ space: ThemeConstants.SPACE_SM }) {
      // å¤´åƒ
      Row() {
        Text(this.getLevelIcon())
          .fontSize(40)
      }
      .width(80)
      .height(80)
      .backgroundColor(ThemeColors.BG_CARD)
      .borderRadius(40)
      .justifyContent(FlexAlign.Center)
      .border({ width: 3, color: ThemeColors.PRIMARY })

      // æ˜µç§°
      Text(this.profile.nickname)
        .fontSize(ThemeConstants.FONT_SIZE_XL)
        .fontWeight(FontWeight.Bold)
        .fontColor(ThemeColors.TEXT_PRIMARY)

      // ç­‰çº§ç§°å·
      Row({ space: 6 }) {
        Text(this.profile.levelTitle)
          .fontSize(ThemeConstants.FONT_SIZE_SM)
          .fontColor(ThemeColors.PRIMARY_DARK)
          .padding({ left: 8, right: 8, top: 2, bottom: 2 })
          .backgroundColor('rgba(232, 168, 73, 0.2)')
          .borderRadius(4)
      }
    }
    .width('100%')
    .padding({ top: 60, bottom: ThemeConstants.SPACE_MD })
    .alignItems(HorizontalAlign.Center)
  }

  @Builder
  LevelCard() {
    Column({ space: 12 }) {
      Row() {
        Column({ space: 2 }) {
          Text('ç­‰çº§è¿›åº¦')
            .fontSize(ThemeConstants.FONT_SIZE_MD)
            .fontWeight(FontWeight.Medium)
            .fontColor(ThemeColors.TEXT_PRIMARY)
          Text(`è·ç¦»ä¸‹ä¸€ç­‰çº§è¿˜éœ€ ${Math.max(0, this.nextLevelExp - this.profile.experience)} ç»éªŒ`)
            .fontSize(ThemeConstants.FONT_SIZE_XS)
            .fontColor(ThemeColors.TEXT_MUTED)
        }
        .alignItems(HorizontalAlign.Start)

        Blank()

        Text(`${this.profile.experience}`)
          .fontSize(ThemeConstants.FONT_SIZE_2XL)
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeColors.PRIMARY_DARK)
      }
      .width('100%')

      // è¿›åº¦æ?
      Stack({ alignContent: Alignment.Start }) {
        Row()
          .width('100%')
          .height(10)
          .backgroundColor(ThemeColors.BG_TERTIARY)
          .borderRadius(5)

        Row()
          .width(`${this.levelProgress}%`)
          .height(10)
          .linearGradient({
            direction: GradientDirection.Right,
            colors: [[ThemeColors.PRIMARY, 0], [ThemeColors.GRADIENT_PRIMARY_END, 1]]
          })
          .borderRadius(5)
      }
      .width('100%')

      // ç­‰çº§å›¾æ ‡è¯´æ˜
      Row({ space: 4 }) {
        ForEach(['ğŸ£', 'ğŸŸ', 'ğŸ ', 'ğŸ¦ˆ', 'ğŸ‘‘'], (icon: string, index: number) => {
          Column({ space: 2 }) {
            Text(icon)
              .fontSize(index < this.profile.level ? 18 : 14)
              .opacity(index < this.profile.level ? 1 : 0.4)
          }
          .layoutWeight(1)
        })
      }
      .width('100%')
      .margin({ top: 4 })
    }
    .width('100%')
    .padding(ThemeConstants.SPACE_MD)
    .margin({ left: ThemeConstants.SPACE_MD, right: ThemeConstants.SPACE_MD })
    .backgroundColor(ThemeColors.BG_CARD)
    .borderRadius(ThemeConstants.RADIUS_MD)
    .shadow({ radius: 8, color: 'rgba(0,0,0,0.05)', offsetY: 2 })
  }

  @Builder
  StatsRow() {
    Row({ space: ThemeConstants.SPACE_SM }) {
      this.StatItem('æ€»æ¸”è?, `${this.profile.totalCatch.toFixed(1)}`, 'kg')
      this.StatItem('å‡ºé’“æ¬¡æ•°', `${this.profile.totalTrips}`, 'æ¬?)
      this.StatItem('æˆ‘çš„æ”¶è—', `${this.profile.favoriteCount}`, 'ä¸?)
    }
    .width('100%')
    .padding({ left: ThemeConstants.SPACE_MD, right: ThemeConstants.SPACE_MD })
  }

  @Builder
  StatItem(label: string, value: string, unit: string) {
    Column({ space: 4 }) {
      Row() {
        Text(value)
          .fontSize(ThemeConstants.FONT_SIZE_2XL)
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeColors.PRIMARY_DARK)
        Text(unit)
          .fontSize(ThemeConstants.FONT_SIZE_SM)
          .fontColor(ThemeColors.TEXT_SECONDARY)
          .margin({ left: 2, top: 8 })
      }
      Text(label)
        .fontSize(ThemeConstants.FONT_SIZE_XS)
        .fontColor(ThemeColors.TEXT_SECONDARY)
    }
    .layoutWeight(1)
    .padding({ top: 16, bottom: 16 })
    .backgroundColor(ThemeColors.BG_CARD)
    .borderRadius(ThemeConstants.RADIUS_SM)
    .alignItems(HorizontalAlign.Center)
  }

  @Builder
  MenuSection() {
    Column({ space: 1 }) {
      ForEach(this.menuItems, (item: MenuItem, index: number) => {
        this.MenuItemRow(item, index === 0, index === this.menuItems.length - 1)
      })
    }
    .margin({ left: ThemeConstants.SPACE_MD, right: ThemeConstants.SPACE_MD })
    .borderRadius(ThemeConstants.RADIUS_MD)
    .clip(true)
  }

  @Builder
  MenuItemRow(item: MenuItem, isFirst: boolean, isLast: boolean) {
    Row() {
      Image(item.icon)
        .width(24)
        .height(24)
        .fillColor(ThemeColors.PRIMARY)

      Column({ space: 2 }) {
        Text(item.title)
          .fontSize(ThemeConstants.FONT_SIZE_MD)
          .fontColor(ThemeColors.TEXT_PRIMARY)
        Text(item.subtitle)
          .fontSize(ThemeConstants.FONT_SIZE_XS)
          .fontColor(ThemeColors.TEXT_SECONDARY)
      }
      .alignItems(HorizontalAlign.Start)
      .margin({ left: ThemeConstants.SPACE_MD })

      Blank()

      Text('>')
        .fontSize(ThemeConstants.FONT_SIZE_MD)
        .fontColor(ThemeColors.TEXT_MUTED)
    }
    .width('100%')
    .height(64)
    .padding({ left: ThemeConstants.SPACE_MD, right: ThemeConstants.SPACE_MD })
    .backgroundColor(ThemeColors.BG_CARD)
    .onClick(() => {
      Router.push(item.route);
    })
  }

  @Builder
  AboutSection() {
    Column({ space: 1 }) {
      // ç‰ˆæœ¬
      Row() {
        Text('ç‰ˆæœ¬')
          .fontSize(ThemeConstants.FONT_SIZE_MD)
          .fontColor(ThemeColors.TEXT_PRIMARY)
        Blank()
        Text(AppConstants.APP_VERSION)
          .fontSize(ThemeConstants.FONT_SIZE_MD)
          .fontColor(ThemeColors.TEXT_SECONDARY)
      }
      .width('100%')
      .height(52)
      .padding({ left: ThemeConstants.SPACE_MD, right: ThemeConstants.SPACE_MD })
      .backgroundColor(ThemeColors.BG_CARD)

      // éšç§æ”¿ç­–
      Row() {
        Text('éšç§æ”¿ç­–')
          .fontSize(ThemeConstants.FONT_SIZE_MD)
          .fontColor(ThemeColors.TEXT_PRIMARY)
        Blank()
        Text('>')
          .fontSize(ThemeConstants.FONT_SIZE_MD)
          .fontColor(ThemeColors.TEXT_MUTED)
      }
      .width('100%')
      .height(52)
      .padding({ left: ThemeConstants.SPACE_MD, right: ThemeConstants.SPACE_MD })
      .backgroundColor(ThemeColors.BG_CARD)
      .onClick(() => {
        const params = new RouteParams();
        params.title = 'éšç§æ”¿ç­–';
        params.type = 'privacy';
        Router.push('pages/AgreementPage', params);
      })

      // ç”¨æˆ·åè®®
      Row() {
        Text('ç”¨æˆ·åè®®')
          .fontSize(ThemeConstants.FONT_SIZE_MD)
          .fontColor(ThemeColors.TEXT_PRIMARY)
        Blank()
        Text('>')
          .fontSize(ThemeConstants.FONT_SIZE_MD)
          .fontColor(ThemeColors.TEXT_MUTED)
      }
      .width('100%')
      .height(52)
      .padding({ left: ThemeConstants.SPACE_MD, right: ThemeConstants.SPACE_MD })
      .backgroundColor(ThemeColors.BG_CARD)
      .onClick(() => {
        const params = new RouteParams();
        params.title = 'ç”¨æˆ·åè®®';
        params.type = 'agreement';
        Router.push('pages/AgreementPage', params);
      })
    }
    .margin({ left: ThemeConstants.SPACE_MD, right: ThemeConstants.SPACE_MD })
    .borderRadius(ThemeConstants.RADIUS_MD)
    .clip(true)

    // åº”ç”¨ä¿¡æ¯
    Column({ space: ThemeConstants.SPACE_SM }) {
      Text(AppConstants.APP_NAME)
        .fontSize(ThemeConstants.FONT_SIZE_MD)
        .fontWeight(FontWeight.Medium)
        .fontColor(ThemeColors.TEXT_PRIMARY)

      Text(AppConstants.APP_SLOGAN)
        .fontSize(ThemeConstants.FONT_SIZE_XS)
        .fontColor(ThemeColors.TEXT_MUTED)
    }
    .width('100%')
    .padding({ top: ThemeConstants.SPACE_LG })
    .alignItems(HorizontalAlign.Center)
  }

  @Builder
  DataSection() {
    Column({ space: 1 }) {
      // æ¸…é™¤ç¼“å­˜
      Row() {
        Column({ space: 2 }) {
          Text('æ¸…é™¤ç¼“å­˜')
            .fontSize(ThemeConstants.FONT_SIZE_MD)
            .fontColor(ThemeColors.TEXT_PRIMARY)
          Text(`å½“å‰ç¼“å­˜: ${this.cacheSize}`)
            .fontSize(ThemeConstants.FONT_SIZE_XS)
            .fontColor(ThemeColors.TEXT_SECONDARY)
        }
        .alignItems(HorizontalAlign.Start)

        Blank()

        Text('æ¸…é™¤')
          .fontSize(ThemeConstants.FONT_SIZE_SM)
          .fontColor(ThemeColors.PRIMARY_DARK)
      }
      .width('100%')
      .height(64)
      .padding({ left: ThemeConstants.SPACE_MD, right: ThemeConstants.SPACE_MD })
      .backgroundColor(ThemeColors.BG_CARD)
      .onClick(() => {
        this.cacheSize = '0 MB';
        promptAction.showToast({ message: 'ç¼“å­˜å·²æ¸…é™? });
      })

      // é‡ç½®æ•°æ®
      Row() {
        Column({ space: 2 }) {
          Text('é‡ç½®æ•°æ®')
            .fontSize(ThemeConstants.FONT_SIZE_MD)
            .fontColor(ThemeColors.ERROR)
          Text('æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ•°æ?)
            .fontSize(ThemeConstants.FONT_SIZE_XS)
            .fontColor(ThemeColors.TEXT_SECONDARY)
        }
        .alignItems(HorizontalAlign.Start)

        Blank()

        Text('>')
          .fontSize(ThemeConstants.FONT_SIZE_MD)
          .fontColor(ThemeColors.TEXT_MUTED)
      }
      .width('100%')
      .height(64)
      .padding({ left: ThemeConstants.SPACE_MD, right: ThemeConstants.SPACE_MD })
      .backgroundColor(ThemeColors.BG_CARD)
      .onClick(() => {
        promptAction.showDialog({
          title: 'ç¡®è®¤é‡ç½®',
          message: 'æ­¤æ“ä½œå°†æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®ï¼ŒåŒ…æ‹¬é…æ–¹ã€è®°å½•ã€æ”¶è—ç­‰ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ',
          buttons: [
            { text: 'å–æ¶ˆ', color: ThemeColors.TEXT_MUTED },
            { text: 'ç¡®è®¤é‡ç½®', color: ThemeColors.ERROR }
          ]
        }).then(async (result) => {
          if (result.index === 1) {
            // æ¸…é™¤æ‰€æœ‰æ•°æ?
            await userDataService.clearAllData();
            await fishingRecordService.clearAllRecords();
            await userService.resetProfile();
            
            // é‡æ–°åŠ è½½ç”¨æˆ·æ•°æ®
            await this.loadUserData();
            
            promptAction.showToast({ message: 'æ•°æ®å·²é‡ç½? });
          }
        });
      })
    }
    .margin({ left: ThemeConstants.SPACE_MD, right: ThemeConstants.SPACE_MD })
    .borderRadius(ThemeConstants.RADIUS_MD)
    .clip(true)
  }
}
