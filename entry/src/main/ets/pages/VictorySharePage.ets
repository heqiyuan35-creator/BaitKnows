/**
 * é¥µçŸ¥é“ - èƒœåˆ©ç»“ç®—å›¾é¡µé¢
 * ç”Ÿæˆç²¾ç¾çš„æ¸”è·åˆ†äº«å›¾
 * 
 * ä½¿ç”¨ SaveButton å®‰å…¨æ§ä»¶ä¿å­˜å›¾ç‰‡åˆ°ç›¸å†Œï¼Œæ— éœ€ç”³è¯·æƒé™
 */
import { ThemeColors } from '../theme/ThemeColors';
import { ThemeConstants } from '../theme/ThemeConstants';
import { Router } from '../router/Router';
import { FishingRecord } from '../common/types/UserTypes';
import { promptAction, componentSnapshot } from '@kit.ArkUI';
import { image } from '@kit.ImageKit';
import { fileIo as fs } from '@kit.CoreFileKit';
import { photoAccessHelper } from '@kit.MediaLibraryKit';
import { common } from '@kit.AbilityKit';
import { BusinessError } from '@kit.BasicServicesKit';
import { getCachedWeather, WeatherData } from '../services/WeatherService';
import { LocationService } from '../services/LocationService';
import { site } from '@kit.MapKit';

// åˆ†äº«å¡ç‰‡æ ·å¼
interface CardStyle {
  name: string;
  bgColor: string;
  gradientColors: [string, number][];
  textColor: string;
  accentColor: string;
  bgImage?: string;  // å¯é€‰çš„èƒŒæ™¯å›¾ç‰‡
}

@Entry
@Component
struct VictorySharePage {
  @State record: FishingRecord | null = null;
  // å®æ—¶ä½ç½®å’Œå¤©æ°”æ•°æ®
  @State currentLocation: string = '';
  @State currentWeather: string = '';
  @State selectedPhoto: string = '';
  @State selectedStyle: number = 0;
  @State isGenerating: boolean = false;
  @State victoryComment: string = '';
  @State victoryTags: string[] = [];
  @State decorationText: string = '666';
  @State generatedImageUri: string = '';  // ç”Ÿæˆçš„å›¾ç‰‡URI
  @State showSuccessDialog: boolean = false;  // æ˜¾ç¤ºæˆåŠŸå¼¹çª—
  @State customBgImage: string = '';  // è‡ªå®šä¹‰èƒŒæ™¯å›¾

  // å¡ç‰‡æ ·å¼é¢„è®¾
  private cardStyles: CardStyle[] = [
    {
      name: 'é‡‘è‰²è£è€€',
      bgColor: '#1a1a2e',
      gradientColors: [['rgba(232,168,73,0.8)', 0], ['rgba(255,200,100,0.3)', 1]],
      textColor: '#FFFFFF',
      accentColor: '#E8A849'
    },
    {
      name: 'æµ·æ´‹è“',
      bgColor: '#0a1628',
      gradientColors: [['rgba(64,169,255,0.7)', 0], ['rgba(24,144,255,0.2)', 1]],
      textColor: '#FFFFFF',
      accentColor: '#40A9FF'
    },
    {
      name: 'æ£®æ—ç»¿',
      bgColor: '#0d1f0d',
      gradientColors: [['rgba(82,196,26,0.7)', 0], ['rgba(115,209,61,0.2)', 1]],
      textColor: '#FFFFFF',
      accentColor: '#52C41A'
    },
    {
      name: 'æ™šéœç´«',
      bgColor: '#1a0a28',
      gradientColors: [['rgba(177,130,255,0.7)', 0], ['rgba(114,46,209,0.2)', 1]],
      textColor: '#FFFFFF',
      accentColor: '#B182FF'
    },
    {
      name: 'è‡ªå®šä¹‰',
      bgColor: '#1a1a2e',
      gradientColors: [['rgba(0,0,0,0.5)', 0], ['rgba(0,0,0,0.3)', 1]],
      textColor: '#FFFFFF',
      accentColor: '#FFD700'
    }
  ];

  aboutToAppear(): void {
    const params = Router.getParams() as Record<string, Object>;
    if (params && params.record) {
      this.record = params.record as FishingRecord;
      // é»˜è®¤é€‰æ‹©ç¬¬ä¸€å¼ å›¾ç‰‡
      if (this.record.photos && this.record.photos.length > 0) {
        this.selectedPhoto = this.record.photos[0];
      }
    }
    // åˆå§‹åŒ–éšæœºå†…å®¹
    this.refreshRandomContent();
    
    // è·å–å®æ—¶ä½ç½®å’Œå¤©æ°”æ•°æ®
    this.loadCurrentLocationAndWeather();
  }

  // åŠ è½½å½“å‰ä½ç½®å’Œå¤©æ°”
  private async loadCurrentLocationAndWeather(): Promise<void> {
    // è·å–ç¼“å­˜çš„å¤©æ°”æ•°æ®
    const weather = getCachedWeather();
    if (weather.isValid) {
      this.currentWeather = weather.weatherText;
    }
    
    // è·å–å½“å‰ä½ç½®çš„ç²¾ç¡®åœ°å€
    const location = LocationService.currentLocation;
    if (location.isValid) {
      try {
        const params: site.ReverseGeocodeParams = {
          location: {
            latitude: location.latitude,
            longitude: location.longitude
          },
          language: 'zh',
          radius: 50  // å°åŠå¾„è·å–æ›´ç²¾ç¡®çš„ä½ç½®
        };
        const result = await site.reverseGeocode(params);
        if (result && result.addressComponent) {
          const addr = result.addressComponent;
          // æ‹¼æ¥åœ°å€ï¼šåŒº + è¡—é“/é“è·¯ï¼Œè·å–æ›´ç²¾ç¡®çš„ä½ç½®
          const parts: string[] = [];
          if (addr.adminLevel3) {
            parts.push(addr.adminLevel3);
          }
          if (addr.adminLevel4) {
            parts.push(addr.adminLevel4);
          }
          
          if (parts.length > 0) {
            this.currentLocation = parts.join(' ');
          } else if (addr.adminLevel2) {
            this.currentLocation = addr.adminLevel2;
          } else {
            this.currentLocation = 'å½“å‰ä½ç½®';
          }
        }
      } catch (error) {
        console.error('è·å–ä½ç½®åç§°å¤±è´¥:', JSON.stringify(error));
      }
    }
  }

  // åˆ·æ–°éšæœºå†…å®¹
  private refreshRandomContent(): void {
    this.victoryComment = this.generateVictoryComment();
    this.victoryTags = this.generateVictoryTags();
    this.decorationText = this.generateDecorationText();
  }

  build() {
    Stack() {
      // ä¸»å†…å®¹
      Column() {
        this.HeaderBar()

        Scroll() {
          Column({ space: 16 }) {
            // é¢„è§ˆå¡ç‰‡
            this.PreviewCard()

            // å›¾ç‰‡é€‰æ‹©ï¼ˆå¦‚æœæœ‰å¤šå¼ ï¼‰
            if (this.record?.photos && this.record.photos.length > 1) {
              this.PhotoSelector()
            }

            // æ ·å¼é€‰æ‹©
            this.StyleSelector()

            // æ“ä½œæŒ‰é’®
            this.ActionButtons()
          }
          .padding({ left: 16, right: 16, bottom: 40 })
        }
        .layoutWeight(1)
        .scrollBar(BarState.Off)
      }
      .width('100%')
      .height('100%')
      .backgroundColor(ThemeColors.BG_PRIMARY)

      // æˆåŠŸå¼¹çª— - å…¨å±è¦†ç›–
      if (this.showSuccessDialog) {
        this.SuccessDialog()
      }
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  HeaderBar() {
    Column() {
      Row().width('100%').height(36)

      Row() {
        Image($r('app.media.Left'))
          .width(24)
          .height(24)
          .fillColor(ThemeColors.TEXT_PRIMARY)
          .onClick(() => Router.back())

        Blank()

        Text('ç”Ÿæˆåˆ†äº«å›¾')
          .fontSize(ThemeConstants.FONT_SIZE_LG)
          .fontWeight(FontWeight.Medium)
          .fontColor(ThemeColors.TEXT_PRIMARY)

        Blank()

        Row().width(24)
      }
      .width('100%')
      .height(48)
      .padding({ left: 16, right: 16 })
    }
    .width('100%')
  }

  // æ ¹æ®æ¸”è·æ•°æ®ç”Ÿæˆè¶£å‘³è¯„è¯­ - æ›´éª„å‚²æ›´éšæœº
  private generateVictoryComment(): string {
    const weight = this.record?.weight || 0;
    const count = this.record?.count || 0;

    // è¶…çº§å¤§ä¸°æ”¶ (10kg+)
    if (weight >= 10) {
      const comments = [
        'ğŸ† ä»Šå¤©æˆ‘å°±æ˜¯é’“ç¥ï¼ä¸æ¥å—åé©³ï¼',
        'ğŸ‘‘ å°ç¥ä¹‹æˆ˜ï¼è¿™é±¼å¡˜æˆ‘æ‰¿åŒ…äº†ï¼',
        'ğŸ”¥ çˆ†æŠ¤è­¦å‘Šï¼å…¶ä»–é’“å‹å·²ç¾¡æ…•å“­ï¼',
        'ğŸ’ ç‹è€…å½’æ¥ï¼é±¼å„¿æ’é˜Ÿä¸Šé’©ï¼',
        'ğŸš€ èµ·é£ï¼ä»Šå¤©çš„é±¼éƒ½æ˜¯æˆ‘çš„ï¼'
      ];
      return comments[Math.floor(Math.random() * comments.length)];
    }

    // å¤§ä¸°æ”¶ (5kg+)
    if (weight >= 5) {
      const comments = [
        'ğŸ’ª 666ï¼ä»Šå¤©çŠ¶æ€æ‹‰æ»¡ï¼',
        'ğŸ˜ å°±è¿™ï¼Ÿè½»è½»æ¾æ¾æ‹¿ä¸‹ï¼',
        'ğŸ¯ ç²¾å‡†å‡ºå‡»ï¼Œå¼¹æ— è™šå‘ï¼',
        'âš¡ å¼€æŒ‚äº†å±äºæ˜¯ï¼å¤ªå¼ºäº†ï¼',
        'ğŸŒŸ é—ªè€€å…¨åœºï¼MVPéæˆ‘è«å±ï¼'
      ];
      return comments[Math.floor(Math.random() * comments.length)];
    }

    // è¿ç«¿ (10å°¾+)
    if (count >= 10) {
      const comments = [
        'ğŸ”¥ è¿ç«¿åˆ°æ‰‹è½¯ï¼åœä¸ä¸‹æ¥ï¼',
        'ğŸ’¥ çˆ†æŠ¤æ¨¡å¼å¼€å¯ï¼é±¼å„¿ç–¯ç‹‚å’¬é’©ï¼',
        'ğŸª ä»Šå¤©çš„é±¼éƒ½æƒ³è®¤è¯†æˆ‘ï¼',
        'â­ æ•°é‡å³æ­£ä¹‰ï¼é‡å¤§ç®¡é¥±ï¼',
        'ğŸ° ä¸­å¥–äº†ï¼ä»Šå¤©è¿æ°”çˆ†æ£šï¼'
      ];
      return comments[Math.floor(Math.random() * comments.length)];
    }

    // ä¸é”™çš„æ”¶è· (2kg+ æˆ– 3å°¾+)
    if (weight >= 2 || count >= 3) {
      const comments = [
        'ğŸ‘ ç¨³å¦‚è€ç‹—ï¼è¿™æ³¢ä¸äºï¼',
        'ğŸ˜ å°æ„æ€ï¼Œä¸‹æ¬¡æ›´çŒ›ï¼',
        'âœ¨ ä»Šæ—¥ä»½çš„å¿«ä¹å·²åˆ°è´¦ï¼',
        'ğŸ£ æŠ€æœ¯åœ¨çº¿ï¼Œæ¸”è·æ»¡æ»¡ï¼',
        'ğŸ’¯ å®Œç¾æ”¶å®˜ï¼æ˜å¤©ç»§ç»­ï¼'
      ];
      return comments[Math.floor(Math.random() * comments.length)];
    }

    // å¼€å¼ 
    const comments = [
      'ğŸ‰ å¼€å¼ å¤§å‰ï¼å¥½è¿å¼€å§‹ï¼',
      'ğŸŒˆ ä¸‡äº‹å¼€å¤´éš¾ï¼Œåé¢å…¨æ˜¯é±¼ï¼',
      'ğŸ€ ä»Šå¤©çš„å¹¸è¿å·²ç­¾åˆ°ï¼',
      'ğŸ˜„ é‡åœ¨å‚ä¸ï¼Œå¿«ä¹é’“é±¼ï¼',
      'ğŸˆ å°è¯•ç‰›åˆ€ï¼Œå¤§çš„è¿˜åœ¨åé¢ï¼'
    ];
    return comments[Math.floor(Math.random() * comments.length)];
  }

  // è·å–è¶£å‘³æ ‡ç­¾ - æ›´å¤šéšæœºæ ‡ç­¾
  private generateVictoryTags(): string[] {
    const tags: string[] = [];
    const weight = this.record?.weight || 0;
    const count = this.record?.count || 0;

    // æ ¹æ®é‡é‡æ·»åŠ æ ‡ç­¾
    if (weight >= 10) {
      const heavyTags = ['é’“ç¥ä¸‹å‡¡', 'é±¼å¡˜ç»ˆç»“è€…', 'ä»Šæ—¥MVP', 'æ¸”è·ä¹‹ç‹'];
      tags.push(heavyTags[Math.floor(Math.random() * heavyTags.length)]);
    } else if (weight >= 5) {
      const goodTags = ['é’“é±¼å¤§å¸ˆ', 'æŠ€æœ¯æµ', 'ç¨³å®šå‘æŒ¥', 'å®åŠ›æ´¾'];
      tags.push(goodTags[Math.floor(Math.random() * goodTags.length)]);
    }

    // æ ¹æ®æ•°é‡æ·»åŠ æ ‡ç­¾
    if (count >= 10) {
      const manyTags = ['è¿ç«¿ç‹', 'çˆ†æŠ¤è¾¾äºº', 'æ•°é‡æ‹…å½“', 'æ•ˆç‡ä¹‹æ˜Ÿ'];
      tags.push(manyTags[Math.floor(Math.random() * manyTags.length)]);
    } else if (count >= 5) {
      const someTags = ['å°æœ‰æ–©è·', 'æ¸”è·æ»¡æ»¡', 'æ”¶è·é¢‡ä¸°'];
      tags.push(someTags[Math.floor(Math.random() * someTags.length)]);
    }

    // å¤©æ°”ç›¸å…³æ ‡ç­¾
    if (this.record?.weather === 'å°é›¨') {
      tags.push('é£é›¨æ— é˜»');
    } else if (this.record?.weather === 'å¤§é£') {
      tags.push('è¿é£ä½œæˆ˜');
    } else if (this.record?.weather === 'æ™´æœ—') {
      const sunnyTags = ['é˜³å…‰é’“æ‰‹', 'å¥½å¤©å¥½é±¼'];
      tags.push(sunnyTags[Math.floor(Math.random() * sunnyTags.length)]);
    }

    // éšæœºè¶£å‘³æ ‡ç­¾
    const funTags = ['å¿«ä¹å‚é’“', 'ä½›ç³»é’“é±¼', 'äº«å—è¿‡ç¨‹', 'é’“é±¼ä½¿æˆ‘å¿«ä¹', 'ä»Šæ—¥å®œé’“é±¼'];
    if (tags.length < 2) {
      tags.push(funTags[Math.floor(Math.random() * funTags.length)]);
    }

    return tags.slice(0, 3); // æœ€å¤š3ä¸ªæ ‡ç­¾
  }

  // è·å–è£…é¥°æ€§èƒŒæ™¯æ–‡å­—
  private generateDecorationText(): string {
    const texts = ['666', 'NICE', 'ç‰›!', '6!', 'èµ¢!', 'WIN', 'YES'];
    return texts[Math.floor(Math.random() * texts.length)];
  }

  @Builder
  PreviewCard() {
    Column() {
      Text('é¢„è§ˆæ•ˆæœ')
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .width('100%')
        .margin({ bottom: 8 })

      // åˆ†äº«å¡ç‰‡é¢„è§ˆ
      Column() {
        // é¡¶éƒ¨æ ‡é¢˜æ 
        Row() {
          Row({ space: 6 }) {
            Text('ğŸ£')
              .fontSize(18)
            Text('æ¸”è·æˆ˜æŠ¥')
              .fontSize(15)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.cardStyles[this.selectedStyle].textColor)
          }

          Blank()

          Text(this.record?.dateStr || '')
            .fontSize(11)
            .fontColor(this.cardStyles[this.selectedStyle].textColor)
            .opacity(0.7)
        }
        .width('100%')
        .padding({ left: 14, right: 14, top: 14 })

        // è¶£å‘³è¯„è¯­
        Row() {
          Text(this.victoryComment)
            .fontSize(13)
            .fontWeight(FontWeight.Medium)
            .fontColor(this.cardStyles[this.selectedStyle].accentColor)
        }
        .width('100%')
        .padding({ left: 14, right: 14, top: 6 })

        // ä¸»å›¾åŒºåŸŸ - ä¿æŒå›¾ç‰‡åŸå§‹æ¯”ä¾‹
        Column() {
          if (this.selectedPhoto) {
            Image(this.selectedPhoto)
              .width('100%')
              .fitOriginalSize(true)
              .objectFit(ImageFit.Contain)
              .borderRadius(10)
          } else {
            // æ— å›¾ç‰‡å ä½
            Column() {
              Text('ğŸŸ')
                .fontSize(40)
              Text('æš‚æ— æ¸”è·å›¾ç‰‡')
                .fontSize(12)
                .fontColor(this.cardStyles[this.selectedStyle].textColor)
                .opacity(0.5)
                .margin({ top: 6 })
            }
            .width('100%')
            .height(140)
            .justifyContent(FlexAlign.Center)
            .backgroundColor('rgba(255,255,255,0.08)')
            .borderRadius(10)
          }
        }
        .width('100%')
        .padding({ left: 14, right: 14, top: 10 })

        // è¶£å‘³æ ‡ç­¾
        Row({ space: 6 }) {
          ForEach(this.victoryTags, (tag: string) => {
            Text(`#${tag}`)
              .fontSize(10)
              .fontColor(this.cardStyles[this.selectedStyle].accentColor)
              .padding({ left: 8, right: 8, top: 3, bottom: 3 })
              .backgroundColor(`${this.cardStyles[this.selectedStyle].accentColor}20`)
              .borderRadius(10)
          }, (tag: string) => tag)
        }
        .width('100%')
        .padding({ left: 14, right: 14, top: 10 })

        // æ•°æ®å±•ç¤º
        Row() {
          // é±¼ç§
          Column({ space: 3 }) {
            Text('ğŸŸ é±¼ç§')
              .fontSize(9)
              .fontColor(this.cardStyles[this.selectedStyle].textColor)
              .opacity(0.6)
            Text(this.record?.fishName || 'æœªçŸ¥')
              .fontSize(13)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.cardStyles[this.selectedStyle].accentColor)
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
          }
          .layoutWeight(1)
          .alignItems(HorizontalAlign.Center)

          // åˆ†éš”çº¿
          Column()
            .width(1)
            .height(30)
            .backgroundColor(this.cardStyles[this.selectedStyle].textColor)
            .opacity(0.2)

          // é‡é‡
          Column({ space: 3 }) {
            Text('âš–ï¸ æ€»é‡')
              .fontSize(9)
              .fontColor(this.cardStyles[this.selectedStyle].textColor)
              .opacity(0.6)
            Text(`${this.record?.weight || 0} kg`)
              .fontSize(13)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.cardStyles[this.selectedStyle].accentColor)
          }
          .layoutWeight(1)
          .alignItems(HorizontalAlign.Center)

          // åˆ†éš”çº¿
          Column()
            .width(1)
            .height(30)
            .backgroundColor(this.cardStyles[this.selectedStyle].textColor)
            .opacity(0.2)

          // æ•°é‡
          Column({ space: 3 }) {
            Text('ğŸ”¢ æ•°é‡')
              .fontSize(9)
              .fontColor(this.cardStyles[this.selectedStyle].textColor)
              .opacity(0.6)
            Text(`${this.record?.count || 0} å°¾`)
              .fontSize(13)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.cardStyles[this.selectedStyle].accentColor)
          }
          .layoutWeight(1)
          .alignItems(HorizontalAlign.Center)
        }
        .width('100%')
        .padding({ left: 14, right: 14, top: 12 })

        // é’“ç‚¹å’Œå¤©æ°”
        Row() {
          Row({ space: 4 }) {
            Text('ğŸ“')
              .fontSize(11)
            Text(this.currentLocation || this.record?.location || 'æœªçŸ¥é’“ç‚¹')
              .fontSize(11)
              .fontColor(this.cardStyles[this.selectedStyle].textColor)
              .opacity(0.7)
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
          }
          .layoutWeight(1)

          Row({ space: 4 }) {
            Text(this.getWeatherIcon(this.currentWeather || this.record?.weather || ''))
              .fontSize(11)
            Text(this.currentWeather || this.record?.weather || '')
              .fontSize(11)
              .fontColor(this.cardStyles[this.selectedStyle].textColor)
              .opacity(0.7)
          }
        }
        .width('100%')
        .padding({ left: 14, right: 14, top: 10 })

        // åº•éƒ¨æ°´å°
        Row() {
          Text('â€” é¥µçŸ¥é“ Â· æ™ºèƒ½é’“é±¼åŠ©æ‰‹ â€”')
            .fontSize(9)
            .fontColor(this.cardStyles[this.selectedStyle].textColor)
            .opacity(0.4)
        }
        .width('100%')
        .justifyContent(FlexAlign.Center)
        .padding({ top: 12, bottom: 12 })
      }
      .width('100%')
      .backgroundImage(this.isCustomStyle() && this.customBgImage ? this.customBgImage : '')
      .backgroundImageSize(ImageSize.Cover)
      .backgroundColor(this.cardStyles[this.selectedStyle].bgColor)
      .linearGradient({
        direction: GradientDirection.RightBottom,
        colors: this.cardStyles[this.selectedStyle].gradientColors
      })
      .borderRadius(16)
      .clip(true)
      .shadow({ radius: 16, color: 'rgba(0,0,0,0.25)', offsetY: 8 })
      .id('victoryCard')
    }
  }

  // åˆ¤æ–­æ˜¯å¦ä¸ºè‡ªå®šä¹‰æ ·å¼
  private isCustomStyle(): boolean {
    return this.selectedStyle === this.cardStyles.length - 1;
  }

  // é€‰æ‹©è‡ªå®šä¹‰èƒŒæ™¯å›¾
  private async selectCustomBgImage(): Promise<void> {
    try {
      const photoPicker = new photoAccessHelper.PhotoViewPicker();
      const result = await photoPicker.select({
        MIMEType: photoAccessHelper.PhotoViewMIMETypes.IMAGE_TYPE,
        maxSelectNumber: 1
      });
      if (result.photoUris && result.photoUris.length > 0) {
        this.customBgImage = result.photoUris[0];
        // è‡ªåŠ¨åˆ‡æ¢åˆ°è‡ªå®šä¹‰æ ·å¼
        this.selectedStyle = this.cardStyles.length - 1;
      }
    } catch (error) {
      console.error('é€‰æ‹©èƒŒæ™¯å›¾å¤±è´¥:', JSON.stringify(error));
    }
  }

  @Builder
  SuccessDialog() {
    Stack() {
      // é®ç½©
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0,0,0,0.6)')
        .onClick(() => {
          this.showSuccessDialog = false;
        })

      // å¼¹çª—å†…å®¹
      Column({ space: 16 }) {
        Text('ğŸ‰')
          .fontSize(48)

        Text('åˆ†äº«å›¾å·²ç”Ÿæˆ')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeColors.TEXT_PRIMARY)

        Text('å›¾ç‰‡å·²ä¿å­˜åˆ°ç›¸å†Œ')
          .fontSize(14)
          .fontColor(ThemeColors.TEXT_SECONDARY)
          .textAlign(TextAlign.Center)

        Column({ space: 4 }) {
          Text('âœ… ä¿å­˜æˆåŠŸ')
            .fontSize(12)
            .fontColor(ThemeColors.SUCCESS)
          Text('å¯åœ¨ç›¸å†Œä¸­æŸ¥çœ‹å’Œåˆ†äº«')
            .fontSize(12)
            .fontColor(ThemeColors.TEXT_SECONDARY)
        }
        .padding(12)
        .backgroundColor(ThemeColors.SUCCESS_LIGHT)
        .borderRadius(8)
        .width('100%')

        Row({ space: 12 }) {
          Button('ç»§ç»­ç¼–è¾‘')
            .fontSize(14)
            .fontColor(ThemeColors.TEXT_PRIMARY)
            .backgroundColor(ThemeColors.BG_TERTIARY)
            .borderRadius(20)
            .height(40)
            .layoutWeight(1)
            .onClick(() => {
              this.showSuccessDialog = false;
            })

          Button('å®Œæˆ')
            .fontSize(14)
            .fontColor(ThemeColors.TEXT_PRIMARY)
            .backgroundColor(ThemeColors.PRIMARY)
            .borderRadius(20)
            .height(40)
            .layoutWeight(1)
            .onClick(() => {
              this.showSuccessDialog = false;
              Router.back();
            })
        }
        .width('100%')
        .margin({ top: 8 })
      }
      .width('80%')
      .padding(24)
      .backgroundColor(ThemeColors.BG_CARD)
      .borderRadius(20)
      .shadow({ radius: 20, color: 'rgba(0,0,0,0.3)', offsetY: 10 })
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  PhotoSelector() {
    Column({ space: 8 }) {
      Text('é€‰æ‹©å±•ç¤ºå›¾ç‰‡')
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .width('100%')

      Row({ space: 8 }) {
        ForEach(this.record?.photos || [], (photo: string, index: number) => {
          Stack() {
            Image(photo)
              .width(72)
              .height(72)
              .objectFit(ImageFit.Cover)
              .borderRadius(8)
              .opacity(this.selectedPhoto === photo ? 1 : 0.6)

            if (this.selectedPhoto === photo) {
              Column()
                .width(72)
                .height(72)
                .borderRadius(8)
                .border({ width: 3, color: ThemeColors.PRIMARY })

              Text('âœ“')
                .fontSize(16)
                .fontColor(Color.White)
                .backgroundColor(ThemeColors.PRIMARY)
                .borderRadius(12)
                .width(24)
                .height(24)
                .textAlign(TextAlign.Center)
                .position({ x: 48, y: -4 })
            }
          }
          .onClick(() => {
            this.selectedPhoto = photo;
          })
        }, (photo: string, index: number) => `select_${index}`)
      }
    }
  }

  @Builder
  StyleSelector() {
    Column({ space: 8 }) {
      Row() {
        Text('é€‰æ‹©å¡ç‰‡æ ·å¼')
          .fontSize(ThemeConstants.FONT_SIZE_SM)
          .fontColor(ThemeColors.TEXT_SECONDARY)

        Blank()

        // æ¢ä¸€æ¢æŒ‰é’®
        Row({ space: 4 }) {
          Text('ğŸ²')
            .fontSize(14)
          Text('æ¢ä¸€æ¢æ–‡æ¡ˆ')
            .fontSize(ThemeConstants.FONT_SIZE_XS)
            .fontColor(ThemeColors.PRIMARY)
        }
        .padding({ left: 10, right: 10, top: 4, bottom: 4 })
        .backgroundColor(ThemeColors.PRIMARY_LIGHT)
        .borderRadius(12)
        .onClick(() => {
          this.refreshRandomContent();
        })
      }
      .width('100%')

      Scroll() {
        Row({ space: 12 }) {
          ForEach(this.cardStyles, (style: CardStyle, index: number) => {
            Column({ space: 6 }) {
              // æ ·å¼é¢„è§ˆè‰²å—
              Stack() {
                // è‡ªå®šä¹‰æ ·å¼æ˜¾ç¤ºèƒŒæ™¯å›¾æˆ–æ·»åŠ å›¾æ ‡
                if (index === this.cardStyles.length - 1) {
                  if (this.customBgImage) {
                    Image(this.customBgImage)
                      .width(60)
                      .height(40)
                      .objectFit(ImageFit.Cover)
                      .borderRadius(8)
                  } else {
                    Column()
                      .width(60)
                      .height(40)
                      .backgroundColor('#333')
                      .borderRadius(8)
                    Text('ğŸ“·')
                      .fontSize(18)
                  }
                } else {
                  Column()
                    .width(60)
                    .height(40)
                    .backgroundColor(style.bgColor)
                    .borderRadius(8)

                  Column()
                    .width(60)
                    .height(40)
                    .linearGradient({
                      direction: GradientDirection.RightBottom,
                      colors: style.gradientColors
                    })
                    .borderRadius(8)
                }

                if (this.selectedStyle === index) {
                  Text('âœ“')
                    .fontSize(14)
                    .fontColor(Color.White)
                }
              }
              .border(this.selectedStyle === index ?
                { width: 2, color: ThemeColors.PRIMARY } :
                { width: 1, color: ThemeColors.TEXT_MUTED })
              .borderRadius(8)

              Text(style.name)
                .fontSize(ThemeConstants.FONT_SIZE_XS)
                .fontColor(this.selectedStyle === index ? ThemeColors.PRIMARY : ThemeColors.TEXT_SECONDARY)
            }
            .onClick(() => {
              if (index === this.cardStyles.length - 1) {
                // è‡ªå®šä¹‰æ ·å¼ï¼Œé€‰æ‹©èƒŒæ™¯å›¾
                this.selectCustomBgImage();
              } else {
                this.selectedStyle = index;
              }
            })
          }, (style: CardStyle, index: number) => `style_${index}`)
        }
      }
      .scrollable(ScrollDirection.Horizontal)
      .scrollBar(BarState.Off)
      .width('100%')
    }
  }

  @Builder
  ActionButtons() {
    Column({ space: 12 }) {
      // ä½¿ç”¨ SaveButton å®‰å…¨æ§ä»¶ä¿å­˜åˆ°ç›¸å†Œ
      SaveButton()
        .onClick(async (event: ClickEvent, result: SaveButtonOnClickResult) => {
          if (result === SaveButtonOnClickResult.SUCCESS) {
            await this.saveToGallery();
          } else {
            promptAction.showToast({ message: 'éœ€è¦æˆæƒæ‰èƒ½ä¿å­˜å›¾ç‰‡' });
          }
        })

      // è¿”å›æŒ‰é’®
      Button('è¿”å›')
        .fontSize(ThemeConstants.FONT_SIZE_MD)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .backgroundColor(ThemeColors.BG_TERTIARY)
        .borderRadius(ThemeConstants.RADIUS_MD)
        .width('100%')
        .height(48)
        .onClick(() => {
          Router.back();
        })
    }
    .margin({ top: 16 })
  }

  // ä¿å­˜å›¾ç‰‡åˆ°ç›¸å†Œ - ä½¿ç”¨ SaveButton è·å–ä¸´æ—¶æƒé™
  private async saveToGallery(): Promise<void> {
    if (this.isGenerating) return;

    this.isGenerating = true;

    try {
      const context = getContext(this) as common.UIAbilityContext;
      const helper = photoAccessHelper.getPhotoAccessHelper(context);

      // onClick è§¦å‘å 5 ç§’å†…é€šè¿‡ createAsset æ¥å£åˆ›å»ºå›¾ç‰‡æ–‡ä»¶
      const uri = await helper.createAsset(photoAccessHelper.PhotoType.IMAGE, 'jpg');

      // ä½¿ç”¨ uri æ‰“å¼€æ–‡ä»¶
      const file = await fs.open(uri, fs.OpenMode.READ_WRITE | fs.OpenMode.CREATE);

      // æˆªå–ç»„ä»¶ç”Ÿæˆ PixelMap
      const snapshotOptions: componentSnapshot.SnapshotOptions = {
        waitUntilRenderFinished: true
      };
      const pixelMap = await componentSnapshot.get('victoryCard', snapshotOptions);

      if (pixelMap) {
        // ç¼–ç å¹¶å†™å…¥æ–‡ä»¶
        const packOpts: image.PackingOption = { format: 'image/jpeg', quality: 95 };
        const imagePacker = image.createImagePacker();

        await imagePacker.packToFile(pixelMap, file.fd, packOpts);

        imagePacker.release();
        fs.close(file.fd);

        this.generatedImageUri = uri;
        promptAction.showToast({ message: 'å›¾ç‰‡å·²ä¿å­˜è‡³ç›¸å†Œ' });
        this.showSuccessDialog = true;
      } else {
        fs.close(file.fd);
        promptAction.showToast({ message: 'æˆªå›¾å¤±è´¥ï¼Œè¯·é‡è¯•' });
      }
    } catch (error) {
      const err = error as BusinessError;
      console.error(`ä¿å­˜å¤±è´¥: code=${err.code}, message=${err.message}`);
      promptAction.showToast({ message: 'ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•' });
    } finally {
      this.isGenerating = false;
    }
  }

  private getWeatherIcon(weather: string): string {
    const icons: Record<string, string> = {
      'æ™´æœ—': 'â˜€ï¸',
      'å¤šäº‘': 'â›…',
      'é˜´å¤©': 'â˜ï¸',
      'å°é›¨': 'ğŸŒ§ï¸',
      'å¤§é£': 'ğŸ’¨'
    };
    return icons[weather] || 'ğŸŒ¤ï¸';
  }
}
