/**
 * ç²¾ç¡®åŒ¹é… - ç»“æœå±•ç¤ºé¡?
 * å±•ç¤ºé…æ–¹åˆ†æç»“æœã€å›¾è¡¨ã€è¯¦æƒ?
 */
import { router, promptAction } from '@kit.ArkUI';
import { ThemeColors } from '../theme/ThemeColors';
import {
  PreciseMatchInput,
  PreciseMatchResult,
  DimensionScores,
  ParameterWeight,
  AnalysisStep,
  IngredientRatio,
  FEEDBACK_OPTIONS,
  FeedbackOption,
  FeedbackType
} from '../common/types/PreciseMatchTypes';
import { GeneratedRecipe, RecipeIngredient } from '../common/types/RecipeTypes';
import { preciseMatchEngine } from '../services/engine/PreciseMatchEngine';
import { getFishById } from '../data/FishData';
import { userDataService } from '../services/UserDataService';
import { AnalysisAnimation } from '../components/AnalysisAnimation';
import { RecipeService, Recipe, Ingredient } from '../services/RecipeService';

@Entry
@Component
struct PreciseResultPage {
  @State result: PreciseMatchResult = new PreciseMatchResult();
  @State isLoading: boolean = true;
  @State showFeedbackDialog: boolean = false;
  @State selectedFeedbacks: FeedbackType[] = [];
  @State showAnalysisAnimation: boolean = true;
  @State currentStep: number = 0;
  @State fishName: string = 'ç›®æ ‡é±?;
  @State contentOpacity: number = 0;
  @State showIngredientSelect: boolean = false;  // æ˜¾ç¤ºåŸæ–™é€‰æ‹©
  @State excludedIngredients: string[] = [];     // æ’é™¤çš„åŸæ–™åç§?
  @State showOtherReason: boolean = false;       // æ˜¾ç¤ºå…¶ä»–åŸå› æç¤º
  @State isSaved: boolean = false;               // æ˜¯å¦å·²ä¿å­˜åˆ°é…æ–¹åº?

  private input: PreciseMatchInput = new PreciseMatchInput();
  private animationTimer: number = -1;
  private recipeService: RecipeService = RecipeService.getInstance();

  aboutToAppear(): void {
    // è·å–ä¼ å…¥çš„å‚æ•?
    const params = router.getParams() as Record<string, string>;
    if (params && params.input) {
      try {
        const inputData = JSON.parse(params.input) as PreciseMatchInput;
        // æ‰‹åŠ¨å¤åˆ¶å±æ€?
        this.input.targetFish = inputData.targetFish;
        this.input.waterType = inputData.waterType;
        this.input.season = inputData.season;
        this.input.temperature = inputData.temperature;
        this.input.waterDepth = inputData.waterDepth;
        this.input.waterQuality = inputData.waterQuality;
        this.input.lightCondition = inputData.lightCondition;
        this.input.windCondition = inputData.windCondition;
        this.input.baitState = inputData.baitState;
        this.input.flavorIntensity = inputData.flavorIntensity;
        this.input.targetFishSize = inputData.targetFishSize;
        // è·å–é±¼ç§åç§°
        const fishData = getFishById(this.input.targetFish);
        if (fishData) {
          this.fishName = fishData.name;
        }
      } catch (e) {
        console.error('Parse input failed:', e);
      }
    }

    // å¼€å§‹åˆ†æåŠ¨ç”?
    this.startAnalysisAnimation();
  }

  aboutToDisappear(): void {
    if (this.animationTimer !== -1) {
      clearInterval(this.animationTimer);
    }
  }

  // å¼€å§‹åˆ†æåŠ¨ç”?
  private startAnalysisAnimation(): void {
    this.showAnalysisAnimation = true;
    this.currentStep = 0;
    this.contentOpacity = 0;

    // æ¨¡æ‹Ÿåˆ†æè¿‡ç¨‹
    this.animationTimer = setInterval(() => {
      this.currentStep++;
      if (this.currentStep >= 5) {
        clearInterval(this.animationTimer);
        this.animationTimer = -1;

        // æ‰§è¡Œå®é™…åˆ†æ
        setTimeout(() => {
          this.result = preciseMatchEngine.analyze(this.input);
          this.showAnalysisAnimation = false;
          this.isLoading = false;

          // ä¿å­˜åˆ°å†å²è®°å½?
          this.saveToHistory();

          // å†…å®¹æ·¡å…¥åŠ¨ç”»
          animateTo({
            duration: 400,
            curve: Curve.EaseOut
          }, () => {
            this.contentOpacity = 1;
          });
        }, 300);
      }
    }, 400);
  }

  // è¿”å›ä¸Šä¸€é¡?
  private onBack(): void {
    router.back();
  }

  // æ¢ä¸€æ?
  private onRefresh(): void {
    this.showFeedbackDialog = true;
  }

  // ç¡®è®¤åé¦ˆå¹¶é‡æ–°ç”Ÿæˆ?
  private onConfirmFeedback(): void {
    this.showFeedbackDialog = false;
    this.showIngredientSelect = false;
    this.showOtherReason = false;
    this.isLoading = true;

    // ä¿å­˜åé¦ˆè®°å½•
    this.saveFeedback();

    setTimeout(() => {
      // ä¼ é€’æ’é™¤çš„åŸæ–™ç»™å¼•æ“?
      this.result = preciseMatchEngine.adjustByFeedback(
        this.result,
        this.selectedFeedbacks,
        this.excludedIngredients
      );
      this.selectedFeedbacks = [];
      this.excludedIngredients = [];
      this.isLoading = false;
    }, 500);
  }

  // ä¿å­˜åˆ°å†å²è®°å½?
  private async saveToHistory(): Promise<void> {
    try {
      const fishData = getFishById(this.input.targetFish);
      const fishName = fishData?.name || this.input.targetFish;
      await userDataService.addPreciseHistory(
        this.result.recipe.name,
        fishName,
        this.result.matchScore,
        JSON.stringify(this.input)
      );
    } catch (e) {
      console.error('Save to history failed:', e);
    }
  }

  // ä¿å­˜åé¦ˆè®°å½•
  private async saveFeedback(): Promise<void> {
    try {
      await userDataService.addFeedback(
        this.result.recipe.id,
        this.selectedFeedbacks,
        ''
      );
    } catch (e) {
      console.error('Save feedback failed:', e);
    }
  }

  // ä¿å­˜é…æ–¹åˆ°é…æ–¹åº“
  private saveToRecipeLibrary(): void {
    if (this.isSaved) {
      promptAction.showToast({ message: 'é…æ–¹å·²ä¿å­˜è¿‡äº? });
      return;
    }

    try {
      // å°?GeneratedRecipe è½¬æ¢ä¸?Recipe æ ¼å¼
      const recipe: Recipe = {
        id: `precise_${Date.now()}`,
        name: this.result.recipe.name,
        targetFish: [this.fishName],
        waterTypes: [this.input.waterType || 'é€šç”¨'],
        seasons: [this.input.season || 'å››å­£'],
        difficulty: 'ä¸­ç­‰',
        prepTime: '15åˆ†é’Ÿ',
        ingredients: this.result.recipe.ingredients.map((ing: RecipeIngredient): Ingredient => ({
          name: ing.name,
          amount: String(ing.weight),
          unit: 'g'
        })),
        steps: [
          `å°†æ‰€æœ‰åŸæ–™æŒ‰é…æ¯”æ··åˆ`,
          `åŠ å…¥${this.result.recipe.usage.waterRatio}çš„æ°´`,
          `æ…æ‹Œå‡åŒ€å?{this.result.recipe.usage.restTime}`,
          this.result.recipe.usage.firstCast
        ],
        tips: [
          `ä¸»å‘³å‹ï¼š${this.result.recipe.flavorProfile.primary}`,
          `è¾…å‘³å‹ï¼š${this.result.recipe.flavorProfile.secondary}`,
          this.result.recipe.usage.nestSuggestion
        ],
        rating: this.result.matchScore / 20,  // è½¬æ¢ä¸?åˆ†åˆ¶
        usageCount: 0,
        isGenerated: true,
        createTime: Date.now()
      };

      // æ·»åŠ åˆ°é…æ–¹åº“
      this.recipeService.addRecipe(recipe);
      this.isSaved = true;
      promptAction.showToast({ message: 'âœ?å·²ä¿å­˜åˆ°é…æ–¹åº? });
    } catch (e) {
      console.error('Save to recipe library failed:', e);
      promptAction.showToast({ message: 'ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•' });
    }
  }

  // åˆ‡æ¢åé¦ˆé€‰é¡¹
  private toggleFeedback(type: FeedbackType): void {
    const index = this.selectedFeedbacks.indexOf(type);
    if (index >= 0) {
      this.selectedFeedbacks.splice(index, 1);
    } else {
      this.selectedFeedbacks.push(type);
    }
    // è§¦å‘UIæ›´æ–°
    this.selectedFeedbacks = [...this.selectedFeedbacks];
  }

  build() {
    Stack() {
      Column() {
        // é¡¶éƒ¨æ ‡é¢˜æ ?
        this.TitleBar()

        if (this.showAnalysisAnimation) {
          // åˆ†æåŠ¨ç”» - ä½¿ç”¨ç‹¬ç«‹ç»„ä»¶
          AnalysisAnimation({
            currentStep: this.currentStep,
            fishName: this.fishName
          })
            .layoutWeight(1)
        } else if (this.isLoading) {
          // åŠ è½½ä¸?
          Column() {
            LoadingProgress().width(48).height(48).color(ThemeColors.PRIMARY)
            Text('æ­£åœ¨ç”Ÿæˆé…æ–¹...').fontSize(14).fontColor('#666').margin({ top: 16 })
          }
          .width('100%')
          .layoutWeight(1)
          .justifyContent(FlexAlign.Center)
        } else {
          // ç»“æœå†…å®¹
          Scroll() {
            Column({ space: 20 }) {
              // åŒ¹é…åº¦è¯„åˆ†å¡ç‰?
              this.ScoreCard()

              // åˆ†æå›¾è¡¨åŒ?
              this.ChartSection()

              // é…æ–¹è¯¦æƒ…
              this.RecipeDetailCard()

              // ä½¿ç”¨å»ºè®®
              this.UsageSuggestionCard()

              // å¤‡é€‰æ–¹æ¡?
              this.AlternativesSection()
            }
            .width('100%')
            .padding({ left: 20, right: 20, bottom: 40 })
            .opacity(this.contentOpacity)
          }
          .layoutWeight(1)
          .scrollBar(BarState.Off)
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#FFFBF5')

      // åé¦ˆå¯¹è¯æ¡?
      if (this.showFeedbackDialog) {
        this.FeedbackDialogView()
      }
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  TitleBar() {
    Row() {
      Row() {
        Text('â†?).fontSize(24).fontColor('#1A1A1A')
      }
      .width(40)
      .height(40)
      .justifyContent(FlexAlign.Center)
      .onClick(() => this.onBack())

      Text('ç²¾ç¡®åŒ¹é…ç»“æœ')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1A1A1A')
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      // æ¢ä¸€æ¢æŒ‰é’?
      Row() {
        Text('ğŸ”„')
          .fontSize(18)
      }
      .width(40)
      .height(40)
      .justifyContent(FlexAlign.Center)
      .onClick(() => this.onRefresh())
    }
    .width('100%')
    .height(56)
    .padding({ left: 12, right: 12 })
    .margin({ top: 44 })
  }

  @Builder
  ScoreCard() {
    Column({ space: 12 }) {
      Row({ space: 16 }) {
        // å¤§åˆ†æ•?
        Column() {
          Text(`${this.result.matchScore}`)
            .fontSize(48)
            .fontWeight(FontWeight.Bold)
            .fontColor(ThemeColors.PRIMARY_DARK)
          Text('/100')
            .fontSize(16)
            .fontColor('#999')
        }

        // è¯„åˆ†è¯´æ˜
        Column({ space: 8 }) {
          Text('åŒ¹é…åº¦è¯„åˆ?)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#1A1A1A')
          Text(this.result.scoreDescription)
            .fontSize(14)
            .fontColor('#666')

          // è¯„åˆ†æ?
          Row() {
            Row()
              .width(`${this.result.matchScore}%`)
              .height(8)
              .backgroundColor(ThemeColors.PRIMARY)
              .borderRadius(4)
          }
          .width('100%')
          .height(8)
          .backgroundColor('#F0F0F0')
          .borderRadius(4)
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)
      }
      .width('100%')
    }
    .width('100%')
    .padding(20)
    .backgroundColor(Color.White)
    .borderRadius(16)
  }

  @Builder
  ChartSection() {
    // äº”ç»´è¯„åˆ†å¡ç‰‡
    Column({ space: 12 }) {
      Text('äº”ç»´èƒ½åŠ›åˆ†æ')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1A1A1A')

      Row({ space: 16 }) {
        // å·¦ä¾§ï¼šç»¼åˆè¯„åˆ†ç¯
        Stack() {
          Progress({ value: this.result.matchScore, total: 100, type: ProgressType.Ring })
            .width(90)
            .height(90)
            .color(ThemeColors.PRIMARY)
            .backgroundColor('#F0F0F0')
            .style({ strokeWidth: 10 })

          Column() {
            Text(`${this.result.matchScore}`)
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor(ThemeColors.PRIMARY_DARK)
            Text('ç»¼åˆ')
              .fontSize(11)
              .fontColor('#999')
          }
        }
        .width(90)
        .height(90)

        // å³ä¾§ï¼šäº”ç»´æ•°å€¼æ¡
        Column({ space: 8 }) {
          this.DimensionBar('è¯±é±¼æ€?, this.result.dimensionScores.attraction, '#E6A23C')
          this.DimensionBar('é€‚å£æ€?, this.result.dimensionScores.palatability, '#67C23A')
          this.DimensionBar('çŠ¶æ€?, this.result.dimensionScores.state, '#409EFF')
          this.DimensionBar('ç•™é±¼æ€?, this.result.dimensionScores.retention, '#F56C6C')
          this.DimensionBar('æ€§ä»·æ¯?, this.result.dimensionScores.costEffective, '#909399')
        }
        .layoutWeight(1)
      }
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(16)
  }

  @Builder
  DimensionBar(name: string, score: number, color: string) {
    Row() {
      Row()
        .width(8)
        .height(8)
        .borderRadius(4)
        .backgroundColor(color)

      Text(name)
        .fontSize(12)
        .fontColor('#666')
        .margin({ left: 6 })
        .width(42)

      Stack({ alignContent: Alignment.Start }) {
        Row()
          .width('100%')
          .height(10)
          .backgroundColor('#F5F5F5')
          .borderRadius(5)

        Row()
          .width(`${score}%`)
          .height(10)
          .backgroundColor(color)
          .borderRadius(5)
      }
      .layoutWeight(1)
      .margin({ left: 6, right: 6 })

      Text(`${score}`)
        .fontSize(12)
        .fontWeight(FontWeight.Medium)
        .fontColor(color)
        .width(24)
        .textAlign(TextAlign.End)
    }
    .width('100%')
  }

  @Builder
  RecipeDetailCard() {
    Column({ space: 16 }) {
      // é…æ–¹åç§°å’Œä¿å­˜æŒ‰é’?
      Row() {
        Text(this.result.recipe.name)
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1A1A1A')
          .layoutWeight(1)
        
        // ä¿å­˜åˆ°é…æ–¹åº“æŒ‰é’®
        Row({ space: 4 }) {
          Text(this.isSaved ? 'âœ? : 'ğŸ’¾')
            .fontSize(14)
          Text(this.isSaved ? 'å·²ä¿å­? : 'ä¿å­˜')
            .fontSize(12)
            .fontColor(this.isSaved ? '#67C23A' : ThemeColors.PRIMARY)
        }
        .padding({ left: 10, right: 10, top: 6, bottom: 6 })
        .backgroundColor(this.isSaved ? '#F0F9EB' : '#FFF5E6')
        .borderRadius(14)
        .onClick(() => this.saveToRecipeLibrary())
        
        Text(`${this.result.recipe.totalWeight}g`)
          .fontSize(14)
          .fontColor('#999')
          .margin({ left: 8 })
      }
      .width('100%')

      // åŸæ–™åˆ—è¡¨
      Column({ space: 8 }) {
        Text('åŸæ–™é…æ¯”')
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor('#666')

        ForEach(this.result.recipe.ingredients, (ing: RecipeIngredient) => {
          Row() {
            Text(ing.name)
              .fontSize(14)
              .fontColor('#1A1A1A')
              .layoutWeight(1)
            Text(`${ing.weight}g`)
              .fontSize(14)
              .fontColor('#666')
              .width(50)
            Text(`${ing.percentage}%`)
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .fontColor(ThemeColors.PRIMARY_DARK)
              .width(40)
              .textAlign(TextAlign.End)
          }
          .width('100%')
          .padding({ top: 8, bottom: 8 })
          .borderWidth({ bottom: 1 })
          .borderColor('#F0F0F0')
        })
      }
      .width('100%')

      // å‘³å‹è¯´æ˜
      Row({ space: 16 }) {
        Column({ space: 4 }) {
          Text('ä¸»å‘³å?).fontSize(12).fontColor('#999')
          Text(this.result.recipe.flavorProfile.primary)
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .fontColor('#1A1A1A')
        }

        Column({ space: 4 }) {
          Text('è¾…å‘³å?).fontSize(12).fontColor('#999')
          Text(this.result.recipe.flavorProfile.secondary)
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .fontColor('#1A1A1A')
        }

        Column({ space: 4 }) {
          Text('æµ“åº¦').fontSize(12).fontColor('#999')
          Text(`${this.result.recipe.flavorProfile.intensity}/10`)
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .fontColor(ThemeColors.PRIMARY_DARK)
        }
      }
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(16)
  }

  @Builder
  UsageSuggestionCard() {
    Column({ space: 12 }) {
      Text('ä½¿ç”¨å»ºè®®')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1A1A1A')

      Row({ space: 24 }) {
        Column({ space: 4 }) {
          Text('æ°´æ¯”').fontSize(12).fontColor('#999')
          Text(this.result.recipe.usage.waterRatio)
            .fontSize(15)
            .fontWeight(FontWeight.Medium)
            .fontColor('#1A1A1A')
        }

        Column({ space: 4 }) {
          Text('é†’é¥µæ—¶é—´').fontSize(12).fontColor('#999')
          Text(this.result.recipe.usage.restTime)
            .fontSize(15)
            .fontWeight(FontWeight.Medium)
            .fontColor('#1A1A1A')
        }
      }
      .width('100%')

      Text(this.result.recipe.usage.firstCast)
        .fontSize(14)
        .fontColor('#666')
        .lineHeight(22)

      Text(this.result.recipe.usage.nestSuggestion)
        .fontSize(14)
        .fontColor('#666')
        .lineHeight(22)
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(16)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  AlternativesSection() {
    Column({ space: 12 }) {
      Text('å¤‡é€‰æ–¹æ¡?)
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1A1A1A')

      Scroll() {
        Row({ space: 12 }) {
          ForEach(this.result.alternatives, (alt: GeneratedRecipe) => {
            Column({ space: 8 }) {
              Text(alt.name)
                .fontSize(14)
                .fontWeight(FontWeight.Medium)
                .fontColor('#1A1A1A')

              Text(`${alt.flavorProfile.primary} Â· ${alt.flavorProfile.secondary}`)
                .fontSize(12)
                .fontColor('#666')

              Text(`æµ“åº¦ ${alt.flavorProfile.intensity}/10`)
                .fontSize(12)
                .fontColor(ThemeColors.PRIMARY_DARK)
            }
            .width(140)
            .padding(12)
            .backgroundColor('#FFF5E6')
            .borderRadius(12)
            .alignItems(HorizontalAlign.Start)
          })
        }
      }
      .scrollable(ScrollDirection.Horizontal)
      .scrollBar(BarState.Off)
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  FeedbackDialogView() {
    Column() {
      // é®ç½©
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0,0,0,0.5)')
        .onClick(() => {
          this.showFeedbackDialog = false;
          this.showIngredientSelect = false;
          this.showOtherReason = false;
        })
    }
    .width('100%')
    .height('100%')
    .position({ x: 0, y: 0 })

    // å¯¹è¯æ¡?
    Scroll() {
      Column({ space: 16 }) {
        Text('ä¸æ»¡æ„çš„åœ°æ–¹')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1A1A1A')

        // é€‰é¡¹1ï¼šå‘³å‹ä¸å–œæ¬¢
        this.FeedbackOptionItem('ğŸ‘ƒ', 'å‘³å‹ä¸å–œæ¬?, 'flavor_dislike')

        // é€‰é¡¹2ï¼šæé¦™ï¼ˆæƒ³è¦æ›´é¦™ï¼?
        this.FeedbackOptionItem('ğŸŒ¸', 'æƒ³è¦æé¦™', 'want_more_fragrant')

        // é€‰é¡¹3ï¼šåŸæ–™éš¾è·å–
        Column({ space: 8 }) {
          Row({ space: 12 }) {
            Text('ğŸ›’').fontSize(20)
            Text('åŸæ–™éš¾è·å?)
              .fontSize(15)
              .fontColor('#1A1A1A')
              .layoutWeight(1)
            Text(this.showIngredientSelect ? 'â–? : 'â–?)
              .fontSize(12)
              .fontColor('#999')
          }
          .width('100%')
          .padding(12)
          .backgroundColor(this.selectedFeedbacks.includes('ingredient_hard') ? '#FFF5E6' : '#F5F5F5')
          .borderRadius(8)
          .onClick(() => {
            this.showIngredientSelect = !this.showIngredientSelect;
            this.showOtherReason = false;
            if (this.showIngredientSelect) {
              this.toggleFeedback('ingredient_hard');
            }
          })

          // åŸæ–™åˆ—è¡¨ï¼ˆå±•å¼€æ—¶æ˜¾ç¤ºï¼‰
          if (this.showIngredientSelect) {
            Column({ space: 8 }) {
              Text('é€‰æ‹©éš¾ä¹°åˆ°çš„åŸæ–™ï¼?)
                .fontSize(13)
                .fontColor('#666')
                .margin({ bottom: 4 })

              ForEach(this.result.recipe.ingredients, (ing: RecipeIngredient) => {
                Row({ space: 8 }) {
                  Checkbox()
                    .select(this.excludedIngredients.includes(ing.name))
                    .selectedColor(ThemeColors.PRIMARY)
                    .onChange((checked: boolean) => {
                      if (checked) {
                        this.excludedIngredients.push(ing.name);
                      } else {
                        const idx = this.excludedIngredients.indexOf(ing.name);
                        if (idx >= 0) {
                          this.excludedIngredients.splice(idx, 1);
                        }
                      }
                      this.excludedIngredients = [...this.excludedIngredients];
                    })

                  Text(ing.name)
                    .fontSize(14)
                    .fontColor('#1A1A1A')
                    .layoutWeight(1)

                  Text(`${ing.weight}g`)
                    .fontSize(13)
                    .fontColor('#999')
                }
                .width('100%')
                .padding({ left: 8, right: 8, top: 6, bottom: 6 })
              })
            }
            .width('100%')
            .padding(12)
            .backgroundColor('#FAFAFA')
            .borderRadius(8)
          }
        }
        .width('100%')

        // é€‰é¡¹4ï¼šå…¶ä»–åŸå›?
        Column({ space: 8 }) {
          Row({ space: 12 }) {
            Text('ğŸ’¬').fontSize(20)
            Text('å…¶ä»–åŸå› ')
              .fontSize(15)
              .fontColor('#1A1A1A')
              .layoutWeight(1)
            Text(this.showOtherReason ? 'â–? : 'â–?)
              .fontSize(12)
              .fontColor('#999')
          }
          .width('100%')
          .padding(12)
          .backgroundColor(this.selectedFeedbacks.includes('other') ? '#FFF5E6' : '#F5F5F5')
          .borderRadius(8)
          .onClick(() => {
            this.showOtherReason = !this.showOtherReason;
            this.showIngredientSelect = false;
            if (this.showOtherReason) {
              this.toggleFeedback('other');
            }
          })

          // é‚®ç®±æç¤ºï¼ˆå±•å¼€æ—¶æ˜¾ç¤ºï¼‰
          if (this.showOtherReason) {
            Column({ space: 8 }) {
              Text('å¦‚æœ‰å…¶ä»–é—®é¢˜ï¼Œè¯·è”ç³»ï¼?)
                .fontSize(13)
                .fontColor('#666')

              Row({ space: 8 }) {
                Text('ğŸ“§')
                  .fontSize(16)
                Text('2770113524@qq.com')
                  .fontSize(14)
                  .fontColor(ThemeColors.PRIMARY_DARK)
                  .fontWeight(FontWeight.Medium)
              }

              Text('ç¡®è®¤åå°†ç›´æ¥ä¸ºæ‚¨æ›´æ¢é…æ–¹')
                .fontSize(12)
                .fontColor('#999')
            }
            .width('100%')
            .padding(12)
            .backgroundColor('#FAFAFA')
            .borderRadius(8)
            .alignItems(HorizontalAlign.Start)
          }
        }
        .width('100%')

        // æŒ‰é’®
        Row({ space: 12 }) {
          Button('å–æ¶ˆ')
            .fontSize(15)
            .fontColor('#666')
            .backgroundColor('#F5F5F5')
            .layoutWeight(1)
            .height(44)
            .onClick(() => {
              this.showFeedbackDialog = false;
              this.showIngredientSelect = false;
              this.showOtherReason = false;
              this.selectedFeedbacks = [];
              this.excludedIngredients = [];
            })

          Button('é‡æ–°ç”Ÿæˆ')
            .fontSize(15)
            .fontColor(Color.White)
            .backgroundColor(ThemeColors.PRIMARY)
            .layoutWeight(1)
            .height(44)
            .enabled(this.selectedFeedbacks.length > 0 || this.excludedIngredients.length > 0)
            .onClick(() => this.onConfirmFeedback())
        }
        .width('100%')
      }
      .width('100%')
      .padding(20)
    }
    .width('90%')
    .constraintSize({ maxHeight: '70%' })
    .backgroundColor(Color.White)
    .borderRadius(16)
    .position({ x: '5%', y: '15%' })
  }

  @Builder
  FeedbackOptionItem(icon: string, label: string, type: FeedbackType) {
    Row({ space: 12 }) {
      Text(icon).fontSize(20)
      Text(label)
        .fontSize(15)
        .fontColor('#1A1A1A')
        .layoutWeight(1)

      if (this.selectedFeedbacks.includes(type)) {
        Text('âœ?)
          .fontSize(16)
          .fontColor(ThemeColors.PRIMARY_DARK)
      }
    }
    .width('100%')
    .padding(12)
    .backgroundColor(this.selectedFeedbacks.includes(type) ? '#FFF5E6' : '#F5F5F5')
    .borderRadius(8)
    .onClick(() => {
      this.toggleFeedback(type);
      this.showIngredientSelect = false;
      this.showOtherReason = false;
    })
  }
}
