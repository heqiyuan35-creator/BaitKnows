/**
 * é±¼é¥µç”Ÿæˆå™¨ - æŒ‰è®¾è®¡å›¾é‡åš
 */
import { router } from '@kit.ArkUI';
import { ThemeColors } from '../theme/ThemeColors';
import { GenerateRecipeInput, RecipeSeason, RecipeWaterType, FishDensity, FishActivity, FishingMethod, GenerateMode } from '../common/types/RecipeTypes';
import { generateRecipe, getCurrentSeason } from '../services/RecipeGeneratorService';
import { fetchWeather } from '../services/WeatherService';

interface FishItem { id: string; name: string; normalImage: Resource; selectedImage: Resource; }
interface WaterItem { type: RecipeWaterType; name: string; normalImage: Resource; selectedImage: Resource; }
interface SeasonItem { type: RecipeSeason; name: string; normalImage: Resource; selectedImage: Resource; }

@Entry
@Component
struct SmartGeneratorPage {
  @State selectedFish: string = 'carp';
  @State selectedWater: RecipeWaterType = 'river';
  @State selectedSeason: RecipeSeason = 'spring';
  @State temperature: number = 24;
  @State showAdvanced: boolean = false;
  @State fishDensity: FishDensity = 'medium';
  @State fishActivity: FishActivity = 'normal';
  @State fishingMethod: FishingMethod = 'rub';
  @State mode: GenerateMode = 'balanced';
  @State isLoading: boolean = false;
  @State lastRecord: string = 'é¦™è¾£ç‰ç±³';

  private fishList: FishItem[] = [
    { id: 'carp', name: 'é²¤é±¼', normalImage: $r('app.media.Carp'), selectedImage: $r('app.media.Carp') },
    { id: 'crucian', name: 'é²«é±¼', normalImage: $r('app.media.Crucian_carp'), selectedImage: $r('app.media.Crucian_carp') },
    { id: 'grass', name: 'è‰é±¼', normalImage: $r('app.media.Grass_carp'), selectedImage: $r('app.media.Grass_carp') },
    { id: 'catfish', name: 'é²¶é±¼', normalImage: $r('app.media.Catfish'), selectedImage: $r('app.media.Catfish') },
    { id: 'black', name: 'é’é±¼', normalImage: $r('app.media.Black_carp'), selectedImage: $r('app.media.Black_carp') }
  ];

  private waterList: WaterItem[] = [
    { type: 'river', name: 'æ²³æµ', normalImage: $r('app.media.River'), selectedImage: $r('app.media.Rivers') },
    { type: 'wild_pond', name: 'æ¹–æ³Š', normalImage: $r('app.media.Lake'), selectedImage: $r('app.media.Lakes') },
    { type: 'pond', name: 'æ± å¡˜', normalImage: $r('app.media.Pond'), selectedImage: $r('app.media.Ponds') },
    { type: 'reservoir', name: 'æ°´åº“', normalImage: $r('app.media.Reservoir'), selectedImage: $r('app.media.Reservoirs') }
  ];

  private seasonList: SeasonItem[] = [
    { type: 'spring', name: 'æ˜¥å­£', normalImage: $r('app.media.Spring'), selectedImage: $r('app.media.Springs') },
    { type: 'summer', name: 'å¤å­£', normalImage: $r('app.media.Summer'), selectedImage: $r('app.media.Summers') },
    { type: 'autumn', name: 'ç§‹å­£', normalImage: $r('app.media.Autumn'), selectedImage: $r('app.media.Autumns') },
    { type: 'winter', name: 'å†¬å­£', normalImage: $r('app.media.Winter'), selectedImage: $r('app.media.Winters') }
  ];

  aboutToAppear(): void {
    this.selectedSeason = getCurrentSeason();
    this.loadWeather();
  }

  async loadWeather(): Promise<void> {
    try {
      const weather = await fetchWeather();
      if (weather.isValid) {
        this.temperature = Math.round(weather.temperature);
      }
    } catch (err) { console.error('Load weather failed:', err); }
  }


  onGenerate(): void {
    if (!this.selectedFish) return;
    this.isLoading = true;

    const input = new GenerateRecipeInput();
    input.targetFishId = this.selectedFish;
    input.waterType = this.selectedWater;
    input.temperature = this.temperature;
    input.season = this.selectedSeason;
    input.fishDensity = this.fishDensity;
    input.fishActivity = this.fishActivity;
    input.fishingMethod = this.fishingMethod;
    input.mode = this.mode;

    try {
      const recipe = generateRecipe(input);
      const recipeJson = JSON.stringify(recipe);
      this.isLoading = false;
      router.pushUrl({ url: 'pages/GeneratedRecipePage', params: { recipe: recipeJson } });
    } catch (err) {
      console.error('Generate failed:', err);
      this.isLoading = false;
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      Row() {
        Text('é±¼é¥µç”Ÿæˆå™¨').fontSize(18).fontWeight(FontWeight.Bold).fontColor('#1A1A1A')
        Blank()
        Text('âŸ³').fontSize(22).fontColor('#1A1A1A')
      }
      .width('100%').height(56).padding({ left: 20, right: 20 }).margin({ top: 44 })

      Scroll() {
        Column({ space: 24 }) {
          // ç›®æ ‡é±¼ç§
          this.FishSection()

          // æ°´åŸŸç¯å¢ƒ
          this.WaterSection()

          // å­£èŠ‚ä¸å¤©æ°”
          this.SeasonWeatherSection()

          // é«˜çº§é€‰é¡¹
          this.AdvancedSection()

          // ä¸Šæ¬¡è®°å½•
          this.LastRecordSection()
        }
        .width('100%')
        .padding({ left: 20, right: 20, bottom: 120 })
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)

      // åº•éƒ¨ç”ŸæˆæŒ‰é’®
      this.GenerateButton()
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FFFBF5')
  }

  @Builder FishSection() {
    Column({ space: 16 }) {
      Row() {
        Text('ç›®æ ‡é±¼ç§').fontSize(18).fontWeight(FontWeight.Bold).fontColor('#1A1A1A')
        Blank()
        Text('æŸ¥çœ‹å…¨éƒ¨').fontSize(14).fontColor(ThemeColors.PRIMARY)
      }.width('100%')

      Scroll() {
        Row({ space: 12 }) {
          ForEach(this.fishList, (fish: FishItem) => {
            Column({ space: 8 }) {
              Stack() {
                // å›¾ç‰‡ç›´æ¥è®¾ç½®åœ†å½¢
                Image(this.selectedFish === fish.id ? fish.selectedImage : fish.normalImage)
                  .width(66)
                  .height(66)
                  .borderRadius(33)
                  .objectFit(ImageFit.Cover)
                  .border({
                    width: this.selectedFish === fish.id ? 3 : 1,
                    color: this.selectedFish === fish.id ? ThemeColors.PRIMARY : '#E5E5E5'
                  })

                // é€‰ä¸­å‹¾é€‰æ ‡è®°
                if (this.selectedFish === fish.id) {
                  Row() {
                    Text('âœ“').fontSize(11).fontColor(Color.White)
                  }
                  .width(18)
                  .height(18)
                  .borderRadius(9)
                  .backgroundColor(ThemeColors.PRIMARY)
                  .justifyContent(FlexAlign.Center)
                  .position({ x: 48, y: 48 })
                }
              }
              .width(66)
              .height(66)

              Text(fish.name)
                .fontSize(13)
                .fontColor(this.selectedFish === fish.id ? ThemeColors.PRIMARY : '#666')
            }
            .onClick(() => { this.selectedFish = fish.id; })
          })
        }
      }
      .scrollable(ScrollDirection.Horizontal)
      .scrollBar(BarState.Off)
    }.width('100%').alignItems(HorizontalAlign.Start)
  }


  @Builder WaterSection() {
    Column({ space: 12 }) {
      Text('æ°´åŸŸç¯å¢ƒ').fontSize(18).fontWeight(FontWeight.Bold).fontColor('#1A1A1A')

      Flex({ wrap: FlexWrap.Wrap }) {
        ForEach(this.waterList, (water: WaterItem) => {
          Row({ space: 6 }) {
            Image(this.selectedWater === water.type ? water.selectedImage : water.normalImage)
              .width(20).height(20)
            Text(water.name).fontSize(14)
              .fontColor(this.selectedWater === water.type ? ThemeColors.PRIMARY : '#666')
          }
          .height(40)
          .padding({ left: 16, right: 16 })
          .backgroundColor(this.selectedWater === water.type ? '#FFF5E6' : Color.White)
          .borderRadius(20)
          .border({
            width: 1,
            color: this.selectedWater === water.type ? ThemeColors.PRIMARY : '#E5E5E5'
          })
          .margin({ right: 10, bottom: 10 })
          .onClick(() => { this.selectedWater = water.type; })
        })
      }
    }.width('100%').alignItems(HorizontalAlign.Start)
  }

  @Builder SeasonWeatherSection() {
    Column({ space: 16 }) {
      Text('å­£èŠ‚ä¸å¤©æ°”').fontSize(18).fontWeight(FontWeight.Bold).fontColor('#1A1A1A')

      // æ¸©åº¦æ»‘å—å¡ç‰‡
      Column({ space: 12 }) {
        Row() {
          Row({ space: 6 }) {
            Text('ğŸŒ¡').fontSize(16)
            Text('æ°”æ¸©').fontSize(15).fontColor('#1A1A1A')
          }
          Blank()
          Text(`${this.temperature}Â°C`).fontSize(18).fontWeight(FontWeight.Bold).fontColor(ThemeColors.PRIMARY)
        }.width('100%')

        Slider({
          value: this.temperature,
          min: 0,
          max: 40,
          step: 1,
          style: SliderStyle.OutSet
        })
          .selectedColor(ThemeColors.PRIMARY)
          .trackColor('#F0F0F0')
          .blockColor(ThemeColors.PRIMARY)
          .onChange((value: number) => {
            this.temperature = Math.round(value);
            // æ ¹æ®æ¸©åº¦è‡ªåŠ¨è°ƒæ•´å­£èŠ‚
            if (this.temperature < 10) this.selectedSeason = 'winter';
            else if (this.temperature < 20) this.selectedSeason = 'spring';
            else if (this.temperature < 30) this.selectedSeason = 'summer';
            else this.selectedSeason = 'autumn';
          })

        Row() {
          Text('å¯’å†· (0Â°C)').fontSize(12).fontColor('#999')
          Blank()
          Text('ç‚çƒ­ (40Â°C)').fontSize(12).fontColor('#999')
        }.width('100%')
      }
      .width('100%')
      .padding(16)
      .backgroundColor(Color.White)
      .borderRadius(12)

      // å­£èŠ‚é€‰æ‹© 2x2 ç½‘æ ¼
      Grid() {
        ForEach(this.seasonList, (season: SeasonItem) => {
          GridItem() {
            Column({ space: 8 }) {
              Image(this.selectedSeason === season.type ? season.selectedImage : season.normalImage)
                .width(36).height(36)
              Text(season.name).fontSize(14)
                .fontColor(this.selectedSeason === season.type ? ThemeColors.PRIMARY : '#666')
            }
            .width('100%')
            .height(80)
            .justifyContent(FlexAlign.Center)
            .backgroundColor(this.selectedSeason === season.type ? '#FFF5E6' : Color.White)
            .borderRadius(12)
            .border({
              width: this.selectedSeason === season.type ? 2 : 1,
              color: this.selectedSeason === season.type ? ThemeColors.PRIMARY : '#F0F0F0'
            })
            .onClick(() => { this.selectedSeason = season.type; })
          }
        })
      }
      .columnsTemplate('1fr 1fr')
      .rowsGap(12)
      .columnsGap(12)
      .width('100%')
      .height(172)
    }.width('100%').alignItems(HorizontalAlign.Start)
  }


  @Builder AdvancedSection() {
    Column({ space: 12 }) {
      Row() {
        Text('âš™').fontSize(16).fontColor('#666')
        Text('é«˜çº§é€‰é¡¹').fontSize(16).fontColor('#1A1A1A').margin({ left: 8 })
        Blank()
        Text(this.showAdvanced ? 'âˆ§' : 'âˆ¨').fontSize(16).fontColor('#999')
      }
      .width('100%')
      .height(50)
      .padding({ left: 16, right: 16 })
      .backgroundColor(Color.White)
      .borderRadius(12)
      .onClick(() => { this.showAdvanced = !this.showAdvanced; })

      if (this.showAdvanced) {
        Column({ space: 16 }) {
          // é±¼æƒ…
          Column({ space: 8 }) {
            Text('é±¼æƒ…åˆ¤æ–­').fontSize(14).fontColor('#666')
            Row({ space: 8 }) {
              this.OptionChip('å¯†åº¦é«˜', this.fishDensity === 'high', () => { this.fishDensity = 'high'; })
              this.OptionChip('å¯†åº¦ä¸­', this.fishDensity === 'medium', () => { this.fishDensity = 'medium'; })
              this.OptionChip('å¯†åº¦ä½', this.fishDensity === 'low', () => { this.fishDensity = 'low'; })
            }
            Row({ space: 8 }) {
              this.OptionChip('å¼€å£å¥½', this.fishActivity === 'good', () => { this.fishActivity = 'good'; })
              this.OptionChip('å¼€å£ä¸€èˆ¬', this.fishActivity === 'normal', () => { this.fishActivity = 'normal'; })
              this.OptionChip('å¼€å£å·®', this.fishActivity === 'poor', () => { this.fishActivity = 'poor'; })
            }
          }.width('100%').alignItems(HorizontalAlign.Start)

          // é’“æ³•
          Column({ space: 8 }) {
            Text('ä½œé’“æ–¹å¼').fontSize(14).fontColor('#666')
            Row({ space: 8 }) {
              this.OptionChip('æ“é¥µ', this.fishingMethod === 'rub', () => { this.fishingMethod = 'rub'; })
              this.OptionChip('æ‹‰é¥µ', this.fishingMethod === 'pull', () => { this.fishingMethod = 'pull'; })
              this.OptionChip('æ•£ç‚®', this.fishingMethod === 'scatter', () => { this.fishingMethod = 'scatter'; })
              this.OptionChip('åŒ…é£Ÿ', this.fishingMethod === 'wrap', () => { this.fishingMethod = 'wrap'; })
            }
          }.width('100%').alignItems(HorizontalAlign.Start)

          // æ¨¡å¼
          Column({ space: 8 }) {
            Text('ç”Ÿæˆæ¨¡å¼').fontSize(14).fontColor('#666')
            Row({ space: 8 }) {
              this.OptionChip('ä¿å®ˆ', this.mode === 'conservative', () => { this.mode = 'conservative'; })
              this.OptionChip('å‡è¡¡', this.mode === 'balanced', () => { this.mode = 'balanced'; })
              this.OptionChip('æ¿€è¿›', this.mode === 'aggressive', () => { this.mode = 'aggressive'; })
            }
          }.width('100%').alignItems(HorizontalAlign.Start)
        }
        .width('100%')
        .padding(16)
        .backgroundColor(Color.White)
        .borderRadius(12)
      }
    }.width('100%').alignItems(HorizontalAlign.Start)
  }

  @Builder OptionChip(label: string, selected: boolean, onClick: () => void) {
    Text(label)
      .fontSize(13)
      .fontColor(selected ? ThemeColors.PRIMARY : '#666')
      .padding({ left: 14, right: 14, top: 8, bottom: 8 })
      .backgroundColor(selected ? '#FFF5E6' : '#F5F5F5')
      .borderRadius(16)
      .border({ width: selected ? 1 : 0, color: ThemeColors.PRIMARY })
      .onClick(onClick)
  }

  @Builder LastRecordSection() {
    Row() {
      Row({ space: 6 }) {
        Text('â±').fontSize(14).fontColor('#999')
        Text(`ä¸Šæ¬¡è®°å½•: ${this.lastRecord}`).fontSize(13).fontColor('#666')
      }
      Blank()
      Text('è½½å…¥').fontSize(14).fontColor(ThemeColors.PRIMARY)
    }
    .width('100%')
    .padding({ left: 4, right: 4 })
  }

  @Builder GenerateButton() {
    Column() {
      Button() {
        Row({ space: 8 }) {
          if (this.isLoading) {
            LoadingProgress().width(20).height(20).color(Color.White)
          } else {
            Text('âœ¦').fontSize(16).fontColor(Color.White)
          }
          Text(this.isLoading ? 'ç”Ÿæˆä¸­...' : 'ç”Ÿæˆé…æ–¹')
            .fontSize(16).fontColor(Color.White).fontWeight(FontWeight.Medium)
        }
      }
      .width('100%')
      .height(52)
      .backgroundColor(ThemeColors.PRIMARY)
      .borderRadius(26)
      .enabled(!this.isLoading)
      .onClick(() => this.onGenerate())
    }
    .width('100%')
    .padding({ left: 20, right: 20, bottom: 34, top: 12 })
    .backgroundColor('#FFFBF5')
  }
}
