/**
 * é¥µçŸ¥é?- æ¸”è·åˆ†æé¡µé¢ï¼ˆåˆ›æ„ç‰ˆï¼?
 * é’“é±¼æˆå°±ã€ä¸ªäººç”»åƒã€è¶£å‘³æ•°æ?
 */
import { ThemeColors } from '../theme/ThemeColors';
import { ThemeConstants } from '../theme/ThemeConstants';
import { Router } from '../router/Router';
import { FishingRecord } from '../common/types/UserTypes';
import { fishingRecordService } from '../services/FishingRecordService';

// æˆå°±å®šä¹‰
class Achievement {
  id: string = '';
  name: string = '';
  icon: string = '';
  desc: string = '';
  unlocked: boolean = false;
  progress: number = 0;
  target: number = 1;
}

// é’“é±¼ç”»åƒæ ‡ç­¾
class ProfileTag {
  label: string = '';
  color: string = '';
  icon: string = '';
}

// é…æ–¹ç»Ÿè®¡
class RecipeStats {
  name: string = '';
  recipeId: string = '';
  trips: number = 0;
  totalWeight: number = 0;
  avgWeight: number = 0;
}

class RecipeMapValue {
  recipeId: string = '';
  trips: number = 0;
  totalWeight: number = 0;
}

// é±¼ç§ç»Ÿè®¡
class FishStats {
  name: string = '';
  weight: number = 0;
  count: number = 0;
  percentage: number = 0;
}

class FishMapValue {
  weight: number = 0;
  count: number = 0;
}

@Entry
@Component
struct RecordAnalysisPage {
  @State records: FishingRecord[] = [];
  @State isLoading: boolean = true;
  @State achievements: Achievement[] = [];
  @State profileTags: ProfileTag[] = [];
  @State recipeStats: RecipeStats[] = [];
  @State fishStats: FishStats[] = [];
  @State mvpRecipe: RecipeStats | null = null;
  
  // åŸºç¡€ç»Ÿè®¡
  @State totalWeight: number = 0;
  @State totalTrips: number = 0;
  @State totalCount: number = 0;
  @State maxSingle: number = 0;
  @State avgWeight: number = 0;
  @State favoriteFish: string = '';
  @State favoriteLocation: string = '';
  @State favoriteWeather: string = '';
  
  // è¶£å‘³æ•°æ®
  @State funFacts: string[] = [];

  aboutToAppear(): void {
    this.loadAndAnalyze();
  }

  private async loadAndAnalyze(): Promise<void> {
    this.isLoading = true;
    await fishingRecordService.load();
    this.records = fishingRecordService.records;
    if (this.records.length > 0) {
      this.calculateBasicStats();
      this.generateAchievements();
      this.generateProfileTags();
      this.generateFunFacts();
      this.analyzeRecipes();
      this.analyzeFish();
    }
    this.isLoading = false;
  }

  private calculateBasicStats(): void {
    this.totalTrips = this.records.length;
    let sumWeight = 0;
    let sumCount = 0;
    let maxW = 0;
    
    const locationMap = new Map<string, number>();
    const weatherMap = new Map<string, number>();
    const fishMap = new Map<string, number>();
    
    for (const r of this.records) {
      sumWeight += r.weight;
      sumCount += r.count;
      if (r.maxSingle > maxW) maxW = r.maxSingle;
      
      // ç»Ÿè®¡æœ€çˆ±é’“ç‚?
      const loc = r.location || 'æœªçŸ¥';
      locationMap.set(loc, (locationMap.get(loc) || 0) + r.weight);
      
      // ç»Ÿè®¡æœ€çˆ±å¤©æ°?
      const weather = r.weather || 'æœªçŸ¥';
      weatherMap.set(weather, (weatherMap.get(weather) || 0) + r.weight);
      
      // ç»Ÿè®¡æœ€çˆ±é±¼ç§?
      const fishNames = r.fishName.split('ã€?);
      for (const f of fishNames) {
        const name = f.trim();
        if (name) fishMap.set(name, (fishMap.get(name) || 0) + 1);
      }
    }
    
    this.totalWeight = Math.round(sumWeight * 10) / 10;
    this.totalCount = sumCount;
    this.maxSingle = Math.round(maxW * 10) / 10;
    this.avgWeight = this.totalTrips > 0 ? Math.round((sumWeight / this.totalTrips) * 10) / 10 : 0;
    
    // æ‰¾æœ€çˆ?
    let maxLoc = '';
    let maxLocW = 0;
    locationMap.forEach((w, loc) => { if (w > maxLocW) { maxLocW = w; maxLoc = loc; } });
    this.favoriteLocation = maxLoc;
    
    let maxWeather = '';
    let maxWeatherW = 0;
    weatherMap.forEach((w, weather) => { if (w > maxWeatherW) { maxWeatherW = w; maxWeather = weather; } });
    this.favoriteWeather = maxWeather;
    
    let maxFish = '';
    let maxFishC = 0;
    fishMap.forEach((c, fish) => { if (c > maxFishC) { maxFishC = c; maxFish = fish; } });
    this.favoriteFish = maxFish;
  }


  private generateAchievements(): void {
    const list: Achievement[] = [];
    
    // åˆå‡ºèŒ…åº - ç¬¬ä¸€æ¬¡è®°å½?
    const a1 = new Achievement();
    a1.id = 'first'; a1.name = 'åˆå‡ºèŒ…åº'; a1.icon = 'ğŸ£';
    a1.desc = 'å®Œæˆç¬¬ä¸€æ¬¡æ¸”è·è®°å½?; a1.target = 1;
    a1.progress = Math.min(this.totalTrips, 1);
    a1.unlocked = this.totalTrips >= 1;
    list.push(a1);
    
    // é’“é±¼è¾¾äºº - å‡ºé’“10æ¬?
    const a2 = new Achievement();
    a2.id = 'trips10'; a2.name = 'é’“é±¼è¾¾äºº'; a2.icon = 'ğŸ†';
    a2.desc = 'ç´¯è®¡å‡ºé’“10æ¬?; a2.target = 10;
    a2.progress = Math.min(this.totalTrips, 10);
    a2.unlocked = this.totalTrips >= 10;
    list.push(a2);
    
    // ç™¾æ–¤æ¸”ç‹ - æ€»æ¸”è?00kg
    const a3 = new Achievement();
    a3.id = 'weight100'; a3.name = 'ç™¾æ–¤æ¸”ç‹'; a3.icon = 'ğŸ‘‘';
    a3.desc = 'ç´¯è®¡æ¸”è·è¾?00kg'; a3.target = 100;
    a3.progress = Math.min(this.totalWeight, 100);
    a3.unlocked = this.totalWeight >= 100;
    list.push(a3);
    
    // å¤§ç‰©çŒæ‰‹ - å•å°¾è¶?kg
    const a4 = new Achievement();
    a4.id = 'big5'; a4.name = 'å¤§ç‰©çŒæ‰‹'; a4.icon = 'ğŸ¦ˆ';
    a4.desc = 'é’“è·å•å°¾è¶?kgçš„å¤§é±?; a4.target = 5;
    a4.progress = Math.min(this.maxSingle, 5);
    a4.unlocked = this.maxSingle >= 5;
    list.push(a4);
    
    // æ•ˆç‡ä¹‹ç‹ - åœºå‡è¶?0kg
    const a5 = new Achievement();
    a5.id = 'avg10'; a5.name = 'æ•ˆç‡ä¹‹ç‹'; a5.icon = 'âš?;
    a5.desc = 'åœºå‡æ¸”è·è¶…è¿‡10kg'; a5.target = 10;
    a5.progress = Math.min(this.avgWeight, 10);
    a5.unlocked = this.avgWeight >= 10;
    list.push(a5);
    
    // å¤šå¤šç›Šå–„ - å•æ¬¡é’“è·10å°¾ä»¥ä¸?
    let maxCount = 0;
    for (const r of this.records) { if (r.count > maxCount) maxCount = r.count; }
    const a6 = new Achievement();
    a6.id = 'count10'; a6.name = 'å¤šå¤šç›Šå–„'; a6.icon = 'ğŸŸ';
    a6.desc = 'å•æ¬¡é’“è·10å°¾ä»¥ä¸?; a6.target = 10;
    a6.progress = Math.min(maxCount, 10);
    a6.unlocked = maxCount >= 10;
    list.push(a6);
    
    this.achievements = list;
  }

  private generateProfileTags(): void {
    const tags: ProfileTag[] = [];
    
    // æ ¹æ®å‡ºé’“é¢‘ç‡
    if (this.totalTrips >= 20) {
      const t = new ProfileTag(); t.label = 'é’“é±¼ç‹‚çƒ­è€?; t.color = '#FF6B6B'; t.icon = 'ğŸ”¥'; tags.push(t);
    } else if (this.totalTrips >= 10) {
      const t = new ProfileTag(); t.label = 'èµ„æ·±é’“å‹'; t.color = '#4ECDC4'; t.icon = 'â­?; tags.push(t);
    } else if (this.totalTrips >= 5) {
      const t = new ProfileTag(); t.label = 'é’“é±¼çˆ±å¥½è€?; t.color = '#45B7D1'; t.icon = 'ğŸ’™'; tags.push(t);
    }
    
    // æ ¹æ®åœºå‡æ¸”è·
    if (this.avgWeight >= 20) {
      const t = new ProfileTag(); t.label = 'çˆ†æŠ¤ä¸“å®¶'; t.color = '#F7DC6F'; t.icon = 'ğŸ’°'; tags.push(t);
    } else if (this.avgWeight >= 10) {
      const t = new ProfileTag(); t.label = 'ç¨³å®šè¾“å‡º'; t.color = '#82E0AA'; t.icon = 'ğŸ“ˆ'; tags.push(t);
    }
    
    // æ ¹æ®æœ€å¤§å•å°?
    if (this.maxSingle >= 10) {
      const t = new ProfileTag(); t.label = 'å·¨ç‰©ç»ˆç»“è€?; t.color = '#BB8FCE'; t.icon = 'ğŸ¦ˆ'; tags.push(t);
    } else if (this.maxSingle >= 5) {
      const t = new ProfileTag(); t.label = 'å¤§ç‰©çŒäºº'; t.color = '#F8B500'; t.icon = 'ğŸ¯'; tags.push(t);
    }
    
    // æ ¹æ®æœ€çˆ±å¤©æ°?
    if (this.favoriteWeather === 'å°é›¨') {
      const t = new ProfileTag(); t.label = 'é›¨ä¸­å‚é’“è€?; t.color = '#5DADE2'; t.icon = 'ğŸŒ§ï¸?; tags.push(t);
    } else if (this.favoriteWeather === 'æ™´æœ—') {
      const t = new ProfileTag(); t.label = 'é˜³å…‰é’“æ‰‹'; t.color = '#F39C12'; t.icon = 'â˜€ï¸?; tags.push(t);
    }
    
    // é»˜è®¤æ ‡ç­¾
    if (tags.length === 0) {
      const t = new ProfileTag(); t.label = 'é’“é±¼æ–°æ‰‹'; t.color = '#85C1E9'; t.icon = 'ğŸŒ±'; tags.push(t);
    }
    
    this.profileTags = tags.slice(0, 4);
  }

  private generateFunFacts(): void {
    const facts: string[] = [];
    
    // é±¼æ±¤è®¡ç®—ï¼ˆå‡è®?kgé±¼å¯ä»¥åš2ç¢—é±¼æ±¤ï¼‰
    const soupCount = Math.round(this.totalWeight * 2);
    if (soupCount > 0) facts.push(`ğŸœ ä½ çš„æ¸”è·å¯ä»¥å?${soupCount} ç¢—é±¼æ±¤`);
    
    // æ—¶é—´è®¡ç®—ï¼ˆå‡è®¾æ¯æ¬¡å‡ºé’“å¹³å?å°æ—¶ï¼?
    const hours = this.totalTrips * 4;
    if (hours >= 24) {
      const days = Math.round(hours / 24 * 10) / 10;
      facts.push(`â?ä½ å·²åœ¨æ°´è¾¹åº¦è¿‡çº¦ ${days} å¤©`);
    } else if (hours > 0) {
      facts.push(`â?ä½ å·²åœ¨æ°´è¾¹åº¦è¿‡çº¦ ${hours} å°æ—¶`);
    }
    
    // é‡é‡æ¯”å–»
    if (this.totalWeight >= 100) {
      facts.push(`âš–ï¸ æ¸”è·æ€»é‡ç›¸å½“äº?${Math.round(this.totalWeight / 50)} è¢‹å¤§ç±³`);
    } else if (this.totalWeight >= 10) {
      facts.push(`âš–ï¸ æ¸”è·æ€»é‡ç›¸å½“äº?${Math.round(this.totalWeight / 3)} åªçŒ«å’ª`);
    }
    
    // é±¼çš„æ•°é‡
    if (this.totalCount >= 100) {
      facts.push(`ğŸŸ é’“è·çš„é±¼å¯ä»¥ç»„æˆä¸€ä¸ªå°é±¼ç¾¤äº†ï¼`);
    } else if (this.totalCount >= 50) {
      facts.push(`ğŸŸ ä½ å·²ç»é’“äº†ä¸€ä¸ªé±¼ç¼¸çš„é‡ï¼`);
    }
    
    this.funFacts = facts;
  }


  private analyzeRecipes(): void {
    const recipeMap = new Map<string, RecipeMapValue>();
    for (const r of this.records) {
      if (!r.recipeName) continue;
      let existing = recipeMap.get(r.recipeName);
      if (!existing) {
        existing = new RecipeMapValue();
        existing.recipeId = r.recipeId || '';
        recipeMap.set(r.recipeName, existing);
      }
      existing.trips += 1;
      existing.totalWeight += r.weight;
    }
    
    const result: RecipeStats[] = [];
    recipeMap.forEach((v, k) => {
      const s = new RecipeStats();
      s.name = k; s.recipeId = v.recipeId; s.trips = v.trips;
      s.totalWeight = Math.round(v.totalWeight * 10) / 10;
      s.avgWeight = Math.round((v.totalWeight / v.trips) * 10) / 10;
      result.push(s);
    });
    this.recipeStats = result.sort((a, b) => b.totalWeight - a.totalWeight).slice(0, 3);
    if (this.recipeStats.length > 0) this.mvpRecipe = this.recipeStats[0];
  }

  private analyzeFish(): void {
    const fishMap = new Map<string, FishMapValue>();
    for (const r of this.records) {
      const names = r.fishName.split('ã€?);
      const wPerFish = r.weight / names.length;
      const cPerFish = Math.ceil(r.count / names.length);
      for (const f of names) {
        const name = f.trim();
        if (!name) continue;
        let existing = fishMap.get(name);
        if (!existing) { existing = new FishMapValue(); fishMap.set(name, existing); }
        existing.weight += wPerFish;
        existing.count += cPerFish;
      }
    }
    
    let totalW = 0;
    fishMap.forEach(v => { totalW += v.weight; });
    
    const result: FishStats[] = [];
    fishMap.forEach((v, k) => {
      const s = new FishStats();
      s.name = k; s.weight = Math.round(v.weight * 10) / 10;
      s.count = v.count; s.percentage = Math.round((v.weight / totalW) * 100);
      result.push(s);
    });
    this.fishStats = result.sort((a, b) => b.weight - a.weight).slice(0, 5);
  }

  build() {
    Column() {
      this.HeaderBar()
      if (this.isLoading) {
        this.LoadingView()
      } else if (this.records.length === 0) {
        this.EmptyView()
      } else {
        Scroll() {
          Column({ space: 16 }) {
            this.ProfileSection()
            this.AchievementSection()
            this.FunFactsSection()
            this.MVPSection()
            this.FishRankSection()
          }
          .padding({ left: 16, right: 16, bottom: 40 })
        }
        .layoutWeight(1).scrollBar(BarState.Off)
      }
    }
    .width('100%').height('100%').backgroundColor(ThemeColors.BG_PRIMARY)
  }

  @Builder
  HeaderBar() {
    Column() {
      Row().width('100%').height(36)
      Row() {
        Image($r('app.media.Left')).width(24).height(24)
          .fillColor(ThemeColors.TEXT_PRIMARY).onClick(() => Router.back())
        Blank()
        Text('æ¸”è·åˆ†æ').fontSize(18).fontWeight(FontWeight.Medium).fontColor(ThemeColors.TEXT_PRIMARY)
        Blank()
        Row().width(24)
      }
      .width('100%').height(48).padding({ left: 16, right: 16 })
    }
    .width('100%')
  }

  @Builder
  LoadingView() {
    Column({ space: 12 }) {
      LoadingProgress().width(48).height(48).color(ThemeColors.PRIMARY)
      Text('æ­£åœ¨åˆ†æä½ çš„é’“é±¼æ•°æ®...').fontSize(14).fontColor(ThemeColors.TEXT_SECONDARY)
    }
    .width('100%').layoutWeight(1).justifyContent(FlexAlign.Center)
  }

  @Builder
  EmptyView() {
    Column({ space: 16 }) {
      Text('ğŸ“Š').fontSize(56)
      Text('æš‚æ— æ¸”è·æ•°æ®').fontSize(18).fontColor(ThemeColors.TEXT_PRIMARY)
      Text('è®°å½•ä½ çš„ç¬¬ä¸€æ¬¡æ¸”è·ï¼Œå¼€å¯é’“é±¼ä¹‹æ—?).fontSize(14).fontColor(ThemeColors.TEXT_SECONDARY)
      Button('å»è®°å½?).fontSize(14).fontColor(Color.White).backgroundColor(ThemeColors.PRIMARY)
        .borderRadius(20).height(40).padding({ left: 24, right: 24 }).margin({ top: 8 })
        .onClick(() => Router.push('pages/AddRecordPage'))
    }
    .width('100%').layoutWeight(1).justifyContent(FlexAlign.Center)
  }


  @Builder
  ProfileSection() {
    Column({ space: 16 }) {
      // ä¸ªäººç”»åƒæ ‡é¢˜
      Row({ space: 8 }) {
        Text('ğŸ­').fontSize(20)
        Text('æˆ‘çš„é’“é±¼ç”»åƒ').fontSize(16).fontWeight(FontWeight.Bold).fontColor(ThemeColors.TEXT_PRIMARY)
      }
      .width('100%')

      // æ ¸å¿ƒæ•°æ®å±•ç¤º
      Row() {
        Column({ space: 4 }) {
          Text(`${this.totalTrips}`).fontSize(32).fontWeight(FontWeight.Bold).fontColor(ThemeColors.PRIMARY_DARK)
          Text('å‡ºé’“æ¬¡æ•°').fontSize(12).fontColor(ThemeColors.TEXT_SECONDARY)
        }
        .layoutWeight(1).alignItems(HorizontalAlign.Center)

        Column({ space: 4 }) {
          Row() {
            Text(`${this.totalWeight}`).fontSize(32).fontWeight(FontWeight.Bold).fontColor(ThemeColors.SUCCESS)
            Text('kg').fontSize(14).fontColor(ThemeColors.TEXT_SECONDARY).margin({ top: 16 })
          }
          Text('æ€»æ¸”è?).fontSize(12).fontColor(ThemeColors.TEXT_SECONDARY)
        }
        .layoutWeight(1).alignItems(HorizontalAlign.Center)

        Column({ space: 4 }) {
          Row() {
            Text(`${this.maxSingle}`).fontSize(32).fontWeight(FontWeight.Bold).fontColor(ThemeColors.WARNING)
            Text('kg').fontSize(14).fontColor(ThemeColors.TEXT_SECONDARY).margin({ top: 16 })
          }
          Text('æœ€å¤§å•å°?).fontSize(12).fontColor(ThemeColors.TEXT_SECONDARY)
        }
        .layoutWeight(1).alignItems(HorizontalAlign.Center)
      }
      .width('100%').padding({ top: 8, bottom: 8 })

      // ä¸ªäººæ ‡ç­¾
      if (this.profileTags.length > 0) {
        Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Center }) {
          ForEach(this.profileTags, (tag: ProfileTag) => {
            Row({ space: 4 }) {
              Text(tag.icon).fontSize(12)
              Text(tag.label).fontSize(12).fontColor(Color.White)
            }
            .padding({ left: 10, right: 10, top: 6, bottom: 6 })
            .backgroundColor(tag.color)
            .borderRadius(14)
            .margin({ right: 8, bottom: 8 })
          }, (tag: ProfileTag) => tag.label)
        }
        .width('100%')
      }

      // æœ€çˆ±ä¿¡æ?
      Row({ space: 8 }) {
        this.FavoriteItem('ğŸŸ', 'æœ€çˆ±é±¼ç§?, this.favoriteFish || '--')
        this.FavoriteItem('ğŸ“', 'å¸¸å»é’“ç‚¹', this.favoriteLocation || '--')
        this.FavoriteItem('ğŸŒ¤ï¸?, 'åçˆ±å¤©æ°”', this.favoriteWeather || '--')
      }
      .width('100%')
    }
    .width('100%').padding(16)
    .linearGradient({
      direction: GradientDirection.RightBottom,
      colors: [['#FFF8F0', 0], ['#FFF3E8', 1]]
    })
    .borderRadius(16)
  }

  @Builder
  FavoriteItem(icon: string, label: string, value: string) {
    Column({ space: 4 }) {
      Text(icon).fontSize(16)
      Text(value).fontSize(13).fontWeight(FontWeight.Medium).fontColor(ThemeColors.TEXT_PRIMARY)
        .maxLines(1).textOverflow({ overflow: TextOverflow.Ellipsis })
      Text(label).fontSize(10).fontColor(ThemeColors.TEXT_MUTED)
    }
    .layoutWeight(1).padding(8).backgroundColor('rgba(255,255,255,0.8)')
    .borderRadius(8).alignItems(HorizontalAlign.Center)
  }

  @Builder
  AchievementSection() {
    Column({ space: 12 }) {
      Row({ space: 8 }) {
        Text('ğŸ…').fontSize(20)
        Text('é’“é±¼æˆå°±').fontSize(16).fontWeight(FontWeight.Bold).fontColor(ThemeColors.TEXT_PRIMARY)
        Blank()
        Text(`${this.achievements.filter(a => a.unlocked).length}/${this.achievements.length}`)
          .fontSize(12).fontColor(ThemeColors.TEXT_SECONDARY)
      }
      .width('100%')

      // æˆå°±ç½‘æ ¼
      Flex({ wrap: FlexWrap.Wrap }) {
        ForEach(this.achievements, (ach: Achievement) => {
          Column({ space: 6 }) {
            Stack() {
              Text(ach.icon).fontSize(28).opacity(ach.unlocked ? 1 : 0.3)
              if (!ach.unlocked) {
                Text('ğŸ”’').fontSize(14).position({ x: '60%', y: '60%' })
              }
            }
            .width(48).height(48)

            Text(ach.name).fontSize(11).fontColor(ach.unlocked ? ThemeColors.TEXT_PRIMARY : ThemeColors.TEXT_MUTED)
              .fontWeight(ach.unlocked ? FontWeight.Medium : FontWeight.Normal)

            if (!ach.unlocked) {
              // è¿›åº¦æ?
              Stack({ alignContent: Alignment.Start }) {
                Row().width('100%').height(4).backgroundColor(ThemeColors.BG_TERTIARY).borderRadius(2)
                Row().width(`${(ach.progress / ach.target) * 100}%`).height(4)
                  .backgroundColor(ThemeColors.PRIMARY).borderRadius(2)
              }
              .width('80%')
            }
          }
          .width('33%').padding(8).alignItems(HorizontalAlign.Center)
        }, (ach: Achievement) => ach.id)
      }
      .width('100%')
    }
    .width('100%').padding(16).backgroundColor(ThemeColors.BG_CARD).borderRadius(16)
  }


  @Builder
  FunFactsSection() {
    if (this.funFacts.length > 0) {
      Column({ space: 12 }) {
        Row({ space: 8 }) {
          Text('âœ?).fontSize(20)
          Text('è¶£å‘³æ•°æ®').fontSize(16).fontWeight(FontWeight.Bold).fontColor(ThemeColors.TEXT_PRIMARY)
        }
        .width('100%')

        Column({ space: 8 }) {
          ForEach(this.funFacts, (fact: string, index: number) => {
            Row() {
              Text(fact).fontSize(14).fontColor(ThemeColors.TEXT_PRIMARY).layoutWeight(1)
            }
            .width('100%').padding(12)
            .backgroundColor(index % 2 === 0 ? 'rgba(232, 168, 73, 0.1)' : 'rgba(76, 175, 80, 0.1)')
            .borderRadius(8)
          }, (fact: string, index: number) => `fact_${index}`)
        }
        .width('100%')
      }
      .width('100%').padding(16).backgroundColor(ThemeColors.BG_CARD).borderRadius(16)
    }
  }

  @Builder
  MVPSection() {
    Column({ space: 12 }) {
      Row({ space: 8 }) {
        Text('ğŸ†').fontSize(20)
        Text('é…æ–¹MVP').fontSize(16).fontWeight(FontWeight.Bold).fontColor(ThemeColors.TEXT_PRIMARY)
      }
      .width('100%')

      if (this.mvpRecipe === null) {
        Column({ space: 8 }) {
          Text('ğŸ§ª').fontSize(36).opacity(0.5)
          Text('æš‚æ— é…æ–¹æ•°æ®').fontSize(14).fontColor(ThemeColors.TEXT_SECONDARY)
          Text('è®°å½•æ—¶å…³è”é…æ–¹ï¼Œçœ‹çœ‹å“ªä¸ªæœ€ç»™åŠ›').fontSize(12).fontColor(ThemeColors.TEXT_MUTED)
        }
        .width('100%').padding({ top: 16, bottom: 16 }).alignItems(HorizontalAlign.Center)
      } else {
        // MVPå¡ç‰‡
        Row({ space: 12 }) {
          Column() {
            Text('ğŸ¥‡').fontSize(36)
          }
          .width(64).height(64)
          .linearGradient({ direction: GradientDirection.Bottom, colors: [['#FFD700', 0], ['#FFA500', 1]] })
          .borderRadius(32).justifyContent(FlexAlign.Center)

          Column({ space: 4 }) {
            Text(this.mvpRecipe.name).fontSize(16).fontWeight(FontWeight.Bold)
              .fontColor(ThemeColors.TEXT_PRIMARY).maxLines(1).textOverflow({ overflow: TextOverflow.Ellipsis })
            Text(`ä½¿ç”¨ ${this.mvpRecipe.trips} æ¬¡`).fontSize(12).fontColor(ThemeColors.TEXT_SECONDARY)
          }
          .alignItems(HorizontalAlign.Start).layoutWeight(1)

          Column({ space: 2 }) {
            Row() {
              Text(`${this.mvpRecipe.totalWeight}`).fontSize(24).fontWeight(FontWeight.Bold).fontColor(ThemeColors.PRIMARY_DARK)
              Text('kg').fontSize(12).fontColor(ThemeColors.TEXT_SECONDARY).margin({ left: 2, top: 10 })
            }
            Text('æ€»æ¸”è?).fontSize(10).fontColor(ThemeColors.TEXT_MUTED)
          }
          .alignItems(HorizontalAlign.End)
        }
        .width('100%').padding(12).backgroundColor('rgba(255, 215, 0, 0.1)').borderRadius(12)

        // å…¶ä»–é…æ–¹
        if (this.recipeStats.length > 1) {
          Column({ space: 6 }) {
            ForEach(this.recipeStats.slice(1), (recipe: RecipeStats, index: number) => {
              Row({ space: 8 }) {
                Text(index === 0 ? 'ğŸ¥ˆ' : 'ğŸ¥‰').fontSize(16)
                Text(recipe.name).fontSize(13).fontColor(ThemeColors.TEXT_PRIMARY)
                  .layoutWeight(1).maxLines(1).textOverflow({ overflow: TextOverflow.Ellipsis })
                Text(`${recipe.totalWeight}kg`).fontSize(12).fontColor(ThemeColors.PRIMARY_DARK)
              }
              .width('100%').padding({ top: 6, bottom: 6 })
            }, (recipe: RecipeStats) => recipe.name)
          }
          .width('100%').margin({ top: 8 })
        }
      }
    }
    .width('100%').padding(16).backgroundColor(ThemeColors.BG_CARD).borderRadius(16)
  }

  @Builder
  FishRankSection() {
    Column({ space: 12 }) {
      Row({ space: 8 }) {
        Text('ğŸŸ').fontSize(20)
        Text('é±¼ç§æˆ˜ç»©').fontSize(16).fontWeight(FontWeight.Bold).fontColor(ThemeColors.TEXT_PRIMARY)
      }
      .width('100%')

      if (this.fishStats.length === 0) {
        Text('æš‚æ— æ•°æ®').fontSize(14).fontColor(ThemeColors.TEXT_SECONDARY)
      } else {
        Column({ space: 8 }) {
          ForEach(this.fishStats, (fish: FishStats, index: number) => {
            Row({ space: 12 }) {
              // æ’åå¾½ç« 
              Column() {
                Text(index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `${index + 1}`)
                  .fontSize(index < 3 ? 18 : 14)
                  .fontColor(index < 3 ? ThemeColors.PRIMARY : ThemeColors.TEXT_SECONDARY)
              }
              .width(32).alignItems(HorizontalAlign.Center)

              // é±¼ç§åå’Œè¿›åº¦æ?
              Column({ space: 4 }) {
                Row() {
                  Text(fish.name).fontSize(14).fontWeight(FontWeight.Medium).fontColor(ThemeColors.TEXT_PRIMARY)
                  Blank()
                  Text(`${fish.weight}kg`).fontSize(13).fontColor(ThemeColors.PRIMARY_DARK)
                }
                .width('100%')

                Stack({ alignContent: Alignment.Start }) {
                  Row().width('100%').height(8).backgroundColor(ThemeColors.BG_TERTIARY).borderRadius(4)
                  Row().width(`${fish.percentage}%`).height(8)
                    .linearGradient({ direction: GradientDirection.Right, 
                      colors: [[ThemeColors.PRIMARY, 0], ['#FFD700', 1]] })
                    .borderRadius(4)
                }
                .width('100%')
              }
              .layoutWeight(1)
            }
            .width('100%').padding({ top: 4, bottom: 4 })
          }, (fish: FishStats) => fish.name)
        }
        .width('100%')
      }
    }
    .width('100%').padding(16).backgroundColor(ThemeColors.BG_CARD).borderRadius(16)
  }
}
