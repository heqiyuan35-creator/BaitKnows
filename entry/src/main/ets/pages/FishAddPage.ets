/**
 * é¥µçŸ¥é?- é±¼ç±»æ–°å¢é¡µé¢
 * ç”¨æˆ·è‡ªå®šä¹‰æ·»åŠ é±¼ç§æ•°æ?
 */
import { router } from '@kit.ArkUI';
import { photoAccessHelper } from '@kit.MediaLibraryKit';
import { ThemeColors } from '../theme/ThemeColors';
import { ThemeConstants } from '../theme/ThemeConstants';
import { userDataService } from '../services/UserDataService';

// é€‰é¡¹ç±?
class SelectOption {
  id: string = '';
  name: string = '';
}

// åˆ›å»ºé€‰é¡¹è¾…åŠ©å‡½æ•°
function makeOption(id: string, name: string): SelectOption {
  const opt = new SelectOption();
  opt.id = id;
  opt.name = name;
  return opt;
}

@Entry
@Component
struct FishAddPage {
  @State fishName: string = '';
  @State fishNameEn: string = '';
  @State selectedWaterTypes: string[] = [];
  @State selectedFeedingType: string = 'omnivore';
  @State selectedWaterLayer: string = 'bottom';
  @State selectedActivityTime: string = 'all';
  @State selectedTempRange: string = 'medium';  // é€‚å®œæ°´æ¸©èŒƒå›´
  @State selectedFoods: string[] = [];  // å–œé£Ÿé¥µæ–™ï¼ˆå¤šé€‰ï¼‰
  @State description: string = '';
  @State fishIcon: string = '';  // é±¼ç§å›¾æ ‡è·¯å¾„
  @State showToast: boolean = false;
  @State toastMessage: string = '';
  @State isSaving: boolean = false;

  private waterTypes: SelectOption[] = [
    makeOption('pond', 'æ± å¡˜'),
    makeOption('river', 'æ²³æµ'),
    makeOption('reservoir', 'æ°´åº“'),
    makeOption('lake', 'æ¹–æ³Š')
  ];

  private feedingTypes: SelectOption[] = [
    makeOption('herbivore', 'è‰é£Ÿæ€?),
    makeOption('carnivore', 'è‚‰é£Ÿæ€?),
    makeOption('omnivore', 'æ‚é£Ÿæ€?)
  ];

  private waterLayers: SelectOption[] = [
    makeOption('surface', 'ä¸Šå±‚'),
    makeOption('middle', 'ä¸­å±‚'),
    makeOption('bottom', 'åº•å±‚'),
    makeOption('all', 'å…¨æ°´å±?)
  ];

  private activityTimes: SelectOption[] = [
    makeOption('day', 'ç™½å¤©'),
    makeOption('night', 'å¤œé—´'),
    makeOption('dawn_dusk', 'æ™¨æ˜'),
    makeOption('all', 'å…¨å¤©')
  ];

  // é€‚å®œæ°´æ¸©èŒƒå›´é€‰é¡¹
  private tempRanges: SelectOption[] = [
    makeOption('cold', 'ä½æ¸© (5-15Â°C)'),
    makeOption('cool', 'å‡‰çˆ½ (10-20Â°C)'),
    makeOption('medium', 'é€‚ä¸­ (15-25Â°C)'),
    makeOption('warm', 'æ¸©æš– (20-30Â°C)'),
    makeOption('hot', 'é«˜æ¸© (25-35Â°C)')
  ];

  // å–œé£Ÿé¥µæ–™é€‰é¡¹
  private foodOptions: SelectOption[] = [
    makeOption('earthworm', 'èš¯èš“'),
    makeOption('bloodworm', 'çº¢è™«'),
    makeOption('corn', 'ç‰ç±³'),
    makeOption('wheat', 'å°éº¦'),
    makeOption('pellet', 'é¢—ç²’é¥²æ–™'),
    makeOption('dough', 'é¢é¥µ'),
    makeOption('shrimp', 'è™?),
    makeOption('snail', 'èºè›³'),
    makeOption('grass', 'æ°´è‰'),
    makeOption('insect', 'æ˜†è™«'),
    makeOption('fish', 'å°é±¼'),
    makeOption('commercial', 'å•†å“é¥?)
  ];

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ ?
      this.NavBar()

      // è¡¨å•å†…å®¹
      Scroll() {
        Column({ space: 20 }) {
          // é±¼ç§å›¾ç‰‡
          this.FishIconSection()

          // é±¼ç§åç§°
          this.FishNameSection()

          // è‹±æ–‡å?
          this.FishNameEnSection()

          // é€‚åˆæ°´åŸŸ
          this.WaterTypeSection()

          // é£Ÿæ€?
          this.FeedingTypeSection()

          // æ´»åŠ¨æ°´å±‚
          this.WaterLayerSection()

          // æ´»åŠ¨æ—¶æ®µ
          this.ActivityTimeSection()

          // é€‚å®œæ°´æ¸©
          this.TempSection()

          // å–œé£Ÿé¥µæ–™
          this.FavoriteFoodSection()

          // ä¹ æ€§æè¿?
          this.DescriptionSection()

          // ä¿å­˜æŒ‰é’®
          Button('ä¿å­˜é±¼ç§')
            .width('100%')
            .height(48)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .backgroundColor(this.isSaving ? ThemeColors.TEXT_MUTED : ThemeColors.PRIMARY)
            .fontColor(ThemeColors.TEXT_PRIMARY)
            .margin({ top: 16, bottom: 32 })
            .enabled(!this.isSaving)
            .onClick(() => this.saveFish())
        }
        .padding(16)
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)

      // Toast æç¤º
      if (this.showToast) {
        Column() {
          Text(this.toastMessage)
            .fontSize(14)
            .fontColor(Color.White)
            .padding({ left: 16, right: 16, top: 10, bottom: 10 })
            .backgroundColor('rgba(0, 0, 0, 0.7)')
            .borderRadius(20)
        }
        .width('100%')
        .position({ x: 0, y: '40%' })
        .justifyContent(FlexAlign.Center)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(ThemeColors.BG_PRIMARY)
  }

  @Builder
  FishIconSection() {
    Column({ space: 8 }) {
      Text('é±¼ç§å›¾ç‰‡')
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .fontWeight(FontWeight.Medium)

      Row() {
        if (this.fishIcon) {
          // å·²é€‰æ‹©å›¾ç‰‡
          Stack() {
            Image(this.fishIcon)
              .width(100)
              .height(100)
              .borderRadius(12)
              .objectFit(ImageFit.Cover)

            // åˆ é™¤æŒ‰é’®
            Text('Ã—')
              .fontSize(16)
              .fontColor(Color.White)
              .width(24)
              .height(24)
              .textAlign(TextAlign.Center)
              .backgroundColor('rgba(0,0,0,0.5)')
              .borderRadius(12)
              .position({ x: 76, y: 0 })
              .onClick(() => {
                this.fishIcon = '';
              })
          }
          .width(100)
          .height(100)
        } else {
          // ä¸Šä¼ å ä½
          Column({ space: 8 }) {
            Image($r('app.media.fishImage'))
              .width(48)
              .height(48)
              .objectFit(ImageFit.Contain)

            Text('ç‚¹å‡»ä¸Šä¼ ')
              .fontSize(12)
              .fontColor(ThemeColors.TEXT_MUTED)
          }
          .width(100)
          .height(100)
          .justifyContent(FlexAlign.Center)
          .backgroundColor(ThemeColors.BG_CARD)
          .borderRadius(12)
          .border({ width: 1, color: ThemeColors.PRIMARY, style: BorderStyle.Dashed })
          .onClick(() => {
            // è°ƒç”¨å›¾ç‰‡é€‰æ‹©å™?
            this.selectImageFromGallery();
          })
        }

        // æç¤ºæ–‡å­—
        Column({ space: 4 }) {
          Text('å»ºè®®ä¸Šä¼ æ­£æ–¹å½¢å›¾ç‰?)
            .fontSize(12)
            .fontColor(ThemeColors.TEXT_MUTED)

          Text('æ”¯æŒ JPGã€PNG æ ¼å¼')
            .fontSize(12)
            .fontColor(ThemeColors.TEXT_MUTED)

          Text('ä¸ä¸Šä¼ å°†ä½¿ç”¨é»˜è®¤å›¾æ ‡')
            .fontSize(12)
            .fontColor(ThemeColors.TEXT_HINT)
        }
        .alignItems(HorizontalAlign.Start)
        .margin({ left: 16 })
      }
      .width('100%')
      .alignItems(VerticalAlign.Top)
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  NavBar() {
    Row() {
      Text('â†?)
        .fontSize(24)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .onClick(() => router.back())
        .padding(8)

      Text('æ·»åŠ é±¼ç§')
        .fontSize(ThemeConstants.FONT_SIZE_LG)
        .fontWeight(FontWeight.Bold)
        .fontColor(ThemeColors.TEXT_PRIMARY)
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      Text('')
        .width(40)
    }
    .width('100%')
    .height(56)
    .padding({ left: 8, right: 16 })
    .margin({ top: 44 })
    .backgroundColor(ThemeColors.BG_SECONDARY)
  }

  @Builder
  FishNameSection() {
    Column({ space: 8 }) {
      Text('é±¼ç§åç§° *')
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .fontWeight(FontWeight.Medium)

      TextInput({ placeholder: 'è¯·è¾“å…¥é±¼ç§ä¸­æ–‡å', text: this.fishName })
        .width('100%')
        .height(48)
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .backgroundColor(ThemeColors.BG_CARD)
        .borderRadius(ThemeConstants.RADIUS_SM)
        .padding({ left: 12, right: 12 })
        .onChange((value: string) => {
          this.fishName = value;
        })
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  FishNameEnSection() {
    Column({ space: 8 }) {
      Text('è‹±æ–‡åï¼ˆå¯é€‰ï¼‰')
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .fontWeight(FontWeight.Medium)

      TextInput({ placeholder: 'è¯·è¾“å…¥è‹±æ–‡å', text: this.fishNameEn })
        .width('100%')
        .height(48)
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .backgroundColor(ThemeColors.BG_CARD)
        .borderRadius(ThemeConstants.RADIUS_SM)
        .padding({ left: 12, right: 12 })
        .onChange((value: string) => {
          this.fishNameEn = value;
        })
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  WaterTypeSection() {
    Column({ space: 8 }) {
      Text('é€‚åˆæ°´åŸŸ *')
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .fontWeight(FontWeight.Medium)

      this.WaterTypeSelector()
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  FeedingTypeSection() {
    Column({ space: 8 }) {
      Text('é£Ÿæ€?*')
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .fontWeight(FontWeight.Medium)

      this.FeedingTypeSelector()
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  WaterLayerSection() {
    Column({ space: 8 }) {
      Text('æ´»åŠ¨æ°´å±‚')
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .fontWeight(FontWeight.Medium)

      this.WaterLayerSelector()
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  ActivityTimeSection() {
    Column({ space: 8 }) {
      Text('æ´»åŠ¨æ—¶æ®µ')
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .fontWeight(FontWeight.Medium)

      this.ActivityTimeSelector()
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  TempSection() {
    Column({ space: 8 }) {
      Text('é€‚å®œæ°´æ¸©')
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .fontWeight(FontWeight.Medium)

      Flex({ wrap: FlexWrap.Wrap }) {
        ForEach(this.tempRanges, (item: SelectOption) => {
          Text(item.name)
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(this.selectedTempRange === item.id ? ThemeColors.PRIMARY : ThemeColors.TEXT_SECONDARY)
            .padding({ left: 12, right: 12, top: 8, bottom: 8 })
            .backgroundColor(this.selectedTempRange === item.id ? 'rgba(232, 168, 73, 0.15)' : ThemeColors.BG_CARD)
            .borderRadius(ThemeConstants.RADIUS_FULL)
            .border({
              width: 1,
              color: this.selectedTempRange === item.id ? ThemeColors.PRIMARY : Color.Transparent
            })
            .margin({ right: 8, bottom: 8 })
            .onClick(() => {
              this.selectedTempRange = item.id;
            })
        })
      }
      .width('100%')
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  FavoriteFoodSection() {
    Column({ space: 8 }) {
      Text('å–œé£Ÿé¥µæ–™ï¼ˆå¯å¤šé€‰ï¼‰')
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .fontWeight(FontWeight.Medium)

      Flex({ wrap: FlexWrap.Wrap }) {
        ForEach(this.foodOptions, (item: SelectOption) => {
          Row() {
            Checkbox()
              .select(this.selectedFoods.includes(item.id))
              .selectedColor(ThemeColors.PRIMARY)
              .width(16)
              .height(16)
              .onChange((checked: boolean) => {
                if (checked) {
                  this.selectedFoods.push(item.id);
                } else {
                  const idx = this.selectedFoods.indexOf(item.id);
                  if (idx > -1) {
                    this.selectedFoods.splice(idx, 1);
                  }
                }
                this.selectedFoods = this.selectedFoods.slice();
              })

            Text(item.name)
              .fontSize(ThemeConstants.FONT_SIZE_SM)
              .fontColor(ThemeColors.TEXT_PRIMARY)
              .margin({ left: 4 })
          }
          .padding({ left: 10, right: 10, top: 6, bottom: 6 })
          .backgroundColor(this.selectedFoods.includes(item.id) ? 'rgba(232, 168, 73, 0.15)' : ThemeColors.BG_CARD)
          .borderRadius(ThemeConstants.RADIUS_SM)
          .margin({ right: 8, bottom: 8 })
        })
      }
      .width('100%')
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  DescriptionSection() {
    Column({ space: 8 }) {
      Text('ä¹ æ€§æè¿?)
        .fontSize(ThemeConstants.FONT_SIZE_SM)
        .fontColor(ThemeColors.TEXT_SECONDARY)
        .fontWeight(FontWeight.Medium)

      TextArea({ placeholder: 'æè¿°è¯¥é±¼ç§çš„ç”Ÿæ´»ä¹ æ€§ã€å‚é’“æŠ€å·§ç­‰', text: this.description })
        .width('100%')
        .height(100)
        .fontSize(ThemeConstants.FONT_SIZE_BASE)
        .backgroundColor(ThemeColors.BG_CARD)
        .borderRadius(ThemeConstants.RADIUS_SM)
        .padding(12)
        .onChange((value: string) => {
          this.description = value;
        })
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  WaterTypeSelector() {
    Row({ space: 8 }) {
      ForEach(this.waterTypes, (item: SelectOption) => {
        Row() {
          Checkbox()
            .select(this.selectedWaterTypes.includes(item.id))
            .selectedColor(ThemeColors.PRIMARY)
            .width(18)
            .height(18)
            .onChange((checked: boolean) => {
              if (checked) {
                this.selectedWaterTypes.push(item.id);
              } else {
                const idx = this.selectedWaterTypes.indexOf(item.id);
                if (idx > -1) {
                  this.selectedWaterTypes.splice(idx, 1);
                }
              }
              this.selectedWaterTypes = this.selectedWaterTypes.slice();
            })

          Text(item.name)
            .fontSize(ThemeConstants.FONT_SIZE_SM)
            .fontColor(ThemeColors.TEXT_PRIMARY)
            .margin({ left: 4 })
        }
        .padding({ left: 12, right: 12, top: 8, bottom: 8 })
        .backgroundColor(this.selectedWaterTypes.includes(item.id) ? 'rgba(232, 168, 73, 0.15)' : ThemeColors.BG_CARD)
        .borderRadius(ThemeConstants.RADIUS_SM)
      })
    }
    .width('100%')
  }

  @Builder
  FeedingTypeSelector() {
    Row({ space: 8 }) {
      ForEach(this.feedingTypes, (item: SelectOption) => {
        Text(item.name)
          .fontSize(ThemeConstants.FONT_SIZE_SM)
          .fontColor(this.selectedFeedingType === item.id ? ThemeColors.PRIMARY : ThemeColors.TEXT_SECONDARY)
          .padding({ left: 16, right: 16, top: 8, bottom: 8 })
          .backgroundColor(this.selectedFeedingType === item.id ? 'rgba(232, 168, 73, 0.15)' : ThemeColors.BG_CARD)
          .borderRadius(ThemeConstants.RADIUS_FULL)
          .border({
            width: 1,
            color: this.selectedFeedingType === item.id ? ThemeColors.PRIMARY : Color.Transparent
          })
          .onClick(() => {
            this.selectedFeedingType = item.id;
          })
      })
    }
    .width('100%')
  }

  @Builder
  WaterLayerSelector() {
    Row({ space: 8 }) {
      ForEach(this.waterLayers, (item: SelectOption) => {
        Text(item.name)
          .fontSize(ThemeConstants.FONT_SIZE_SM)
          .fontColor(this.selectedWaterLayer === item.id ? ThemeColors.PRIMARY : ThemeColors.TEXT_SECONDARY)
          .padding({ left: 16, right: 16, top: 8, bottom: 8 })
          .backgroundColor(this.selectedWaterLayer === item.id ? 'rgba(232, 168, 73, 0.15)' : ThemeColors.BG_CARD)
          .borderRadius(ThemeConstants.RADIUS_FULL)
          .border({
            width: 1,
            color: this.selectedWaterLayer === item.id ? ThemeColors.PRIMARY : Color.Transparent
          })
          .onClick(() => {
            this.selectedWaterLayer = item.id;
          })
      })
    }
    .width('100%')
  }

  @Builder
  ActivityTimeSelector() {
    Row({ space: 8 }) {
      ForEach(this.activityTimes, (item: SelectOption) => {
        Text(item.name)
          .fontSize(ThemeConstants.FONT_SIZE_SM)
          .fontColor(this.selectedActivityTime === item.id ? ThemeColors.PRIMARY : ThemeColors.TEXT_SECONDARY)
          .padding({ left: 16, right: 16, top: 8, bottom: 8 })
          .backgroundColor(this.selectedActivityTime === item.id ? 'rgba(232, 168, 73, 0.15)' : ThemeColors.BG_CARD)
          .borderRadius(ThemeConstants.RADIUS_FULL)
          .border({
            width: 1,
            color: this.selectedActivityTime === item.id ? ThemeColors.PRIMARY : Color.Transparent
          })
          .onClick(() => {
            this.selectedActivityTime = item.id;
          })
      })
    }
    .width('100%')
  }

  private async saveFish(): Promise<void> {
    if (this.isSaving) return;

    // éªŒè¯åç§°
    const trimmedName = this.fishName.trim();
    if (!trimmedName) {
      this.showToastMessage('è¯·è¾“å…¥é±¼ç§åç§?);
      return;
    }

    if (trimmedName.length < 2) {
      this.showToastMessage('é±¼ç§åç§°è‡³å°‘2ä¸ªå­—ç¬?);
      return;
    }

    // éªŒè¯æ°´åŸŸ
    if (this.selectedWaterTypes.length === 0) {
      this.showToastMessage('è¯·é€‰æ‹©é€‚åˆæ°´åŸŸ');
      return;
    }

    this.isSaving = true;

    try {
      // ä¿å­˜åˆ?UserDataServiceï¼ˆåŒ…å«å›¾ç‰‡è·¯å¾„ï¼‰
      await userDataService.addFish(
        trimmedName,
        this.fishNameEn.trim(),
        this.fishIcon,  // å›¾ç‰‡è·¯å¾„
        this.selectedWaterTypes.slice(),
        this.selectedFeedingType,
        this.selectedWaterLayer,
        this.selectedActivityTime,
        this.selectedTempRange,  // é€‚å®œæ°´æ¸©èŒƒå›´
        this.selectedFoods.slice(),  // å–œé£Ÿé¥µæ–™ï¼ˆå¤šé€‰ï¼‰
        this.description.trim()
      );

      this.showToastMessage('é±¼ç§ä¿å­˜æˆåŠŸ');

      setTimeout(() => {
        router.back();
      }, 800);

    } catch (error) {
      console.error('ä¿å­˜é±¼ç§å¤±è´¥:', error);
      this.showToastMessage('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
      this.isSaving = false;
    }
  }

  // ä»ç›¸å†Œé€‰æ‹©å›¾ç‰‡
  private selectImageFromGallery(): void {
    const photoPicker = new photoAccessHelper.PhotoViewPicker();
    photoPicker.select({
      MIMEType: photoAccessHelper.PhotoViewMIMETypes.IMAGE_TYPE,
      maxSelectNumber: 1
    }).then((res: photoAccessHelper.PhotoSelectResult) => {
      if (res.photoUris && res.photoUris.length > 0) {
        this.fishIcon = res.photoUris[0];
        this.showToastMessage('å›¾ç‰‡é€‰æ‹©æˆåŠŸ');
      }
    }).catch((err: Error) => {
      console.error('é€‰æ‹©å›¾ç‰‡å¤±è´¥:', err);
      this.showToastMessage('é€‰æ‹©å›¾ç‰‡å¤±è´¥');
    });
  }

  private showToastMessage(message: string): void {
    this.toastMessage = message;
    this.showToast = true;
    setTimeout(() => {
      this.showToast = false;
    }, 2000);
  }
}
